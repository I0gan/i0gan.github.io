<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>协程实现 | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>协程实现</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2021-04-24T01:07:55.000Z" id="date"> 2021-04-24</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-10-24T09:47:52.839Z" id="updated"> 2022-10-24</time></div></span><br><span>Word Count: <div class="control">1.5k</div></span><br><span>Read Time: <div class="control">7 min</div></span></div></div><hr><div id="post-content"><h1 id="协程实现"><a href="#协程实现" class="headerlink" title="协程实现"></a>协程实现</h1><h2 id="C"><a href="#C" class="headerlink" title="C"></a>C</h2><p><strong>1. 利用 C 语言的 setjmp 和 longjmp，函数中使用 static local 的变量来保存协程内部的数据。</strong></p>
<p>函数原型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int setjmp(jmp_buf envbuf);<br>void longjmp(jmp_buf envbuf, int val);<br></code></pre></td></tr></table></figure>



<p>先调用setjmp，用变量envbuf记录当前的位置，然后调用longjmp，返回envbuf所记录的位置，并使setjmp的返回值为val。使用longjmp后，envbuf的内容会被销毁。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-number">1</span> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span> </span><br> <span class="hljs-number">2</span> <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;setjmp.h&gt;</span></span><br> <span class="hljs-number">3</span>  <br> <span class="hljs-number">4</span> jmp_buf buf; <br> <span class="hljs-number">5</span> <br> <span class="hljs-number">6</span> banana()<br> <span class="hljs-number">7</span> &#123; <br> <span class="hljs-number">8</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;in banana() \n&quot;</span>); <br> <span class="hljs-number">9</span>     longjmp(buf,<span class="hljs-number">1</span>); <br><span class="hljs-number">10</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;you&#x27;ll never see this,because i longjmp&#x27;d&quot;</span>); <br><span class="hljs-number">11</span> &#125; <br><span class="hljs-number">12</span> <br><span class="hljs-number">13</span> main() &#123; <br><span class="hljs-number">15</span>     <span class="hljs-keyword">if</span>(setjmp(buf)) <br><span class="hljs-number">16</span>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;back in main\n&quot;</span>); <br><span class="hljs-number">17</span>     <span class="hljs-keyword">else</span><br><span class="hljs-number">18</span>     &#123; <br><span class="hljs-number">19</span>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;first time through\n&quot;</span>); <br><span class="hljs-number">20</span>         banana(); <br>	&#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">first time through<br><br>in banana()<br><br>back in main<br></code></pre></td></tr></table></figure>

<p><strong>2、利用C语言语法switch-case的技巧来实现</strong></p>
<p>设置一个标识符，改变标识符的值，通过switch-case对标识符值的判断操纵各协程函数轮流执行。</p>
<p>每个协程函数可配一个结构体，保存栈内容和状态机。</p>
<p>代码：<a target="_blank" rel="noopener" href="https://github.com/georgeredinger/protothreads">https://github.com/georgeredinger/protothreads</a></p>
<p><strong>3、使用汇编代码来切换上下文(实现c协程) 。</strong></p>
<p>构建一个结构体保存栈内容和当前位置等上下文信息，利用汇编语言的跳转实现协程功能。</p>
<p>详情见：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/heluan/p/9899824.html">https://www.cnblogs.com/heluan/p/9899824.html</a></p>
<p><strong>4、利用操作系统提供的接口：Linux的ucontext，Windows的Fiber。（云风的coroutine）</strong></p>
<p><strong>ucontext：</strong>　makecontext(）　　　　　　　创建上下文   　　</p>
<p>　　　　　　getcontext()　　　　　　　　　读取上下文</p>
<p>　　　　　　setcontext()　　　　　　　　　设置上下文</p>
<p>　　　　　　swapcontext()　　　　　　　　跳转上下文</p>
<p><strong>Fiber(纤程)：</strong>ConverThreadToFiber()　 　　从当前线程进入纤程</p>
<p>　　　　　　CreateFiber()　　　　　　 　　创建新纤程</p>
<p>　　　　　　SwitchToFiber()　　　　　 　　切换到纤程</p>
<p>　　　　　　DeleteFiber()　　　　　　 　　删除纤程</p>
<p>　　　　　　　　　　　　　　　　　　　　如果删除当前纤程，会导致它所在的线程退出 </p>
<p>操作系统的接口函数本身，提供了保存栈内容的功能。 </p>
<h2 id="C-1"><a href="#C-1" class="headerlink" title="C++"></a>C++</h2><p>说到 c++ 上的协程，boost 里其实已经有相关的实现了，不过接口上看用起来有些麻烦，单纯从语法上来说，我觉得 Lua 的协程最简洁易用了，概念上也比较直接，为什么不做一个类似的呢？所以我就打算照着 Lua 来山寨一个，只需要支持四个接口就够了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">create coroutine<br>run/resume coroutine<br>Yield running corouinte<br>IsCoroutineAlive<br></code></pre></td></tr></table></figure>



<h3 id="存与恢复上下文"><a href="#存与恢复上下文" class="headerlink" title="存与恢复上下文"></a>存与恢复上下文</h3><p>实现协程&#x2F;线程，最麻烦莫过于保存和切换上下文了，好在 makecontext，swapcontext 这几个函数相当好用，已经完全帮忙解决了这个难题：makecontext 可以帮我们建立起协程的上下文，swapcontext 则可以切换不同的上下文，从而实现那种把当前函数暂时停住，切换出去执行别的函数然后再切换回来继续执行的效果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ucontext.h&gt;</span></span><br>using namespace <span class="hljs-built_in">std</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> g_stack[<span class="hljs-number">2048</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">ucontext_t</span> ctx,ctx_main;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-comment">// do something.</span><br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;enter func&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br><br>    swapcontext(&amp;ctx, &amp;ctx_main);<br><br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;func1 resume from yield&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-comment">// continue to do something.</span><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>   getcontext(&amp;ctx);<br>   ctx.uc_stack.ss_sp = g_stack;<br>   ctx.uc_stack.ss_size = <span class="hljs-keyword">sizeof</span> g_stack;<br>   ctx.uc_link = &amp;ctx_main;<br>    <br>   makecontext(&amp;ctx, func, <span class="hljs-number">0</span>);<br><br>   <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;in main, before coroutine starts&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br><br>   swapcontext(&amp;ctx_main, &amp;ctx);<br><br>   <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;back to main&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br><br>   swapcontext(&amp;ctx_main, &amp;ctx);<br>   <br>   <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;back to main again&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如上代码所示，显然我们只要简单包装一下 swapcontext，很容易就可以实现 Yield 和 Resume，有了它们的帮助协程做起来就容易多了。</p>
<h3 id="使用与实现"><a href="#使用与实现" class="headerlink" title="使用与实现"></a>使用与实现</h3><p>在使用 makecontext，swapcontext 的基础上，参看<a target="_blank" rel="noopener" href="https://github.com/kmalloc/coroutine">这里</a>，代码写下来总共才200多行，出乎意料的简单，用起来也很方便了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;coroutine.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><br>using namespace <span class="hljs-built_in">std</span>;<br><br>CoroutineScheduler* sched = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span><br>&#123;<br>    <span class="hljs-type">uintptr_t</span> ret;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;function1 a now!,arg:&quot;</span> &lt;&lt; arg &lt;&lt; <span class="hljs-string">&quot;, start to yield.&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    ret = sched-&gt;Yield((<span class="hljs-type">uintptr_t</span>)<span class="hljs-string">&quot;func1 yield 1&quot;</span>);<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;1.fun1 return from yield:&quot;</span> &lt;&lt; (<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)ret &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    ret = sched-&gt;Yield((<span class="hljs-type">uintptr_t</span>)<span class="hljs-string">&quot;func1 yield 2&quot;</span>);<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;2.fun1 return from yield:&quot;</span> &lt;&lt; (<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)ret &lt;&lt; <span class="hljs-string">&quot;, going to stop&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">(<span class="hljs-type">void</span>* s)</span><br>&#123;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;function2 a now!, arg:&quot;</span> &lt;&lt; s &lt;&lt; <span class="hljs-string">&quot;, start to yield.&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* y = (<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)sched-&gt;Yield((<span class="hljs-type">uintptr_t</span>)<span class="hljs-string">&quot;func2 yield 1&quot;</span>);<br>    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;fun2 return from yield:&quot;</span> &lt;&lt; y &lt;&lt;<span class="hljs-string">&quot;, going to stop&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    sched = new CoroutineScheduler();<br><br>    <span class="hljs-type">bool</span> stop = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">int</span> f1 = sched-&gt;CreateCoroutine(func1, (<span class="hljs-type">void</span>*)<span class="hljs-number">111</span>);<br>    <span class="hljs-type">int</span> f2 = sched-&gt;CreateCoroutine(func2, (<span class="hljs-type">void</span>*)<span class="hljs-number">222</span>);<br><br>    <span class="hljs-keyword">while</span> (!stop)<br>    &#123;<br>        stop = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (sched-&gt;IsCoroutineAlive(f1))<br>        &#123;<br>            stop = <span class="hljs-literal">false</span>;<br>            <span class="hljs-type">const</span> <span class="hljs-type">char</span>* y1 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)sched-&gt;ResumeCoroutine(f1, (<span class="hljs-type">uintptr_t</span>)<span class="hljs-string">&quot;resume func1&quot;</span>);<br>            <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;func1 yield:&quot;</span> &lt;&lt; y1 &lt;&lt; <span class="hljs-built_in">endl</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (sched-&gt;IsCoroutineAlive(f2))<br>        &#123;<br>            stop = <span class="hljs-literal">false</span>;<br>            <span class="hljs-type">const</span> <span class="hljs-type">char</span>* y2 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)sched-&gt;ResumeCoroutine(f2, (<span class="hljs-type">uintptr_t</span>)<span class="hljs-string">&quot;resume func2&quot;</span>);<br>            <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;func2 yield:&quot;</span> &lt;&lt; y2 &lt;&lt; <span class="hljs-built_in">endl</span>;<br>        &#125;<br>    &#125;<br><br>    delete sched;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如上所示，Yield 里传的参数会在调用 Resume 时被返回，同理 Resume 里的第二个参数，会在 Yield 里被返回，这种机制也是模仿 Lua 来的，有些时候可以用来在协程间传递一些参数，很方便，看起来也挺酷的，但在实现上却相当地简洁，核心代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// static function</span><br><span class="hljs-type">void</span> CoroutineScheduler::SchedulerImpl::Schedule(<span class="hljs-type">void</span>* arg)<br>&#123;<br>    assert(arg);<br>    SchedulerImpl* sched = (SchedulerImpl*) arg;<br><br>    <span class="hljs-type">int</span> running = sched-&gt;running_;<br><br>    coroutine* cor = sched-&gt;id2routine_[running];<br>    assert(cor);<br><br>    cor-&gt;func(cor-&gt;arg);<br><br>    sched-&gt;running_ = <span class="hljs-number">-1</span>;<br>    cor-&gt;status = CO_FINISHED;<br>&#125;<br><br><span class="hljs-comment">// resume coroutine.</span><br><span class="hljs-type">uintptr_t</span> CoroutineScheduler::SchedulerImpl::ResumeCoroutine(<span class="hljs-type">int</span> id, <span class="hljs-type">uintptr_t</span> y)<br>&#123;<br>    coroutine* cor = id2routine_[id];<br>    <span class="hljs-keyword">if</span> (cor == <span class="hljs-literal">NULL</span> || cor-&gt;status == CO_RUNNING) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    cor-&gt;yield = y;<br>    <span class="hljs-keyword">switch</span> (cor-&gt;status)<br>    &#123;<br>        <span class="hljs-keyword">case</span> CO_READY:<br>            &#123;<br>                getcontext(&amp;cor-&gt;cxt);<br><br>                cor-&gt;status = CO_RUNNING;<br>                cor-&gt;cxt.uc_stack.ss_sp = cor-&gt;<span class="hljs-built_in">stack</span>;<br>                cor-&gt;cxt.uc_stack.ss_size = stacksize_;<br>                <span class="hljs-comment">// sucessor context.</span><br>                cor-&gt;cxt.uc_link = &amp;mainContext_;<br><br>                running_ = id;<br>                makecontext(&amp;cor-&gt;cxt, (<span class="hljs-type">void</span> (*)())Schedule, <span class="hljs-number">1</span>, this);<br>                swapcontext(&amp;mainContext_, &amp;cor-&gt;cxt);<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CO_SUSPENDED:<br>            &#123;<br>                running_ = id;<br>                cor-&gt;status = CO_RUNNING;<br>                swapcontext(&amp;mainContext_, &amp;cor-&gt;cxt);<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            assert(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-type">uintptr_t</span> ret = cor-&gt;yield;<br><br>    <span class="hljs-keyword">if</span> (running_ == <span class="hljs-number">-1</span> &amp;&amp; cor-&gt;status == CO_FINISHED) DestroyCoroutine(id);<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">uintptr_t</span> CoroutineScheduler::SchedulerImpl::Yield(<span class="hljs-type">uintptr_t</span> y)<br>&#123;<br>    <span class="hljs-keyword">if</span> (running_ &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">int</span> cur = running_;<br>    running_ = <span class="hljs-number">-1</span>;<br><br>    coroutine* cor = id2routine_[cur];<br><br>    cor-&gt;yield = y;<br>    cor-&gt;status = CO_SUSPENDED;<br><br>    swapcontext(&amp;cor-&gt;cxt, &amp;mainContext_);<br>    <span class="hljs-keyword">return</span> cor-&gt;yield;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>ref:  <a target="_blank" rel="noopener" href="https://www.cnblogs.com/catch/p/3617962.html">https://www.cnblogs.com/catch/p/3617962.html</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2021/04/24/security/hw/2021-04-hw/">← Next 中级蓝队护网外包驻场总结</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2021/04/23/security/crypto/https_identify/">HTTPS单项认证与双向认证 Prev →</a></div></div></div><details id="reward"><summary>打赏点小钱</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E5%AE%9E%E7%8E%B0"><span class="toc-text">协程实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#C"><span class="toc-text">C</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C-1"><span class="toc-text">C++</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E4%B8%8E%E6%81%A2%E5%A4%8D%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-text">存与恢复上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-text">使用与实现</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">2022 by i0gan</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'TzNey4n3v0Sx6vdBbytYLoH9-gzGzoHsz'
 , appKey: 'GIXXrK9zLxt0bZLww1hte0Oq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>