<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Heap-Based Buffer Overflow in Sudo | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>Heap-Based Buffer Overflow in Sudo</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2021-03-31T16:48:43.000Z" id="date"> 2021-04-01</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-10-24T09:06:59.503Z" id="updated"> 2022-10-24</time></div></span><br><span>Word Count: <div class="control">2.3k</div></span><br><span>Read Time: <div class="control">14 min</div></span></div></div><hr><div id="post-content"><h1 id="CVE-2021-3156-Heap-Based-Buffer-Overflow-in-Sudo"><a href="#CVE-2021-3156-Heap-Based-Buffer-Overflow-in-Sudo" class="headerlink" title="CVE-2021-3156: Heap-Based Buffer Overflow in Sudo"></a>CVE-2021-3156: Heap-Based Buffer Overflow in Sudo</h1><h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>This CVE almost impact on all distributions of linux, every common user can use this vulnerability  escaped permission as root. Disclosured at 2021-01-13. We have a ctf match (hws) at 2021-02, there is a pwn challenge can use this vulnerability to escape permission as root, but I don’t use this CVE to realize it. Just  use CVE-2019-14287 easily to get root. At that time, I knew this CVE, but I didn’t want explore the  background technologes. Now, this paper will analyse this vulnerability and let’s to exploit it.</p>
<p>What versions are vulnerable?</p>
<p>The following versions of sudo are vulnerable:</p>
<ul>
<li>All legacy versions from 1.8.2 to 1.8.31p2</li>
<li>All stable versions from 1.9.0 to 1.9.5p1</li>
</ul>
<p>sudo official website: <a target="_blank" rel="noopener" href="https://www.sudo.ws/">https://www.sudo.ws/</a></p>
<h2 id="Check-if-you-are-affected"><a href="#Check-if-you-are-affected" class="headerlink" title="Check if you are affected"></a>Check if you are affected</h2><p>Login as non-root user</p>
<h3 id="Method-1"><a href="#Method-1" class="headerlink" title="Method 1"></a>Method 1</h3><p>Run a command as follow to check.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">sudoedit -s &#x27;aaaaaaaaaaaaaaaaa\&#x27;<br></code></pre></td></tr></table></figure>

<p>If you receive a usage or error message, sudo is not vulnerable. If the result is a Segmentation fault, sudo is vulnerable. As you can see below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">malloc(): memory corruption<br>Aborted (core dumped)<br></code></pre></td></tr></table></figure>

<h3 id="Method-2"><a href="#Method-2" class="headerlink" title="Method 2"></a>Method 2</h3><p>Coming from official judge method (Not recommend!)</p>
<p>Run command <code>sudoedit -s /</code></p>
<p>If the system is vulnerable, it will response with an error that starts with “sudoedit”</p>
<p>If the system is not vulnerable, it will response with an error that starts with “usage”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[i0gan@arch ~]$ sudoedit -s / <br>usage: sudoedit [-AknS] [-C num] [-D directory] [-g group] [-h host] [-p prompt] [-R directory] [-T timeout] [-u user]<br>                file ...<br></code></pre></td></tr></table></figure>

<p>But I try it, this dosen’t work, I cannot use this method to judge if my system is vulnerable. becuase I test on my latest sudo, this version has been patched, I use this method to test,the result is correct. when I test on my vulnerable system. it dosen’t show “sudoedit”, instead let me input password. So I recommend tester to use method 1 to test your linux system.</p>
<h2 id="Prepare-ENV"><a href="#Prepare-ENV" class="headerlink" title="Prepare ENV"></a>Prepare ENV</h2><p>My sudo version and operation system version information as follows.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">sudo --version<br>Sudo version 1.8.21p2<br>Sudoers policy plugin version 1.8.21p2<br>Sudoers file grammar version 46<br>Sudoers I/O plugin version 1.8.21p2<br><br>cat /proc/version<br>Linux version 5.3.0-28-generic (buildd@lcy01-amd64-009) (gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04.1)) #30~18.04.1-Ubuntu SMP Fri Jan 17 06:14:09 UTC 2020<br></code></pre></td></tr></table></figure>

<p>My vulnerable system is ubuntu 18.04.1 and operation system is ubuntu~18.04.1</p>
<p>I test version is 1.8.21p2.  We should download source code to analyse this vulnerability. You can download source code of 1.8.21p2 version here.</p>
<p><a target="_blank" rel="noopener" href="https://www.sudo.ws/dist/sudo-1.8.21p2.tar.gz">Download</a> </p>
<p>If we downloaded source code, we can open NEWS file learn historic vulnerabilities : ). There are so many bug we can learn. Nice!!!</p>
<p>Now we must to dynamic debugging sudo program, some tools we will used.</p>
<p>gdb + pwndbg plugin   — Debugging sudo program</p>
<p>gcc  — Compile our C exploit script to ELF binary</p>
<p>If your prepared tools above, now starting our journey. Last set your linux system sudo program version as 1.8.21p2. </p>
<p>install step</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./configure<br>make<br>sudo make install<br></code></pre></td></tr></table></figure>



<h2 id="Hole-Technical-Analysis"><a href="#Hole-Technical-Analysis" class="headerlink" title="Hole Technical Analysis"></a>Hole Technical Analysis</h2><p>This vulnerability is discovered by fuzz, So we have to explore how is it crashed. <code>sudo</code> allows users to run programs with the security previleges of another user. <code>sudoedit</code> is a built-in command of sudo that allows users to securely edit files. In this new fulnerability, Qualys researchers discovered that when running <code>sudoedit</code> whth flags -s or -i, the command will not result exit with an error, and the sudoers policy plugin will not remove the escape characters, resulting instead in reading beyond the last of a string. if it ends with an un-escaped backslash character. May allow attackers to exploit this vulnerability in order to run arbitrary code execution with root privilege without authentication.</p>
<p>Test what arguments in running programs</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span> &#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, argv[<span class="hljs-number">1</span>]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>outputs:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./a.out &#x27;AAAAAAAAA\&#x27;<br>AAAAAAAAA\<br></code></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#! /bin/bash</span><br>args=`<span class="hljs-built_in">echo</span> -e <span class="hljs-string">&#x27;AAAAAAAAA\&#x27;</span>`<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;sudoedit -s <span class="hljs-variable">$args</span>&quot;</span><br>sudoedit -s <span class="hljs-variable">$args</span><br></code></pre></td></tr></table></figure>

<p>outputs:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./t<br>sudoedit -s AAAAAAAAA\<br>malloc(): memory corruption<br>./t: line 4:  8832 Aborted                 (core dumped) sudoedit -s $args<br></code></pre></td></tr></table></figure>

<p>So arguments is AAAAAAAAA\</p>
<p>This version, if <code>sudo</code> is executed to run a command in <code>shell mode</code> . through the <code>-s</code> option</p>
<p> or through -i option sets sudo’s <code>MODE_SHELL</code> and <code>MODE_LOGIN_SHELL</code> flags. </p>
<p><code>parse_args</code> function used for parse program arguments</p>
<p>src&#x2F;sudo.c: 193 in main() function</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse command line arguments. */</span><br>sudo_mode = parse_args(argc, argv, &amp;nargc, &amp;nargv, &amp;settings, &amp;env_add);<br>sudo_debug_printf(SUDO_DEBUG_DEBUG, <span class="hljs-string">&quot;sudo_mode %d&quot;</span>, sudo_mode); <br></code></pre></td></tr></table></figure>

<p>if we set flags as MODE_SHELL, we can enter shell mode, that can rewrite argv.</p>
<p>By concatenating all command-line arguments and by escaping all meta-characters with backslashes</p>
<p>src&#x2F;parse_args.c : 528 in  parse_args() function</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*  </span><br><span class="hljs-comment"> * For shell mode we need to rewrite argv</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (ISSET(mode, MODE_RUN) &amp;&amp; ISSET(flags, MODE_SHELL)) &#123;<br><span class="hljs-type">char</span> **av, *cmnd = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">int</span> ac = <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">if</span> (argc != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">/* shell -c &quot;command&quot; */</span><br>    <span class="hljs-type">char</span> *src, *dst;<br>    <span class="hljs-comment">// command size</span><br>    <span class="hljs-type">size_t</span> cmnd_size = (<span class="hljs-type">size_t</span>) (argv[argc - <span class="hljs-number">1</span>] - argv[<span class="hljs-number">0</span>]) +<br>    <span class="hljs-built_in">strlen</span>(argv[argc - <span class="hljs-number">1</span>]) + <span class="hljs-number">1</span>;<br><br>    cmnd = dst = reallocarray(<span class="hljs-literal">NULL</span>, cmnd_size, <span class="hljs-number">2</span>); <span class="hljs-comment">// malloc mem to store command</span><br>    <span class="hljs-keyword">if</span> (cmnd == <span class="hljs-literal">NULL</span>)<br>    sudo_fatalx(U_(<span class="hljs-string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="hljs-string">&quot;unable to allocate memory&quot;</span>));<br>    <span class="hljs-keyword">if</span> (!gc_add(GC_PTR, cmnd))<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// By concatenating all command-line arguments </span><br>    <span class="hljs-keyword">for</span> (av = argv; *av != <span class="hljs-literal">NULL</span>; av++) &#123;<br>    <span class="hljs-keyword">for</span> (src = *av; *src != <span class="hljs-string">&#x27;\0&#x27;</span>; src++) &#123; <span class="hljs-comment">// get one commands</span><br>        <span class="hljs-comment">/* quote potential meta characters */</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isalnum</span>((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)*src) &amp;&amp; *src != <span class="hljs-string">&#x27;_&#x27;</span> &amp;&amp; *src != <span class="hljs-string">&#x27;-&#x27;</span> &amp;&amp; *src != <span class="hljs-string">&#x27;$&#x27;</span>)<br>        *dst++ = <span class="hljs-string">&#x27;\\&#x27;</span>; <span class="hljs-comment">// Escaping all meta-characters with backslashes, that can make a easy heap overflow</span><br>        *dst++ = *src;<br>    &#125;   <br>    *dst++ = <span class="hljs-string">&#x27; &#x27;</span>;<br>    &#125;   <br>    <span class="hljs-keyword">if</span> (cmnd != dst)<br>    dst--;  <span class="hljs-comment">/* replace last space with a NUL */</span><br>    *dst = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>    ac += <span class="hljs-number">2</span>; <span class="hljs-comment">/* -c cmnd */</span><br>&#125;<br><br>av = reallocarray(<span class="hljs-literal">NULL</span>, ac + <span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span> *));<br><span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span>)                                                                                                                                                                                                                                          <br>    sudo_fatalx(U_(<span class="hljs-string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="hljs-string">&quot;unable to allocate memory&quot;</span>));<br><span class="hljs-keyword">if</span> (!gc_add(GC_PTR, av))<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br><br>av[<span class="hljs-number">0</span>] = (<span class="hljs-type">char</span> *)user_details.shell; <span class="hljs-comment">/* plugin may override shell */</span><br><span class="hljs-keyword">if</span> (cmnd != <span class="hljs-literal">NULL</span>) &#123;<br>    av[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-c&quot;</span>;<br>    av[<span class="hljs-number">2</span>] = cmnd;<br>&#125;   <br>av[ac] = <span class="hljs-literal">NULL</span>;<br><br>argv = av; <br>argc = ac; <br>&#125;<br></code></pre></td></tr></table></figure>



<p>Now we debugging this sudoedit program, copy this file to current directory from &#x2F;usr&#x2F;bin&#x2F;sudoedit, use IDA or Cutter to analyse it.</p>
<p>I use IDA 7.5 to decompile it, we should find parse_args function. because this program haven’t parse_args function symbol, I have to find this parse_args function by self according main argc arguments.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)sudo_conf_disable_coredump_v1() )<br>  sub_14E00(<span class="hljs-number">0LL</span>);<br>dword_2250C0 = sub_11760((<span class="hljs-type">int</span>)v4, a2, (<span class="hljs-type">int</span> *)&amp;v171, &amp;v172, &amp;v177, &amp;v173);<br>sudo_debug_printf2_v1(<br>  <span class="hljs-string">&quot;main&quot;</span>,<br>  <span class="hljs-string">&quot;../../src/sudo.c&quot;</span>,<br>  <span class="hljs-number">194LL</span>,<br>  <span class="hljs-number">456LL</span>,<br>  <span class="hljs-string">&quot;sudo_mode %d&quot;</span>,<br>  (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)dword_2250C0);<br></code></pre></td></tr></table></figure>

<p>Because v2 is main function argc argument, so I easily found sub_11760, it is parse_args function.</p>
<p>Found above source’s pseudo code as follow.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">LABEL_100:<br>  <span class="hljs-keyword">if</span> ( (v122 &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span> || (v123 &amp; <span class="hljs-number">0x20000</span>) == <span class="hljs-number">0</span> ) <span class="hljs-comment">// flags</span><br>    <span class="hljs-keyword">goto</span> LABEL_128;<br>  <span class="hljs-keyword">if</span> ( v38 )<br>  &#123;<br>    v41 = v36[v38 - <span class="hljs-number">1</span>];<br>    v42 = <span class="hljs-built_in">strlen</span>(v41);<br>    v43 = reallocarray(<span class="hljs-number">0LL</span>, v42 + v41 - *v36 + <span class="hljs-number">1</span>, <span class="hljs-number">2LL</span>);<br>    v44 = (_BYTE *)v43;<br>    <span class="hljs-keyword">if</span> ( !v43 )<br>    &#123;<br>      sudo_warn_gettext_v1(<span class="hljs-number">0LL</span>, <span class="hljs-string">&quot;unable to allocate memory&quot;</span>);<br>      v106 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)sudo_warn_gettext_v1(<span class="hljs-number">0LL</span>, <span class="hljs-string">&quot;%s: %s&quot;</span>, v104, v105);<br>      sudo_debug_printf2_v1(<span class="hljs-string">&quot;parse_args&quot;</span>, <span class="hljs-string">&quot;../../src/parse_args.c&quot;</span>, <span class="hljs-number">540LL</span>, <span class="hljs-number">98LL</span>, v106);<br>      <span class="hljs-keyword">goto</span> LABEL_153;<br>    &#125;<br> ...<br></code></pre></td></tr></table></figure>

<p>We just to know address of this part for debugging.</p>
<p>show asm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:0000000000011F4A                 test    [rsp+0E8h+var_D8], 20000h<br>.text:0000000000011F52                 jz      loc_121DB<br>.text:0000000000011F58                 test    ebx, ebx<br>.text:0000000000011F5A                 jz      loc_1217B<br>.text:0000000000011F60                 movsxd  rbx, ebx<br>.text:0000000000011F63                 mov     rbx, [r14+rbx*8-8]<br>.text:0000000000011F68                 mov     rdi, rbx        ; s<br>.text:0000000000011F6B                 call    _strlen<br>.text:0000000000011F70                 sub     rbx, [r14]<br>.text:0000000000011F73                 xor     edi, edi<br>.text:0000000000011F75                 mov     edx, 2<br>.text:0000000000011F7A                 lea     rsi, [rax+rbx+1]<br>.text:0000000000011F7F                 call    _reallocarray<br></code></pre></td></tr></table></figure>

<p>The parse_args function offset is 0x11760</p>
<p>0x11760-&gt; 0x118B0 -&gt; 0x5674</p>
<p>Now we can set breakpoint at  ELF_BASE_ADDRESS + 0x11760 ( parse_args ) to debugging sudoedit program.</p>
<p>When I debugging, I don’t know why this program haven’t enter above code. </p>
<p>Continue to read blog @_@ … </p>
<p>The author say: In sudoders_policy_main(), set_cmnd() concatenates the command-line arguements into a heap-based buffer. user_args and unescapes the meta-characters (for sudoers matching and logging purposes). These functions are at plugins&#x2F;sudoers&#x2F;sudoers.c. </p>
<p>plugins&#x2F;sudoers&#x2F;sudoers.c in set_cmnd() function </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Fill in user_cmnd, user_args, user_base and user_stat variables</span><br><span class="hljs-comment"> * and apply any command-specific defaults entries.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">set_cmnd</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <span class="hljs-comment">// vulnerable function</span><br>&#123;<br>    <span class="hljs-type">int</span> ret = FOUND;<br>    <span class="hljs-type">char</span> *path = user_path;<br>    debug_decl(set_cmnd, SUDOERS_DEBUG_PLUGIN)<br><br>    <span class="hljs-comment">/* Allocate user_stat for find_path() and match functions. */</span><br>    user_stat = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> stat));<br>    <span class="hljs-keyword">if</span> (user_stat == <span class="hljs-literal">NULL</span>) &#123;<br>    sudo_warnx(U_(<span class="hljs-string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="hljs-string">&quot;unable to allocate memory&quot;</span>));<br>    debug_return_int(NOT_FOUND_ERROR);<br>    &#125;<br><br>    <span class="hljs-comment">/* Default value for cmnd, overridden below. */</span><br>    <span class="hljs-keyword">if</span> (user_cmnd == <span class="hljs-literal">NULL</span>)<br>    user_cmnd = NewArgv[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-keyword">if</span> (sudo_mode &amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) &#123;<br>    <span class="hljs-keyword">if</span> (ISSET(sudo_mode, MODE_RUN | MODE_CHECK)) &#123;<br>        <span class="hljs-keyword">if</span> (def_secure_path &amp;&amp; !user_is_exempt())<br>        path = def_secure_path;<br>        <span class="hljs-keyword">if</span> (!set_perms(PERM_RUNAS))<br>        debug_return_int(<span class="hljs-number">-1</span>);<br>        ret = find_path(NewArgv[<span class="hljs-number">0</span>], &amp;user_cmnd, user_stat, path,<br>        def_ignore_dot, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-keyword">if</span> (!restore_perms())<br>        debug_return_int(<span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (ret == NOT_FOUND) &#123;<br>        <span class="hljs-comment">/* Failed as root, try as invoking user. */</span><br>        <span class="hljs-keyword">if</span> (!set_perms(PERM_USER))<br>            debug_return_int(<span class="hljs-number">-1</span>);<br>        ret = find_path(NewArgv[<span class="hljs-number">0</span>], &amp;user_cmnd, user_stat, path,<br>            def_ignore_dot, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-keyword">if</span> (!restore_perms())<br>            debug_return_int(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ret == NOT_FOUND_ERROR) &#123;<br>        <span class="hljs-keyword">if</span> (errno == ENAMETOOLONG)<br>            audit_failure(NewArgc, NewArgv, N_(<span class="hljs-string">&quot;command too long&quot;</span>));<br>        log_warning(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%s&quot;</span>, NewArgv[<span class="hljs-number">0</span>]);<br>        debug_return_int(ret);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* set user_args */</span><br>    <span class="hljs-keyword">if</span> (NewArgc &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-type">char</span> *to, *from, **av;<br>        <span class="hljs-type">size_t</span> size, n;<br><br>        <span class="hljs-comment">/* Alloc and build up user_args. */</span><br>        <span class="hljs-keyword">for</span> (size = <span class="hljs-number">0</span>, av = NewArgv + <span class="hljs-number">1</span>; *av; av++)<br>        size += <span class="hljs-built_in">strlen</span>(*av) + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span> || (user_args = <span class="hljs-built_in">malloc</span>(size)) == <span class="hljs-literal">NULL</span>) &#123;<br>        sudo_warnx(U_(<span class="hljs-string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="hljs-string">&quot;unable to allocate memory&quot;</span>));<br>        debug_return_int(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * When running a command via a shell, the sudo front-end</span><br><span class="hljs-comment">         * escapes potential meta chars.  We unescape non-spaces</span><br><span class="hljs-comment">         * for sudoers matching and logging purposes.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">for</span> (to = user_args, av = NewArgv + <span class="hljs-number">1</span>; (from = *av); av++) &#123;<br>            <span class="hljs-keyword">while</span> (*from) &#123; <span class="hljs-comment">// vulnerability: if command-line == &#x27;\&#x27;</span><br>            <span class="hljs-comment">// form [0] == &#x27;\\&#x27; &amp;&amp; form[1] == &#x27;\x00&#x27;</span><br>            <span class="hljs-keyword">if</span> (from[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="hljs-built_in">isspace</span>((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)from[<span class="hljs-number">1</span>]))<br>                from++;<br>            *to++ = *from++; <span class="hljs-comment">// copy data to user_args, form pointer add again, out of range</span><br>            &#125; <br>            *to++ = <span class="hljs-string">&#x27; &#x27;</span>;<br>        &#125;<br>        *--to = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">for</span> (to = user_args, av = NewArgv + <span class="hljs-number">1</span>; *av; av++) &#123;<br>            n = strlcpy(to, *av, size - (to - user_args));<br>            <span class="hljs-keyword">if</span> (n &gt;= size - (to - user_args)) &#123;<br>            sudo_warnx(U_(<span class="hljs-string">&quot;internal error, %s overflow&quot;</span>), __func__);<br>            debug_return_int(<span class="hljs-number">-1</span>);<br>            &#125;<br>            to += n;<br>            *to++ = <span class="hljs-string">&#x27; &#x27;</span>;<br>        &#125;<br>        *--to = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>        &#125;<br>    &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((user_base = <span class="hljs-built_in">strrchr</span>(user_cmnd, <span class="hljs-string">&#x27;/&#x27;</span>)) != <span class="hljs-literal">NULL</span>)<br>    user_base++;<br>    <span class="hljs-keyword">else</span><br>    user_base = user_cmnd;<br><br>    <span class="hljs-keyword">if</span> (!update_defaults(SETDEF_CMND, <span class="hljs-literal">false</span>)) &#123;<br>    log_warningx(SLOG_SEND_MAIL|SLOG_NO_STDERR,<br>        N_(<span class="hljs-string">&quot;problem with defaults entries&quot;</span>));<br>    &#125;<br><br>    debug_return_int(ret);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>If a command-line argument ends with a signle backslash character, then <code>form[0]</code> is a backslash character, and <code>form[1]</code> is ‘\x00’  (is not space character)</p>
<p><code>form</code> is incremented and points to the null terminator (‘\x00’);</p>
<p>The null terminator is copied to the <code>user_args</code> buffer, the <code>form</code> is incremented again and points to the first character after the null terminator. (out of arguments’ bounds). The whill loop reads and copies out of bounds characters to the <code>user_args</code> buffer.</p>
<p>So, In the words, set_cmnd is a vulnerable function. There is a heap-based buffer overflow vulnerability.</p>
<p>That copy out of bounds data to the <code>user_args</code> buffer, and not sure how much copied it is. when we exploit, we can use ‘\00’ to terminate coping.</p>
<p>Now how we trigger this vulnerability? </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL))<br></code></pre></td></tr></table></figure>

<p>we should set sudo_mode as <code>MODE_SHELL</code> and <code>MODE_LOGIN_SHELL</code> </p>
<p>It is necessary condition for reaching the vulnerable code. parse_args function can do that, but this function already escaped all meta-characters (i.e., it escaped every single backslash with a second backslash). so including more backslashes, that cannot trigger vuln.</p>
<p>Found a loophole:</p>
<p>if we execute <code>sudo</code> as <code>sudoedit</code> instead of <code>sudo</code>, then parse_args() automatically sets sudo_mode as  MODE_EDIT,  but does not reset <code>valid_flags</code>, and the <code>valid_flags</code> include <code>MODE_SHELL</code> by default.</p>
<p>If we execute <code>sudoedit -s</code>, then we set both <code>MODE_EDIT</code> and <code>MODE_SHELL</code> (but not MODE_RUN), we avoid the escape code, reach the vulnerable code, and overflow the heap-based buffer <code>user_args</code> through a command-line argument that ends with a single backslash character.</p>
<p>Testing heap overflow, we use gdb to test it.</p>
<h2 id="How-to-exploit"><a href="#How-to-exploit" class="headerlink" title="How to exploit?"></a>How to exploit?</h2><p>gdb.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#! /bin/bash</span><br>sudo gdb /usr/bin/sudoedit \<br>    -ex <span class="hljs-string">&quot;set args -s &#x27;AAAAAAAAAAAABBBBBBB\&#x27;&quot;</span><br></code></pre></td></tr></table></figure>

<p>Run gdb.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./gdb.sh<br></code></pre></td></tr></table></figure>

<p>Input run, heap in gdb program</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0x55791f9b40a0 FASTBIN &#123;<br>  mchunk_prev_size = 0,<br>  mchunk_size = 33,<br>  fd = 0x4141414141414141,<br>  bk = 0x4242424241414141,<br>  fd_nextsize = 0x435f534c00424242,<br>  bk_nextsize = 0x73723d53524f4c4f<br>&#125;<br>Exception occurred: malloc_chunk: Cannot access memory at address 0x55791f900000 (&lt;class &#x27;gdb.MemoryError&#x27;&gt;)<br>For more info invoke `set exception-verbose on` and rerun the command<br>or debug it by yourself with `set exception-debugger on`<br>&#x27;heap&#x27;: Prints out chunks starting from the address specified by `addr`.<br></code></pre></td></tr></table></figure>

<p>Show memory.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; x /40gx 0x55791f9b40a0<br>0x55791f9b40a0:	0x0000000000000000	0x0000000000000021<br>0x55791f9b40b0:	0x4141414141414141	0x4242424241414141<br>0x55791f9b40c0:	0x435f534c00424242	0x73723d53524f4c4f<br>0x55791f9b40d0:	0x31303d69643a303d	0x303d6e6c3a34333b<br>0x55791f9b40e0:	0x3d686d3a36333b31	0x30343d69703a3030<br>0x55791f9b40f0:	0x303d6f733a33333b	0x3d6f643a35333b31<br>0x55791f9b4100:	0x64623a35333b3130	0x303b33333b30343d<br>0x55791f9b4110:	0x3b30343d64633a31	0x726f3a31303b3333<br>0x55791f9b4120:	0x303b31333b30343d	0x3a30303d696d3a31<br>0x55791f9b4130:	0x31343b37333d7573	0x343b30333d67733a<br>0x55791f9b4140:	0x3b30333d61633a33	0x30333d77743a3134<br></code></pre></td></tr></table></figure>

<p>It is obviously, this is a heap overflow at top chunk, has overlaped the top chunk.</p>
<p>How can we get shell?</p>
<p>Updating…</p>
<p>ref: <a target="_blank" rel="noopener" href="https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit">https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit</a></p>
<p>ref: <a target="_blank" rel="noopener" href="https://github.com/blasty/CVE-2021-3156">https://github.com/blasty/CVE-2021-3156</a></p>
<p>ref: <a target="_blank" rel="noopener" href="https://github.com/reverse-ex/CVE-2021-3156/blob/main/info">https://github.com/reverse-ex/CVE-2021-3156/blob/main/info</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2021/04/02/security/ctf/compitation/wp-hong-ming-gu/">← Next The Writeup Of Hong Ming Gu Cup Online</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2021/03/31/security/ctf/pwn/auto-pwn/">AUTO PWN Prev →</a></div></div></div><details id="reward"><summary>打赏点小钱</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2021-3156-Heap-Based-Buffer-Overflow-in-Sudo"><span class="toc-text">CVE-2021-3156: Heap-Based Buffer Overflow in Sudo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Intro"><span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Check-if-you-are-affected"><span class="toc-text">Check if you are affected</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-1"><span class="toc-text">Method 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-2"><span class="toc-text">Method 2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prepare-ENV"><span class="toc-text">Prepare ENV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hole-Technical-Analysis"><span class="toc-text">Hole Technical Analysis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-exploit"><span class="toc-text">How to exploit?</span></a></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">2022 by i0gan</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'TzNey4n3v0Sx6vdBbytYLoH9-gzGzoHsz'
 , appKey: 'GIXXrK9zLxt0bZLww1hte0Oq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>