<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>openvpn环境搭建 | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>openvpn环境搭建</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2021-06-28T01:40:16.000Z" id="date"> 2021-06-28</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-04-30T22:38:43.320Z" id="updated"> 2022-05-01</time></div></span><br><span>Word Count: <div class="control">1.6k</div></span><br><span>Read Time: <div class="control">7 min</div></span></div></div><hr><div id="post-content"><h1 id="OPENVPN环境搭建"><a href="#OPENVPN环境搭建" class="headerlink" title="OPENVPN环境搭建"></a>OPENVPN环境搭建</h1><p>说明：启动时注意用户权限，比如root用户启动。</p>
<p>Ubuntu：</p>
<ul>
<li>服务器环境：Ubuntu 16.04 64位系统</li>
<li>内网IP：10.143.80.116</li>
<li>外网IP：203.195.1.2</li>
<li>OpenVPN版本：OpenVPN 2.3.10</li>
</ul>
<p>OpenVPN：</p>
<ul>
<li>一般以系统源安装的版本为准，比如现在安装的基本以2.3.10为主，可能以后会随着源升级而更新到最新版本。</li>
<li>可以单独上<a target="_blank" rel="noopener" href="http://openvpn.net/">官网</a>（需要翻出去）下载指定版本的来安装，但前提注意系统安装的依赖。</li>
</ul>
<p><strong>搭建过程：</strong></p>
<p><strong>1、安装前准备</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"># 安装openssl和lzo，lzo用于压缩通讯数据加快传输速度<br>sudo apt-get install openssl libssl-dev<br>sudo apt-get install lzop<br></code></pre></td></tr></table></figure>

<p><strong>2、安装及配置OpenVPN和easy-rsa</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"># 安装openvpn和easy-rsa<br>sudo apt-get install openvpn<br>sudo apt-get install easy-rsa<br># 修改vars文件 <br>sudo su<br>cd /usr/share/easy-rsa/ <br>vim vars<br># 修改注册信息，比如公司地址、公司名称、部门名称等。<br>export KEY_COUNTRY=&quot;CN&quot;<br>export KEY_PROVINCE=&quot;Shandong&quot;<br>export KEY_CITY=&quot;Qingdao&quot;<br>export KEY_ORG=&quot;MyOrganization&quot;<br>export KEY_EMAIL=&quot;me@myhost.mydomain&quot;<br>export KEY_OU=&quot;MyOrganizationalUnit&quot;<br># 初始化环境变量<br>source vars<br> <br># 清除keys目录下所有与证书相关的文件<br># 下面步骤生成的证书和密钥都在/usr/share/easy-rsa/keys目录里<br>./clean-all<br> <br># 生成根证书ca.crt和根密钥ca.key（一路按回车即可）<br>./build-ca<br> <br># 为服务端生成证书和私钥（一路按回车，直到提示需要输入y/n时，输入y再按回车，一共两次）<br>./build-key-server server<br> <br># 每一个登陆的VPN客户端需要有一个证书，每个证书在同一时刻只能供一个客户端连接，下面建立2份<br># 为客户端生成证书和私钥（一路按回车，直到提示需要输入y/n时，输入y再按回车，一共两次）<br>./build-key client1<br>./build-key client2<br> <br># 创建迪菲·赫尔曼密钥，会生成dh2048.pem文件（生成过程比较慢，在此期间不要去中断它）<br>./build-dh<br> <br># 生成ta.key文件（防DDos攻击、UDP淹没等恶意攻击）<br>openvpn --genkey --secret keys/ta.key<br></code></pre></td></tr></table></figure>

<p><strong>3、创建服务器端配置文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"># 在openvpn的配置目录下新建一个keys目录<br>mkdir /etc/openvpn/keys<br> <br># 将需要用到的openvpn证书和密钥复制一份到刚创建好的keys目录中<br>cp /usr/share/easy-rsa/keys/&#123;ca.crt,server.&#123;crt,key&#125;,dh2048.pem,ta.key&#125; /etc/openvpn/keys/<br> <br># 复制一份服务器端配置文件模板server.conf到/etc/openvpn/gzip -d /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz<br>cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/<br><br># 查看server.conf里的配置参数<br>grep &#x27;^[^#;]&#x27; /etc/openvpn/server.conf<br><br># 编辑server.conf<br>vim /etc/openvpn/server.conf <br>port 1194<br># 改成tcp，默认使用udp，如果使用HTTP Proxy，必须使用tcp协议<br>proto tcp<br>dev tun # 路由模式，桥接模式用dev tap<br># 路径前面加keys，全路径为/etc/openvpn/keys/ca.crt<br>ca keys/ca.crt<br>cert keys/server.crt<br>key keys/server.key  # This file should be kept secret<br>dh keys/dh2048.pem<br># 默认虚拟局域网网段，不要和实际的局域网冲突即可<br>server 10.8.0.0 255.255.255.0 # 路由模式，桥接模式用server-bridge<br>ifconfig-pool-persist ipp.txt<br># 10.0.0.0/8是我这台VPN服务器所在的内网的网段，读者应该根据自身实际情况进行修改<br>push &quot;route 10.0.0.0 255.0.0.0&quot;<br># 可以让客户端之间相互访问直接通过openvpn程序转发，根据需要设置<br>client-to-client<br># 如果客户端都使用相同的证书和密钥连接VPN，一定要打开这个选项，否则每个证书只允许一个人连接VPN<br>duplicate-cn<br>keepalive 10 120<br>tls-auth keys/ta.key 0 # This file is secret<br>comp-lzo<br>persist-key<br>persist-tun<br># OpenVPN的状态日志，默认为/etc/openvpn/openvpn-status.log<br>status openvpn-status.log<br># OpenVPN的运行日志，默认为/etc/openvpn/openvpn.log <br>log-append openvpn.log<br># 改成verb 5可以多查看一些调试信息<br>verb 5<br></code></pre></td></tr></table></figure>

<p><strong>4、配置内核和防火墙，启动服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"># 开启路由转发功能<br>sed -i &#x27;/net.ipv4.ip_forward/s/0/1/&#x27; /etc/sysctl.confsed -i &#x27;/net.ipv4.ip_forward/s/#//&#x27; /etc/sysctl.conf<br>sysctl -p<br> <br># 配置防火墙，别忘记保存<br>iptables -I INPUT -p tcp --dport 1194 -m comment --comment &quot;openvpn&quot; -j ACCEPT<br>iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE<br>mkdir /etc/iptables<br>iptables-save &gt; /etc/iptables/iptables.conf# 关闭ufw防火墙，改成iptables，这一步按需要设置，比较ufw在Ubuntu默认关闭的。iptables和ufw任选一个即可。ufw disable<br> <br># 启动openvpn并设置为开机启动<br>systemctl start openvpn@server<br>systemctl enable openvpn@server<br># 在systemd单元文件的后面，我们通过指定特定的配置文件名来作为一个实例变量来开启OpenVPN服务，我们的配置文件名称为/etc/openvpn/server.conf，所以我们在systemd单元文件的后面添加@server来开启OpenVPN服务<br><br>journalctl -xe # 查看启动日志<br></code></pre></td></tr></table></figure>

<p><strong>5、创建客户端配置****文件client.ovpn（用于客户端软件使用）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"># 复制一份client.conf模板命名为client.ovpn<br>cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/client.ovpn  <br><br># 编辑client.ovpn<br>vim /etc/openvpn/client.ovpn<br>client<br>dev tun # 路由模式<br># 改为tcp<br>proto tcp<br># OpenVPN服务器的外网IP和端口<br>remote 203.195.1.2 1194<br>resolv-retry infinite<br>nobind<br>persist-key<br>persist-tun<br>ca ca.crt<br># client1的证书<br>cert client1.crt<br># client1的密钥<br>key client1.key<br>ns-cert-type server<br># 去掉前面的注释<br>tls-auth ta.key 1<br>comp-lzo<br>verb 5<br></code></pre></td></tr></table></figure>

<p><strong>6、配置client</strong></p>
<p>安装软件，可以和服务器安装的保持一致：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"># 安装openssl和lzo，lzo用于压缩通讯数据加快传输速度<br>sudo apt-get install openssl libssl-dev<br>sudo apt-get install lzop<br><br># 安装openvpn和easy-rsa<br>sudo apt-get install openvpn<br>sudo apt-get install easy-rsa<br></code></pre></td></tr></table></figure>

<p>在服务器上下载回需要的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">sz /etc/openvpn/client.ovpn /etc/openvpn/keys/ca.crt /etc/openvpn/keys/client1.crt /etc/openvpn/keys/client1.key /etc/openvpn/keys/ta.key<br></code></pre></td></tr></table></figure>

<p>将OpenVPN服务器上的client.ovpn、ca.crt、client1.crt、client1.key、ta.key上传到Linux客户端安装目录下的&#x2F;etc&#x2F;openvpn文件夹（使用rz命令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[root@linux64 openvpn]# pwd<br>/etc/openvpn<br>[root@linux64 openvpn]# ls<br>ca.crt client1.crt client1.key client.ovpn conf ta.key<br></code></pre></td></tr></table></figure>

<p>启动客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">openvpn --daemon --cd /etc/openvpn --config client.ovpn --log-append /var/log/openvpn.log &amp;<br></code></pre></td></tr></table></figure>

<p>上面是以守护进程启动的，可以把上面脚本放在&#x2F;etc&#x2F;rc.local实现开机启动。或者使用以服务的形式启动，如果想清晰明了，建议放在启动脚本。</p>
<p>ref: <a target="_blank" rel="noopener" href="http://www.manongjc.com/detail/6-eqkmpihxsfrrauu.html">http://www.manongjc.com/detail/6-eqkmpihxsfrrauu.html</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">explicit-exit-notify 1<br>#此选项开启只能使用udp协议。否则会报错error: --explicit-exit-notify can only be used with --proto udp<br></code></pre></td></tr></table></figure>

<p>ref: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/154309923">https://zhuanlan.zhihu.com/p/154309923</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2021/06/29/dev/game/ue4/UnrealEngine-Install/">← Next 在Linux上安装Unreal Engine 4</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2021/06/26/dev/tools/git/git/">Git学习 Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OPENVPN%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">OPENVPN环境搭建</span></a></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">2022 by i0gan</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'TzNey4n3v0Sx6vdBbytYLoH9-gzGzoHsz'
 , appKey: 'GIXXrK9zLxt0bZLww1hte0Oq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>