<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>2020-03-28 周报 | Hexo</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/demo/"><span class="navItemTitle">独立页面</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>2020-03-28 周报</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-03-28T10:24:21.000Z" id="date"> 2020-03-28</time></div></span><br><span>Last Update: <div class="control"><time datetime="2021-10-28T10:11:33.073Z" id="updated"> 2021-10-28</time></div></span><br><span>Word Count: <div class="control">1.1k</div></span><br><span>Read Time: <div class="control">4 min</div></span></div></div><hr><div id="post-content"><h1 id="2020-03-28-周报"><a href="#2020-03-28-周报" class="headerlink" title="2020-03-28 周报"></a>2020-03-28 周报</h1><h3 id="这周在干什么"><a href="#这周在干什么" class="headerlink" title="这周在干什么?"></a>这周在干什么?</h3><p>百变不离其宗,正在学习heap的各种套路<br>目前先对堆进行一点总结, 也是刚入门.这个星期昨天才开始搞…. <del>_</del>…..可悲可悲….</p>
<h4 id="先说一下各种常见的hook吧-堆中常见"><a href="#先说一下各种常见的hook吧-堆中常见" class="headerlink" title="先说一下各种常见的hook吧 (堆中常见)."></a>先说一下各种常见的hook吧 (堆中常见).</h4><p>__malloc_hook<br>这是一个函数指针变量，指向的是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void * function(size_t size, void * caller) <br></code></pre></td></tr></table></figure>

<p>其中caller是表示在栈中调用malloc的函数的时候的函数地址，%p可以打印出他的地址</p>
<ul>
<li>__free_hook<br>同样这个也是一个函数指针变量，指向的是：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void function(void * ptr, void * caller)<br></code></pre></td></tr></table></figure>

<ul>
<li>__realloc_hook<br>这也是指向一个函数指针变量，指向的是:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void * function(void * ptr ,size_t size, void * caller)<br></code></pre></td></tr></table></figure>

<p>__memalign_hook<br>这个函数是指向的一个函数指针，不过是：<br>aligned_alloc, memalign, posix_memalign and valloc</p>
<p>__malloc_initialize_hook</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void (*__malloc_initialize_hook) (void) = my_init_hook;<br></code></pre></td></tr></table></figure>

<p>是一个弱类型，只是在初始化的时候使用一次</p>
<h4 id="使用原理"><a href="#使用原理" class="headerlink" title="使用原理"></a>使用原理</h4><p>hook函数只是对malloc realloc以及free等函数有一个包装，即每当调用了这些函数后，利用hook函数，可以得到我们想要的结果，比如当前调用的动态分配内存函数的地址，hook变量的值等等,这样在debug的时候，可以知道内存泄漏的地点</p>
<p>言归正传, 所以才会有malloc_hook修改可以实现任意目标函数执行</p>
<h4 id="一般分为以下几种劫持"><a href="#一般分为以下几种劫持" class="headerlink" title="一般分为以下几种劫持"></a>一般分为以下几种劫持</h4><p>got劫持, iofile劫持打OneGadget, hook劫持</p>
<h4 id="怎样获取libc基地址"><a href="#怎样获取libc基地址" class="headerlink" title="怎样获取libc基地址"></a>怎样获取libc基地址</h4><p>若没有dump函数, 可以修改free的got表为puts,然后构造好参数, 实现dump出libc中函数的地址,即可以获取libc基地址.<br>若remove掉时,没有对指针清空, 可以通过对溢出构造fake chunk实现unlink时得到main_arena地址, 计算偏移就可得到libc基地址.</p>
<h4 id="如何实现任意地址修改"><a href="#如何实现任意地址修改" class="headerlink" title="如何实现任意地址修改"></a>如何实现任意地址修改</h4><p>最关键的还是看题中的逻辑漏洞<br>比如 easyheap, babyfenshui 中添加一个item,就会malloc两个堆.就找第一个堆与第二个堆的逻辑漏洞.比如,先创建第一堆,然后再作判断漏洞<br>一般情况下,常用的还是 fastbin attack来实现 write anything anywhere.</p>
<p>上面是小白的我,进行一些基础的总结, 其实远远不止这些, 下面是正在学习的套路术语</p>
<h4 id="Off-by-one"><a href="#Off-by-one" class="headerlink" title="Off by one"></a>Off by one</h4><p>在向缓冲区输入的时,可以越界一个字节可以控制,其利用一根据题中还存在的其他漏洞来判定</p>
<h4 id="House-of-Force"><a href="#House-of-Force" class="headerlink" title="House of Force"></a>House of Force</h4><p>利用堆溢出修改top chunk 大小,一般采用负数来修改到大的值. 计算目标地址与top chunk的地址之差, 然后在malloc的时候设置大小为这个差值,就可以实现 write anythen anywhere.</p>
<p>一方面,需要绕过REQUEST_OUT_RANGE(req)检测, 即传给malloc的值在负数范围内,不得大于-2 * MINSIZE.一般这个情况都是满足的.</p>
<h4 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h4><p>控制 prev_size和prev_inuse字段, 可以将新malloc出来的chunk指向 anywhere</p>
<p>一般情况下, 就可以使用off by one 漏洞覆盖prev_inuse, 通过 fake chunk绕过 unlink检测.</p>
<p>控制prev_size和prev_inuse字段需要满足:chunk_at_offset(p, -((long) prevsize)), 所以直接算目标地址与当前chunk的差值.</p>
<h3 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h3><p>unlink就是将双向链表中的空闲块取出来,然后和目前相邻的 free 掉的chunk进行合并</p>
<p>目前也正在学习, 大概就先说这么多…</p>
<h3 id="这周遇到的问题"><a href="#这周遇到的问题" class="headerlink" title="这周遇到的问题"></a>这周遇到的问题</h3><p>生活琐事: 自己在转转购买东西, 天天催发货, 后面发货发错了,我就要求商家退款,可是商家不退, 我前天就搞一上午的信息搜集,正准备采用这招搞他, 后面还是想想, 若才用这招威胁, 可能一分钱也得不到, 人的心也是肉做的, 采用社工的方式,求个情, 然后后面就退钱了, 被坑400.唉,耽误时间有浪费钱啊.下次不再在转转平台上买东西了.(其实这个东西我后面了解到, 是违反法律的黑产, 违法刑法155条, 损失400块就当作是个教训, 买东西还是到正规的店中去买, 不要贪图便宜)</p>
<p>对于堆利用, 常挂在嘴边说, 就是没有好好做, 反省一下自己, 以后天天搞.向师傅们学习.</p>
<h3 id="下周计划"><a href="#下周计划" class="headerlink" title="下周计划"></a>下周计划</h3><p>把各种套路理清楚, 跟着师傅们的思路走, 整理各种脚本, 方便真正开打的时候直接上脚本,也要学习一下如何批量提交flag脚本.</p>
<p>只要学不死, 就望死里学……下周的我…</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2020/03/28/others/weekly-report/2021-03-08-%E5%91%A8%E6%8A%A5/">← Next 2020-03-28 周报</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/03/25/tools/linux/vim_config/">vim配置 Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/Yue-plus">John Doe</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2020-03-28-%E5%91%A8%E6%8A%A5"><span class="toc-number">1.</span> <span class="toc-text">2020-03-28 周报</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E5%91%A8%E5%9C%A8%E5%B9%B2%E4%BB%80%E4%B9%88"><span class="toc-number">1.0.1.</span> <span class="toc-text">这周在干什么?</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%88%E8%AF%B4%E4%B8%80%E4%B8%8B%E5%90%84%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84hook%E5%90%A7-%E5%A0%86%E4%B8%AD%E5%B8%B8%E8%A7%81"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">先说一下各种常见的hook吧 (堆中常见).</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8E%9F%E7%90%86"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">使用原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%88%AC%E5%88%86%E4%B8%BA%E4%BB%A5%E4%B8%8B%E5%87%A0%E7%A7%8D%E5%8A%AB%E6%8C%81"><span class="toc-number">1.0.1.3.</span> <span class="toc-text">一般分为以下几种劫持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E6%A0%B7%E8%8E%B7%E5%8F%96libc%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">1.0.1.4.</span> <span class="toc-text">怎样获取libc基地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E4%BF%AE%E6%94%B9"><span class="toc-number">1.0.1.5.</span> <span class="toc-text">如何实现任意地址修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Off-by-one"><span class="toc-number">1.0.1.6.</span> <span class="toc-text">Off by one</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Force"><span class="toc-number">1.0.1.7.</span> <span class="toc-text">House of Force</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-Of-Einherjar"><span class="toc-number">1.0.1.8.</span> <span class="toc-text">House Of Einherjar</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Unlink"><span class="toc-number">1.0.2.</span> <span class="toc-text">Unlink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E5%91%A8%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.0.3.</span> <span class="toc-text">这周遇到的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E5%91%A8%E8%AE%A1%E5%88%92"><span class="toc-number">1.0.4.</span> <span class="toc-text">下周计划</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">赣ICP备19008355号</a></nobr><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><br><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'LSe7mf1XYliLqgIrc3jlqXfT-gzGzoHsz'
 , appKey: 'Fu9giJfnidkCamaW89FUpidw' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>