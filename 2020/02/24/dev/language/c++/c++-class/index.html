<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>C++ Class | Hexo</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/demo/"><span class="navItemTitle">独立页面</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>C++ Class</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-02-24T10:52:00.000Z" id="date"> 2020-02-24</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-04-30T14:01:52.090Z" id="updated"> 2022-04-30</time></div></span><br><span>Word Count: <div class="control">1.6k</div></span><br><span>Read Time: <div class="control">8 min</div></span></div></div><hr><div id="post-content"><h1 id="C-析构函数中抛出异常问题"><a href="#C-析构函数中抛出异常问题" class="headerlink" title="C++析构函数中抛出异常问题"></a>C++析构函数中抛出异常问题</h1><p>注意: 不要在析构函数中抛出异常 </p>
<h2 id="析构函数调用规则"><a href="#析构函数调用规则" class="headerlink" title="析构函数调用规则"></a>析构函数调用规则</h2><ol>
<li>先调用成员析构</li>
<li>再调用派生类析构</li>
</ol>
<h2 id="问题代码"><a href="#问题代码" class="headerlink" title="问题代码"></a>问题代码</h2><p>分析代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-built_in">A</span>() &#123;&#125;<br>		~<span class="hljs-built_in">A</span>() &#123; std::cout &lt;&lt; <span class="hljs-string">&quot;A析构了..&quot;</span> &lt;&lt; std::endl; &#125;<br>&#125;;<br><span class="hljs-comment">//析构函数绝对不要抛出异常</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A&#123;<br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-built_in">B</span>() &#123;&#125;<br>		~<span class="hljs-built_in">B</span>() &#123; std::cout &lt;&lt; <span class="hljs-string">&quot;B析构了.. &quot;</span> &lt;&lt; std::endl; <br>		<span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;B error&quot;</span>); &#125; <span class="hljs-comment">// 编译器默认析构函数: inline ~B() noexcept &#123;&#125;</span><br>	<span class="hljs-comment">//编译器默认析构函数实现:</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">		inline ~B() noexcept &#123;</span><br><span class="hljs-comment">			try &#123;</span><br><span class="hljs-comment">			</span><br><span class="hljs-comment">			&#125; catch(...) &#123;</span><br><span class="hljs-comment">				std::terminate();	</span><br><span class="hljs-comment">				//析构函数绝对不要抛出异常</span><br><span class="hljs-comment">			&#125;</span><br><span class="hljs-comment">		&#125; </span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">private</span>:<br>		std::string m_value;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">			在掉~B() 析构时候, 先调用 m_value的析构,再调用派生类 ~A();</span><br><span class="hljs-comment">		 */</span><br>&#125;;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">testClass_1</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">//测试析构</span><br>	B *b = <span class="hljs-keyword">new</span> B;<br>	<span class="hljs-keyword">delete</span> b;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilB</span> : <span class="hljs-keyword">public</span> B &#123;<br>	<span class="hljs-keyword">public</span>:<br>		~<span class="hljs-built_in">EvilB</span>() <span class="hljs-built_in">noexcept</span>(<span class="hljs-literal">false</span>) &#123; <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;error&quot;</span>); &#125;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">testEvilB</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">try</span> &#123;<br>		EvilB *b = <span class="hljs-keyword">new</span> <span class="hljs-built_in">EvilB</span>();	<br>		<span class="hljs-keyword">delete</span> b;<br>		<br>	&#125; <span class="hljs-built_in">catch</span>(std::string e) &#123;<br>		<span class="hljs-comment">//没有捕获到异常,编译器已经调用std::terminate(),且程序崩溃</span><br>		<span class="hljs-comment">//因为编译器为析构函数默认加入关键字 noexcept,可以加入关键字 noexcept(false) </span><br>		<span class="hljs-comment">//问题1 : 派生类虽然能够析构,若派生类析构函数也抛出异常,则程序就挂.</span><br>		<span class="hljs-comment">//出现抛出两个异常, 则无法捕获.</span><br>		<span class="hljs-comment">//问题2 : 若声明两次EvilB对象,析构两次时,则程序就会崩溃.</span><br>		std::cout &lt;&lt; <span class="hljs-string">&quot;catch your evil: &quot;</span> &lt;&lt; e &lt;&lt;  std::endl;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br>	<span class="hljs-built_in">testEvilB</span>();<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="正确做法"><a href="#正确做法" class="headerlink" title="正确做法"></a>正确做法</h2><p>建议: 在类的构造函数中抛出异常 </p>
<p>代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cassert&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-built_in">A</span>() &#123;&#125;<br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A &#123;<br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-built_in">B</span>() &#123;&#125;<br>		~<span class="hljs-built_in">B</span>() &#123; <span class="hljs-comment">/*std::cout &lt;&lt; &quot;byebye B\n&quot;;*/</span> &#125;<br>	<span class="hljs-keyword">private</span>:<br>		std::string m_value;<br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodB</span> : <span class="hljs-keyword">public</span> B &#123;<br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-built_in">GoodB</span>() : <span class="hljs-built_in">m_v</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">char</span>(<span class="hljs-number">10000000</span>)) &#123;&#125;<br>		<span class="hljs-built_in">GoodB</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* f) : <span class="hljs-built_in">m_file</span>(f, std::ios_base::in) &#123;<br>			<span class="hljs-comment">//在构造器里进行抛出异常,而不是一直判断是否有错误来避免错误.</span><br>			<span class="hljs-keyword">if</span>(!m_file.<span class="hljs-built_in">is_open</span>()) <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;Couldn&#x27;t open file..\n&quot;</span>);<br><br>			std::string line;	<br>			<span class="hljs-keyword">while</span>(std::<span class="hljs-built_in">getline</span>(m_file, line)) &#123;<br>				m_info.<span class="hljs-built_in">push_back</span>(line);<br>			&#125;<br>		&#125;<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">doIt</span><span class="hljs-params">( GoodB <span class="hljs-type">const</span>&amp;b)</span> </span>&#123;<br>			<span class="hljs-keyword">if</span>(b.<span class="hljs-built_in">isOpen</span>()) &#123;<br>				<span class="hljs-comment">//do	</span><br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">//通过析构来提示.</span><br>		~<span class="hljs-built_in">GoodB</span>() &#123; <span class="hljs-built_in">assert</span>((!<span class="hljs-built_in">isOpen</span>()) &amp;&amp; <span class="hljs-string">&quot;open file: &quot;</span>); &#125;<br>	<span class="hljs-keyword">private</span>:<br>		<span class="hljs-type">char</span> *m_v;<br>		std::fstream m_file; <span class="hljs-comment">//外部文件 </span><br>		std::vector&lt;std::string&gt; m_info;<br>		<span class="hljs-comment">//若作为状态判断,一般声明为私有函数, 通过assert来提示.</span><br>		<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isOpen</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> !m_info.<span class="hljs-built_in">empty</span>(); &#125;<br>&#125;;<br><span class="hljs-comment">//循环构造, 内存崩溃</span><br><span class="hljs-comment">//想实现一个 std::out_of_memory 异常</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(;;) &#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			++i;	<br>			<span class="hljs-keyword">if</span>(i % <span class="hljs-number">10000</span> == <span class="hljs-number">0</span>) std::cout &lt;&lt; <span class="hljs-string">&quot;count i: &quot;</span> &lt;&lt; i &lt;&lt; std::endl;<br>			GoodB b;	<br>		&#125; <span class="hljs-built_in">catch</span>(...) &#123;<br>			<span class="hljs-keyword">return</span> ;	<br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test2</span><span class="hljs-params">(<span class="hljs-type">char</span> *filename)</span> </span>&#123;<br>	<span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//在构造时候进行抛出异常,重复抛出, 不会出现问题, 而在析构函数中抛出,程序则会崩溃</span><br>		<span class="hljs-function">GoodB <span class="hljs-title">b</span><span class="hljs-params">(filename)</span></span>;<br>		<span class="hljs-function">GoodB <span class="hljs-title">d</span><span class="hljs-params">(filename)</span></span>;<br>		b.<span class="hljs-built_in">doIt</span>(b);<br>		<span class="hljs-comment">//std::swap(b, d) //也不要抛出异常</span><br>	&#125; <span class="hljs-built_in">catch</span>(std::string msg) &#123;<br>		std::cout &lt;&lt; msg;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span>(argc &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-comment">//	test();</span><br>	<span class="hljs-built_in">test2</span>(argv[<span class="hljs-number">1</span>]);<br>	std::cout &lt;&lt; <span class="hljs-string">&quot;exit!!!\n&quot;</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="c-管理内存的几种方式"><a href="#c-管理内存的几种方式" class="headerlink" title="c++管理内存的几种方式"></a>c++管理内存的几种方式</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">versionOne</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">versionTwo</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br><br>	<span class="hljs-built_in">versionOne</span>();<br>	<span class="hljs-built_in">versionTwo</span>();<br>	<span class="hljs-built_in">versionThree</span>();<br>	<span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">versionOne</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-comment">//c语言方式开辟内存</span><br>	<span class="hljs-type">int</span> *ageC = (<span class="hljs-type">int</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>));<br>	<span class="hljs-keyword">if</span>(argC) &#123;<br>		<span class="hljs-built_in">free</span>(ageC);<br>	&#125;<br>	<span class="hljs-type">char</span> *c = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br>	<span class="hljs-built_in">free</span>(c);<br><br>	<span class="hljs-comment">//c++ 开辟内存方式</span><br>	<span class="hljs-type">int</span> *age = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">25</span>);<br>	<span class="hljs-type">int</span> *height = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">160</span>);<br>	<span class="hljs-comment">//缺陷,容易忘掉free 或 delete</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">versionTow</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-comment">//智能指针</span><br>	<span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">age</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>(<span class="hljs-number">28</span>))</span></span>;<br>	<span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">height</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>(<span class="hljs-number">160</span>))</span></span>;<br><br>	std::cout &lt;&lt; <span class="hljs-string">&quot;VersionTwo: you age is &quot;</span> &lt;&lt; *age &lt;&lt; <span class="hljs-string">&quot;, and your height is &quot;</span><br>		&lt;&lt; *height &lt;&lt; std::endl;<br>	<span class="hljs-comment">//不需要做任何事情, 内存会自动的释放掉</span><br>	<span class="hljs-comment">//基本上,不会造成内存泄露问题</span><br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="C-逐渐退化的虚函数"><a href="#C-逐渐退化的虚函数" class="headerlink" title="C++逐渐退化的虚函数"></a>C++逐渐退化的虚函数</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;map&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">	类虚函数遇到构造和析构就退化了</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Event</span>; <span class="hljs-comment">//类的前置声明</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Event</span> &#123;&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> &#123;<br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base</span>() &#123;&#125; <span class="hljs-comment">//why? virtual</span><br>		<span class="hljs-built_in">Base</span>(<span class="hljs-type">int</span> _id) : <span class="hljs-built_in">m_id</span>(_id) &#123;&#125;<br>		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">act</span><span class="hljs-params">(Event <span class="hljs-type">const</span>&amp;)</span> </span>= <span class="hljs-number">0</span>;<br>		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;<br>		<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">id</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> m_id; &#125; <br>	<span class="hljs-keyword">private</span>:<br>		<span class="hljs-type">int</span> m_id;<br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Drived</span> : <span class="hljs-keyword">public</span> Base &#123; <span class="hljs-comment">//why public?</span><br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">act</span> <span class="hljs-params">(Event <span class="hljs-type">const</span>&amp;)</span></span>;<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br>		<span class="hljs-built_in">Drived</span>(<span class="hljs-type">int</span> id);<br>		~<span class="hljs-built_in">Drived</span>();<br>	<span class="hljs-keyword">private</span>:<br><br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Grouped</span> : <span class="hljs-keyword">public</span> Base &#123;<br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">act</span><span class="hljs-params">(Event <span class="hljs-type">const</span>&amp;)</span></span>;<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addBase</span><span class="hljs-params">(Base* b)</span></span>;<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">removeBase</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span>;<br>		<span class="hljs-built_in">Grouped</span>(<span class="hljs-type">int</span> id);<br>		~<span class="hljs-built_in">Grouped</span>();<br>	<span class="hljs-keyword">private</span>:<br>		std::map&lt;<span class="hljs-type">int</span>, Base *&gt; m_info;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-comment">//int a = 1;</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	Drived *info = new Drived(1);	</span><br><span class="hljs-comment">	Grouped *group = new Grouped();</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	group-&gt;print();</span><br><span class="hljs-comment">	group-&gt;act(ev);</span><br><span class="hljs-comment">	group-&gt;addBase(info);</span><br><span class="hljs-comment">	group-&gt;removeBase(info-&gt;id());</span><br><span class="hljs-comment">	group-&gt;id();</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	Base *baseGroup = group;</span><br><span class="hljs-comment">	baseGroup-&gt;act(ev);</span><br><span class="hljs-comment">	baseGroup-&gt;print();</span><br><span class="hljs-comment">	baseGroup-&gt;id();</span><br><span class="hljs-comment">	//removeBase()</span><br><span class="hljs-comment">	//addBase()</span><br><span class="hljs-comment">	//而基类的指针baseGroup中强制把派生类转换,而基类在虚函数中干的事,与派生类的一样</span><br><span class="hljs-comment">	//相当于派生类来实现函数,而不是基类.这就实现了指针对接口进行编程.</span><br><span class="hljs-comment">	delete group; //delete baseGroup;没有内存泄露,　与delete group等价</span><br><span class="hljs-comment">	delete info;</span><br><span class="hljs-comment">	*/</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br>	<span class="hljs-built_in">test</span>();<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="C-虚函数几种实现方法"><a href="#C-虚函数几种实现方法" class="headerlink" title="C++虚函数几种实现方法"></a>C++虚函数几种实现方法</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Base</span> &#123;<br>	<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;base&quot;</span> &lt;&lt; std::endl; &#125;<br>	<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;&#125;<br>	<span class="hljs-built_in">Base</span>() &#123;<br>		<span class="hljs-built_in">init</span>();	<br>	&#125;<br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Derived</span> : Base &#123; <span class="hljs-comment">//结构体默认为public 继承, 类默认为 private</span><br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-comment">//加入override关键字,表示重写基类的f()虚函数</span><br>		std::cout &lt;&lt; <span class="hljs-string">&quot;derived overide&quot;</span> &lt;&lt; std::endl;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;virtual init&quot;</span> &lt;&lt; std::endl; &#125;<br>&#125; ;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Derived2</span> : Derived &#123;<br>	<span class="hljs-keyword">public</span>:<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123;&#125;<br>		<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;&#125;<br>&#125;;<br><br><span class="hljs-function">Base* <span class="hljs-title">factoryBase</span><span class="hljs-params">(<span class="hljs-type">int</span> type)</span> </span>&#123;<br>	Base* ret = <span class="hljs-literal">nullptr</span>;<br>	<span class="hljs-keyword">if</span>(type == <span class="hljs-number">0</span>) &#123;<br>		ret = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Base</span>();	<br>	&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type == <span class="hljs-number">1</span>) &#123;<br>		ret = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();	<br>	&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type == <span class="hljs-number">2</span>) &#123;<br>		ret = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived2</span>();	<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(ret) ret-&gt;<span class="hljs-built_in">init</span>();<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">testVirtual</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-comment">//Base b;</span><br>	<span class="hljs-comment">//Derived d;</span><br>	<span class="hljs-comment">////虚函数调用通过引用</span><br>	<span class="hljs-comment">////virtual funciton call through reference</span><br>	<span class="hljs-comment">//Base&amp; br = b;  //the type of br is Base&amp;</span><br>	<span class="hljs-comment">//Base&amp; dr = d;  //the type of dr is Base&amp; as well</span><br>	<span class="hljs-comment">//br.f();</span><br>	<span class="hljs-comment">//dr.f(); //在Derived类中已经对fun() 重写.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">////虚函数调用通过指针</span><br>	<span class="hljs-comment">////virtual function call through pointer</span><br>	<span class="hljs-comment">//Base* bp = &amp;b;</span><br>	<span class="hljs-comment">//Base* dp = &amp;d;</span><br>	<span class="hljs-comment">//bp-&gt;f();</span><br>	<span class="hljs-comment">//dp-&gt;f();</span><br><br>	<span class="hljs-comment">////直接调用.</span><br>	<span class="hljs-comment">////non-virtual function call</span><br>	<span class="hljs-comment">//b.Base::f();</span><br>	<span class="hljs-comment">//d.Derived::f(); //派生类</span><br>	<span class="hljs-comment">//d.Base::f(); //基类</span><br>	<span class="hljs-comment">////若在构造函数中或者析构函数中调用虚函数, 则会调用自身类中的虚函数,而不是派生类的重写的虚函数</span><br>	<span class="hljs-comment">////虚函数特性还没体现</span><br>	Derived d;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br>	<span class="hljs-built_in">testVirtual</span>();<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2020/02/24/dev/language/c++/c++-smart-pointer/">← Next C++ Smart Pointer</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/02/24/dev/language/c++/c++-stl/">C++ STL Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/Yue-plus">John Doe</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#C-%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0%E4%B8%AD%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">C++析构函数中抛出异常问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%A7%84%E5%88%99"><span class="toc-number">1.1.</span> <span class="toc-text">析构函数调用规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.</span> <span class="toc-text">问题代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E5%81%9A%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">正确做法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#c-%E7%AE%A1%E7%90%86%E5%86%85%E5%AD%98%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">c++管理内存的几种方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-%E9%80%90%E6%B8%90%E9%80%80%E5%8C%96%E7%9A%84%E8%99%9A%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">C++逐渐退化的虚函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-%E8%99%9A%E5%87%BD%E6%95%B0%E5%87%A0%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">C++虚函数几种实现方法</span></a></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">赣ICP备19008355号</a></nobr><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><br><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'LSe7mf1XYliLqgIrc3jlqXfT-gzGzoHsz'
 , appKey: 'Fu9giJfnidkCamaW89FUpidw' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>