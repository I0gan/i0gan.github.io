<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>c网络编程 | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":"search.json"}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(/img/bg.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>c网络编程</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-02-10T11:15:09.000Z" id="date"> 2020-02-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-10-27T06:39:25.067Z" id="updated"> 2022-10-27</time></div></span><br><span>Word Count: <div class="control">1.1k</div></span><br><span>Read Time: <div class="control">6 min</div></span></div></div><hr><div id="post-content"><h1 id="C-Network-programing"><a href="#C-Network-programing" class="headerlink" title="C Network programing"></a>C Network programing</h1><h2 id="字节序"><a href="#字节序" class="headerlink" title="字节序"></a>字节序</h2><p>验证当前电脑是大端还是小端。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">byteorder</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-type">short</span> value;<br>		<span class="hljs-type">char</span> union_bytes[<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">short</span>)];<br>	&#125; test;<br>	test.value = <span class="hljs-number">0x0102</span>;<br>	<span class="hljs-keyword">if</span>((<span class="hljs-number">1</span> == test.union_bytes[<span class="hljs-number">0</span>]) &amp;&amp; (<span class="hljs-number">2</span> == test.union_bytes[<span class="hljs-number">1</span>])) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;big endian\n&quot;</span>);<br>	&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((<span class="hljs-number">2</span> == test.union_bytes[<span class="hljs-number">0</span>]) &amp;&amp; (<span class="hljs-number">1</span> == test.union_bytes[<span class="hljs-number">1</span>])) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;little endian\n&quot;</span>);<br>	&#125;<span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unknown\n&quot;</span>);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>	byteorder();<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="测试listen函数"><a href="#测试listen函数" class="headerlink" title="测试listen函数"></a>测试listen函数</h2><p>server.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">bool</span> stop = <span class="hljs-literal">false</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">handle_term</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span> &#123;<br>	stop = <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> &#123;<br>	signal(SIGTERM, handle_term);<br>	<span class="hljs-keyword">if</span>(argc &lt;= <span class="hljs-number">3</span>) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Usage: %s ip_address port_number backlog\n&quot;</span>, basename(argv[<span class="hljs-number">0</span>]));<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	&#125;<br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *ip = argv[<span class="hljs-number">1</span>];<br>	<span class="hljs-type">int</span> port = atoi(argv[<span class="hljs-number">2</span>]);<br>	<span class="hljs-type">int</span> backlog = atoi(argv[<span class="hljs-number">3</span>]);<br><br>	<span class="hljs-type">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>	assert(sock &gt;= <span class="hljs-number">0</span>);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">address</span>;</span><br>	bzero(&amp;address, <span class="hljs-keyword">sizeof</span>(address)); <span class="hljs-comment">//清空为0</span><br>	address.sin_family = AF_INET;<br><br>	<span class="hljs-comment">//inet_pton是一个IP地址转换函数,</span><br>	<span class="hljs-comment">//可以在将IP地址在“点分十进制”和“二进制整数”之间转换</span><br>	<span class="hljs-comment">//而且inet_pton和inet_ntop这2个函数能够处理ipv4和ipv6</span><br>	<br>	inet_pton(AF_INET, ip,  &amp;address.sin_addr);<br>	address.sin_port = htons(port); <span class="hljs-comment">//转化为网络字节序</span><br><br>	<span class="hljs-comment">//绑定</span><br>	<span class="hljs-type">int</span> ret = bind(sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;address, <span class="hljs-keyword">sizeof</span>(address));<br>	assert(<span class="hljs-number">-1</span> != ret);<br><br>	ret = listen(sock, backlog);<br>	assert(<span class="hljs-number">-1</span> != ret);<br><br>	<span class="hljs-comment">//通过系统发送信号来终止程序</span><br>	<span class="hljs-keyword">while</span>(!stop) &#123;<br>		sleep(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	close(sock);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;End program\n&quot;</span>);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="获取客户端基本信息"><a href="#获取客户端基本信息" class="headerlink" title="获取客户端基本信息"></a>获取客户端基本信息</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> &#123;<br>	<span class="hljs-keyword">if</span>(argc &lt;= <span class="hljs-number">2</span>) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Usage: %s [ip] [port]\n&quot;</span>, basename(argv[<span class="hljs-number">0</span>]));<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	&#125;<br><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *ip = argv[<span class="hljs-number">1</span>];<br>	<span class="hljs-type">int</span> port = atoi(argv[<span class="hljs-number">2</span>]);<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">address</span>;</span><br>	bzero(&amp;address, <span class="hljs-keyword">sizeof</span>(address));<br><br>	address.sin_family = AF_INET;<br>	inet_pton(AF_INET, ip, &amp;address.sin_addr);<br>	address.sin_port = htons(port);<br><br>	<span class="hljs-type">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>	assert(sock &gt;= <span class="hljs-number">0</span>);<br><br>	<span class="hljs-type">int</span> ret = bind(sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;address, <span class="hljs-keyword">sizeof</span>(address));<br>	<span class="hljs-keyword">if</span>(<span class="hljs-number">-1</span> == ret) &#123;<br>		perror(<span class="hljs-string">&quot;bind&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	&#125;<br><br>	ret = listen(sock, <span class="hljs-number">5</span>);<br>	assert(ret != <span class="hljs-number">-1</span>);<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client_addr</span>;</span><br>	<span class="hljs-type">socklen_t</span> client_addr_len = <span class="hljs-keyword">sizeof</span>(client_addr);<br>	<span class="hljs-type">int</span> c_fd = accept(sock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;client_addr, &amp;client_addr_len);<br>	<span class="hljs-keyword">if</span>(c_fd == <span class="hljs-number">-1</span>) &#123;<br>		perror(<span class="hljs-string">&quot;accept::&quot;</span>);<br>	&#125;<span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-type">char</span> remote[INET_ADDRSTRLEN];<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;connected with ip: %s and port %d\n&quot;</span>,<br>		inet_ntop(AF_INET, &amp;client_addr.sin_addr, remote, INET_ADDRSTRLEN),<br>		ntohs(client_addr.sin_port));<br><br>		close(c_fd);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="Echo-Server例子"><a href="#Echo-Server例子" class="headerlink" title="Echo Server例子"></a>Echo Server例子</h2><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>client.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVER_PORT 6666</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVER_IP <span class="hljs-string">&quot;127.0.0.1&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> </span>&#123;<br>	<span class="hljs-type">int</span> sockfd;<br>	<span class="hljs-type">int</span> n;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_in</span> serveraddr;<br>	<span class="hljs-type">char</span> str[<span class="hljs-number">256</span>] = <span class="hljs-string">&quot;Hello You guys\n&quot;</span>;<br>	<span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">2</span>) &#123;<br>		cout &lt;&lt; <span class="hljs-string">&quot;Usage: ./clinet [message]&quot;</span> &lt;&lt; endl;	<br>		<span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;Input error! \n&quot;</span>, stderr);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br><br>	sockfd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">memset</span>(&amp;serveraddr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in));<br>	serveraddr.sin_family = AF_INET;<br><br>	<span class="hljs-built_in">inet_pton</span>(AF_INET, SERVER_IP, &amp;serveraddr.sin_addr);<br>	serveraddr.sin_port = <span class="hljs-built_in">htons</span>(SERVER_PORT); <span class="hljs-comment">//转化为网络字节顺序</span><br>	<br>	<span class="hljs-built_in">connect</span>(sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;serveraddr, <span class="hljs-built_in">sizeof</span>(serveraddr));<br>	<span class="hljs-built_in">write</span>(sockfd, argv[<span class="hljs-number">1</span>], <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]));<br>	n = <span class="hljs-built_in">read</span>(sockfd, str, <span class="hljs-built_in">sizeof</span>(str) - <span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">if</span>(n &gt; <span class="hljs-number">0</span>) &#123;<br>		str[n] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>		cout &lt;&lt; str;<br>	&#125;<span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;error&quot;</span>);<br>	&#125;	<br><br>	cout &lt;&lt; endl &lt;&lt; <span class="hljs-string">&quot;finished&quot;</span> &lt;&lt; endl;<br>	<span class="hljs-built_in">close</span>(sockfd);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERVER_PORT 6666</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>	<span class="hljs-type">int</span> sock;  <span class="hljs-comment">//信箱</span><br>	<span class="hljs-comment">//AF_INET表示使用网络地址, SOCK_STREAM表示使用TCP协议</span><br>	sock = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">server_addr</span>;</span> <span class="hljs-comment">//这个结构体,头文件中已经声明</span><br>	<span class="hljs-comment">//清空标签</span><br>	bzero(&amp;server_addr, <span class="hljs-keyword">sizeof</span>(server_addr));<br>	<span class="hljs-comment">//设置协议家族为网络协议	</span><br>	<span class="hljs-comment">//htonl = host to net ,选择协议族为ipv4,</span><br>	server_addr.sin_family = AF_INET;<br>	<span class="hljs-comment">//监听本地所有地址</span><br>	server_addr.sin_addr.s_addr = htonl(INADDR_ANY);<br>	server_addr.sin_port = htons(SERVER_PORT); <span class="hljs-comment">//绑定端口号</span><br>	<span class="hljs-comment">//实现标签贴到信箱上</span><br>	bind(sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;server_addr, <span class="hljs-keyword">sizeof</span>(server_addr));<br><br>	listen(sock, <span class="hljs-number">128</span>); <span class="hljs-comment">//同时的连接数量,同时来的信件接受多少封,这里为128</span><br>	<br>	<span class="hljs-comment">//万事俱备,只等来信.</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;等待客户连接...\n&quot;</span>);<br><br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client</span>;</span><br>		<span class="hljs-type">int</span> client_sock ; <span class="hljs-comment">//客户端</span><br>		<span class="hljs-type">char</span> client_ip[<span class="hljs-number">64</span>];<br>		<span class="hljs-type">char</span> buf[<span class="hljs-number">256</span>];<br>		<span class="hljs-type">int</span> buf_len;<br>		<span class="hljs-type">socklen_t</span> client_addr_len = <span class="hljs-keyword">sizeof</span>(client);<br><br>		 client_sock = accept(sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;client, &amp;client_addr_len);<br>		<span class="hljs-comment">//打印客户端地址和端口号	</span><br>		<span class="hljs-comment">//转化网络字节序</span><br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;client ip: %s\n port: %d\n&quot;</span>, <br>		inet_ntop(AF_INET, &amp;client.sin_addr.s_addr, client_ip, <span class="hljs-keyword">sizeof</span>(client_ip)),<br>		ntohs(client.sin_port));<br>		<br>		<span class="hljs-comment">//读取数据</span><br>		buf_len = read(client_sock, buf, <span class="hljs-keyword">sizeof</span>(buf) - <span class="hljs-number">1</span>);<br>		buf[buf_len] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;接受到消息: %s\n&quot;</span>, buf);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; buf_len; i++) &#123;<br>				buf[i] = <span class="hljs-built_in">toupper</span>(buf[i]);<br>		&#125;	<br>		write(client_sock, buf, <span class="hljs-built_in">strlen</span>(buf));<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;write[%s] finished!!!\n&quot;</span>, buf);<br><br>		close(client_sock);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2020/02/15/env/linux/myarch/backup_and_recover/">← Next Linux系统备份以及恢复</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/02/07/life/weekly/2021-02-07-%E5%91%A8%E6%8A%A5/">2020-02-07 周报 Prev →</a></div></div></div><details id="reward"><summary>打赏点小钱</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="/images/header.jpg" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#C-Network-programing"><span class="toc-text">C Network programing</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E5%BA%8F"><span class="toc-text">字节序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95listen%E5%87%BD%E6%95%B0"><span class="toc-text">测试listen函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-text">获取客户端基本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Echo-Server%E4%BE%8B%E5%AD%90"><span class="toc-text">Echo Server例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">服务端</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">2022 by i0gan</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'TzNey4n3v0Sx6vdBbytYLoH9-gzGzoHsz'
 , appKey: 'GIXXrK9zLxt0bZLww1hte0Oq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>