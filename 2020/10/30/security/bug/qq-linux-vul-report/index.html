<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>linux qq 崩溃调试分析 | Hexo</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/demo/"><span class="navItemTitle">独立页面</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>linux qq 崩溃调试分析</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-10-29T16:53:19.000Z" id="date"> 2020-10-30</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-05-01T14:37:52.538Z" id="updated"> 2022-05-01</time></div></span><br><span>Word Count: <div class="control">5.7k</div></span><br><span>Read Time: <div class="control">29 min</div></span></div></div><hr><div id="post-content"><h1 id="linux-qq-崩溃调试分析"><a href="#linux-qq-崩溃调试分析" class="headerlink" title="linux qq 崩溃调试分析"></a>linux qq 崩溃调试分析</h1><h2 id="QQ调试报告"><a href="#QQ调试报告" class="headerlink" title="QQ调试报告"></a>QQ调试报告</h2><h3 id="调试者"><a href="#调试者" class="headerlink" title="调试者"></a>调试者</h3><p>I0gan</p>
<p>blog: <a target="_blank" rel="noopener" href="http://i0gan.cn/">http://i0gan.cn</a></p>
<p>github: <a target="_blank" rel="noopener" href="https://github.com/i0gan">https://github.com/i0gan</a></p>
<h3 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">┌[logan☮arch]-(/usr/bin)<br>└&gt; checksec qq<br>[!] Unknown configuration section &#x27;update&#x27;<br>[*] &#x27;/usr/bin/qq&#x27;<br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br>    FORTIFY:  Enabled<br></code></pre></td></tr></table></figure>



<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>qq在登录之后在拉去消息和好友列表时出现段错误, 在反映比较慢的电脑上出现几率比较小, 在反映过快的电脑中, 每次基本都直接崩溃.</p>
<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>2.0.0</p>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>多线程条件竞争, 导致对象释放重利用, 然而在调用该函数指针时, 会出现内存地址非法调用</p>
<p>证实: 调试时, 在登录之后, 只运行主线程, 阻断其他线程运行, 能够成功保证登录之后不会崩溃, 只是接受不了消息</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>由于代码量比较大, 时间性的原因, 只能先暂时提供一下调试信息, 后期会不断更新调试结果, 找出对于的具体漏洞所在</p>
<h3 id="触发段错误漏洞代码块偏移"><a href="#触发段错误漏洞代码块偏移" class="headerlink" title="触发段错误漏洞代码块偏移"></a>触发段错误漏洞代码块偏移</h3><p>0xbfdfa0     (vul 1)</p>
<p>0xCCB500   (vul 2)</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>收到系统信号: sigsegv</p>
<h3 id="线程信息"><a href="#线程信息" class="headerlink" title="线程信息:"></a>线程信息:</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">pwndbg&gt; info threads<br>  Id   Target Id                                          Frame <br>  1    Thread 0x7ffff6964940 (LWP 6251) &quot;qq&quot;              0x00007ffff7ce49e5 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0<br>  2    Thread 0x7ffff6963640 (LWP 6258) &quot;qq&quot;              0x00007ffff7e376a2 in pthread_cond_wait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0<br>  3    Thread 0x7ffff6162640 (LWP 6259) &quot;ThreadPoolServi&quot; 0x00007ffff70485de in epoll_wait () from /usr/lib/libc.so.6<br>  5    Thread 0x7ffff5160640 (LWP 6261) &quot;Qnox_LogicThrea&quot; 0x00007ffff70485de in epoll_wait () from /usr/lib/libc.so.6<br>  6    Thread 0x7ffff495f640 (LWP 6262) &quot;Qnox_IOThread&quot;   0x00007ffff70485de in epoll_wait () from /usr/lib/libc.so.6<br>  7    Thread 0x7ffff415e640 (LWP 6263) &quot;ThreadPoolForeg&quot; 0x00007ffff7e379c8 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0<br>  10   Thread 0x7ffff215a640 (LWP 6267) &quot;inotify_reader&quot;  0x00007ffff703fb7b in select () from /usr/lib/libc.so.6<br>  14   Thread 0x7ffff094f640 (LWP 6270) &quot;qq&quot;              0x00007ffff7e376a2 in pthread_cond_wait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0<br>  16   Thread 0x7ffff1158640 (LWP 6290) &quot;ThreadPoolForeg&quot; 0x0000555555ff85a0 in ?? ()<br>  17   Thread 0x7ffff1959640 (LWP 6291) &quot;ThreadPoolForeg&quot; 0x00007ffff7e379c8 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0<br>  18   Thread 0x7ffff295b640 (LWP 6292) &quot;ThreadPoolForeg&quot; 0x00007ffff7e379c8 in pthread_cond_timedwait@@GLIBC_2.3.2 () from /usr/lib/libpthread.so.0<br>  19   Thread 0x7ffff315c640 (LWP 6293) &quot;ThreadPoolForeg&quot; 0x0000555556000aa0 in ?? ()<br>  20   Thread 0x7ffff395d640 (LWP 6294) &quot;gmain&quot;           0x00007ffff703d46f in poll () from /usr/lib/libc.so.6<br>  21   Thread 0x7fffee64f640 (LWP 6295) &quot;pool-qq&quot;         0x00007ffff7042d5d in syscall () from /usr/lib/libc.so.6<br>* 22   Thread 0x7fffede4e640 (LWP 6296) &quot;gdbus&quot;           0x00007ffff7ce49e5 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0<br></code></pre></td></tr></table></figure>



<h3 id="段错误"><a href="#段错误" class="headerlink" title="段错误"></a>段错误</h3><p>主线程段错误信号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Thread 1 &quot;qq&quot; received signal SIGSEGV, Segmentation fault.<br>0x00007ffff7ce49e5 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0<br></code></pre></td></tr></table></figure>

<p>调试如下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs text">────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────<br> RAX  0x0<br> RBX  0x7ffff7000000 (____wcstof128_l_internal+1168) ◂— adc    eax, 0x748b0000<br> RCX  0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */<br> RDX  0x7ffff7e450a0 (__pthread_keys) ◂— 0x1<br> RDI  0x134a77fdde60 ◂— 0xffffecb700000002<br> RSI  0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]<br> R8   0x134a7710b520 ◂— 0x0<br> R9   0x7fffffffd880 ◂— 0x3000000028 /* &#x27;(&#x27; */<br> R10  0x7ffff7fca080<br> R11  0x286<br> R12  0x1<br> R13  0x134a77743890 ◂— 0x0<br> R14  0x134a77109dc0 ◂— 0x0<br> R15  0x0<br> RBP  0x134a774f4bd0 —▸ 0x134a77fdde60 ◂— 0xffffecb700000002<br> RSP  0x7fffffffd970 —▸ 0x134a77fdde60 ◂— 0xffffecb700000002<br> RIP  0x7ffff7ce49e5 (g_main_context_dispatch+581) ◂— call   qword ptr [rbx + 8]<br>──────────────────────────────────────────[ DISASM ]──────────────────────────────────────────<br> ► 0x7ffff7ce49e5 &lt;g_main_context_dispatch+581&gt;    call   qword ptr [rbx + 8]<br>        rdi: 0x134a77fdde60 ◂— 0xffffecb700000002<br>        rsi: 0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]<br>        rdx: 0x7ffff7e450a0 (__pthread_keys) ◂— 0x1<br>        rcx: 0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */<br><br></code></pre></td></tr></table></figure>

<p>rbx + 8内存</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">pwndbg&gt; x /40gx $rbx + 8<br>0x7ffff7000008 &lt;____wcstof128_l_internal+1176&gt;: 0x2444c74820245c89      0x0ff6850000000058<br>0x7ffff7000018 &lt;____wcstof128_l_internal+1192&gt;: 0xef894c00001c968e      0x448d4c58244c8d48<br>0x7ffff7000028 &lt;____wcstof128_l_internal+1208&gt;: 0xf90ee8ea89485024      0x8b44ff438d48ffff<br>0x7ffff7000038 &lt;____wcstof128_l_internal+1224&gt;: 0xdcacbd0f4c20245c      0x2444894800001b58<br>0x7ffff7000048 &lt;____wcstof128_l_internal+1240&gt;: 0xed85453ff5834918      0x8b48000012c4850f<br>0x7ffff7000058 &lt;____wcstof128_l_internal+1256&gt;: 0x48240c6348582454      0x01fb834850244c89<br></code></pre></td></tr></table></figure>

<p>然而 call   qword ptr [rbx + 8]这条指令就相当于: call 0x2444c74820245c89, 这个地址是非法地址,所以出现段错误</p>
<h3 id="正常情况调试"><a href="#正常情况调试" class="headerlink" title="正常情况调试"></a>正常情况调试</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs text">────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────<br> RAX  0x0<br> RBX  0x7ffff7dc33a0 —▸ 0x7ffff7cdf140 ◂— lock add dword ptr [rdi], 1<br> RCX  0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */<br> RDX  0x7ffff7e450a0 (__pthread_keys) ◂— 0x1<br> RDI  0x1392c57a14a0 ◂— 0xffffec6f00000002<br> RSI  0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]<br> R8   0x1392c57a1520 ◂— 0x0<br> R9   0x7fffffffd880 ◂— 0x3000000028 /* &#x27;(&#x27; */<br> R10  0x7ffff7fca080<br> R11  0x286<br> R12  0x1<br> R13  0x1392c5ddb900 ◂— 0x0<br> R14  0x1392c579fdc0 ◂— 0x0<br> R15  0x0<br> RBP  0x1392c58e8b60 —▸ 0x1392c57a14a0 ◂— 0xffffec6f00000002<br> RSP  0x7fffffffd970 —▸ 0x1392c57a14a0 ◂— 0xffffec6f00000002<br> RIP  0x7ffff7ce49e5 (g_main_context_dispatch+581) ◂— call   qword ptr [rbx + 8]<br>──────────────────────────────────────────[ DISASM ]──────────────────────────────────────────<br> ► 0x7ffff7ce49e5 &lt;g_main_context_dispatch+581&gt;    call   qword ptr [rbx + 8]<br> <br>   0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;    mov    rdi, r14<br>   0x7ffff7ce49eb &lt;g_main_context_dispatch+587&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;<br></code></pre></td></tr></table></figure>

<p>通过以上观察, rbx指向的是0x7ffff7cdf140, 则 rbx + 8内存信息如下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">pwndbg&gt; x /40gx $rbx + 8<br>0x7ffff7dc33a8: 0x00007ffff7cdf270      0x00007ffff7cdef50<br>0x7ffff7dc33b8: 0x0000000000000000      0x00001392c618e070<br>0x7ffff7dc33c8: 0x00007ffff7ce0650      0x0000000000000000<br></code></pre></td></tr></table></figure>

<p>指向的内存如下:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">pwndbg&gt; x /40gx 0x00007ffff7cdf270<br>0x7ffff7cdf270: 0x66c30a74012f83f0      0x0000000000841f0f<br>0x7ffff7cdf280: 0xfd894818478b4855      0x7f8b480674c08548<br>0x7ffff7cdf290: 0xe95def8948d0ff10      0x001f0f90ffffffc4<br>0x7ffff7cdf2a0: 0x2e6690ffffffbbe9      0x0000000000841f0f<br>0x7ffff7cdf2b0: 0x15fffb8953555441      0x48fb6348000e361c<br>0x7ffff7cdf2c0: 0x8b44000e485a158d      0x000001b8c5894820<br>0x7ffff7cdf2d0: 0x0587ba0c87c18900      0x25058b48000e4948<br>0x7ffff7cdf2e0: 0x0080b88b48000e48      0x4400047fb1e80000<br>0x7ffff7cdf2f0: 0xc35c415d5b006589      0x0000000000841f0f<br>0x7ffff7cdf300 &lt;g_clear_handle_id&gt;:     0x1074c08545078b44      0x89440000000007c7<br>0x7ffff7cdf310 &lt;g_clear_handle_id+16&gt;:  0x0000441f0fe6ffc7      0x00000000801f0fc3<br>0x7ffff7cdf320 &lt;g_get_real_time&gt;:       0x4864f63128ec8348      0x480000002825048b<br>0x7ffff7cdf330 &lt;g_get_real_time+16&gt;:    0x8948c03118244489      0x48000e37e115ffe7<br>0x7ffff7cdf340 &lt;g_get_real_time+32&gt;:    0x48000f4240240469      0x24548b4808244403<br>0x7ffff7cdf350 &lt;g_get_real_time+48&gt;:    0x002825142b486418      0x28c4834805750000<br>0x7ffff7cdf360 &lt;g_get_real_time+64&gt;:    0x66000e372915ffc3      0x0000000000841f0f<br>0x7ffff7cdf370 &lt;g_main_context_query&gt;:  0x495641d789495741      0x41fd89495541ce89<br>0x7ffff7cdf380 &lt;g_main_context_query+16&gt;:       0xf38953c589445554      0x2ebee86708ec8348<br>0x7ffff7cdf390 &lt;g_main_context_query+32&gt;:       0x854860458b490005      0x31000000c1840fc0<br>0x7ffff7cdf3a0 &lt;g_main_context_query+48&gt;:       0x2e6634ebe43145f6      0x0000000000841f0f<br></code></pre></td></tr></table></figure>

<p>单步执行</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs text">RAX  0x0<br>RBX  0x7ffff7dc33a0 —▸ 0x7ffff7cdf140 ◂— lock add dword ptr [rdi], 1<br>RCX  0x7ffff7d42930 ◂— 0x796f7274736564 /* &#x27;destroy&#x27; */<br>RDX  0x7ffff7e450a0 (__pthread_keys) ◂— 0x1<br>RDI  0x99bbfa157a0 ◂— 0xfffff66600000002<br>RSI  0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]<br>R8   0x99bbf7f2380 ◂— 0x0<br>R9   0x7fffede4d9e0 ◂— 0x3000000028 /* &#x27;(&#x27; */<br>R10  0x7ffff7fca080<br>R11  0x286<br>R12  0x0<br>R13  0x99bbf9eb250 ◂— 0x0<br>R14  0x99bbf9f9e70 ◂— 0x0<br>R15  0x1<br>RBP  0x99bbf9fc4e0 —▸ 0x99bbfa157a0 ◂— 0xfffff66600000002<br>RSP  0x7fffede4dac8 —▸ 0x7ffff7ce49e8 (g_main_context_dispatch+584) ◂— mov    rdi, r14<br>RIP  0x7ffff7cdf270 ◂— lock sub dword ptr [rdi], 1<br><br>► 0x7ffff7cdf270                                  lock sub dword ptr [rdi], 1<br>   ↓<br>  0x7ffff7cdf276                                  ret    <br>   ↓<br>  0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;    mov    rdi, r14<br>  0x7ffff7ce49eb &lt;g_main_context_dispatch+587&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;<br><br></code></pre></td></tr></table></figure>

<p>可以看到, 原来rbx + 8处的内存储存的是一个该处指令的地址, 这里采用lock sub指令进行对线程使用数 - 1, rdi 指向的是被锁的线程.目前为2</p>
<p>lock前缀指令详解</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">LOCK指令前缀会设置处理器的LOCK#信号（译注：这个信号会使总线锁定，阻止其他处理器接管总线访问内存），直到使用LOCK前缀的指令执行结束，这会使这条指令的执行变为原子操作。在多处理器环境下，设置LOCK#信号能保证某个处理器对共享内存的独占使用。<br>LOCK指令前缀只能用于以下指令，并且要求指令目的操作数为内存操作数，如果源操作数为内存操作数，就会产生undefined opcode异常：ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B,CMPXCHG16B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD, XCHG。LOCK指令前缀用于其他任何指令时，也会产生如果源操作数为内存操作数，就会产生undefined opcode异常。另外，XCHG指令默认会设置LOCK#信号，无论是否使用LOCK指令前缀。<br>LOCK指令前缀经常用于BTS指令，用来在共享内存进行一次read-modify-write操作。<br>从P6处理器家族开始，如果使用了LOCK指令前缀的指令要访问的目的地址的内容已经缓存在了cache中，那么LOCK#信号一般就不会被设置，但是当前处理器的cache会被锁定，然后缓存一致性（cache coherency ）机制会自动确保操作的原子性。<br></code></pre></td></tr></table></figure>



<p>从g_main_context_dispatch结束的可疑地址1</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs text">────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────<br> RAX  0x1<br> RBX  0x1665cdb9ed01 ◂— 0x0<br> RCX  0x7fffffffdac0 —▸ 0x1665cdb9edc8 —▸ 0x5555570bdcb0 —▸ 0x55555617bf10 ◂— push   rbp<br> RDX  0x7ffff7da0251 ◂— &#x27;non-blocking&#x27;<br> RDI  0x1665cda0ddc0 ◂— 0x0<br> RSI  0x1<br> R8   0x1665cda0f520 ◂— 0x0<br> R9   0x7fffffffd920 ◂— 0x3000000028 /* &#x27;(&#x27; */<br> R10  0x7ffff7fca080<br> R11  0x286<br> R12  0x7fffffffdce8 ◂— &#x27;2.0.0-b2&#x27;<br> R13  0x7fffffffdc80 —▸ 0x1665cdb9edd0 —▸ 0x5555570bdd00 —▸ 0x55555617bf20 ◂— push   rbp<br> R14  0x0<br> R15  0x1665cdb8d2d0 —▸ 0x5555570bc718 —▸ 0x555556151e10 ◂— push   rbp<br> RBP  0x7fffffffdb00 —▸ 0x7fffffffdb30 —▸ 0x7fffffffdbc0 —▸ 0x7fffffffdf10 —▸ 0x55555709abe0 ◂— ...<br> RSP  0x7fffffffdac0 —▸ 0x1665cdb9edc8 —▸ 0x5555570bdcb0 —▸ 0x55555617bf10 ◂— push   rbp<br> RIP  0x55555615201a ◂— jne    0x555556152063<br>──────────────────────────────────────────[ DISASM ]──────────────────────────────────────────<br>   0x7ffff7ce3144 &lt;g_main_context_iteration+68&gt;    pop    rbp<br>   0x7ffff7ce3145 &lt;g_main_context_iteration+69&gt;    pop    r12<br>   0x7ffff7ce3147 &lt;g_main_context_iteration+71&gt;    ret    <br>    ↓<br>   0x555556152012                                  mov    rcx, qword ptr [r15 + 8]<br>   0x555556152016                                  cmp    byte ptr [rcx + 8], 0<br> ► 0x55555615201a                                  jne    0x555556152063<br>    ↓<br>   0x55555615201e                                  setne  bl<br>   0x555556152021                                  mov    rdi, qword ptr [rcx]<br>   0x555556152024                                  mov    rax, qword ptr [rdi]<br>   0x555556152027                                  call   qword ptr [rax + 0x20]<br> <br>   0x55555615202a                                  mov    rcx, qword ptr [r15 + 8]<br><br></code></pre></td></tr></table></figure>



<p>程序vmmap</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">0x555555554000     0x555555b69000 r--p   615000 0      /opt/tencent-qq/qq<br>   0x555555b69000     0x5555570a6000 r-xp  153d000 614000 /opt/tencent-qq/qq<br>   0x5555570a6000     0x55555710d000 r--p    67000 1b50000 /opt/tencent-qq/qq<br>   0x55555710d000     0x555557119000 rw-p     c000 1bb6000 /opt/tencent-qq/qq<br>   0x555557119000     0x55555717a000 rw-p    61000 0      [heap]<br>   ....<br><br></code></pre></td></tr></table></figure>

<p>程序基址为: 0x555555554000</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; p /x 0x555556152012 - 0x555555554000<br>$4 = 0xbfe012<br></code></pre></td></tr></table></figure>



<p>可疑问题偏移地址:</p>
<p>0xbfe012</p>
<p>找到该调处用汇编代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs asm">0x00bfdfa0      push rbp<br>0x00bfdfa1      mov rbp, rsp<br>0x00bfdfa4      push r15<br>0x00bfdfa6      push r14<br>0x00bfdfa8      push rbx<br>0x00bfdfa9      sub rsp, 0x28<br>0x00bfdfad      mov r15, rdi<br>0x00bfdfb0      movaps xmm0, xmmword [0x00122f40]<br>0x00bfdfb7      movaps xmmword [rbp - 0x40], xmm0<br>0x00bfdfbb      xorps xmm0, xmm0<br>0x00bfdfbe      movaps xmmword [rbp - 0x30], xmm0<br>0x00bfdfc2      mov qword [rbp - 0x40], rsi<br>0x00bfdfc6      mov byte [rbp - 0x38], 0<br>0x00bfdfca      mov r14, qword [rdi + 8]<br>0x00bfdfce      test r14, r14<br>0x00bfdfd1      je 0xbfdfdc<br>0x00bfdfd3      mov eax, dword [r14 + 0xc]<br>0x00bfdfd7      add eax, 1<br>0x00bfdfda      jmp 0xbfdfe1<br>0x00bfdfdc      mov eax, 1<br>0x00bfdfe1      mov dword [rbp - 0x34], eax<br>0x00bfdfe4      lea rax, [rbp - 0x40]<br>0x00bfdfe8      mov qword [r15 + 8], rax<br>0x00bfdfec      mov rdi, qword [r15 + 0x10]<br>0x00bfdff0      xor esi, esi<br>0x00bfdff2      jmp 0xbfe00d<br>0x00bfdff4      nop word cs:[rax + rax]<br>0x00bfdffe      nop<br>0x00bfe000      test dl, dl<br>0x00bfe002      jne 0xbfe063<br>0x00bfe004      xor al, 1<br>0x00bfe006      mov rdi, qword [r15 + 0x10]<br>0x00bfe00a      movzx esi, al<br>0x00bfe00d      call g_main_context_iteration ; sym.imp.g_main_context_iteration ; 调用<br>0x00bfe012      mov rcx, qword [r15 + 8]<br>0x00bfe016      cmp byte [rcx + 8], 0<br>0x00bfe01a      jne 0xbfe063<br>0x00bfe01c      test eax, eax<br>0x00bfe01e      setne bl<br>0x00bfe021      mov rdi, qword [rcx]<br>0x00bfe024      mov rax, qword [rdi]<br>0x00bfe027      call qword [rax + 0x20]<br>0x00bfe02a      mov rcx, qword [r15 + 8]<br>0x00bfe02e      mov qword [rcx + 0x10], rax<br>0x00bfe032      mov qword [rcx + 0x18], rdx<br>0x00bfe036      mov rcx, qword [r15 + 8]<br>0x00bfe03a      cmp qword [rcx + 0x10], 0<br>0x00bfe03f      sete al<br>0x00bfe042      or al, bl<br>0x00bfe044      movzx edx, byte [rcx + 8]<br>0x00bfe048      test dl, dl<br>0x00bfe04a      jne 0xbfe000<br>0x00bfe04c      test al, al<br>0x00bfe04e      jne 0xbfe000<br>0x00bfe050      mov rdi, qword [rcx]<br>0x00bfe053      mov rax, qword [rdi]<br>0x00bfe056      call qword [rax + 0x38]<br>0x00bfe059      mov rcx, qword [r15 + 8]<br>0x00bfe05d      cmp byte [rcx + 8], 0<br>0x00bfe061      je 0xbfe004<br>0x00bfe063      mov qword [r15 + 8], r14<br>0x00bfe067      add rsp, 0x28<br>0x00bfe06b      pop rbx<br>0x00bfe06c      pop r14<br>0x00bfe06e      pop r15<br>0x00bfe070      pop rbp<br>0x00bfe071      ret<br>0x00bfe072      int3<br>0x00bfe073      int3<br></code></pre></td></tr></table></figure>



<p>IDA伪c代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> __fastcall <span class="hljs-title function_">sub_BFDFA0</span><span class="hljs-params">(__int64 a1, __int64 a2)</span> <span class="hljs-comment">//**************  段错误触发函数</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// r15</span><br>  __int64 v3; <span class="hljs-comment">// r14</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// eax</span><br>  __int64 v5; <span class="hljs-comment">// rdi</span><br>  __int64 i; <span class="hljs-comment">// rsi</span><br>  __int64 v7; <span class="hljs-comment">// rax</span><br>  __int64 v8; <span class="hljs-comment">// rdx</span><br>  _BYTE *v9; <span class="hljs-comment">// rcx</span><br>  <span class="hljs-type">bool</span> v10; <span class="hljs-comment">// bl</span><br>  __int64 v11; <span class="hljs-comment">// rcx</span><br>  __int64 v12; <span class="hljs-comment">// rdx</span><br>  _QWORD *v13; <span class="hljs-comment">// rcx</span><br>  __int64 v14; <span class="hljs-comment">// rdx</span><br>  __int128 v16; <span class="hljs-comment">// [rsp+0h] [rbp-40h]</span><br>  __int128 v17; <span class="hljs-comment">// [rsp+10h] [rbp-30h]</span><br><br>  v2 = a1;<br>  v16 = xmmword_122F40;<br>  v17 = <span class="hljs-number">0LL</span>;<br>  *(_QWORD *)&amp;v16 = a2;<br>  BYTE8(v16) = <span class="hljs-number">0</span>;<br>  v3 = *(_QWORD *)(a1 + <span class="hljs-number">8</span>);<br>  <span class="hljs-keyword">if</span> ( v3 )<br>    v4 = *(_DWORD *)(v3 + <span class="hljs-number">12</span>) + <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">else</span><br>    v4 = <span class="hljs-number">1</span>;<br>  HIDWORD(v16) = v4;<br>  *(_QWORD *)(a1 + <span class="hljs-number">8</span>) = &amp;v16;<br>  v5 = *(_QWORD *)(a1 + <span class="hljs-number">16</span>);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0LL</span>; ; i = (<span class="hljs-type">unsigned</span> __int8)(v7 ^ <span class="hljs-number">1</span>) )<br>  &#123;<br>    LODWORD(v7) = g_main_context_iteration(v5, i); <span class="hljs-comment">//**************  段错误触发函数</span><br>    v9 = *(_BYTE **)(v2 + <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> ( v9[<span class="hljs-number">8</span>] )<br>      <span class="hljs-keyword">break</span>;<br>    v10 = (_DWORD)v7 != <span class="hljs-number">0</span>;<br>    v7 = (*(__int64 (__cdecl **)(_QWORD, __int64, __int64, _BYTE *))(**(_QWORD **)v9 + <span class="hljs-number">32LL</span>))(*(_QWORD *)v9, i, v8, v9);<br>    v11 = *(_QWORD *)(v2 + <span class="hljs-number">8</span>);<br>    *(_QWORD *)(v11 + <span class="hljs-number">16</span>) = v7;<br>    *(_QWORD *)(v11 + <span class="hljs-number">24</span>) = v12;<br>    v13 = *(_QWORD **)(v2 + <span class="hljs-number">8</span>);<br>    LOBYTE(v7) = v10 || v13[<span class="hljs-number">2</span>] == <span class="hljs-number">0LL</span>;<br>    v14 = *((<span class="hljs-type">unsigned</span> __int8 *)v13 + <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> ( (_BYTE)v14 || (_BYTE)v7 )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( (_BYTE)v14 )<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      LOBYTE(v7) = (*(__int64 (__cdecl **)(_QWORD, __int64, __int64, _QWORD *))(*(_QWORD *)*v13 + <span class="hljs-number">56LL</span>))(<br>                     *v13,<br>                     i,<br>                     v14,<br>                     v13);<br>      <span class="hljs-keyword">if</span> ( *(_BYTE *)(*(_QWORD *)(v2 + <span class="hljs-number">8</span>) + <span class="hljs-number">8LL</span>) )<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    v5 = *(_QWORD *)(v2 + <span class="hljs-number">16</span>);<br>  &#125;<br>  *(_QWORD *)(v2 + <span class="hljs-number">8</span>) = v3;<br>  <span class="hljs-keyword">return</span> v7;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>发现在该函数中,没有加入线程锁, 多线程时条件竞争时导致出现内存错误.</p>
<p>最初漏洞所在: </p>
<p>在&lt;g_main_context_dispatch+581&gt;    call   qword ptr [rbx + 8]的地方出现内存错误.</p>
<p>该g_main_context_dispatch函数为g_main_context_iteration所调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asm">│  &gt;0x7ffff7ce49b9 &lt;g_main_context_dispatch+537&gt;    lea    r8,[rip+0xbb8c5]<br>│   0x7ffff7ce49c0 &lt;g_main_context_dispatch+544&gt;    lea    rdx,[rip+0x546aa]<br>│   0x7ffff7ce49c7 &lt;g_main_context_dispatch+551&gt;    call   0x7ffff7d34ad0<br>│   0x7ffff7ce49cc &lt;g_main_context_dispatch+556&gt;    mov    rax,QWORD PTR [rsp+0x18]<br>│   0x7ffff7ce49d1 &lt;g_main_context_dispatch+561&gt;    sub    DWORD PTR [r13+0x0],0x1<br>│   0x7ffff7ce49d6 &lt;g_main_context_dispatch+566&gt;    mov    QWORD PTR [r13+0x8],rax<br>│   0x7ffff7ce49da &lt;g_main_context_dispatch+570&gt;    pop    rcx<br>│   0x7ffff7ce49db &lt;g_main_context_dispatch+571&gt;    pop    rsi<br>│   0x7ffff7ce49dc &lt;g_main_context_dispatch+572&gt;    test   rbx,rbx<br>│   0x7ffff7ce49df &lt;g_main_context_dispatch+575&gt;    je     0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;<br>│   0x7ffff7ce49e1 &lt;g_main_context_dispatch+577&gt;    mov    rdi,QWORD PTR [rsp]<br>│   0x7ffff7ce49e5 &lt;g_main_context_dispatch+581&gt;    call   QWORD PTR [rbx+0x8]     //vul<br>│   0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;    mov    rdi,r14<br></code></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">► 0x55555615200d    call   g_main_context_iteration@plt &lt;0x5555570a28c0&gt;<br>       rdi: 0x3acdd361fdc0 ◂— 0x0<br>       rsi: 0x0<br>       rdx: 0x7fffffffffffffff<br>       rcx: 0x5555570bdd00 —▸ 0x55555617bf20 ◂— push   rbp<br></code></pre></td></tr></table></figure>





<h2 id="调试漏洞函数最后一次状态"><a href="#调试漏洞函数最后一次状态" class="headerlink" title="调试漏洞函数最后一次状态"></a>调试漏洞函数最后一次状态</h2><p>崩溃前</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"> RAX  0x0<br> RBX  0x317f3a79dc01 ◂— 0x0<br> RCX  0x7fffffffdac0 —▸ 0x317f3a79dc68 —▸ 0x5555570bdcb0 —▸ 0x55555617bf10 ◂— push   rbp<br> RDX  0x0<br> RDI  0x317f3a648dc0 ◂— 0x0<br> RSI  0x0<br> R8   0x317f3a5c8003 ◂— 0x0<br> R9   0x0<br> R10  0x7ffff7fca080<br> R11  0x286<br> R12  0x7fffffffdce8 ◂— &#x27;2.0.0-b2&#x27;<br> R13  0x7fffffffdc80 —▸ 0x317f3a79dc70 —▸ 0x5555570bdd00 —▸ 0x55555617bf20 ◂— push   rbp<br> R14  0x0<br> R15  0x317f3a7b8090 —▸ 0x5555570bc718 —▸ 0x555556151e10 ◂— push   rbp<br> RBP  0x7fffffffdb00 —▸ 0x7fffffffdb30 —▸ 0x7fffffffdbc0 —▸ 0x7fffffffdf10 —▸ 0x55555709abe0 ◂— ...<br> RSP  0x7fffffffdab8 —▸ 0x555556152012 ◂— mov    rcx, qword ptr [r15 + 8]<br> RIP  0x7ffff7ce3100 (g_main_context_iteration) ◂— push   r12<br>─────────────────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────────────────<br> ► 0x7ffff7ce3100 &lt;g_main_context_iteration&gt;       push   r12<br><br></code></pre></td></tr></table></figure>



<p>最后一次崩溃g_main_context_iteration的传参</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"> RAX  0x0<br> RBX  0x317f3a79dc01 ◂— 0x0<br> RCX  0x7fffffffdac0 —▸ 0x317f3a79dc68 —▸ 0x5555570bdcb0 —▸ 0x55555617bf10 ◂— push   rbp<br> RDX  0x0<br> RDI  0x317f3a648dc0 ◂— 0x0<br> RSI  0x0<br> R8   0x317f3a5c8003 ◂— 0x0<br> R9   0x0  ; diff<br> R10  0x17 ; diff<br> R11  0x10 ; diff<br> R12  0x7fffffffdce8 ◂— &#x27;2.0.0-b2&#x27;<br> R13  0x7fffffffdc80 —▸ 0x317f3a79dc70 —▸ 0x5555570bdd00 —▸ 0x55555617bf20 ◂— push   rbp<br> R14  0x0<br> R15  0x317f3a7b8090 —▸ 0x5555570bc718 —▸ 0x555556151e10 ◂— push   rbp<br> RBP  0x7fffffffdb00 —▸ 0x7fffffffdb30 —▸ 0x7fffffffdbc0 —▸ 0x7fffffffdf10 —▸ 0x55555709abe0 ◂— ...<br> RSP  0x7fffffffdab8 —▸ 0x555556152012 ◂— mov    rcx, qword ptr [r15 + 8]<br> RIP  0x7ffff7ce3100 (g_main_context_iteration) ◂— push   r12<br>─────────────────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────────────────<br> ► 0x7ffff7ce3100 &lt;g_main_context_iteration&gt;       push   r12<br>    ↓<br>   0x7ffff7ce3105 &lt;g_main_context_iteration+5&gt;     push   rbp<br>   0x7ffff7ce3106 &lt;g_main_context_iteration+6&gt;     mov    rbp, rdi<br>   0x7ffff7ce3109 &lt;g_main_context_iteration+9&gt;     sub    rsp, 8<br>   0x7ffff7ce310d &lt;g_main_context_iteration+13&gt;    test   rdi, rdi<br></code></pre></td></tr></table></figure>



<p>g_main_context_dispatch函数最后一次崩溃传参</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs text">Continuing.<br><br>Thread 1 &quot;qq&quot; hit Breakpoint 2, 0x00007ffff7ce47a0 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0                                                                   <br>ERROR: Could not find ELF base!<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>──────────────────────────────────────[ REGISTERS ]──────────────────────────────────────<br> RAX  0x1<br> RBX  0x1<br> RCX  0xf0950bcdd20 ◂— 0x0<br> RDX  0x1<br> RDI  0xf094fee6dc0 ◂— 0x0<br> RSI  0x1<br> R8   0x0<br> R9   0x7fffffffd840 ◂— 0x3000000028 /* &#x27;(&#x27; */<br> R10  0x7ffff7fca080<br> R11  0x293<br> R12  0x3<br> R13  0xf094fee6dc0 ◂— 0x0<br> R14  0x7fffffffda10 ◂— 0x352<br> R15  0x2<br> RBP  0xf095048bf20 ◂— 0x100000021 /* &#x27;!&#x27; */<br> RSP  0x7fffffffd9d8 —▸ 0x7ffff7d38621 ◂— jmp    0x7ffff7d384c0<br> RIP  0x7ffff7ce47a0 (g_main_context_dispatch) ◂— push   r15<br>───────────────────────────────────────[ DISASM ]────────────────────────────────────────<br> ► 0x7ffff7ce47a0 &lt;g_main_context_dispatch&gt;       push   r15<br>    ↓<br>   0x7ffff7ce47a4 &lt;g_main_context_dispatch+4&gt;     mov    r14, rdi<br>   0x7ffff7ce47a7 &lt;g_main_context_dispatch+7&gt;     push   r13<br>   0x7ffff7ce47a9 &lt;g_main_context_dispatch+9&gt;     push   r12<br>   0x7ffff7ce47ab &lt;g_main_context_dispatch+11&gt;    push   rbp<br>   0x7ffff7ce47ac &lt;g_main_context_dispatch+12&gt;    push   rbx<br>   0x7ffff7ce47ad &lt;g_main_context_dispatch+13&gt;    sub    rsp, 0x68<br>   0x7ffff7ce47b1 &lt;g_main_context_dispatch+17&gt;    mov    rax, qword ptr fs:[0x28]<br>   0x7ffff7ce47ba &lt;g_main_context_dispatch+26&gt;    mov    qword ptr [rsp + 0x58], rax<br>   0x7ffff7ce47bf &lt;g_main_context_dispatch+31&gt;    xor    eax, eax<br>   0x7ffff7ce47c1 &lt;g_main_context_dispatch+33&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;<br>────────────────────────────────────────[ STACK ]────────────────────────────────────────<br>00:0000│ rsp  0x7fffffffd9d8 —▸ 0x7ffff7d38621 ◂— jmp    0x7ffff7d384c0<br>01:0008│      0x7fffffffd9e0 ◂— 0x352<br>02:0010│      0x7fffffffd9e8 ◂— 0x249b1fe8<br>03:0018│      0x7fffffffd9f0 ◂— 0x100000000<br>04:0020│      0x7fffffffd9f8 —▸ 0x7ffff7cead90 (g_poll) ◂— mov    esi, esi<br>05:0028│      0x7fffffffda00 ◂— 0xaaaaaaaaaaaaaaaa<br>06:0030│      0x7fffffffda08 ◂— 0x0<br>07:0038│ r14  0x7fffffffda10 ◂— 0x352<br>──────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────<br> ► f 0     7ffff7ce47a0 g_main_context_dispatch<br>   f 1     7ffff7d38621<br>   f 2     7ffff7ce3131 g_main_context_iteration+49<br>   f 3     555556152012<br>   f 4     55555617d0e5<br>   f 5     5555561660ee<br>   f 6     555555f0f6f4<br>   f 7     7ffff6f70152 __libc_start_main+242<br>─────────────────────────────────────────────────────────────────────────────────────────<br>pwndbg&gt; <br>Continuing.<br><br>Thread 1 &quot;qq&quot; hit Breakpoint 2, 0x00007ffff7ce47a0 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0                                                                   <br>ERROR: Could not find ELF base!<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>──────────────────────────────────────[ REGISTERS ]──────────────────────────────────────<br> RAX  0x1<br> RBX  0x1<br> RCX  0x4 ;diff<br> RDX  0x1<br> RDI  0xf094fee6dc0 ◂— 0x0<br> RSI  0x1<br> R8   0x0<br> R9   0x7fffffffd840 ◂— 0x3000000028 /* &#x27;(&#x27; */<br> R10  0x7ffff7fca080<br> R11  0x293<br> R12  0x3<br> R13  0xf094fee6dc0 ◂— 0x0<br> R14  0x7fffffffda10 ◂— 0x353 ; diff ++<br> R15  0x2<br> RBP  0xf095048bf20 ◂— 0x100000021 /* &#x27;!&#x27; */<br> RSP  0x7fffffffd9d8 —▸ 0x7ffff7d38621 ◂— jmp    0x7ffff7d384c0<br> RIP  0x7ffff7ce47a0 (g_main_context_dispatch) ◂— push   r15<br>───────────────────────────────────────[ DISASM ]────────────────────────────────────────<br> ► 0x7ffff7ce47a0 &lt;g_main_context_dispatch&gt;       push   r15<br>    ↓<br>   0x7ffff7ce47a4 &lt;g_main_context_dispatch+4&gt;     mov    r14, rdi<br>   0x7ffff7ce47a7 &lt;g_main_context_dispatch+7&gt;     push   r13<br>   0x7ffff7ce47a9 &lt;g_main_context_dispatch+9&gt;     push   r12<br>   0x7ffff7ce47ab &lt;g_main_context_dispatch+11&gt;    push   rbp<br>   0x7ffff7ce47ac &lt;g_main_context_dispatch+12&gt;    push   rbx<br>   0x7ffff7ce47ad &lt;g_main_context_dispatch+13&gt;    sub    rsp, 0x68<br>   0x7ffff7ce47b1 &lt;g_main_context_dispatch+17&gt;    mov    rax, qword ptr fs:[0x28]<br>   0x7ffff7ce47ba &lt;g_main_context_dispatch+26&gt;    mov    qword ptr [rsp + 0x58], rax<br>   0x7ffff7ce47bf &lt;g_main_context_dispatch+31&gt;    xor    eax, eax<br>   0x7ffff7ce47c1 &lt;g_main_context_dispatch+33&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;<br>────────────────────────────────────────[ STACK ]────────────────────────────────────────<br>00:0000│ rsp  0x7fffffffd9d8 —▸ 0x7ffff7d38621 ◂— jmp    0x7ffff7d384c0<br>01:0008│      0x7fffffffd9e0 ◂— 0x353<br>02:0010│      0x7fffffffd9e8 ◂— 0x15108cf6<br>03:0018│      0x7fffffffd9f0 ◂— 0x100000000<br>04:0020│      0x7fffffffd9f8 —▸ 0x7ffff7cead90 (g_poll) ◂— mov    esi, esi<br>05:0028│      0x7fffffffda00 ◂— 0xaaaaaaaaaaaaaaaa<br>06:0030│      0x7fffffffda08 ◂— 0x0<br>07:0038│ r14  0x7fffffffda10 ◂— 0x353<br>──────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────<br> ► f 0     7ffff7ce47a0 g_main_context_dispatch<br>   f 1     7ffff7d38621<br>   f 2     7ffff7ce3131 g_main_context_iteration+49<br>   f 3     555556152012<br>   f 4     55555617d0e5<br>   f 5     5555561660ee<br>   f 6     555555f0f6f4<br>   f 7     7ffff6f70152 __libc_start_main+242<br>─────────────────────────────────────────────────────────────────────────────────────────<br>pwndbg&gt; <br>Continuing.<br><br>Thread 1 &quot;qq&quot; received signal SIGSEGV, Segmentation fault.<br>0x00007ffff7ce49e5 in g_main_context_dispatch () from /usr/lib/libglib-2.0.so.0<br>ERROR: Could not find ELF base!<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>──────────────────────────────────────[ REGISTERS ]──────────────────────────────────────<br> RAX  0x0<br> RBX  0x7ffff7000000 (____wcstof128_l_internal+1168) ◂— adc    eax, 0x748b0000<br> RCX  0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */<br> RDX  0x7ffff7e450a0 (__pthread_keys) ◂— 0x1<br> RDI  0xf09506b6740 ◂— 0xfffff0f400000002<br> RSI  0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]<br> R8   0xf094fee8520 ◂— 0x0<br> R9   0x7fffffffd850 ◂— 0x3000000028 /* &#x27;(&#x27; */<br> R10  0x7ffff7fca080<br> R11  0x286<br> R12  0x1<br> R13  0xf0950489980 ◂— 0x0<br> R14  0xf094fee6dc0 ◂— 0x0<br> R15  0x2<br> RBP  0xf0950b47d20 —▸ 0xf09506b6740 ◂— 0xfffff0f400000002<br> RSP  0x7fffffffd940 —▸ 0xf09506b6740 ◂— 0xfffff0f400000002<br> RIP  0x7ffff7ce49e5 (g_main_context_dispatch+581) ◂— call   qword ptr [rbx + 8]<br>───────────────────────────────────────[ DISASM ]────────────────────────────────────────<br> ► 0x7ffff7ce49e5 &lt;g_main_context_dispatch+581&gt;    call   qword ptr [rbx + 8]<br>        rdi: 0xf09506b6740 ◂— 0xfffff0f400000002<br>        rsi: 0x7ffff7ce498d (g_main_context_dispatch+493) ◂— mov    rdi, qword ptr [rsp + 0x18]<br>        rdx: 0x7ffff7e450a0 (__pthread_keys) ◂— 0x1<br>        rcx: 0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */<br> <br>   0x7ffff7ce49e8 &lt;g_main_context_dispatch+584&gt;    mov    rdi, r14<br>   0x7ffff7ce49eb &lt;g_main_context_dispatch+587&gt;    call   g_mutex_lock &lt;0x7ffff7d32250&gt;<br> <br>   0x7ffff7ce49f1 &lt;g_main_context_dispatch+593&gt;    mov    edx, dword ptr [rsp + 0x2c]<br>   0x7ffff7ce49f5 &lt;g_main_context_dispatch+597&gt;    mov    eax, dword ptr [rbp + 0x2c]<br>   0x7ffff7ce49f8 &lt;g_main_context_dispatch+600&gt;    test   edx, edx<br>   0x7ffff7ce49fa &lt;g_main_context_dispatch+602&gt;    jne    g_main_context_dispatch+610 &lt;0x7ffff7ce4a02&gt;<br> <br>   0x7ffff7ce49fc &lt;g_main_context_dispatch+604&gt;    and    eax, 0xfffffffd<br>   0x7ffff7ce49ff &lt;g_main_context_dispatch+607&gt;    mov    dword ptr [rbp + 0x2c], eax<br>   0x7ffff7ce4a02 &lt;g_main_context_dispatch+610&gt;    and    eax, 0x41<br>   0x7ffff7ce4a05 &lt;g_main_context_dispatch+613&gt;    cmp    eax, 0x41<br>────────────────────────────────────────[ STACK ]────────────────────────────────────────<br>00:0000│ rsp  0x7fffffffd940 —▸ 0xf09506b6740 ◂— 0xfffff0f400000002<br>01:0008│      0x7fffffffd948 ◂— 0x0<br>02:0010│      0x7fffffffd950 —▸ 0x7ffff7d42938 ◂— 0x6f5347007065656b /* &#x27;keep&#x27; */<br>03:0018│      0x7fffffffd958 ◂— 0xc646f4bc63<br>04:0020│      0x7fffffffd960 —▸ 0x7ffff7d42760 ◂— &#x27;(unnamed)&#x27;<br>05:0028│      0x7fffffffd968 ◂— 0x1<br>06:0030│      0x7fffffffd970 ◂— 0x0<br>07:0038│      0x7fffffffd978 —▸ 0x555555c44670 ◂— push   rbp<br>──────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────<br> ► f 0     7ffff7ce49e5 g_main_context_dispatch+581<br>   f 1     7ffff7d38621<br>   f 2     7ffff7ce3131 g_main_context_iteration+49<br>   f 3     555556152012<br>   f 4     55555617d0e5<br>   f 5     5555561660ee<br>   f 6     555555f0f6f4<br>   f 7     7ffff6f70152 __libc_start_main+242<br>─────────────────────────────────────────────────────────────────────────────────────────<br></code></pre></td></tr></table></figure>





<p>0x527A0  + 581 &#x3D;&#x3D; x529e5</p>
<h2 id="其他线程漏洞"><a href="#其他线程漏洞" class="headerlink" title="其他线程漏洞"></a>其他线程漏洞</h2><p>经过多线程调试, 找到bug2, 发生在Qnox_LogicThrea线程中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pwndbg&gt; <br><br>Thread 5 &quot;Qnox_LogicThrea&quot; received signal SIGSEGV, Segmentation fault.<br>0x000055555621f539 in ?? ()<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>───────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────<br> RAX  0xffffc39f73c44bb8<br> RBX  0x3c62263bf000 ◂— 0x0<br> RCX  0x55555621f500 ◂— push   rbp<br> RDX  0xf0<br> RDI  0x7ffff515f830 ◂— 0xaaaaaaaaaaaaaaaa<br> RSI  0x3c622690f240 ◂— 0xffffc39f73c44bb8<br> R8   0x3c62264ca003 ◂— 0x0<br> R9   0x1<br> R10  0x7ffff7fca080<br> R11  0x286<br> R12  0x0<br> R13  0xaaaaaaaaaaaaaaaa<br> R14  0x0<br> R15  0x3c62267d3000 —▸ 0x5555570c4350 —▸ 0x55555621d7d0 ◂— push   rbp<br> RBP  0x7ffff515f870 —▸ 0x7ffff515f930 —▸ 0x7ffff515fa10 —▸ 0x7ffff515fa60 —▸ 0x7ffff515fac0 ◂— ...<br> RSP  0x7ffff515f6e0 ◂— 0x0<br> RIP  0x55555621f539 ◂— call   qword ptr [rax + 0x30]<br>─────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────<br> ► 0x55555621f539    call   qword ptr [rax + 0x30]<br> <br>   0x55555621f53c    mov    edi, 2<br>   0x55555621f541    call   0x55555614f1b0<br> <br>   0x55555621f546    test   al, al<br>   0x55555621f548    je     0x55555621f5de<br> <br>   0x55555621f54e    lea    rsi, [rip - 0xb59197]<br>   0x55555621f555    lea    rdi, [rbp - 0x178]<br>   0x55555621f55c    mov    edx, 0x107<br>   0x55555621f561    mov    ecx, 2<br>   0x55555621f566    call   0x55555614f2a0<br> <br>   0x55555621f56b    lea    rdi, [rbp - 0x170]<br><br></code></pre></td></tr></table></figure>

<p>可以看到, call   qword ptr [rax + 0x30]指令中, rax对应的值为: 0xffffc39f73c44bb8</p>
<p>指令: 0x55555 621f539 -  0x55555 5554000 &#x3D;&#x3D; 0xccb539</p>
<p>vmmap</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0x555555554000     0x555555b69000 r--p   615000 0      /opt/tencent-qq/qq<br>   0x555555b69000     0x5555570a6000 r-xp  153d000 614000 /opt/tencent-qq/qq<br>   0x5555570a6000     0x55555710d000 r--p    67000 1b50000 /opt/tencent-qq/qq<br>   0x55555710d000     0x555557119000 rw-p     c000 1bb6000 /opt/tencent-qq/qq<br>   0x555557119000     0x55555717a000 rw-p    61000 0      [heap]<br><br></code></pre></td></tr></table></figure>

<p>在0xccb539处找到call    qword ptr [rax+30h]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs asm">0000000CCB500 ; __unwind &#123;<br>.text:0000000000CCB500                 push    rbp<br>.text:0000000000CCB501                 mov     rbp, rsp<br>.text:0000000000CCB504                 push    r15<br>.text:0000000000CCB506                 push    r14<br>.text:0000000000CCB508                 push    rbx<br>.text:0000000000CCB509                 sub     rsp, 178h<br>.text:0000000000CCB510                 mov     r15, rdi<br>.text:0000000000CCB513                 mov     rax, fs:28h<br>.text:0000000000CCB51C                 mov     [rbp+var_20], rax<br>.text:0000000000CCB520                 movaps  xmm0, cs:xmmword_122F40<br>.text:0000000000CCB527                 movaps  [rbp+var_40], xmm0<br>.text:0000000000CCB52B                 mov     [rbp+var_30], 0AAAAAAAAh<br>.text:0000000000CCB532                 mov     rax, [rsi]<br>.text:0000000000CCB535                 lea     rdi, [rbp+var_40]<br>.text:0000000000CCB539                 call    qword ptr [rax+30h] // vul<br>.text:0000000000CCB53C                 mov     edi, 2<br>.text:0000000000CCB541                 call    sub_BFB1B0<br>.text:0000000000CCB546                 test    al, al<br>.text:0000000000CCB548                 jz      loc_CCB5DE<br>.text:0000000000CCB54E                 lea     rsi, aQnoxMsfMsfping ; &quot;../../qnox/msf/msfping.cc&quot;<br>.text:0000000000CCB555                 lea     rdi, [rbp+var_178]<br>.text:0000000000CCB55C                 mov     edx, 107h<br>.text:0000000000CCB561                 mov     ecx, 2<br>.text:0000000000CCB566                 call    sub_BFB2A0<br>.text:0000000000CCB56B                 lea     rdi, [rbp+var_170]<br>.text:0000000000CCB572                 lea     rsi, unk_19F568<br>.text:0000000000CCB579                 mov     edx, 11h<br>.text:0000000000CCB57E                 call    sub_66E360<br>.text:0000000000CCB583                 mov     r14, rax<br>.text:0000000000CCB586                 lea     rbx, [rbp+var_190]<br>.text:0000000000CCB58D                 lea     rsi, [rbp+var_40]<br>.text:0000000000CCB591                 mov     rdi, rbx<br>.text:0000000000CCB594                 call    sub_1706710<br>.text:0000000000CCB599                 movzx   edx, [rbp+var_179]<br>.text:0000000000CCB5A0                 test    dl, dl<br>.text:0000000000CCB5A2                 jns     short loc_CCB5B2<br>.text:0000000000CCB5A4                 mov     rbx, [rbp+var_190]<br>.text:0000000000CCB5AB                 mov     rdx, [rbp+var_188]<br>.text:0000000000CCB5B2<br>.text:0000000000CCB5B2 loc_CCB5B2:                             ; CODE XREF: vul2+A2↑j<br>.text:0000000000CCB5B2                 mov     rdi, r14<br>.text:0000000000CCB5B5                 mov     rsi, rbx<br>.text:0000000000CCB5B8                 call    sub_66E360<br>.text:0000000000CCB5BD                 cmp     [rbp+var_179], 0<br>.text:0000000000CCB5C4                 jns     short loc_CCB5D2<br>.text:0000000000CCB5C6                 mov     rdi, [rbp+var_190]<br>.text:0000000000CCB5CD                 call    free<br>.text:0000000000CCB5D2<br>.text:0000000000CCB5D2 loc_CCB5D2:                             ; CODE XREF: vul2+C4↑j<br>.text:0000000000CCB5D2                 lea     rdi, [rbp+var_178]<br>.text:0000000000CCB5D9                 call    sub_BFBB10<br>.text:0000000000CCB5DE<br>.text:0000000000CCB5DE loc_CCB5DE:                             ; CODE XREF: vul2+48↑j<br>.text:0000000000CCB5DE                 add     dword ptr [r15+2Ch], 1<br>.text:0000000000CCB5E3                 mov     rdi, r15<br>.text:0000000000CCB5E6                 call    sub_CCA290<br>.text:0000000000CCB5EB                 lea     rdi, [rbp+var_40]<br>.text:0000000000CCB5EF                 call    sub_B636B0<br>.text:0000000000CCB5F4                 mov     rax, fs:28h<br>.text:0000000000CCB5FD                 cmp     rax, [rbp+var_20]<br>.text:0000000000CCB601                 jnz     short loc_CCB611<br>.text:0000000000CCB603                 add     rsp, 178h<br>.text:0000000000CCB60A                 pop     rbx<br>.text:0000000000CCB60B                 pop     r14<br>.text:0000000000CCB60D                 pop     r15<br>.text:0000000000CCB60F                 pop     rbp<br>.text:0000000000CCB610                 retn<br></code></pre></td></tr></table></figure>



<p>漏洞2伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">vul2</span><span class="hljs-params">(__int64 a1, __int64 a2)</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// r14</span><br>  __int64 *v3; <span class="hljs-comment">// rbx</span><br>  __int64 v4; <span class="hljs-comment">// rdx</span><br>  __int64 *v6; <span class="hljs-comment">// [rsp+0h] [rbp-190h]</span><br>  __int64 v7; <span class="hljs-comment">// [rsp+8h] [rbp-188h]</span><br>  <span class="hljs-type">unsigned</span> __int8 v8; <span class="hljs-comment">// [rsp+17h] [rbp-179h]</span><br>  <span class="hljs-type">char</span> v9; <span class="hljs-comment">// [rsp+18h] [rbp-178h]</span><br>  <span class="hljs-type">char</span> v10; <span class="hljs-comment">// [rsp+20h] [rbp-170h]</span><br>  __int128 v11; <span class="hljs-comment">// [rsp+150h] [rbp-40h]</span><br>  <span class="hljs-type">int</span> v12; <span class="hljs-comment">// [rsp+160h] [rbp-30h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v13; <span class="hljs-comment">// [rsp+170h] [rbp-20h]</span><br><br>  v13 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v11 = xmmword_122F40;<br>  v12 = <span class="hljs-number">-1431655766</span>;<br>  (*(<span class="hljs-type">void</span> (__fastcall **)(__int128 *))(*(_QWORD *)a2 + <span class="hljs-number">48LL</span>))(&amp;v11);<span class="hljs-comment">// 出现段错误函数指针调用</span><br>  <span class="hljs-keyword">if</span> ( sub_BFB1B0(<span class="hljs-number">2</span>) )<br>  &#123;<br>    sub_BFB2A0((__int64)&amp;v9, (__int64)<span class="hljs-string">&quot;../../qnox/msf/msfping.cc&quot;</span>, <span class="hljs-number">0x107</span>u, <span class="hljs-number">2</span>);<br>    v2 = sub_66E360(&amp;v10, &amp;unk_19F568, <span class="hljs-number">17LL</span>);<br>    v3 = (__int64 *)&amp;v6;<br>    sub_1706710(&amp;v6, &amp;v11);<br>    v4 = v8;<br>    <span class="hljs-keyword">if</span> ( (v8 &amp; <span class="hljs-number">0x80</span>u) != <span class="hljs-number">0</span> )<br>    &#123;<br>      v3 = v6;<br>      v4 = v7;<br>    &#125;<br>    sub_66E360(v2, v3, v4);<br>    <span class="hljs-keyword">if</span> ( (v8 &amp; <span class="hljs-number">0x80</span>u) != <span class="hljs-number">0</span> )<br>      <span class="hljs-built_in">free</span>(v6);<br>    sub_BFBB10(&amp;v9);<br>  &#125;<br>  ++*(_DWORD *)(a1 + <span class="hljs-number">44</span>);<br>  sub_CCA290(a1);<br>  sub_B636B0(&amp;v11);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>经过以上调试, 发现目前存在两个段错误漏洞, 应该是多线程处理对象时处理不当造成的, 望腾讯公司进行严格的代码审计与修复</p>
<h2 id="Linux-QQ-无用解决闪退的方法"><a href="#Linux-QQ-无用解决闪退的方法" class="headerlink" title="Linux QQ 无用解决闪退的方法"></a>Linux QQ 无用解决闪退的方法</h2><h3 id="解决方案1"><a href="#解决方案1" class="headerlink" title="解决方案1"></a>解决方案1</h3><p>删除掉配置文件即可</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36462403/article/details/105902227">https://blog.csdn.net/qq_36462403/article/details/105902227</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">rm -r ~/.config/tencent-qq<br></code></pre></td></tr></table></figure>

<p>经过测试, 无效</p>
<h3 id="解决方案2"><a href="#解决方案2" class="headerlink" title="解决方案2"></a>解决方案2</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_33692284/article/details/91508019">https://blog.csdn.net/weixin_33692284/article/details/91508019</a></p>
<p>经过测试,无效</p>
<h2 id="其他知识补充"><a href="#其他知识补充" class="headerlink" title="其他知识补充"></a>其他知识补充</h2><h3 id="gtklib之主事件循环"><a href="#gtklib之主事件循环" class="headerlink" title="gtklib之主事件循环"></a>gtklib之主事件循环</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/silvermagic/p/9087881.html">https://www.cnblogs.com/silvermagic/p/9087881.html</a></p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>GLib和GTK+应用的主事件循环管理着所有事件源。这些事件的来源有很多种比如文件描述符(文件、管道或套接字)或超时。新类型的事件源可以通过<strong>g_source_attach()<strong>函数添加。<br> 为了让多组独立事件源能够在不同的线程中被处理，每个事件源都会关联一个</strong>GMainContext</strong>。一个线程只能运行一个<strong>GMainContext</strong>，但是在其他线程中能够对事件源进行添加和删除操作。<br> 每个事件源都被赋予了优先级。默认的优先级是G_PRIORITY_DEFAULT(0)。值越小优先级越高，优先级高的事件源优先处理。<br> Idle函数在没有更高优先级的事件被处理的时候才会执行。<br> <strong>GMainLoop</strong>数据类型代表了一个主事件循环。通过<strong>g_main_loop_new()<strong>来创建</strong>GMainLoop</strong>对象。在添加完初始事件源后执行<strong>g_main_loop_run()<strong>，主循环将持续不断的检查每个事件源产生的新事件，然后分发它们，直到处理来自某个事件源的事件的时候触发了</strong>g_main_loop_quit()<strong>调用退出主循环为止。<br> <strong>GMainLoop</strong>实例能够被递归创建。在GTK+应用中经常使用这种方式来显示模态对话框。注意如果一个事件源被添加到一个</strong>GMainContext</strong>，那么它将被所有关联这个<strong>GMainContext</strong>的主线程检查和分发。<br> GTK+对这些函数做了些封装，例如gtk_main、gtk_mian_quit和gtk_events_pending。</p>
<h3 id="自定义事件类型"><a href="#自定义事件类型" class="headerlink" title="自定义事件类型"></a>自定义事件类型</h3><p><strong>GMainLoop</strong>一个不常用的特性就是能够创建一个新的事件源类型，然后当做内置事件源的扩展来使用。一个新的事件源类型通常用来处理GDK事件。通过继承<strong>GSource</strong>结构来创建一个新的事件源类型。继承产生的新事件源类型表示<strong>GSource</strong>结构作为新事件源类型的第一个元素然后其他元素紧跟其后。使用<strong>g_source_new</strong>函数来创建新的事件源类型实例，函数的参数就是新的事件源类型大小。<strong>GSourceFuncs</strong>决定新的事件源类型的行为。<br> 新的事件源有两种基本方式与<strong>GMainContext</strong>交互。它们<strong>GSourceFuncs</strong>中的准备函数能够设置睡眠事件，用来决定主循环下次检测它们的时间。此外事件源也可以使用<strong>g_source_add_poll()<strong>函数添加文件描述符到</strong>GMainContext</strong>进行检测。</p>
<h3 id="自定义主循环迭代"><a href="#自定义主循环迭代" class="headerlink" title="自定义主循环迭代"></a>自定义主循环迭代</h3><p>执行<strong>g_main_context_iteration()<strong>函数可以完成</strong>GMainContext</strong>的单次迭代。在一些情况下，我们可能想获取主循环更多的底层控制细节，我们可以调用**g_main_context_iteration()<strong>里的组件函数：</strong>g_main_context_prepare()<strong>、</strong>g_main_context_prepare ()<strong>、</strong>g_main_context_query()<strong>、</strong>g_main_context_check()<strong>和</strong>g_main_context_dispatch()**。</p>
<h3 id="Main-Context状态"><a href="#Main-Context状态" class="headerlink" title="Main Context状态"></a>Main Context状态</h3><p>在UNIX系统上，GLib的主循环和**fork()**是不兼容的。</p>
<h3 id="事件源内存管理"><a href="#事件源内存管理" class="headerlink" title="事件源内存管理"></a>事件源内存管理</h3><p>有两种可选的方式来管理传递给<strong>GSource</strong>回调函数用户数据的内存。用户数据就是在调用**g_timeout_add()<strong>、</strong>g_timeout_add_full()<strong>、</strong>g_idle_add()**传入的参数。这些数据通常被timeout或idle回调函数所拥有，比如一个构件或一个网路协议的实现。有些时候这些回调函数会在数据被销毁的后背调用，因为使用了已经被释放的内存，所以这会导致一个错误。</p>
<ul>
<li>第一种推荐的方法就是保存<strong>g_timeout_add()<strong>、</strong>g_source_attach()<strong>返回的事件源ID，然后在其维持的用户数据被释放后显示的将其从</strong>GMainContext</strong>移除。这样就能保证调用这些回调函数的时候，这些用户数据依然有效。</li>
<li>第二种就是保存这些回调函数中的用户数据对象的引用，然后在<strong>GDestroyNotify</strong>回调函数中释放它。这样就能确保数据对象在事件源最后一次调用然后被释放前一直有效。<strong>GDestroyNotify</strong>回调函数是<strong>GSource</strong>函数的一个变体的入参，它在事件源被释放时调用。<br>第二条途径有必要提醒下，如果在事件源还没被调用前主循环就结束的情况下，用户数据对象被维持状态是不确定的。</li>
</ul>
<h3 id="官方文档-gtk库函数"><a href="#官方文档-gtk库函数" class="headerlink" title="官方文档 gtk库函数"></a>官方文档 gtk库函数</h3><p>参考：<a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html">https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html</a></p>
<h3 id="g-main-context-dispatch"><a href="#g-main-context-dispatch" class="headerlink" title="g_main_context_dispatch ()"></a>g_main_context_dispatch ()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void<br>g_main_context_dispatch (GMainContext *context);<br></code></pre></td></tr></table></figure>

<p>Dispatches all pending sources.</p>
<p>You must have successfully acquired the context with <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-acquire"><code>g_main_context_acquire()</code></a> before you may call this function.</p>
<h3 id="g-main-context-acquire"><a href="#g-main-context-acquire" class="headerlink" title="g_main_context_acquire ()"></a>g_main_context_acquire ()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">gboolean<br>g_main_context_acquire (GMainContext *context);<br></code></pre></td></tr></table></figure>

<p>Tries to become the owner of the specified context. If some other thread is the owner of the context, returns <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#FALSE:CAPS"><code>FALSE</code></a> immediately. Ownership is properly recursive: the owner can require ownership again and will release ownership when <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-release"><code>g_main_context_release()</code></a> is called as many times as <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-acquire"><code>g_main_context_acquire()</code></a>.</p>
<p>You must be the owner of a context before you can call <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-prepare"><code>g_main_context_prepare()</code></a>, <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-query"><code>g_main_context_query()</code></a>, <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-check"><code>g_main_context_check()</code></a>, <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-dispatch"><code>g_main_context_dispatch()</code></a>.</p>
<h3 id="g-main-context-iteration"><a href="#g-main-context-iteration" class="headerlink" title="g_main_context_iteration ()"></a>g_main_context_iteration ()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">gboolean<br>g_main_context_iteration (GMainContext *context,<br>                          gboolean may_block);<br></code></pre></td></tr></table></figure>

<p>Runs a single iteration for the given main loop. This involves checking to see if any event sources are ready to be processed, then if no events sources are ready and <em><code>may_block</code></em> is <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#TRUE:CAPS"><code>TRUE</code></a>, waiting for a source to become ready, then dispatching the highest priority events sources that are ready. Otherwise, if <em><code>may_block</code></em> is <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#FALSE:CAPS"><code>FALSE</code></a> sources are not waited to become ready, only those highest priority events sources will be dispatched (if any), that are ready at this given moment without further waiting.</p>
<p>Note that even when <em><code>may_block</code></em> is <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#TRUE:CAPS"><code>TRUE</code></a>, it is still possible for <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#g-main-context-iteration"><code>g_main_context_iteration()</code></a> to return <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#FALSE:CAPS"><code>FALSE</code></a>, since the wait may be interrupted for other reasons than an event source becoming ready.</p>
<h4 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a>Parameters</h4><table>
<thead>
<tr>
<th>context</th>
<th>a <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-The-Main-Event-Loop.html#GMainContext">GMainContext</a> (if <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#NULL:CAPS"><code>NULL</code></a>, the default context will be used).</th>
<th>[nullable]</th>
</tr>
</thead>
<tbody><tr>
<td>may_block</td>
<td>whether the call may block.</td>
<td></td>
</tr>
</tbody></table>
<h4 id="Returns"><a href="#Returns" class="headerlink" title="Returns"></a>Returns</h4><p> <a target="_blank" rel="noopener" href="https://developer.gnome.org/glib/stable/glib-Standard-Macros.html#TRUE:CAPS"><code>TRUE</code></a> if events were dispatched.</p>
<h3 id="GMainContext"><a href="#GMainContext" class="headerlink" title="GMainContext"></a>GMainContext</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _GMainContext GMainContext;<br></code></pre></td></tr></table></figure>

<p>The <code>GMainContext</code> struct is an opaque data type representing a set of sources to be handled in a main loop.</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2020/10/31/security/ctf/wp/wp-xnuca-2020/">← Next wp-xnuca-2020</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/10/29/security/ctf/pwn/new-heap-exploit/">HEAP-2020-姿势学习 Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/Yue-plus">John Doe</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#linux-qq-%E5%B4%A9%E6%BA%83%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">linux qq 崩溃调试分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#QQ%E8%B0%83%E8%AF%95%E6%8A%A5%E5%91%8A"><span class="toc-number">1.1.</span> <span class="toc-text">QQ调试报告</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E8%80%85"><span class="toc-number">1.1.1.</span> <span class="toc-text">调试者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.2.</span> <span class="toc-text">保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.3.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.1.4.</span> <span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.1.5.</span> <span class="toc-text">原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">1.1.6.</span> <span class="toc-text">其他</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%AE%B5%E9%94%99%E8%AF%AF%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81%E5%9D%97%E5%81%8F%E7%A7%BB"><span class="toc-number">1.1.7.</span> <span class="toc-text">触发段错误漏洞代码块偏移</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">1.2.</span> <span class="toc-text">调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">线程信息:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AE%B5%E9%94%99%E8%AF%AF"><span class="toc-number">1.2.2.</span> <span class="toc-text">段错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%83%85%E5%86%B5%E8%B0%83%E8%AF%95"><span class="toc-number">1.2.3.</span> <span class="toc-text">正常情况调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%BC%8F%E6%B4%9E%E5%87%BD%E6%95%B0%E6%9C%80%E5%90%8E%E4%B8%80%E6%AC%A1%E7%8A%B6%E6%80%81"><span class="toc-number">1.3.</span> <span class="toc-text">调试漏洞函数最后一次状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%BA%BF%E7%A8%8B%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.</span> <span class="toc-text">其他线程漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-QQ-%E6%97%A0%E7%94%A8%E8%A7%A3%E5%86%B3%E9%97%AA%E9%80%80%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">Linux QQ 无用解决闪退的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%881"><span class="toc-number">1.5.1.</span> <span class="toc-text">解决方案1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%882"><span class="toc-number">1.5.2.</span> <span class="toc-text">解决方案2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%9F%A5%E8%AF%86%E8%A1%A5%E5%85%85"><span class="toc-number">1.6.</span> <span class="toc-text">其他知识补充</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gtklib%E4%B9%8B%E4%B8%BB%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.6.1.</span> <span class="toc-text">gtklib之主事件循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.6.2.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">自定义事件类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%BB%E5%BE%AA%E7%8E%AF%E8%BF%AD%E4%BB%A3"><span class="toc-number">1.6.4.</span> <span class="toc-text">自定义主循环迭代</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Main-Context%E7%8A%B6%E6%80%81"><span class="toc-number">1.6.5.</span> <span class="toc-text">Main Context状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E6%BA%90%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">1.6.6.</span> <span class="toc-text">事件源内存管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3-gtk%E5%BA%93%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.7.</span> <span class="toc-text">官方文档 gtk库函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#g-main-context-dispatch"><span class="toc-number">1.6.8.</span> <span class="toc-text">g_main_context_dispatch ()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#g-main-context-acquire"><span class="toc-number">1.6.9.</span> <span class="toc-text">g_main_context_acquire ()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#g-main-context-iteration"><span class="toc-number">1.6.10.</span> <span class="toc-text">g_main_context_iteration ()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Parameters"><span class="toc-number">1.6.10.1.</span> <span class="toc-text">Parameters</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Returns"><span class="toc-number">1.6.10.2.</span> <span class="toc-text">Returns</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GMainContext"><span class="toc-number">1.6.11.</span> <span class="toc-text">GMainContext</span></a></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">赣ICP备19008355号</a></nobr><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><br><nobr>published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'LSe7mf1XYliLqgIrc3jlqXfT-gzGzoHsz'
 , appKey: 'Fu9giJfnidkCamaW89FUpidw' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>